{"sample_id": "Math_102", "model": "llama3-8b-groq", "code_context": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.apache.commons.math.stat.inference;\n\nimport org.apache.commons.math.MathException;\nimport org.apache.commons.math.distribution.ChiSquaredDistribution;\nimport org.apache.commons.math.distribution.ChiSquaredDistributionImpl;\nimport org.apache.commons.math.distribution.DistributionFactory;\n\n/**\n * Implements Chi-Square test statistics defined in the\n * {@link UnknownDistributionChiSquareTest} interface.\n *\n * @version $Revision$ $Date$\n */\npublic class ChiSquareTestImpl implements UnknownDistributionChiSquareTest {\n\n    /** Distribution used to compute inference statistics. */\n    private ChiSquaredDistribution distribution;\n  \n    /**\n     * Construct a ChiSquareTestImpl \n     */\n    public ChiSquareTestImpl() {\n        this(new ChiSquaredDistributionImpl(1.0));\n    }\n\n    /**\n     * Create a test instance using the given distribution for computing\n     * inference statistics.\n     * @param x distribution used to compute inference statistics.\n     * @since 1.2\n     */\n    public ChiSquareTestImpl(ChiSquaredDistribution x) {\n        super();\n        setDistribution(x);\n    }\n     /**\n     * {@inheritDoc}\n     * <p><strong>Note: </strong>This implementation rescales the \n     * <code>expected</code> array if necessary to ensure that the sum of the\n     * expected and observed counts are equal.</p>\n     * \n     * @param observed array of observed frequency counts\n     * @param expected array of expected frequency counts\n     * @return chi-square test statistic\n     * @throws IllegalArgumentException if preconditions are not met\n     * or length is less than 2\n     */\n    public double chiSquare(double[] expected, long[] observed)\n        throws IllegalArgumentException {\n        if ((expected.length < 2) || (expected.length != observed.length)) {\n            throw new IllegalArgumentException(\n                    \"observed, expected array lengths incorrect\");\n        }\n        if (!isPositive(expected) || !isNonNegative(observed)) {\n            throw new IllegalArgumentException(\n                \"observed counts must be non-negative and expected counts must be postive\");\n        }\n        double sumSq = 0.0d;\n        double dev = 0.0d;\n        for (int i = 0; i < observed.length; i++) {\n                dev = ((double) observed[i] - expected[i]);\n                sumSq += dev * dev / expected[i];\n        }\n        return sumSq;\n    }\n\n    /**\n     * {@inheritDoc}\n     * <p><strong>Note: </strong>This implementation rescales the \n     * <code>expected</code> array if necessary to ensure that the sum of the\n     * expected and observed counts are equal.</p>\n     * \n     * @param observed array of observed frequency counts\n     * @param expected array of exptected frequency counts\n     * @return p-value\n     * @throws IllegalArgumentException if preconditions are not met\n     * @throws MathException if an error occurs computing the p-value\n     */\n    public double chiSquareTest(double[] expected, long[] observed)\n        throws IllegalArgumentException, MathException {\n        distribution.setDegreesOfFreedom(expected.length - 1.0);\n        return 1.0 - distribution.cumulativeProbability(\n            chiSquare(expected, observed));\n    }\n\n    /**\n     * {@inheritDoc}\n     * <p><strong>Note: </strong>This implementation rescales the \n     * <code>expected</code> array if necessary to ensure that the sum of the\n     * expected and observed counts are equal.</p>\n     * \n     * @param observed array of observed frequency counts\n     * @param expected array of exptected frequency counts\n     * @param alpha significance level of the test\n     * @return true iff null hypothesis can be rejected with confidence\n     * 1 - alpha\n     * @throws IllegalArgumentException if preconditions are not met\n     * @throws MathException if an error occurs performing the test\n     */\n    public boolean chiSquareTest(double[] expected, long[] observed, \n            double alpha) throws IllegalArgumentException, MathException {\n        if ((alpha <= 0) || (alpha > 0.5)) {\n            throw new IllegalArgumentException(\n                    \"bad significance level: \" + alpha);\n        }\n        return (chiSquareTest(expected, observed) < alpha);\n    }\n    \n    /**\n     * @param counts array representation of 2-way table\n     * @return chi-square test statistic\n     * @throws IllegalArgumentException if preconditions are not met\n     */\n    public double chiSquare(long[][] counts) throws IllegalArgumentException {\n        \n        checkArray(counts);\n        int nRows = counts.length;\n        int nCols = counts[0].length;\n        \n        // compute row, column and total sums\n        double[] rowSum = new double[nRows];\n        double[] colSum = new double[nCols];\n        double total = 0.0d;\n        for (int row = 0; row < nRows; row++) {\n            for (int col = 0; col < nCols; col++) {\n                rowSum[row] += (double) counts[row][col];\n                colSum[col] += (double) counts[row][col];\n                total += (double) counts[row][col];\n            }\n        }\n        \n        // compute expected counts and chi-square\n        double sumSq = 0.0d;\n        double expected = 0.0d;\n        for (int row = 0; row < nRows; row++) {\n            for (int col = 0; col < nCols; col++) {\n                expected = (rowSum[row] * colSum[col]) / total;\n                sumSq += (((double) counts[row][col] - expected) * \n                        ((double) counts[row][col] - expected)) / expected; \n            }\n        } \n        return sumSq;\n    }\n\n    /**\n     * @param counts array representation of 2-way table\n     * @return p-value\n     * @throws IllegalArgumentException if preconditions are not met\n     * @throws MathException if an error occurs computing the p-value\n     */\n    public double chiSquareTest(long[][] counts)\n    throws IllegalArgumentException, MathException {\n        checkArray(counts);\n        double df = ((double) counts.length -1) * ((double) counts[0].length - 1);\n        distribution.setDegreesOfFreedom(df);\n        return 1 - distribution.cumulativeProbability(chiSquare(counts));\n    }\n\n    /**\n     * @param counts array representation of 2-way table\n     * @param alpha significance level of the test\n     * @return true iff null hypothesis can be rejected with confidence\n     * 1 - alpha\n     * @throws IllegalArgumentException if preconditions are not met\n     * @throws MathException if an error occurs performing the test\n     */\n    public boolean chiSquareTest(long[][] counts, double alpha)\n    throws IllegalArgumentException, MathException {\n        if ((alpha <= 0) || (alpha > 0.5)) {\n            throw new IllegalArgumentException(\"bad significance level: \" + alpha);\n        }\n        return (chiSquareTest(counts) < alpha);\n    }\n    \n    /**\n     * @param observed1 array of observed frequency counts of the first data set\n     * @param observed2 array of observed frequency counts of the second data set\n     * @return chi-square test statistic\n     * @throws IllegalArgumentException if preconditions are not met\n     */\n    public double chiSquareDataSetsComparison(long[] observed1, long[] observed2)\n        throws IllegalArgumentException {\n        \n        // Make sure lengths are same\n        if ((observed1.length < 2) || (observed1.length != observed2.length)) {\n            throw new IllegalArgumentException(\n                    \"oberved1, observed2 array lengths incorrect\");\n        }\n        // Ensure non-negative counts\n        if (!isNonNegative(observed1) || !isNonNegative(observed2)) {\n            throw new IllegalArgumentException(\n                \"observed counts must be non-negative\");\n        }\n        // Compute and compare count sums\n        long countSum1 = 0;\n        long countSum2 = 0;\n        boolean unequalCounts = false;\n        double weight = 0.0;\n        for (int i = 0; i < observed1.length; i++) {\n            countSum1 += observed1[i];\n            countSum2 += observed2[i];   \n        }\n        // Ensure neither sample is uniformly 0\n        if (countSum1 * countSum2 == 0) {\n            throw new IllegalArgumentException(\n             \"observed counts cannot all be 0\"); \n        }\n        // Compare and compute weight only if different\n        unequalCounts = (countSum1 != countSum2);\n        if (unequalCounts) {\n            weight = Math.sqrt((double) countSum1 / (double) countSum2);\n        }\n        // Compute ChiSquare statistic\n        double sumSq = 0.0d;\n        double dev = 0.0d;\n        double obs1 = 0.0d;\n        double obs2 = 0.0d;\n        for (int i = 0; i < observed1.length; i++) {\n            if (observed1[i] == 0 && observed2[i] == 0) {\n                throw new IllegalArgumentException(\n                        \"observed counts must not both be zero\");\n            } else {\n                obs1 = (double) observed1[i];\n                obs2 = (double) observed2[i];\n                if (unequalCounts) { // apply weights\n                    dev = obs1/weight - obs2 * weight;\n                } else {\n                    dev = obs1 - obs2;\n                }\n                sumSq += (dev * dev) / (obs1 + obs2);\n            }\n        }\n        return sumSq;\n    }\n\n    /**\n     * @param observed1 array of observed frequency counts of the first data set\n     * @param observed2 array of observed frequency counts of the second data set\n     * @return p-value\n     * @throws IllegalArgumentException if preconditions are not met\n     * @throws MathException if an error occurs computing the p-value\n     */\n    public double chiSquareTestDataSetsComparison(long[] observed1, long[] observed2)\n        throws IllegalArgumentException, MathException {\n        distribution.setDegreesOfFreedom((double) observed1.length - 1);\n        return 1 - distribution.cumulativeProbability(\n                chiSquareDataSetsComparison(observed1, observed2));\n    }\n\n    /**\n     * @param observed1 array of observed frequency counts of the first data set\n     * @param observed2 array of observed frequency counts of the second data set\n     * @param alpha significance level of the test\n     * @return true iff null hypothesis can be rejected with confidence\n     * 1 - alpha\n     * @throws IllegalArgumentException if preconditions are not met\n     * @throws MathException if an error occurs performing the test\n     */\n    public boolean chiSquareTestDataSetsComparison(long[] observed1, long[] observed2,\n            double alpha) throws IllegalArgumentException, MathException {\n        if ((alpha <= 0) || (alpha > 0.5)) {\n            throw new IllegalArgumentException(\n                    \"bad significance level: \" + alpha);\n        }\n        return (chiSquareTestDataSetsComparison(observed1, observed2) < alpha);\n    }\n\n    /**\n     * Checks to make sure that the input long[][] array is rectangular,\n     * has at least 2 rows and 2 columns, and has all non-negative entries,\n     * throwing IllegalArgumentException if any of these checks fail.\n     * \n     * @param in input 2-way table to check\n     * @throws IllegalArgumentException if the array is not valid\n     */\n    private void checkArray(long[][] in) throws IllegalArgumentException {\n        \n        if (in.length < 2) {\n            throw new IllegalArgumentException(\"Input table must have at least two rows\");\n        }\n        \n        if (in[0].length < 2) {\n            throw new IllegalArgumentException(\"Input table must have at least two columns\");\n        }    \n        \n        if (!isRectangular(in)) {\n            throw new IllegalArgumentException(\"Input table must be rectangular\");\n        }\n        \n        if (!isNonNegative(in)) {\n            throw new IllegalArgumentException(\"All entries in input 2-way table must be non-negative\");\n        }\n        \n    }\n    \n    //---------------------  Protected methods ---------------------------------\n    /**\n     * Gets a DistributionFactory to use in creating ChiSquaredDistribution instances.\n     * @deprecated inject ChiSquaredDistribution instances directly instead of\n     *             using a factory.\n     */\n    protected DistributionFactory getDistributionFactory() {\n        return DistributionFactory.newInstance();\n    }\n    \n    //---------------------  Private array methods -- should find a utility home for these\n    \n    /**\n     * Returns true iff input array is rectangular.\n     * \n     * @param in array to be tested\n     * @return true if the array is rectangular\n     * @throws NullPointerException if input array is null\n     * @throws ArrayIndexOutOfBoundsException if input array is empty\n     */\n    private boolean isRectangular(long[][] in) {\n        for (int i = 1; i < in.length; i++) {\n            if (in[i].length != in[0].length) {\n                return false;\n            }\n        }  \n        return true;\n    }\n    \n    /**\n     * Returns true iff all entries of the input array are > 0.\n     * Returns true if the array is non-null, but empty\n     * \n     * @param in array to be tested\n     * @return true if all entries of the array are positive\n     * @throws NullPointerException if input array is null\n     */\n    private boolean isPositive(double[] in) {\n        for (int i = 0; i < in.length; i ++) {\n            if (in[i] <= 0) {\n                return false;\n            }\n        }\n        return true;\n    }\n    \n    /**\n     * Returns true iff all entries of the input array are >= 0.\n     * Returns true if the array is non-null, but empty\n     * \n     * @param in array to be tested\n     * @return true if all entries of the array are non-negative\n     * @throws NullPointerException if input array is null\n     */\n    private boolean isNonNegative(long[] in) {\n        for (int i = 0; i < in.length; i ++) {\n            if (in[i] < 0) {\n                return false;\n            }\n        }\n        return true;\n    }\n    \n    /**\n     * Returns true iff all entries of (all subarrays of) the input array are >= 0.\n     * Returns true if the array is non-null, but empty\n     * \n     * @param in array to be tested\n     * @return true if all entries of the array are non-negative\n     * @throws NullPointerException if input array is null\n     */\n    private boolean isNonNegative(long[][] in) {\n        for (int i = 0; i < in.length; i ++) {\n            for (int j = 0; j < in[i].length; j++) {\n                if (in[i][j] < 0) {\n                    return false;\n                }\n            }\n        }\n        return true;\n    }\n \n    /**\n     * Modify the distribution used to compute inference statistics.\n     * \n     * @param value\n     *            the new distribution\n     * @since 1.2\n     */\n    public void setDistribution(ChiSquaredDistribution value) {\n        distribution = value;\n    }\n}\n", "review": {"response": "{\n  \"bugs\": [\n      {\n         \"type\": \"Potential NullPointerException\",\n         \"description\": \"In the constructor ChiSquareTestImpl(), if the input ChiSquaredDistributionImpl is null, a NullPointerException will be thrown when calling setDistribution(x).\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential IllegalArgumentException\",\n         \"description\": \"In the method chiSquare(), if the input arrays expected and observed have different lengths, an IllegalArgumentException will be thrown. However, this check can be improved to also handle cases where the lengths of the arrays are less than 2.\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential IllegalArgumentException\",\n         \"description\": \"In the method chiSquareTest(), if the input array expected has a length less than 2, an IllegalArgumentException will be thrown. However, this check can be improved to also handle cases where the length of the array is less than 2.\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential MathException\",\n         \"description\": \"In the method chiSquareTest(), if an error occurs computing the p-value, a MathException will be thrown. However, this exception is not caught or handled anywhere in the code, which may lead to unexpected behavior.\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential IllegalArgumentException\",\n         \"description\": \"In the method chiSquareTest(), if the input array expected has a length less than 2, an IllegalArgumentException will be thrown. However, this check can be improved to also handle cases where the length of the array is less than 2.\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential NullPointerException\",\n         \"description\": \"In the method chiSquare(), if the input array expected is null, a NullPointerException will be thrown when calling isPositive(expected).\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential NullPointerException\",\n         \"description\": \"In the method chiSquare(), if the input array observed is null, a NullPointerException will be thrown when calling isNonNegative(observed).\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      },\n      {\n         \"type\": \"Potential IllegalArgumentException\",\n         \"description\": \"In the method chiSquare(), if the input arrays expected and observed have different lengths, an IllegalArgumentException will be thrown. However, this check can be improved to also handle cases where the lengths of the arrays are less than 2.\",\n         \"location\": \"org.apache.commons.math.stat.inference.ChiSquareTestImpl\"\n      }\n   ]\n}"}}