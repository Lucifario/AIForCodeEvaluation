{"sample_id": "Math_69", "model": "mistral-nemo", "code_context": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.apache.commons.math.stat.correlation;\n\nimport org.apache.commons.math.MathException;\nimport org.apache.commons.math.MathRuntimeException;\nimport org.apache.commons.math.distribution.TDistribution;\nimport org.apache.commons.math.distribution.TDistributionImpl;\nimport org.apache.commons.math.linear.RealMatrix;\nimport org.apache.commons.math.linear.BlockRealMatrix;\nimport org.apache.commons.math.stat.regression.SimpleRegression;\n\n/**\n * Computes Pearson's product-moment correlation coefficients for pairs of arrays\n * or columns of a matrix.\n *\n * <p>The constructors that take <code>RealMatrix</code> or\n * <code>double[][]</code> arguments generate correlation matrices.  The\n * columns of the input matrices are assumed to represent variable values.\n * Correlations are given by the formula</p>\n * <code>cor(X, Y) = &Sigma;[(x<sub>i</sub> - E(X))(y<sub>i</sub> - E(Y))] / [(n - 1)s(X)s(Y)]</code>\n * where <code>E(X)</code> is the mean of <code>X</code>, <code>E(Y)</code>\n * is the mean of the <code>Y</code> values and s(X), s(Y) are standard deviations.\n *\n * @version $Revision$ $Date$\n * @since 2.0\n */\npublic class PearsonsCorrelation {\n\n    /** correlation matrix */\n    private final RealMatrix correlationMatrix;\n\n    /** number of observations */\n    private final int nObs;\n\n    /**\n     * Create a PearsonsCorrelation instance without data\n     */\n    public PearsonsCorrelation() {\n        super();\n        correlationMatrix = null;\n        nObs = 0;\n    }\n\n    /**\n     * Create a PearsonsCorrelation from a rectangular array\n     * whose columns represent values of variables to be correlated.\n     *\n     * @param data rectangular array with columns representing variables\n     * @throws IllegalArgumentException if the input data array is not\n     * rectangular with at least two rows and two columns.\n     */\n    public PearsonsCorrelation(double[][] data) {\n        this(new BlockRealMatrix(data));\n    }\n\n    /**\n     * Create a PearsonsCorrelation from a RealMatrix whose columns\n     * represent variables to be correlated.\n     *\n     * @param matrix matrix with columns representing variables to correlate\n     */\n    public PearsonsCorrelation(RealMatrix matrix) {\n        checkSufficientData(matrix);\n        nObs = matrix.getRowDimension();\n        correlationMatrix = computeCorrelationMatrix(matrix);\n    }\n\n    /**\n     * Create a PearsonsCorrelation from a {@link Covariance}.  The correlation\n     * matrix is computed by scaling the Covariance's covariance matrix.\n     * The Covariance instance must have been created from a data matrix with\n     * columns representing variable values.\n     *\n     * @param covariance Covariance instance\n     */\n    public PearsonsCorrelation(Covariance covariance) {\n        RealMatrix covarianceMatrix = covariance.getCovarianceMatrix();\n        if (covarianceMatrix == null) {\n            throw MathRuntimeException.createIllegalArgumentException(\"covariance matrix is null\");\n        }\n        nObs = covariance.getN();\n        correlationMatrix = covarianceToCorrelation(covarianceMatrix);\n    }\n\n    /**\n     * Create a PearsonsCorrelation from a covariance matrix.  The correlation\n     * matrix is computed by scaling the covariance matrix.\n     *\n     * @param covarianceMatrix covariance matrix\n     * @param numberOfObservations the number of observations in the dataset used to compute\n     * the covariance matrix\n     */\n    public PearsonsCorrelation(RealMatrix covarianceMatrix, int numberOfObservations) {\n        nObs = numberOfObservations;\n        correlationMatrix = covarianceToCorrelation(covarianceMatrix);\n\n    }\n\n    /**\n     * Returns the correlation matrix\n     *\n     * @return correlation matrix\n     */\n    public RealMatrix getCorrelationMatrix() {\n        return correlationMatrix;\n    }\n\n    /**\n     * Returns a matrix of standard errors associated with the estimates\n     * in the correlation matrix.<br/>\n     * <code>getCorrelationStandardErrors().getEntry(i,j)</code> is the standard\n     * error associated with <code>getCorrelationMatrix.getEntry(i,j)</code>\n     * <p>The formula used to compute the standard error is <br/>\n     * <code>SE<sub>r</sub> = ((1 - r<sup>2</sup>) / (n - 2))<sup>1/2</sup></code>\n     * where <code>r</code> is the estimated correlation coefficient and\n     * <code>n</code> is the number of observations in the source dataset.</p>\n     *\n     * @return matrix of correlation standard errors\n     */\n    public RealMatrix getCorrelationStandardErrors() {\n        int nVars = correlationMatrix.getColumnDimension();\n        double[][] out = new double[nVars][nVars];\n        for (int i = 0; i < nVars; i++) {\n            for (int j = 0; j < nVars; j++) {\n                double r = correlationMatrix.getEntry(i, j);\n                out[i][j] = Math.sqrt((1 - r * r) /(nObs - 2));\n            }\n        }\n        return new BlockRealMatrix(out);\n    }\n\n    /**\n     * Returns a matrix of p-values associated with the (two-sided) null\n     * hypothesis that the corresponding correlation coefficient is zero.\n     * <p><code>getCorrelationPValues().getEntry(i,j)</code> is the probability\n     * that a random variable distributed as <code>t<sub>n-2</sub></code> takes\n     * a value with absolute value greater than or equal to <br>\n     * <code>|r|((n - 2) / (1 - r<sup>2</sup>))<sup>1/2</sup></code></p>\n     * <p>The values in the matrix are sometimes referred to as the\n     * <i>significance</i> of the corresponding correlation coefficients.</p>\n     *\n     * @return matrix of p-values\n     * @throws MathException if an error occurs estimating probabilities\n     */\n    public RealMatrix getCorrelationPValues() throws MathException {\n        TDistribution tDistribution = new TDistributionImpl(nObs - 2);\n        int nVars = correlationMatrix.getColumnDimension();\n        double[][] out = new double[nVars][nVars];\n        for (int i = 0; i < nVars; i++) {\n            for (int j = 0; j < nVars; j++) {\n                if (i == j) {\n                    out[i][j] = 0d;\n                } else {\n                    double r = correlationMatrix.getEntry(i, j);\n                    double t = Math.abs(r * Math.sqrt((nObs - 2)/(1 - r * r)));\n                    out[i][j] = 2 * (1 - tDistribution.cumulativeProbability(t));\n                }\n            }\n        }\n        return new BlockRealMatrix(out);\n    }\n\n\n    /**\n     * Computes the correlation matrix for the columns of the\n     * input matrix.\n     *\n     * @param matrix matrix with columns representing variables to correlate\n     * @return correlation matrix\n     */\n    public RealMatrix computeCorrelationMatrix(RealMatrix matrix) {\n        int nVars = matrix.getColumnDimension();\n        RealMatrix outMatrix = new BlockRealMatrix(nVars, nVars);\n        for (int i = 0; i < nVars; i++) {\n            for (int j = 0; j < i; j++) {\n              double corr = correlation(matrix.getColumn(i), matrix.getColumn(j));\n              outMatrix.setEntry(i, j, corr);\n              outMatrix.setEntry(j, i, corr);\n            }\n            outMatrix.setEntry(i, i, 1d);\n        }\n        return outMatrix;\n    }\n\n    /**\n     * Computes the correlation matrix for the columns of the\n     * input rectangular array.  The colums of the array represent values\n     * of variables to be correlated.\n     *\n     * @param data matrix with columns representing variables to correlate\n     * @return correlation matrix\n     */\n    public RealMatrix computeCorrelationMatrix(double[][] data) {\n       return computeCorrelationMatrix(new BlockRealMatrix(data));\n    }\n\n    /**\n     * Computes the Pearson's product-moment correlation coefficient between the two arrays.\n     *\n     * </p>Throws IllegalArgumentException if the arrays do not have the same length\n     * or their common length is less than 2</p>\n     *\n     * @param xArray first data array\n     * @param yArray second data array\n     * @return Returns Pearson's correlation coefficient for the two arrays\n     * @throws  IllegalArgumentException if the arrays lengths do not match or\n     * there is insufficient data\n     */\n    public double correlation(final double[] xArray, final double[] yArray) throws IllegalArgumentException {\n        SimpleRegression regression = new SimpleRegression();\n        if(xArray.length == yArray.length && xArray.length > 1) {\n            for(int i=0; i<xArray.length; i++) {\n                regression.addData(xArray[i], yArray[i]);\n            }\n            return regression.getR();\n        }\n        else {\n            throw MathRuntimeException.createIllegalArgumentException(\n                    \"invalid array dimensions. xArray has size {0}; yArray has {1} elements\",\n                    xArray.length, yArray.length);\n        }\n    }\n\n    /**\n     * Derives a correlation matrix from a covariance matrix.\n     *\n     * <p>Uses the formula <br/>\n     * <code>r(X,Y) = cov(X,Y)/s(X)s(Y)</code> where\n     * <code>r(&middot,&middot;)</code> is the correlation coefficient and\n     * <code>s(&middot;)</code> means standard deviation.</p>\n     *\n     * @param covarianceMatrix the covariance matrix\n     * @return correlation matrix\n     */\n    public RealMatrix covarianceToCorrelation(RealMatrix covarianceMatrix) {\n        int nVars = covarianceMatrix.getColumnDimension();\n        RealMatrix outMatrix = new BlockRealMatrix(nVars, nVars);\n        for (int i = 0; i < nVars; i++) {\n            double sigma = Math.sqrt(covarianceMatrix.getEntry(i, i));\n            outMatrix.setEntry(i, i, 1d);\n            for (int j = 0; j < i; j++) {\n                double entry = covarianceMatrix.getEntry(i, j) /\n                       (sigma * Math.sqrt(covarianceMatrix.getEntry(j, j)));\n                outMatrix.setEntry(i, j, entry);\n                outMatrix.setEntry(j, i, entry);\n            }\n        }\n        return outMatrix;\n    }\n\n    /**\n     * Throws IllegalArgumentException of the matrix does not have at least\n     * two columns and two rows\n     *\n     * @param matrix matrix to check for sufficiency\n     */\n    private void checkSufficientData(final RealMatrix matrix) {\n        int nRows = matrix.getRowDimension();\n        int nCols = matrix.getColumnDimension();\n        if (nRows < 2 || nCols < 2) {\n            throw MathRuntimeException.createIllegalArgumentException(\n                    \"insufficient data: only {0} rows and {1} columns.\",\n                    nRows, nCols);\n        }\n    }\n}\n", "review": {"response": "{ \"bugs\": [\n\n  {\n    \"description\": \"Null Pointer Exception in constructor\",\n    \"fix\": \"Initialize correlationMatrix and nObs in the default constructor to avoid Null Pointer Exception.\"\n  },\n\n  {\n    \"description\": \"IllegalArgumentException in constructor\",\n    \"fix\": \"Add null checks and size validation for input data array in the constructor that takes a double[][] argument.\"\n  },\n\n  {\n    \"description\": \"Null Pointer Exception in getCorrelationStandardErrors()\",\n    \"fix\": \"Add null check for correlationMatrix in the getCorrelationStandardErrors() method to avoid Null Pointer Exception.\"\n  },\n\n  {\n    \"description\": \"ArrayIndexOutOfBoundsException in getCorrelationStandardErrors()\",\n    \"fix\": \"Add bounds check for i and j in the getCorrelationStandardErrors() method to avoid ArrayIndexOutOfBoundsException.\"\n  }\n\n] }"}}