{"sample_id": "Mockito_10", "model": "llama3-8b-groq", "code_context": "/*\n * Copyright (c) 2007 Mockito contributors\n * This program is made available under the terms of the MIT License.\n */\npackage org.mockito.internal.stubbing.defaultanswers;\n\nimport org.mockito.MockSettings;\nimport org.mockito.Mockito;\nimport org.mockito.internal.InternalMockHandler;\nimport org.mockito.internal.MockitoCore;\nimport org.mockito.internal.creation.settings.CreationSettings;\nimport org.mockito.internal.stubbing.InvocationContainerImpl;\nimport org.mockito.internal.stubbing.StubbedInvocationMatcher;\nimport org.mockito.internal.util.MockUtil;\nimport org.mockito.internal.util.reflection.GenericMetadataSupport;\nimport org.mockito.invocation.InvocationOnMock;\nimport org.mockito.stubbing.Answer;\n\nimport java.io.IOException;\nimport java.io.Serializable;\n\nimport static org.mockito.Mockito.withSettings;\n\n/**\n * Returning deep stub implementation.\n *\n * Will return previously created mock if the invocation matches.\n *\n * <p>Supports nested generic information, with this answer you can write code like this :\n *\n * <pre class=\"code\"><code class=\"java\">\n *     interface GenericsNest&lt;K extends Comparable&lt;K&gt; & Cloneable&gt; extends Map&lt;K, Set&lt;Number&gt;&gt; {}\n *\n *     GenericsNest&lt;?&gt; mock = mock(GenericsNest.class, new ReturnsGenericDeepStubs());\n *     Number number = mock.entrySet().iterator().next().getValue().iterator().next();\n * </code></pre>\n * </p>\n *\n * @see org.mockito.Mockito#RETURNS_DEEP_STUBS\n * @see org.mockito.Answers#RETURNS_DEEP_STUBS\n */\npublic class ReturnsDeepStubs implements Answer<Object>, Serializable {\n\n    private static final long serialVersionUID = -7105341425736035847L;\n\n    public Object answer(InvocationOnMock invocation) throws Throwable {\n        GenericMetadataSupport returnTypeGenericMetadata =\n                actualParameterizedType(invocation.getMock()).resolveGenericReturnType(invocation.getMethod());\n\n        Class<?> rawType = returnTypeGenericMetadata.rawType();\n        if (!mockitoCore().isTypeMockable(rawType)) {\n            return delegate().returnValueFor(rawType);\n        }\n\n        return deepStub(invocation, returnTypeGenericMetadata);\n    }\n\n    private Object deepStub(InvocationOnMock invocation, GenericMetadataSupport returnTypeGenericMetadata) throws Throwable {\n        InternalMockHandler<Object> handler = new MockUtil().getMockHandler(invocation.getMock());\n        InvocationContainerImpl container = (InvocationContainerImpl) handler.getInvocationContainer();\n\n        // matches invocation for verification\n        for (StubbedInvocationMatcher stubbedInvocationMatcher : container.getStubbedInvocations()) {\n            if (container.getInvocationForStubbing().matches(stubbedInvocationMatcher.getInvocation())) {\n                return stubbedInvocationMatcher.answer(invocation);\n            }\n        }\n\n        // record deep stub answer\n        return recordDeepStubAnswer(\n                newDeepStubMock(returnTypeGenericMetadata),\n                container\n        );\n    }\n\n    /**\n     * Creates a mock using the Generics Metadata.\n     *\n     * <li>Finally as we want to mock the actual type, but we want to pass along the contextual generics meta-data\n     * that was resolved for the current return type, for this to happen we associate to the mock an new instance of\n     * {@link ReturnsDeepStubs} answer in which we will store the returned type generic metadata.\n     *\n     * @param returnTypeGenericMetadata The metadata to use to create the new mock.\n     * @param parentMock The parent of the current deep stub mock.\n     * @return The mock\n     */\n    private Object newDeepStubMock(GenericMetadataSupport returnTypeGenericMetadata) {\n        return mockitoCore().mock(\n                returnTypeGenericMetadata.rawType(),\n                withSettingsUsing(returnTypeGenericMetadata)\n        );\n    }\n\n    private MockSettings withSettingsUsing(GenericMetadataSupport returnTypeGenericMetadata) {\n        MockSettings mockSettings = returnTypeGenericMetadata.hasRawExtraInterfaces() ?\n                withSettings().extraInterfaces(returnTypeGenericMetadata.rawExtraInterfaces())\n                : withSettings();\n\n        return mockSettings.serializable()\n                .defaultAnswer(returnsDeepStubsAnswerUsing(returnTypeGenericMetadata));\n    }\n\n\n    private ReturnsDeepStubs returnsDeepStubsAnswerUsing(final GenericMetadataSupport returnTypeGenericMetadata) {\n        return new ReturnsDeepStubsSerializationFallback(returnTypeGenericMetadata);\n    }\n\n    private Object recordDeepStubAnswer(final Object mock, InvocationContainerImpl container) throws Throwable {\n        container.addAnswer(new DeeplyStubbedAnswer(mock), false);\n        return mock;\n    }\n\n    protected GenericMetadataSupport actualParameterizedType(Object mock) {\n        CreationSettings mockSettings = (CreationSettings) new MockUtil().getMockHandler(mock).getMockSettings();\n        return GenericMetadataSupport.inferFrom(mockSettings.getTypeToMock());\n    }\n\n\n    private static class ReturnsDeepStubsSerializationFallback extends ReturnsDeepStubs implements Serializable {\n        @SuppressWarnings(\"serial\") // not gonna be serialized\n        private final GenericMetadataSupport returnTypeGenericMetadata;\n\n        public ReturnsDeepStubsSerializationFallback(GenericMetadataSupport returnTypeGenericMetadata) {\n            this.returnTypeGenericMetadata = returnTypeGenericMetadata;\n        }\n\n        @Override\n        protected GenericMetadataSupport actualParameterizedType(Object mock) {\n            return returnTypeGenericMetadata;\n        }\n        private Object writeReplace() throws IOException {\n            return Mockito.RETURNS_DEEP_STUBS;\n        }\n    }\n\n\n    private static class DeeplyStubbedAnswer implements Answer<Object>, Serializable {\n        @SuppressWarnings(\"serial\") // serialization will fail with a nice message if mock not serializable\n        private final Object mock;\n\n        DeeplyStubbedAnswer(Object mock) {\n            this.mock = mock;\n        }\n        public Object answer(InvocationOnMock invocation) throws Throwable {\n            return mock;\n        }\n    }\n\n\n    private static MockitoCore mockitoCore() {\n        return LazyHolder.MOCKITO_CORE;\n    }\n\n    private static ReturnsEmptyValues delegate() {\n        return LazyHolder.DELEGATE;\n    }\n\n    private static class LazyHolder {\n        private static final MockitoCore MOCKITO_CORE = new MockitoCore();\n        private static final ReturnsEmptyValues DELEGATE = new ReturnsEmptyValues();\n    }\n}\n", "review": {"response": "{\n  \"bugs\":[\n      {\n         \"id\":1,\n         \"description\":\"Potential NPE in the `actualParameterizedType` method when `mockSettings` is null.\"\n      },\n      {\n         \"id\":2,\n         \"description\":\"The `ReturnsDeepStubsSerializationFallback` class is not serializable because it has a non-serializable field `returnTypeGenericMetadata`. This could lead to issues when serializing instances of this class.\"\n      },\n      {\n         \"id\":3,\n         \"description\":\"The `DeeplyStubbedAnswer` class is not serializable because it has a non-serializable field `mock`. This could lead to issues when serializing instances of this class.\"\n      },\n      {\n         \"id\":4,\n         \"description\":\"The `writeReplace` method in `ReturnsDeepStubsSerializationFallback` class does not handle the case where `returnTypeGenericMetadata` is null.\"\n      },\n      {\n         \"id\":5,\n         \"description\":\"The `newDeepStubMock` method does not handle the case where `returnTypeGenericMetadata` is null.\"\n      },\n      {\n         \"id\":6,\n         \"description\":\"The `withSettingsUsing` method does not handle the case where `returnTypeGenericMetadata` is null.\"\n      },\n      {\n         \"id\":7,\n         \"description\":\"The `returnsDeepStubsAnswerUsing` method does not handle the case where `returnTypeGenericMetadata` is null.\"\n      }\n   ]\n}"}}