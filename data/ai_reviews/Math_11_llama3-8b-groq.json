{"sample_id": "Math_11", "model": "llama3-8b-groq", "code_context": "/*\n * Licensed to the Apache Software Foundation (ASF) under one or more\n * contributor license agreements.  See the NOTICE file distributed with\n * this work for additional information regarding copyright ownership.\n * The ASF licenses this file to You under the Apache License, Version 2.0\n * (the \"License\"); you may not use this file except in compliance with\n * the License.  You may obtain a copy of the License at\n *\n *      http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\npackage org.apache.commons.math3.distribution;\n\nimport org.apache.commons.math3.exception.DimensionMismatchException;\nimport org.apache.commons.math3.linear.Array2DRowRealMatrix;\nimport org.apache.commons.math3.linear.EigenDecomposition;\nimport org.apache.commons.math3.linear.NonPositiveDefiniteMatrixException;\nimport org.apache.commons.math3.linear.RealMatrix;\nimport org.apache.commons.math3.linear.SingularMatrixException;\nimport org.apache.commons.math3.random.RandomGenerator;\nimport org.apache.commons.math3.random.Well19937c;\nimport org.apache.commons.math3.util.FastMath;\nimport org.apache.commons.math3.util.MathArrays;\n\n/**\n * Implementation of the multivariate normal (Gaussian) distribution.\n *\n * @see <a href=\"http://en.wikipedia.org/wiki/Multivariate_normal_distribution\">\n * Multivariate normal distribution (Wikipedia)</a>\n * @see <a href=\"http://mathworld.wolfram.com/MultivariateNormalDistribution.html\">\n * Multivariate normal distribution (MathWorld)</a>\n *\n * @version $Id$\n * @since 3.1\n */\npublic class MultivariateNormalDistribution\n    extends AbstractMultivariateRealDistribution {\n    /** Vector of means. */\n    private final double[] means;\n    /** Covariance matrix. */\n    private final RealMatrix covarianceMatrix;\n    /** The matrix inverse of the covariance matrix. */\n    private final RealMatrix covarianceMatrixInverse;\n    /** The determinant of the covariance matrix. */\n    private final double covarianceMatrixDeterminant;\n    /** Matrix used in computation of samples. */\n    private final RealMatrix samplingMatrix;\n\n    /**\n     * Creates a multivariate normal distribution with the given mean vector and\n     * covariance matrix.\n     * <br/>\n     * The number of dimensions is equal to the length of the mean vector\n     * and to the number of rows and columns of the covariance matrix.\n     * It is frequently written as \"p\" in formulae.\n     *\n     * @param means Vector of means.\n     * @param covariances Covariance matrix.\n     * @throws DimensionMismatchException if the arrays length are\n     * inconsistent.\n     * @throws SingularMatrixException if the eigenvalue decomposition cannot\n     * be performed on the provided covariance matrix.\n     * @throws NonPositiveDefiniteMatrixException if any of the eigenvalues is\n     * negative.\n     */\n    public MultivariateNormalDistribution(final double[] means,\n                                          final double[][] covariances)\n        throws SingularMatrixException,\n               DimensionMismatchException,\n               NonPositiveDefiniteMatrixException {\n        this(new Well19937c(), means, covariances);\n    }\n\n    /**\n     * Creates a multivariate normal distribution with the given mean vector and\n     * covariance matrix.\n     * <br/>\n     * The number of dimensions is equal to the length of the mean vector\n     * and to the number of rows and columns of the covariance matrix.\n     * It is frequently written as \"p\" in formulae.\n     *\n     * @param rng Random Number Generator.\n     * @param means Vector of means.\n     * @param covariances Covariance matrix.\n     * @throws DimensionMismatchException if the arrays length are\n     * inconsistent.\n     * @throws SingularMatrixException if the eigenvalue decomposition cannot\n     * be performed on the provided covariance matrix.\n     * @throws NonPositiveDefiniteMatrixException if any of the eigenvalues is\n     * negative.\n     */\n    public MultivariateNormalDistribution(RandomGenerator rng,\n                                          final double[] means,\n                                          final double[][] covariances)\n            throws SingularMatrixException,\n                   DimensionMismatchException,\n                   NonPositiveDefiniteMatrixException {\n        super(rng, means.length);\n\n        final int dim = means.length;\n\n        if (covariances.length != dim) {\n            throw new DimensionMismatchException(covariances.length, dim);\n        }\n\n        for (int i = 0; i < dim; i++) {\n            if (dim != covariances[i].length) {\n                throw new DimensionMismatchException(covariances[i].length, dim);\n            }\n        }\n\n        this.means = MathArrays.copyOf(means);\n\n        covarianceMatrix = new Array2DRowRealMatrix(covariances);\n\n        // Covariance matrix eigen decomposition.\n        final EigenDecomposition covMatDec = new EigenDecomposition(covarianceMatrix);\n\n        // Compute and store the inverse.\n        covarianceMatrixInverse = covMatDec.getSolver().getInverse();\n        // Compute and store the determinant.\n        covarianceMatrixDeterminant = covMatDec.getDeterminant();\n\n        // Eigenvalues of the covariance matrix.\n        final double[] covMatEigenvalues = covMatDec.getRealEigenvalues();\n\n        for (int i = 0; i < covMatEigenvalues.length; i++) {\n            if (covMatEigenvalues[i] < 0) {\n                throw new NonPositiveDefiniteMatrixException(covMatEigenvalues[i], i, 0);\n            }\n        }\n\n        // Matrix where each column is an eigenvector of the covariance matrix.\n        final Array2DRowRealMatrix covMatEigenvectors = new Array2DRowRealMatrix(dim, dim);\n        for (int v = 0; v < dim; v++) {\n            final double[] evec = covMatDec.getEigenvector(v).toArray();\n            covMatEigenvectors.setColumn(v, evec);\n        }\n\n        final RealMatrix tmpMatrix = covMatEigenvectors.transpose();\n\n        // Scale each eigenvector by the square root of its eigenvalue.\n        for (int row = 0; row < dim; row++) {\n            final double factor = FastMath.sqrt(covMatEigenvalues[row]);\n            for (int col = 0; col < dim; col++) {\n                tmpMatrix.multiplyEntry(row, col, factor);\n            }\n        }\n\n        samplingMatrix = covMatEigenvectors.multiply(tmpMatrix);\n    }\n\n    /**\n     * Gets the mean vector.\n     *\n     * @return the mean vector.\n     */\n    public double[] getMeans() {\n        return MathArrays.copyOf(means);\n    }\n\n    /**\n     * Gets the covariance matrix.\n     *\n     * @return the covariance matrix.\n     */\n    public RealMatrix getCovariances() {\n        return covarianceMatrix.copy();\n    }\n\n    /** {@inheritDoc} */\n    public double density(final double[] vals) throws DimensionMismatchException {\n        final int dim = getDimension();\n        if (vals.length != dim) {\n            throw new DimensionMismatchException(vals.length, dim);\n        }\n\n        return FastMath.pow(2 * FastMath.PI, -dim / 2) *\n            FastMath.pow(covarianceMatrixDeterminant, -0.5) *\n            getExponentTerm(vals);\n    }\n\n    /**\n     * Gets the square root of each element on the diagonal of the covariance\n     * matrix.\n     *\n     * @return the standard deviations.\n     */\n    public double[] getStandardDeviations() {\n        final int dim = getDimension();\n        final double[] std = new double[dim];\n        final double[][] s = covarianceMatrix.getData();\n        for (int i = 0; i < dim; i++) {\n            std[i] = FastMath.sqrt(s[i][i]);\n        }\n        return std;\n    }\n\n    /** {@inheritDoc} */\n    public double[] sample() {\n        final int dim = getDimension();\n        final double[] normalVals = new double[dim];\n\n        for (int i = 0; i < dim; i++) {\n            normalVals[i] = random.nextGaussian();\n        }\n\n        final double[] vals = samplingMatrix.operate(normalVals);\n\n        for (int i = 0; i < dim; i++) {\n            vals[i] += means[i];\n        }\n\n        return vals;\n    }\n\n    /**\n     * Computes the term used in the exponent (see definition of the distribution).\n     *\n     * @param values Values at which to compute density.\n     * @return the multiplication factor of density calculations.\n     */\n    private double getExponentTerm(final double[] values) {\n        final double[] centered = new double[values.length];\n        for (int i = 0; i < centered.length; i++) {\n            centered[i] = values[i] - getMeans()[i];\n        }\n        final double[] preMultiplied = covarianceMatrixInverse.preMultiply(centered);\n        double sum = 0;\n        for (int i = 0; i < preMultiplied.length; i++) {\n            sum += preMultiplied[i] * centered[i];\n        }\n        return FastMath.exp(-0.5 * sum);\n    }\n}\n", "review": {"response": "{\n  \"bugs\":[\n      {\n         \"description\":\"The constructor MultivariateNormalDistribution(double[] means, double[][] covariances) does not use the RandomGenerator parameter.\",\n         \"severity\":\"MEDIUM\"\n      },\n      {\n         \"description\":\"The constructor MultivariateNormalDistribution(RandomGenerator rng, double[] means, double[][] covariances) does not check if the input arrays are null.\",\n         \"severity\":\"LOW\"\n      },\n      {\n         \"description\":\"The EigenDecomposition object is not checked for null before calling its methods.\",\n         \"severity\":\"MEDIUM\"\n      },\n      {\n         \"description\":\"The getSolver() method of the EigenDecomposition object returns a DecompositionSolver object which is not checked for null before calling its getInverse() method.\",\n         \"severity\":\"MEDIUM\"\n      },\n      {\n         \"description\":\"The getRealEigenvalues() method of the EigenDecomposition object returns an array which is not checked for null before iterating over it.\",\n         \"severity\":\"MEDIUM\"\n      }\n   ]\n}"}}