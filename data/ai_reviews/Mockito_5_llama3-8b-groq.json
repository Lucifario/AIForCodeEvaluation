{"sample_id": "Mockito_5", "model": "llama3-8b-groq", "code_context": "/*\n * Copyright (c) 2007 Mockito contributors\n * This program is made available under the terms of the MIT License.\n */\npackage org.mockito.internal.verification;\n\nimport org.mockito.exceptions.base.MockitoAssertionError;\nimport org.mockito.internal.util.Timer;\nimport org.mockito.internal.verification.api.VerificationData;\nimport org.mockito.verification.VerificationMode;\n\n/**\n * Verifies that another verification mode (the delegate) is satisfied within a certain timeframe\n * (before timeoutMillis has passed, measured from the call to verify()), and either returns immediately\n * once it does, or waits until it is definitely satisfied once the full time has passed.\n */\npublic class VerificationOverTimeImpl implements VerificationMode {\n\n    private final long pollingPeriodMillis;\n    private final long durationMillis;\n    private final VerificationMode delegate;\n    private final boolean returnOnSuccess;\n    private final Timer timer;\n\n    /**\n     * Create this verification mode, to be used to verify invocation ongoing data later.\n     *\n     * @param pollingPeriodMillis The frequency to poll delegate.verify(), to check whether the delegate has been satisfied\n     * @param durationMillis The max time to wait (in millis) for the delegate verification mode to be satisfied\n     * @param delegate The verification mode to delegate overall success or failure to\n     * @param returnOnSuccess Whether to immediately return successfully once the delegate is satisfied (as in\n     *                        {@link org.mockito.verification.VerificationWithTimeout}, or to only return once\n     *                        the delegate is satisfied and the full duration has passed (as in\n     *                        {@link org.mockito.verification.VerificationAfterDelay}).\n     */\n    public VerificationOverTimeImpl(long pollingPeriodMillis, long durationMillis, VerificationMode delegate, boolean returnOnSuccess) {\n        this(pollingPeriodMillis, durationMillis, delegate, returnOnSuccess, new Timer(durationMillis));\n    }\n\n    /**\n     * Create this verification mode, to be used to verify invocation ongoing data later.\n     *\n     * @param pollingPeriodMillis The frequency to poll delegate.verify(), to check whether the delegate has been satisfied\n     * @param durationMillis The max time to wait (in millis) for the delegate verification mode to be satisfied\n     * @param delegate The verification mode to delegate overall success or failure to\n     * @param returnOnSuccess Whether to immediately return successfully once the delegate is satisfied (as in\n     *                        {@link org.mockito.verification.VerificationWithTimeout}, or to only return once\n     *                        the delegate is satisfied and the full duration has passed (as in\n     *                        {@link org.mockito.verification.VerificationAfterDelay}).\n     * @param timer Checker of whether the duration of the verification is still acceptable\n     */\n    public VerificationOverTimeImpl(long pollingPeriodMillis, long durationMillis, VerificationMode delegate, boolean returnOnSuccess, Timer timer) {\n        this.pollingPeriodMillis = pollingPeriodMillis;\n        this.durationMillis = durationMillis;\n        this.delegate = delegate;\n        this.returnOnSuccess = returnOnSuccess;\n        this.timer = timer;\n    }\n\n    /**\n     * Verify the given ongoing verification data, and confirm that it satisfies the delegate verification mode\n     * before the full duration has passed.\n     *\n     * In practice, this polls the delegate verification mode until it is satisfied. If it is not satisfied once\n     * the full duration has passed, the last error returned by the delegate verification mode will be thrown\n     * here in turn. This may be thrown early if the delegate is unsatisfied and the verification mode is known\n     * to never recover from this situation (e.g. {@link AtMost}).\n     *\n     * If it is satisfied before the full duration has passed, behaviour is dependent on the returnOnSuccess parameter\n     * given in the constructor. If true, this verification mode is immediately satisfied once the delegate is. If\n     * false, this verification mode is not satisfied until the delegate is satisfied and the full time has passed.\n     *\n     * @throws MockitoAssertionError if the delegate verification mode does not succeed before the timeout\n     */\n    public void verify(VerificationData data) {\n        AssertionError error = null;\n\n        timer.start();\n        while (timer.isCounting()) {\n            try {\n                delegate.verify(data);\n\n                if (returnOnSuccess) {\n                    return;\n                } else {\n                    error = null;\n                }\n            } catch (MockitoAssertionError e) {\n                error = handleVerifyException(e);\n            }\n            catch (org.mockito.exceptions.verification.junit.ArgumentsAreDifferent e) {\n                error = handleVerifyException(e);\n            }\n        }\n\n        if (error != null) {\n            throw error;\n        }\n    }\n\n    private AssertionError handleVerifyException(AssertionError e) {\n        if (canRecoverFromFailure(delegate)) {\n            sleep(pollingPeriodMillis);\n            return e;\n        } else {\n            throw e;\n        }\n    }\n\n    protected boolean canRecoverFromFailure(VerificationMode verificationMode) {\n        return !(verificationMode instanceof AtMost || verificationMode instanceof NoMoreInteractions);\n    }\n\n    private void sleep(long sleep) {\n        try {\n            Thread.sleep(sleep);\n        } catch (InterruptedException ie) {\n            // oups. not much luck.\n        }\n    }\n\n    public long getPollingPeriod() {\n        return pollingPeriodMillis;\n    }\n\n    public long getDuration() {\n        return durationMillis;\n    }\n\n    public VerificationMode getDelegate() {\n        return delegate;\n    }\n\n}\n", "review": {"response": "{\n  \"bugs\": [\n      {\n         \"bug\": \"The constructor `VerificationOverTimeImpl(long pollingPeriodMillis, long durationMillis, VerificationMode delegate, boolean returnOnSuccess)` is not used anywhere in the class, it's a duplicate of the other constructor.\",\n         \"severity\": \"MEDIUM\",\n         \"location\": \"line 33\"\n      },\n      {\n         \"bug\": \"The `Timer` class is not thread-safe, which could lead to issues in a multi-threaded environment.\",\n         \"severity\": \"HIGH\",\n         \"location\": \"line 51\"\n      },\n      {\n         \"bug\": \"The `sleep` method is not thread-safe, it can cause the program to freeze if interrupted.\",\n         \"severity\": \"HIGH\",\n         \"location\": \"line 104\"\n      },\n      {\n         \"bug\": \"The `handleVerifyException` method does not handle all possible exceptions that could be thrown by the delegate verification mode.\",\n         \"severity\": \"MEDIUM\",\n         \"location\": \"line 78\"\n      },\n      {\n         \"bug\": \"The `canRecoverFromFailure` method does not handle null verification modes.\",\n         \"severity\": \"LOW\",\n         \"location\": \"line 92\"\n      }\n   ]\n}"}}