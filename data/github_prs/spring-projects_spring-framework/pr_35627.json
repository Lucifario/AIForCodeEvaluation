{
  "id": 35627,
  "repository": "spring-projects/spring-framework",
  "title": "Consider defaultCandidate for scoped proxies",
  "body": "PR for https://github.com/spring-projects/spring-framework/issues/35626",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-14T17:07:04+00:00",
  "created_at": "2025-10-13T20:52:06+00:00",
  "updated_at": "2025-10-14T17:07:04+00:00",
  "author": "hosea",
  "reviewers": [
    "hosea"
  ],
  "base_sha": "3a61460f91a31ee75891a28fbbc1fc9261ab4e40",
  "head_sha": "c1b1b2fec8d9bc20b128b5df96646e51ec28f39b",
  "review_comments": [
    {
      "user": "hosea",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-13T20:55:46+00:00"
    },
    {
      "user": "hosea",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-13T20:58:01+00:00"
    },
    {
      "user": "hosea",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-13T20:59:28+00:00"
    }
  ],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "spring-aop/src/main/java/org/springframework/aop/scope/ScopedProxyUtils.java",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "patch": "@@ -83,11 +83,15 @@ public static BeanDefinitionHolder createScopedProxy(BeanDefinitionHolder defini\n \t\tproxyDefinition.setPrimary(targetDefinition.isPrimary());\n \t\tif (targetDefinition instanceof AbstractBeanDefinition abd) {\n \t\t\tproxyDefinition.copyQualifiersFrom(abd);\n+\t\t\tproxyDefinition.setDefaultCandidate(abd.isDefaultCandidate());\n \t\t}\n \n \t\t// The target bean should be ignored in favor of the scoped proxy.\n \t\ttargetDefinition.setAutowireCandidate(false);\n \t\ttargetDefinition.setPrimary(false);\n+\t\tif (targetDefinition instanceof AbstractBeanDefinition abd) {\n+\t\t\tabd.setDefaultCandidate(false);\n+\t\t}\n \n \t\t// Register the target bean as separate bean in the factory.\n \t\tregistry.registerBeanDefinition(targetBeanName, targetDefinition);"
    },
    {
      "filename": "spring-aop/src/test/java/org/springframework/aop/scope/ScopedProxyUtilsTests.java",
      "status": "modified",
      "additions": 73,
      "deletions": 0,
      "changes": 73,
      "patch": "@@ -18,9 +18,19 @@\n \n import org.junit.jupiter.api.Test;\n \n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.beans.factory.config.BeanDefinitionHolder;\n+import org.springframework.beans.factory.support.AbstractBeanDefinition;\n+import org.springframework.beans.factory.support.AutowireCandidateQualifier;\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry;\n+import org.springframework.beans.factory.support.GenericBeanDefinition;\n+import org.springframework.beans.factory.support.RootBeanDefinition;\n+import org.springframework.beans.factory.support.SimpleBeanDefinitionRegistry;\n+\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n \n+\n /**\n  * Tests for {@link ScopedProxyUtils}.\n  *\n@@ -64,4 +74,67 @@ void getOriginalBeanNameForNonScopedTarget() {\n \t\t\t.withMessage(\"bean name 'myBean' does not refer to the target of a scoped proxy\");\n \t}\n \n+\t@Test\n+\tvoid createScopedProxyTargetOvertakesAutowireSettingsToProxyBeanDefinition() {\n+\t\tfinal AbstractBeanDefinition targetDefinition = new GenericBeanDefinition();\n+\t\t// Opposite of defaults\n+\t\ttargetDefinition.setAutowireCandidate(false);\n+\t\ttargetDefinition.setDefaultCandidate(false);\n+\t\ttargetDefinition.setPrimary(true);\n+\n+\t\tfinal BeanDefinitionRegistry registry = new SimpleBeanDefinitionRegistry();\n+\t\tfinal BeanDefinitionHolder proxyHolder = ScopedProxyUtils.createScopedProxy(new BeanDefinitionHolder(targetDefinition, \"myBean\"), registry, false);\n+\t\tassertThat(proxyHolder).isNotNull();\n+\t\tfinal BeanDefinition proxyBeanDefinition = proxyHolder.getBeanDefinition();\n+\t\tassertThat(proxyBeanDefinition).isNotNull();\n+\t\tassertThat(proxyBeanDefinition).isInstanceOf(RootBeanDefinition.class);\n+\n+\t\tassertThat(proxyBeanDefinition.isAutowireCandidate()).isFalse();\n+\t\tassertThat(proxyBeanDefinition.isPrimary()).isTrue();\n+\t\tassertThat(((RootBeanDefinition)proxyBeanDefinition).isDefaultCandidate()).isFalse();\n+\t}\n+\n+\t@Test\n+\tvoid createScopedProxyTargetOvertakesBeanAttributesToProxyBeanDefinition() {\n+\t\tfinal GenericBeanDefinition targetDefinition = new GenericBeanDefinition();\n+\t\t// Opposite of defaults\n+\t\ttargetDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n+\t\ttargetDefinition.setSource(\"theSource\");\n+\t\ttargetDefinition.addQualifier(new AutowireCandidateQualifier(\"myQualifier\"));\n+\n+\t\tfinal BeanDefinitionRegistry registry = new SimpleBeanDefinitionRegistry();\n+\t\tfinal BeanDefinitionHolder proxyHolder = ScopedProxyUtils.createScopedProxy(new BeanDefinitionHolder(targetDefinition, \"myBean\"), registry, false);\n+\t\tassertThat(proxyHolder).isNotNull();\n+\t\tfinal BeanDefinition proxyBeanDefinition = proxyHolder.getBeanDefinition();\n+\t\tassertThat(proxyBeanDefinition).isNotNull();\n+\n+\t\tassertThat(proxyBeanDefinition.getRole()).isEqualTo(BeanDefinition.ROLE_INFRASTRUCTURE);\n+\t\tassertThat(proxyBeanDefinition).isInstanceOf(RootBeanDefinition.class);\n+\t\tassertThat(proxyBeanDefinition.getPropertyValues()).hasSize(2);\n+\t\tassertThat(proxyBeanDefinition.getPropertyValues().get(\"proxyTargetClass\")).isEqualTo(false);\n+\t\tassertThat(proxyBeanDefinition.getPropertyValues().get(\"targetBeanName\")).isEqualTo(ScopedProxyUtils.getTargetBeanName(\"myBean\"));\n+\n+\t\tfinal RootBeanDefinition rootBeanDefinition = (RootBeanDefinition) proxyBeanDefinition;\n+\t\tassertThat(rootBeanDefinition.getQualifiers()).hasSize(1);\n+\t\tassertThat(rootBeanDefinition.hasQualifier(\"myQualifier\")).isTrue();\n+\t\tassertThat(rootBeanDefinition.getSource()).isEqualTo(\"theSource\");\n+\t}\n+\n+\t@Test\n+\tvoid createScopedProxyTargetCleansAutowireSettingsInTargetDefinition() {\n+\t\tfinal AbstractBeanDefinition targetDefinition = new GenericBeanDefinition();\n+\t\ttargetDefinition.setAutowireCandidate(true);\n+\t\ttargetDefinition.setDefaultCandidate(true);\n+\t\ttargetDefinition.setPrimary(true);\n+\n+\t\tfinal BeanDefinitionRegistry registry = new SimpleBeanDefinitionRegistry();\n+\t\tfinal BeanDefinitionHolder proxyHolder = ScopedProxyUtils.createScopedProxy(new BeanDefinitionHolder(targetDefinition, \"myBean\"), registry, false);\n+\t\tassertThat(proxyHolder).isNotNull();\n+\t\tfinal BeanDefinition proxyBeanDefinition = proxyHolder.getBeanDefinition();\n+\t\tassertThat(proxyBeanDefinition).isNotNull();\n+\n+\t\tassertThat(targetDefinition.isAutowireCandidate()).isFalse();\n+\t\tassertThat(targetDefinition.isDefaultCandidate()).isFalse();\n+\t\tassertThat(targetDefinition.isPrimary()).isFalse();\n+\t}\n }"
    }
  ],
  "diff": "diff --git a/spring-aop/src/main/java/org/springframework/aop/scope/ScopedProxyUtils.java b/spring-aop/src/main/java/org/springframework/aop/scope/ScopedProxyUtils.java\nindex f6715a15d15d..004012b0123d 100644\n--- a/spring-aop/src/main/java/org/springframework/aop/scope/ScopedProxyUtils.java\n+++ b/spring-aop/src/main/java/org/springframework/aop/scope/ScopedProxyUtils.java\n@@ -83,11 +83,15 @@ public static BeanDefinitionHolder createScopedProxy(BeanDefinitionHolder defini\n \t\tproxyDefinition.setPrimary(targetDefinition.isPrimary());\n \t\tif (targetDefinition instanceof AbstractBeanDefinition abd) {\n \t\t\tproxyDefinition.copyQualifiersFrom(abd);\n+\t\t\tproxyDefinition.setDefaultCandidate(abd.isDefaultCandidate());\n \t\t}\n \n \t\t// The target bean should be ignored in favor of the scoped proxy.\n \t\ttargetDefinition.setAutowireCandidate(false);\n \t\ttargetDefinition.setPrimary(false);\n+\t\tif (targetDefinition instanceof AbstractBeanDefinition abd) {\n+\t\t\tabd.setDefaultCandidate(false);\n+\t\t}\n \n \t\t// Register the target bean as separate bean in the factory.\n \t\tregistry.registerBeanDefinition(targetBeanName, targetDefinition);\ndiff --git a/spring-aop/src/test/java/org/springframework/aop/scope/ScopedProxyUtilsTests.java b/spring-aop/src/test/java/org/springframework/aop/scope/ScopedProxyUtilsTests.java\nindex ff3299cd4a50..164e6c85216b 100644\n--- a/spring-aop/src/test/java/org/springframework/aop/scope/ScopedProxyUtilsTests.java\n+++ b/spring-aop/src/test/java/org/springframework/aop/scope/ScopedProxyUtilsTests.java\n@@ -18,9 +18,19 @@\n \n import org.junit.jupiter.api.Test;\n \n+import org.springframework.beans.factory.config.BeanDefinition;\n+import org.springframework.beans.factory.config.BeanDefinitionHolder;\n+import org.springframework.beans.factory.support.AbstractBeanDefinition;\n+import org.springframework.beans.factory.support.AutowireCandidateQualifier;\n+import org.springframework.beans.factory.support.BeanDefinitionRegistry;\n+import org.springframework.beans.factory.support.GenericBeanDefinition;\n+import org.springframework.beans.factory.support.RootBeanDefinition;\n+import org.springframework.beans.factory.support.SimpleBeanDefinitionRegistry;\n+\n import static org.assertj.core.api.Assertions.assertThat;\n import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n \n+\n /**\n  * Tests for {@link ScopedProxyUtils}.\n  *\n@@ -64,4 +74,67 @@ void getOriginalBeanNameForNonScopedTarget() {\n \t\t\t.withMessage(\"bean name 'myBean' does not refer to the target of a scoped proxy\");\n \t}\n \n+\t@Test\n+\tvoid createScopedProxyTargetOvertakesAutowireSettingsToProxyBeanDefinition() {\n+\t\tfinal AbstractBeanDefinition targetDefinition = new GenericBeanDefinition();\n+\t\t// Opposite of defaults\n+\t\ttargetDefinition.setAutowireCandidate(false);\n+\t\ttargetDefinition.setDefaultCandidate(false);\n+\t\ttargetDefinition.setPrimary(true);\n+\n+\t\tfinal BeanDefinitionRegistry registry = new SimpleBeanDefinitionRegistry();\n+\t\tfinal BeanDefinitionHolder proxyHolder = ScopedProxyUtils.createScopedProxy(new BeanDefinitionHolder(targetDefinition, \"myBean\"), registry, false);\n+\t\tassertThat(proxyHolder).isNotNull();\n+\t\tfinal BeanDefinition proxyBeanDefinition = proxyHolder.getBeanDefinition();\n+\t\tassertThat(proxyBeanDefinition).isNotNull();\n+\t\tassertThat(proxyBeanDefinition).isInstanceOf(RootBeanDefinition.class);\n+\n+\t\tassertThat(proxyBeanDefinition.isAutowireCandidate()).isFalse();\n+\t\tassertThat(proxyBeanDefinition.isPrimary()).isTrue();\n+\t\tassertThat(((RootBeanDefinition)proxyBeanDefinition).isDefaultCandidate()).isFalse();\n+\t}\n+\n+\t@Test\n+\tvoid createScopedProxyTargetOvertakesBeanAttributesToProxyBeanDefinition() {\n+\t\tfinal GenericBeanDefinition targetDefinition = new GenericBeanDefinition();\n+\t\t// Opposite of defaults\n+\t\ttargetDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);\n+\t\ttargetDefinition.setSource(\"theSource\");\n+\t\ttargetDefinition.addQualifier(new AutowireCandidateQualifier(\"myQualifier\"));\n+\n+\t\tfinal BeanDefinitionRegistry registry = new SimpleBeanDefinitionRegistry();\n+\t\tfinal BeanDefinitionHolder proxyHolder = ScopedProxyUtils.createScopedProxy(new BeanDefinitionHolder(targetDefinition, \"myBean\"), registry, false);\n+\t\tassertThat(proxyHolder).isNotNull();\n+\t\tfinal BeanDefinition proxyBeanDefinition = proxyHolder.getBeanDefinition();\n+\t\tassertThat(proxyBeanDefinition).isNotNull();\n+\n+\t\tassertThat(proxyBeanDefinition.getRole()).isEqualTo(BeanDefinition.ROLE_INFRASTRUCTURE);\n+\t\tassertThat(proxyBeanDefinition).isInstanceOf(RootBeanDefinition.class);\n+\t\tassertThat(proxyBeanDefinition.getPropertyValues()).hasSize(2);\n+\t\tassertThat(proxyBeanDefinition.getPropertyValues().get(\"proxyTargetClass\")).isEqualTo(false);\n+\t\tassertThat(proxyBeanDefinition.getPropertyValues().get(\"targetBeanName\")).isEqualTo(ScopedProxyUtils.getTargetBeanName(\"myBean\"));\n+\n+\t\tfinal RootBeanDefinition rootBeanDefinition = (RootBeanDefinition) proxyBeanDefinition;\n+\t\tassertThat(rootBeanDefinition.getQualifiers()).hasSize(1);\n+\t\tassertThat(rootBeanDefinition.hasQualifier(\"myQualifier\")).isTrue();\n+\t\tassertThat(rootBeanDefinition.getSource()).isEqualTo(\"theSource\");\n+\t}\n+\n+\t@Test\n+\tvoid createScopedProxyTargetCleansAutowireSettingsInTargetDefinition() {\n+\t\tfinal AbstractBeanDefinition targetDefinition = new GenericBeanDefinition();\n+\t\ttargetDefinition.setAutowireCandidate(true);\n+\t\ttargetDefinition.setDefaultCandidate(true);\n+\t\ttargetDefinition.setPrimary(true);\n+\n+\t\tfinal BeanDefinitionRegistry registry = new SimpleBeanDefinitionRegistry();\n+\t\tfinal BeanDefinitionHolder proxyHolder = ScopedProxyUtils.createScopedProxy(new BeanDefinitionHolder(targetDefinition, \"myBean\"), registry, false);\n+\t\tassertThat(proxyHolder).isNotNull();\n+\t\tfinal BeanDefinition proxyBeanDefinition = proxyHolder.getBeanDefinition();\n+\t\tassertThat(proxyBeanDefinition).isNotNull();\n+\n+\t\tassertThat(targetDefinition.isAutowireCandidate()).isFalse();\n+\t\tassertThat(targetDefinition.isDefaultCandidate()).isFalse();\n+\t\tassertThat(targetDefinition.isPrimary()).isFalse();\n+\t}\n }\n",
  "additions": 77,
  "deletions": 0,
  "changed_files": 2,
  "url": "https://github.com/spring-projects/spring-framework/pull/35627",
  "mined_at": "2025-10-25T13:07:57.285935"
}