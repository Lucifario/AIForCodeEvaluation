{
  "id": 35543,
  "repository": "spring-projects/spring-framework",
  "title": "Remove redundant object allocation in cglib proxy method calls",
  "body": "Fixes gh-35542\r\n\r\nI've noticed ~1.2TB of memory allocations of `java.lang.Boolean` in 10 minute long JMC dump.\r\nThis seemed a lot to me so I have fixed it. After the patch, the bytecode of generated cglib proxies now display a more memory saving `valueOf()` calls to box primitives (especially the Boolean)",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-02T19:22:19+00:00",
  "created_at": "2025-09-25T11:19:46+00:00",
  "updated_at": "2025-10-02T19:59:02+00:00",
  "author": "Entea",
  "reviewers": [],
  "base_sha": "ba0de1edce63630173784b2b2b2d60489f8c2d3c",
  "head_sha": "96d8109b780a97a3c8780003d25b5a8a1f9ce90f",
  "review_comments": [],
  "pr_comments": [
    {
      "user": "github-actions[bot]",
      "body": "Fixed via 2da821389c98423e9c705c2751990e4232bffb10",
      "created_at": "2025-10-02T19:59:02+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "spring-core/src/main/java/org/springframework/cglib/core/CodeEmitter.java",
      "status": "modified",
      "additions": 61,
      "deletions": 18,
      "changes": 79,
      "patch": "@@ -29,6 +29,22 @@\n public class CodeEmitter extends LocalVariablesSorter {\n     private static final Signature BOOLEAN_VALUE =\n       TypeUtils.parseSignature(\"boolean booleanValue()\");\n+    private static final Signature BOOLEAN_VALUE_OF =\n+      TypeUtils.parseSignature(\"Boolean valueOf(boolean)\");\n+    private static final Signature INTEGER_VALUE_OF =\n+      TypeUtils.parseSignature(\"Integer valueOf(int)\");\n+    private static final Signature BYTE_VALUE_OF =\n+      TypeUtils.parseSignature(\"Byte valueOf(byte)\");\n+    private static final Signature SHORT_VALUE_OF =\n+      TypeUtils.parseSignature(\"Short valueOf(short)\");\n+    private static final Signature LONG_VALUE_OF =\n+      TypeUtils.parseSignature(\"Long valueOf(long)\");\n+    private static final Signature FLOAT_VALUE_OF =\n+      TypeUtils.parseSignature(\"Float valueOf(float)\");\n+    private static final Signature DOUBLE_VALUE_OF =\n+      TypeUtils.parseSignature(\"Double valueOf(double)\");\n+    private static final Signature CHARACTER_VALUE_OF =\n+      TypeUtils.parseSignature(\"Character valueOf(char)\");\n     private static final Signature CHAR_VALUE =\n       TypeUtils.parseSignature(\"char charValue()\");\n     private static final Signature LONG_VALUE =\n@@ -705,29 +721,56 @@ public void throw_exception(Type type, String msg) {\n \n     /**\n      * If the argument is a primitive class, replaces the primitive value\n-     * on the top of the stack with the wrapped (Object) equivalent. For\n-     * example, char -> Character.\n+     * on the top of the stack with the wrapped (Object) equivalent using valueOf() methods.\n+\t * For example, char -> Character.\n      * If the class is Void, a null is pushed onto the stack instead.\n      * @param type the class indicating the current type of the top stack value\n      */\n     public void box(Type type) {\n         if (TypeUtils.isPrimitive(type)) {\n-            if (type == Type.VOID_TYPE) {\n-                aconst_null();\n-            } else {\n-                Type boxed = TypeUtils.getBoxedType(type);\n-                new_instance(boxed);\n-                if (type.getSize() == 2) {\n-                    // Pp -> Ppo -> oPpo -> ooPpo -> ooPp -> o\n-                    dup_x2();\n-                    dup_x2();\n-                    pop();\n-                } else {\n-                    // p -> po -> opo -> oop -> o\n-                    dup_x1();\n-                    swap();\n-                }\n-                invoke_constructor(boxed, new Signature(Constants.CONSTRUCTOR_NAME, Type.VOID_TYPE, new Type[]{ type }));\n+\t\t\tswitch (type.getSort()) {\n+\t\t\t\tcase Type.VOID:\n+\t\t\t\t\taconst_null();\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.BOOLEAN:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_BOOLEAN, BOOLEAN_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.INT:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_INTEGER, INTEGER_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.BYTE:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_BYTE, BYTE_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.SHORT:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_SHORT, SHORT_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.LONG:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_LONG, LONG_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.FLOAT:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_FLOAT, FLOAT_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.DOUBLE:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_DOUBLE, DOUBLE_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.CHAR:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_CHARACTER, CHARACTER_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\n+\t\t\t\tdefault:\n+\t\t\t\t\tType boxed = TypeUtils.getBoxedType(type);\n+\t\t\t\t\tnew_instance(boxed);\n+\t\t\t\t\tif (type.getSize() == 2) {\n+\t\t\t\t\t\t// Pp -> Ppo -> oPpo -> ooPpo -> ooPp -> o\n+\t\t\t\t\t\tdup_x2();\n+\t\t\t\t\t\tdup_x2();\n+\t\t\t\t\t\tpop();\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\t// p -> po -> opo -> oop -> o\n+\t\t\t\t\t\tdup_x1();\n+\t\t\t\t\t\tswap();\n+\t\t\t\t\t}\n+\t\t\t\t\tinvoke_constructor(boxed, new Signature(Constants.CONSTRUCTOR_NAME, Type.VOID_TYPE, new Type[]{ type }));\n             }\n         }\n     }"
    }
  ],
  "diff": "diff --git a/spring-core/src/main/java/org/springframework/cglib/core/CodeEmitter.java b/spring-core/src/main/java/org/springframework/cglib/core/CodeEmitter.java\nindex 35181c5d8940..6fa920a0d032 100644\n--- a/spring-core/src/main/java/org/springframework/cglib/core/CodeEmitter.java\n+++ b/spring-core/src/main/java/org/springframework/cglib/core/CodeEmitter.java\n@@ -29,6 +29,22 @@\n public class CodeEmitter extends LocalVariablesSorter {\n     private static final Signature BOOLEAN_VALUE =\n       TypeUtils.parseSignature(\"boolean booleanValue()\");\n+    private static final Signature BOOLEAN_VALUE_OF =\n+      TypeUtils.parseSignature(\"Boolean valueOf(boolean)\");\n+    private static final Signature INTEGER_VALUE_OF =\n+      TypeUtils.parseSignature(\"Integer valueOf(int)\");\n+    private static final Signature BYTE_VALUE_OF =\n+      TypeUtils.parseSignature(\"Byte valueOf(byte)\");\n+    private static final Signature SHORT_VALUE_OF =\n+      TypeUtils.parseSignature(\"Short valueOf(short)\");\n+    private static final Signature LONG_VALUE_OF =\n+      TypeUtils.parseSignature(\"Long valueOf(long)\");\n+    private static final Signature FLOAT_VALUE_OF =\n+      TypeUtils.parseSignature(\"Float valueOf(float)\");\n+    private static final Signature DOUBLE_VALUE_OF =\n+      TypeUtils.parseSignature(\"Double valueOf(double)\");\n+    private static final Signature CHARACTER_VALUE_OF =\n+      TypeUtils.parseSignature(\"Character valueOf(char)\");\n     private static final Signature CHAR_VALUE =\n       TypeUtils.parseSignature(\"char charValue()\");\n     private static final Signature LONG_VALUE =\n@@ -705,29 +721,56 @@ public void throw_exception(Type type, String msg) {\n \n     /**\n      * If the argument is a primitive class, replaces the primitive value\n-     * on the top of the stack with the wrapped (Object) equivalent. For\n-     * example, char -> Character.\n+     * on the top of the stack with the wrapped (Object) equivalent using valueOf() methods.\n+\t * For example, char -> Character.\n      * If the class is Void, a null is pushed onto the stack instead.\n      * @param type the class indicating the current type of the top stack value\n      */\n     public void box(Type type) {\n         if (TypeUtils.isPrimitive(type)) {\n-            if (type == Type.VOID_TYPE) {\n-                aconst_null();\n-            } else {\n-                Type boxed = TypeUtils.getBoxedType(type);\n-                new_instance(boxed);\n-                if (type.getSize() == 2) {\n-                    // Pp -> Ppo -> oPpo -> ooPpo -> ooPp -> o\n-                    dup_x2();\n-                    dup_x2();\n-                    pop();\n-                } else {\n-                    // p -> po -> opo -> oop -> o\n-                    dup_x1();\n-                    swap();\n-                }\n-                invoke_constructor(boxed, new Signature(Constants.CONSTRUCTOR_NAME, Type.VOID_TYPE, new Type[]{ type }));\n+\t\t\tswitch (type.getSort()) {\n+\t\t\t\tcase Type.VOID:\n+\t\t\t\t\taconst_null();\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.BOOLEAN:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_BOOLEAN, BOOLEAN_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.INT:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_INTEGER, INTEGER_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.BYTE:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_BYTE, BYTE_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.SHORT:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_SHORT, SHORT_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.LONG:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_LONG, LONG_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.FLOAT:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_FLOAT, FLOAT_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.DOUBLE:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_DOUBLE, DOUBLE_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase Type.CHAR:\n+\t\t\t\t\tinvoke_static(Constants.TYPE_CHARACTER, CHARACTER_VALUE_OF);\n+\t\t\t\t\tbreak;\n+\n+\t\t\t\tdefault:\n+\t\t\t\t\tType boxed = TypeUtils.getBoxedType(type);\n+\t\t\t\t\tnew_instance(boxed);\n+\t\t\t\t\tif (type.getSize() == 2) {\n+\t\t\t\t\t\t// Pp -> Ppo -> oPpo -> ooPpo -> ooPp -> o\n+\t\t\t\t\t\tdup_x2();\n+\t\t\t\t\t\tdup_x2();\n+\t\t\t\t\t\tpop();\n+\t\t\t\t\t} else {\n+\t\t\t\t\t\t// p -> po -> opo -> oop -> o\n+\t\t\t\t\t\tdup_x1();\n+\t\t\t\t\t\tswap();\n+\t\t\t\t\t}\n+\t\t\t\t\tinvoke_constructor(boxed, new Signature(Constants.CONSTRUCTOR_NAME, Type.VOID_TYPE, new Type[]{ type }));\n             }\n         }\n     }\n",
  "additions": 61,
  "deletions": 18,
  "changed_files": 1,
  "url": "https://github.com/spring-projects/spring-framework/pull/35543",
  "mined_at": "2025-10-25T13:08:34.763450"
}