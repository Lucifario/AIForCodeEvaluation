{
  "id": 7992,
  "repository": "google/guava",
  "title": "Add a unit test for `Iterators.mergeSorted()`.",
  "body": "Add a unit test for `Iterators.mergeSorted()`.\n\nRELNOTES=n/a\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-09-15T13:10:32+00:00",
  "created_at": "2025-09-15T12:47:40+00:00",
  "updated_at": "2025-09-15T13:10:32+00:00",
  "author": "copybara-service[bot]",
  "reviewers": [],
  "base_sha": "087f2c4a8012fb1256f80f6f776df0e8706af683",
  "head_sha": "288aeaea0942d898a111cd09fb822ca3f7fd548e",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "android/guava-tests/test/com/google/common/collect/IteratorsTest.java",
      "status": "modified",
      "additions": 72,
      "deletions": 0,
      "changes": 72,
      "patch": "@@ -61,13 +61,15 @@\n import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.ConcurrentModificationException;\n import java.util.Enumeration;\n import java.util.Iterator;\n import java.util.LinkedHashSet;\n import java.util.List;\n import java.util.ListIterator;\n import java.util.NoSuchElementException;\n+import java.util.Objects;\n import java.util.RandomAccess;\n import java.util.Set;\n import java.util.Vector;\n@@ -1546,4 +1548,74 @@ public void testPeekingIteratorShortCircuit() {\n     assertSame(peek, Iterators.peekingIterator(peek));\n     assertSame(peek, Iterators.peekingIterator((Iterator<String>) peek));\n   }\n+\n+  public void testMergeSorted_stable_issue5773Example() {\n+    ImmutableList<TestDatum> left = ImmutableList.of(new TestDatum(\"B\", 1), new TestDatum(\"C\", 1));\n+    ImmutableList<TestDatum> right = ImmutableList.of(new TestDatum(\"A\", 2), new TestDatum(\"C\", 2));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+\n+    // When elements compare as equal (both C's have same letter), our merge should always return C1\n+    // before C2, since C1 is from the first iterator.\n+\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(left.iterator(), right.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"B\", 1),\n+            new TestDatum(\"C\", 1),\n+            new TestDatum(\"C\", 2));\n+  }\n+\n+  public void testMergeSorted_stable_allEqual() {\n+    ImmutableList<TestDatum> first = ImmutableList.of(new TestDatum(\"A\", 1), new TestDatum(\"A\", 2));\n+    ImmutableList<TestDatum> second =\n+        ImmutableList.of(new TestDatum(\"A\", 3), new TestDatum(\"A\", 4));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(first.iterator(), second.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 1),\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"A\", 3),\n+            new TestDatum(\"A\", 4));\n+  }\n+\n+  private static final class TestDatum {\n+    final String letter;\n+    final int number;\n+\n+    TestDatum(String letter, int number) {\n+      this.letter = letter;\n+      this.number = number;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return letter + number;\n+    }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {\n+      if (!(o instanceof TestDatum)) {\n+        return false;\n+      }\n+      TestDatum other = (TestDatum) o;\n+      return letter.equals(other.letter) && number == other.number;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(letter, number);\n+    }\n+  }\n }"
    },
    {
      "filename": "guava-tests/test/com/google/common/collect/IteratorsTest.java",
      "status": "modified",
      "additions": 72,
      "deletions": 0,
      "changes": 72,
      "patch": "@@ -61,13 +61,15 @@\n import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.ConcurrentModificationException;\n import java.util.Enumeration;\n import java.util.Iterator;\n import java.util.LinkedHashSet;\n import java.util.List;\n import java.util.ListIterator;\n import java.util.NoSuchElementException;\n+import java.util.Objects;\n import java.util.RandomAccess;\n import java.util.Set;\n import java.util.Vector;\n@@ -1546,4 +1548,74 @@ public void testPeekingIteratorShortCircuit() {\n     assertSame(peek, Iterators.peekingIterator(peek));\n     assertSame(peek, Iterators.peekingIterator((Iterator<String>) peek));\n   }\n+\n+  public void testMergeSorted_stable_issue5773Example() {\n+    ImmutableList<TestDatum> left = ImmutableList.of(new TestDatum(\"B\", 1), new TestDatum(\"C\", 1));\n+    ImmutableList<TestDatum> right = ImmutableList.of(new TestDatum(\"A\", 2), new TestDatum(\"C\", 2));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+\n+    // When elements compare as equal (both C's have same letter), our merge should always return C1\n+    // before C2, since C1 is from the first iterator.\n+\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(left.iterator(), right.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"B\", 1),\n+            new TestDatum(\"C\", 1),\n+            new TestDatum(\"C\", 2));\n+  }\n+\n+  public void testMergeSorted_stable_allEqual() {\n+    ImmutableList<TestDatum> first = ImmutableList.of(new TestDatum(\"A\", 1), new TestDatum(\"A\", 2));\n+    ImmutableList<TestDatum> second =\n+        ImmutableList.of(new TestDatum(\"A\", 3), new TestDatum(\"A\", 4));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(first.iterator(), second.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 1),\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"A\", 3),\n+            new TestDatum(\"A\", 4));\n+  }\n+\n+  private static final class TestDatum {\n+    final String letter;\n+    final int number;\n+\n+    TestDatum(String letter, int number) {\n+      this.letter = letter;\n+      this.number = number;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return letter + number;\n+    }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {\n+      if (!(o instanceof TestDatum)) {\n+        return false;\n+      }\n+      TestDatum other = (TestDatum) o;\n+      return letter.equals(other.letter) && number == other.number;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(letter, number);\n+    }\n+  }\n }"
    }
  ],
  "diff": "diff --git a/android/guava-tests/test/com/google/common/collect/IteratorsTest.java b/android/guava-tests/test/com/google/common/collect/IteratorsTest.java\nindex b1d09dbbe296..bb7fbb44fde4 100644\n--- a/android/guava-tests/test/com/google/common/collect/IteratorsTest.java\n+++ b/android/guava-tests/test/com/google/common/collect/IteratorsTest.java\n@@ -61,6 +61,7 @@\n import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.ConcurrentModificationException;\n import java.util.Enumeration;\n import java.util.Iterator;\n@@ -68,6 +69,7 @@\n import java.util.List;\n import java.util.ListIterator;\n import java.util.NoSuchElementException;\n+import java.util.Objects;\n import java.util.RandomAccess;\n import java.util.Set;\n import java.util.Vector;\n@@ -1546,4 +1548,74 @@ public void testPeekingIteratorShortCircuit() {\n     assertSame(peek, Iterators.peekingIterator(peek));\n     assertSame(peek, Iterators.peekingIterator((Iterator<String>) peek));\n   }\n+\n+  public void testMergeSorted_stable_issue5773Example() {\n+    ImmutableList<TestDatum> left = ImmutableList.of(new TestDatum(\"B\", 1), new TestDatum(\"C\", 1));\n+    ImmutableList<TestDatum> right = ImmutableList.of(new TestDatum(\"A\", 2), new TestDatum(\"C\", 2));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+\n+    // When elements compare as equal (both C's have same letter), our merge should always return C1\n+    // before C2, since C1 is from the first iterator.\n+\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(left.iterator(), right.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"B\", 1),\n+            new TestDatum(\"C\", 1),\n+            new TestDatum(\"C\", 2));\n+  }\n+\n+  public void testMergeSorted_stable_allEqual() {\n+    ImmutableList<TestDatum> first = ImmutableList.of(new TestDatum(\"A\", 1), new TestDatum(\"A\", 2));\n+    ImmutableList<TestDatum> second =\n+        ImmutableList.of(new TestDatum(\"A\", 3), new TestDatum(\"A\", 4));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(first.iterator(), second.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 1),\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"A\", 3),\n+            new TestDatum(\"A\", 4));\n+  }\n+\n+  private static final class TestDatum {\n+    final String letter;\n+    final int number;\n+\n+    TestDatum(String letter, int number) {\n+      this.letter = letter;\n+      this.number = number;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return letter + number;\n+    }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {\n+      if (!(o instanceof TestDatum)) {\n+        return false;\n+      }\n+      TestDatum other = (TestDatum) o;\n+      return letter.equals(other.letter) && number == other.number;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(letter, number);\n+    }\n+  }\n }\ndiff --git a/guava-tests/test/com/google/common/collect/IteratorsTest.java b/guava-tests/test/com/google/common/collect/IteratorsTest.java\nindex b1d09dbbe296..bb7fbb44fde4 100644\n--- a/guava-tests/test/com/google/common/collect/IteratorsTest.java\n+++ b/guava-tests/test/com/google/common/collect/IteratorsTest.java\n@@ -61,6 +61,7 @@\n import java.util.Arrays;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.Comparator;\n import java.util.ConcurrentModificationException;\n import java.util.Enumeration;\n import java.util.Iterator;\n@@ -68,6 +69,7 @@\n import java.util.List;\n import java.util.ListIterator;\n import java.util.NoSuchElementException;\n+import java.util.Objects;\n import java.util.RandomAccess;\n import java.util.Set;\n import java.util.Vector;\n@@ -1546,4 +1548,74 @@ public void testPeekingIteratorShortCircuit() {\n     assertSame(peek, Iterators.peekingIterator(peek));\n     assertSame(peek, Iterators.peekingIterator((Iterator<String>) peek));\n   }\n+\n+  public void testMergeSorted_stable_issue5773Example() {\n+    ImmutableList<TestDatum> left = ImmutableList.of(new TestDatum(\"B\", 1), new TestDatum(\"C\", 1));\n+    ImmutableList<TestDatum> right = ImmutableList.of(new TestDatum(\"A\", 2), new TestDatum(\"C\", 2));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+\n+    // When elements compare as equal (both C's have same letter), our merge should always return C1\n+    // before C2, since C1 is from the first iterator.\n+\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(left.iterator(), right.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"B\", 1),\n+            new TestDatum(\"C\", 1),\n+            new TestDatum(\"C\", 2));\n+  }\n+\n+  public void testMergeSorted_stable_allEqual() {\n+    ImmutableList<TestDatum> first = ImmutableList.of(new TestDatum(\"A\", 1), new TestDatum(\"A\", 2));\n+    ImmutableList<TestDatum> second =\n+        ImmutableList.of(new TestDatum(\"A\", 3), new TestDatum(\"A\", 4));\n+\n+    Comparator<TestDatum> comparator = Comparator.comparing(d -> d.letter);\n+    Iterator<TestDatum> merged =\n+        Iterators.mergeSorted(ImmutableList.of(first.iterator(), second.iterator()), comparator);\n+\n+    ImmutableList<TestDatum> result = ImmutableList.copyOf(merged);\n+\n+    assertThat(result)\n+        .containsExactly(\n+            new TestDatum(\"A\", 1),\n+            new TestDatum(\"A\", 2),\n+            new TestDatum(\"A\", 3),\n+            new TestDatum(\"A\", 4));\n+  }\n+\n+  private static final class TestDatum {\n+    final String letter;\n+    final int number;\n+\n+    TestDatum(String letter, int number) {\n+      this.letter = letter;\n+      this.number = number;\n+    }\n+\n+    @Override\n+    public String toString() {\n+      return letter + number;\n+    }\n+\n+    @Override\n+    public boolean equals(@Nullable Object o) {\n+      if (!(o instanceof TestDatum)) {\n+        return false;\n+      }\n+      TestDatum other = (TestDatum) o;\n+      return letter.equals(other.letter) && number == other.number;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+      return Objects.hash(letter, number);\n+    }\n+  }\n }\n",
  "additions": 144,
  "deletions": 0,
  "changed_files": 2,
  "url": "https://github.com/google/guava/pull/7992",
  "mined_at": "2025-10-25T13:03:16.934795"
}