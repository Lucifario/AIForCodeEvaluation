{
  "id": 7967,
  "repository": "google/guava",
  "title": "Reduce allocations in `TypeToken#getRawType`.",
  "body": "Reduce allocations in `TypeToken#getRawType`.\n\nSpecial-case `Class` and `ParameterizedType` handling in `getRawType` to avoid\nallocating for the trivial / common case.\n\n- Fixes #7957\n- Fixes #7966\n\nRELNOTES=n/a\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-09-03T18:39:33+00:00",
  "created_at": "2025-09-03T18:16:23+00:00",
  "updated_at": "2025-09-03T18:39:34+00:00",
  "author": "copybara-service[bot]",
  "reviewers": [],
  "base_sha": "b08ccaa8a98bbb45f1a6f05b010483f69eccaa51",
  "head_sha": "2bff71bd68cc120ef1c6e2ccc67c8f6a8a21b43f",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "android/guava/src/com/google/common/reflect/TypeToken.java",
      "status": "modified",
      "additions": 13,
      "deletions": 5,
      "changes": 18,
      "patch": "@@ -191,11 +191,19 @@ public static TypeToken<?> of(Type type) {\n    * </ul>\n    */\n   public final Class<? super T> getRawType() {\n-    // For wildcard or type variable, the first bound determines the runtime type.\n-    Class<?> rawType = getRawTypes().iterator().next();\n-    @SuppressWarnings(\"unchecked\") // raw type is |T|\n-    Class<? super T> result = (Class<? super T>) rawType;\n-    return result;\n+    if (runtimeType instanceof Class) {\n+      @SuppressWarnings(\"unchecked\") // raw type is T\n+      Class<? super T> result = (Class<? super T>) runtimeType;\n+      return result;\n+    } else if (runtimeType instanceof ParameterizedType) {\n+      @SuppressWarnings(\"unchecked\") // raw type is |T|\n+      Class<? super T> result = (Class<? super T>) ((ParameterizedType) runtimeType).getRawType();\n+      return result;\n+    } else {\n+      // For a wildcard or type variable, the first bound determines the runtime type.\n+      // This case also covers GenericArrayType.\n+      return getRawTypes().iterator().next();\n+    }\n   }\n \n   /** Returns the represented type. */"
    },
    {
      "filename": "guava/src/com/google/common/reflect/TypeToken.java",
      "status": "modified",
      "additions": 13,
      "deletions": 5,
      "changes": 18,
      "patch": "@@ -191,11 +191,19 @@ public static TypeToken<?> of(Type type) {\n    * </ul>\n    */\n   public final Class<? super T> getRawType() {\n-    // For wildcard or type variable, the first bound determines the runtime type.\n-    Class<?> rawType = getRawTypes().iterator().next();\n-    @SuppressWarnings(\"unchecked\") // raw type is |T|\n-    Class<? super T> result = (Class<? super T>) rawType;\n-    return result;\n+    if (runtimeType instanceof Class) {\n+      @SuppressWarnings(\"unchecked\") // raw type is T\n+      Class<? super T> result = (Class<? super T>) runtimeType;\n+      return result;\n+    } else if (runtimeType instanceof ParameterizedType) {\n+      @SuppressWarnings(\"unchecked\") // raw type is |T|\n+      Class<? super T> result = (Class<? super T>) ((ParameterizedType) runtimeType).getRawType();\n+      return result;\n+    } else {\n+      // For a wildcard or type variable, the first bound determines the runtime type.\n+      // This case also covers GenericArrayType.\n+      return getRawTypes().iterator().next();\n+    }\n   }\n \n   /** Returns the represented type. */"
    }
  ],
  "diff": "diff --git a/android/guava/src/com/google/common/reflect/TypeToken.java b/android/guava/src/com/google/common/reflect/TypeToken.java\nindex 6d53438701f7..866fa925fe36 100644\n--- a/android/guava/src/com/google/common/reflect/TypeToken.java\n+++ b/android/guava/src/com/google/common/reflect/TypeToken.java\n@@ -191,11 +191,19 @@ public static TypeToken<?> of(Type type) {\n    * </ul>\n    */\n   public final Class<? super T> getRawType() {\n-    // For wildcard or type variable, the first bound determines the runtime type.\n-    Class<?> rawType = getRawTypes().iterator().next();\n-    @SuppressWarnings(\"unchecked\") // raw type is |T|\n-    Class<? super T> result = (Class<? super T>) rawType;\n-    return result;\n+    if (runtimeType instanceof Class) {\n+      @SuppressWarnings(\"unchecked\") // raw type is T\n+      Class<? super T> result = (Class<? super T>) runtimeType;\n+      return result;\n+    } else if (runtimeType instanceof ParameterizedType) {\n+      @SuppressWarnings(\"unchecked\") // raw type is |T|\n+      Class<? super T> result = (Class<? super T>) ((ParameterizedType) runtimeType).getRawType();\n+      return result;\n+    } else {\n+      // For a wildcard or type variable, the first bound determines the runtime type.\n+      // This case also covers GenericArrayType.\n+      return getRawTypes().iterator().next();\n+    }\n   }\n \n   /** Returns the represented type. */\ndiff --git a/guava/src/com/google/common/reflect/TypeToken.java b/guava/src/com/google/common/reflect/TypeToken.java\nindex 6d53438701f7..866fa925fe36 100644\n--- a/guava/src/com/google/common/reflect/TypeToken.java\n+++ b/guava/src/com/google/common/reflect/TypeToken.java\n@@ -191,11 +191,19 @@ public static TypeToken<?> of(Type type) {\n    * </ul>\n    */\n   public final Class<? super T> getRawType() {\n-    // For wildcard or type variable, the first bound determines the runtime type.\n-    Class<?> rawType = getRawTypes().iterator().next();\n-    @SuppressWarnings(\"unchecked\") // raw type is |T|\n-    Class<? super T> result = (Class<? super T>) rawType;\n-    return result;\n+    if (runtimeType instanceof Class) {\n+      @SuppressWarnings(\"unchecked\") // raw type is T\n+      Class<? super T> result = (Class<? super T>) runtimeType;\n+      return result;\n+    } else if (runtimeType instanceof ParameterizedType) {\n+      @SuppressWarnings(\"unchecked\") // raw type is |T|\n+      Class<? super T> result = (Class<? super T>) ((ParameterizedType) runtimeType).getRawType();\n+      return result;\n+    } else {\n+      // For a wildcard or type variable, the first bound determines the runtime type.\n+      // This case also covers GenericArrayType.\n+      return getRawTypes().iterator().next();\n+    }\n   }\n \n   /** Returns the represented type. */\n",
  "additions": 26,
  "deletions": 10,
  "changed_files": 2,
  "url": "https://github.com/google/guava/pull/7967",
  "mined_at": "2025-10-25T13:05:56.659483"
}