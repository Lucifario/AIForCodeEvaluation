{
  "id": 7984,
  "repository": "google/guava",
  "title": "Move configuration out of `sonatype-oss-release` to enable it by default (except for `maven-gpg-plugin`), and update related configuration as necessary.",
  "body": "Move configuration out of `sonatype-oss-release` to enable it by default (except for `maven-gpg-plugin`), and update related configuration as necessary.\n\n...as contemplated in cl/788538710 and elsewhere.\n\n(Background: We carried much or all of the `sonatype-oss-release` configuration over from the old `oss-parent` in changes like cl/492304151.)\n\nThis (I hope) accomplished two classes of goals:\n\n- By enabling\\[*\\] `central-publishing-maven-plugin` by default, we enable it even for _snapshot_ deployment. Advantages:\n   - It lets the plugin automatically disable `maven-deploy-plugin`. (Compare cl/805973207 for Truth.) And _that_ allows us to remove the configuration of https://central.sonatype.com/repository/maven-snapshots, which isn't needed by `central-publishing-maven-plugin` but which has been required by `maven-deploy-plugin`, which has no default. (Compare cl/805870501 for Truth.)\n   - It causes us to begin deploying snapshots through the new Central system.\n      - To make that work, we need to [set `server-id` to `central`, not `sonatype-central-staging`](https://github.com/google/auto/issues/1965#issuecomment-3299992670), since `central-publishing-maven-plugin` uses a different ID than we had `maven-deploy-plugin` set up to use. (Compare cl/807814773 for Truth.) Since `central` is also what is used for non-snapshot releases, we could view this is a baby step toward performing non-snapshot releases on GitHub CI someday.\n- It ensures that non-release builds _also_ run some plugins and/or use the versions of those plugins that we have requested. (For _some_ projects, we've already been running these plugins, or we've at least kept versions consistent because we use `dependencyManagement` or other explicit versions.) Advantages and fallout:\n   - We now get coverage for Javadoc during CI. (We've wanted this before. We went so far as to implement it for Truth in cl/509829752, and I've wanted it multiple times for Compile-Testing: cl/494805776, cl/802247571.) This change led to errors for Compile-Testing (again!) under JDK 8, so I fixed those by making the `--add-exports` configuration conditional.\n   - We need to make a change to some of our CI configurations: Our snapshot-publishing builds request Javadoc and sources explicitly at the command line (with `mvn source:jar javadoc:jar deploy`). With this CL's changes, Maven would try to build Javadoc and sources twiceâ€”once for the command-line request and once for the new configuration we have. The fix for that is to stop making the explicit request. (Compare cl/807772725 for Truth, somewhat cl/572327204 for Guava, and maybe sorta kinda cl/536746714 for jimfs.)\n   - We address the following warning, which https://github.com/google/guava/pull/7961 had proposed to address another way but for which I'd merely added a TODO in cl/804600714:\n      ```\n      [WARNING] Some problems were encountered while building the effective model for com.google.guava:guava-tests:jar:999.0.0-HEAD-jre-SNAPSHOT\n      [WARNING] 'build.plugins.plugin.version' for org.sonatype.central:central-publishing-maven-plugin is missing. @ line 103, column 15\n      [WARNING]\n      [WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.\n      [WARNING]\n      [WARNING] For this reason, future Maven versions might no longer support building such malformed projects.\n      ```\n\n\\[*\\] \"Enabling\" may or may not be the right word. The `central-publishing-maven-plugin` plugin still doesn't _run_ unless someone actually runs `mvn deploy`. The only difference in output that that plugin change causes for a typical build is this, which I assume is related to its usage of [`<extensions>true</extensions>`](https://maven.apache.org/guides/mini/guide-using-extensions.html):\n\n```\n[INFO] Inspecting build with total of 6 modules\n[INFO] Installing Central Publishing features\n```\n\nI left `maven-gpg-plugin` alone because we don't want to request that users enter their signing keys during snapshot deployment, let alone during normal builds. Another option would be to move it out of the profile but to disable it by default, with the profile becoming responsible for undoing the disablement. (Or we could stop using a profile entirely in favor of passing a flag to set a property to do the same.) That would theoretically be nice because it helps with the \"same version number\" goal discussed above. But given that I never recall having run `maven-gpg-plugin` outside a release setting, I doubt that that matters in practice.\n\n(If we're lucky, this CL's changes to Auto specifically might be enough to deal with https://github.com/google/auto/issues/1965.)\n\nPlus: I removed some redundant declarations of `<groupId>org.apache.maven.plugins</groupId>`, which is the default for plugins. (We had been including it inconsistently.) Compare cl/793718324.\n\nFinally: In Guava, I removed a \"Guava Documentation Site\" entry. This was added back in cl/29254221, but I can't immediately figure out why, and I see no other references to its `guava-site` in either the main or `gh-pages` branch of our repo, nor anywhere internal to Google. I'm hoping that it's at least become unnecessary in the past decade-plus. (The changes in this CL at least have no effect on the _jars_ that we produce as output.)\n\nBonus Maven curiosity: I noticed that we have been getting a Javadoc warning:\n\n```\n[WARNING] Javadoc 1.4+ doesn't support the -1.1 switch anymore. Ignore this option.\n```\n\nThis appears to be [a known issue](https://lists.apache.org/thread/k15x84xvj0tv9gngy2426cpm83d85l61).\n\nRELNOTES=n/a\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-09-16T21:54:28+00:00",
  "created_at": "2025-09-11T19:13:32+00:00",
  "updated_at": "2025-09-16T21:54:29+00:00",
  "author": "copybara-service[bot]",
  "reviewers": [],
  "base_sha": "eeced9088d3bc84284fca8a052633fe7eac93da5",
  "head_sha": "0edab3dd4a967fb6e094326c8bce32ffc5f5dc9c",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": ".github/workflows/ci.yml",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "patch": "@@ -83,10 +83,10 @@ jobs:\n           # The publish-snapshot workflow doesn't run tests, so we don't have to care which version Maven would select for that step.\n           java-version: 24\n           distribution: 'temurin'\n-          server-id: sonatype-nexus-snapshots\n+          cache: 'maven'\n+          server-id: central\n           server-username: CI_DEPLOY_USERNAME\n           server-password: CI_DEPLOY_PASSWORD\n-          cache: 'maven'\n       - name: 'Publish'\n         env:\n           CI_DEPLOY_USERNAME: ${{ secrets.CI_DEPLOY_USERNAME }}"
    },
    {
      "filename": "android/guava-bom/pom.xml",
      "status": "modified",
      "additions": 10,
      "deletions": 22,
      "changes": 32,
      "patch": "@@ -29,13 +29,6 @@\n     <url>https://github.com/google/guava/issues</url>\n   </issueManagement>\n \n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-  </distributionManagement>\n-\n   <dependencyManagement>\n     <dependencies>\n       <dependency>\n@@ -51,19 +44,14 @@\n     </dependencies>\n   </dependencyManagement>\n \n-  <profiles>\n-    <profile>\n-      <id>sonatype-oss-release</id>\n-      <build>\n-        <plugins>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n-        </plugins>\n-      </build>\n-    </profile>\n-  </profiles>\n+  <build>\n+    <plugins>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n+    </plugins>\n+  </build>\n </project>"
    },
    {
      "filename": "android/guava-tests/pom.xml",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "patch": "@@ -97,7 +97,6 @@\n       <plugin>\n         <groupId>org.sonatype.central</groupId>\n         <artifactId>central-publishing-maven-plugin</artifactId>\n-        <!-- TODO(cpovirk): Set a plugin version here, or find a different way to skip publishing for guava-tests. -->\n         <configuration>\n           <skipPublishing>true</skipPublishing>\n         </configuration>"
    },
    {
      "filename": "android/pom.xml",
      "status": "modified",
      "additions": 6,
      "deletions": 17,
      "changes": 23,
      "patch": "@@ -52,17 +52,6 @@\n     <system>GitHub Actions</system>\n     <url>https://github.com/google/guava/actions</url>\n   </ciManagement>\n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-    <site>\n-      <id>guava-site</id>\n-      <name>Guava Documentation Site</name>\n-      <url>scp://dummy.server/dontinstall/usestaging</url>\n-    </site>\n-  </distributionManagement>\n   <properties>\n     <!--\n     When building Guava, you can pass (e.g.) `-Dsurefire.toolchain.version=21` to change which version to run tests under.\n@@ -164,6 +153,12 @@\n           </execution>\n         </executions>\n       </plugin>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n     </plugins>\n     <pluginManagement>\n       <plugins>\n@@ -483,12 +478,6 @@\n               </execution>\n             </executions>\n           </plugin>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n         </plugins>\n       </build>\n     </profile>"
    },
    {
      "filename": "guava-bom/pom.xml",
      "status": "modified",
      "additions": 10,
      "deletions": 22,
      "changes": 32,
      "patch": "@@ -29,13 +29,6 @@\n     <url>https://github.com/google/guava/issues</url>\n   </issueManagement>\n \n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-  </distributionManagement>\n-\n   <dependencyManagement>\n     <dependencies>\n       <dependency>\n@@ -56,19 +49,14 @@\n     </dependencies>\n   </dependencyManagement>\n \n-  <profiles>\n-    <profile>\n-      <id>sonatype-oss-release</id>\n-      <build>\n-        <plugins>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n-        </plugins>\n-      </build>\n-    </profile>\n-  </profiles>\n+  <build>\n+    <plugins>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n+    </plugins>\n+  </build>\n </project>"
    },
    {
      "filename": "guava-tests/pom.xml",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "patch": "@@ -103,7 +103,6 @@\n       <plugin>\n         <groupId>org.sonatype.central</groupId>\n         <artifactId>central-publishing-maven-plugin</artifactId>\n-        <!-- TODO(cpovirk): Set a plugin version here, or find a different way to skip publishing for guava-tests. -->\n         <configuration>\n           <skipPublishing>true</skipPublishing>\n         </configuration>"
    },
    {
      "filename": "pom.xml",
      "status": "modified",
      "additions": 6,
      "deletions": 17,
      "changes": 23,
      "patch": "@@ -53,17 +53,6 @@\n     <system>GitHub Actions</system>\n     <url>https://github.com/google/guava/actions</url>\n   </ciManagement>\n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-    <site>\n-      <id>guava-site</id>\n-      <name>Guava Documentation Site</name>\n-      <url>scp://dummy.server/dontinstall/usestaging</url>\n-    </site>\n-  </distributionManagement>\n   <properties>\n     <!--\n     When building Guava, you can pass (e.g.) `-Dsurefire.toolchain.version=21` to change which version to run tests under.\n@@ -165,6 +154,12 @@\n           </execution>\n         </executions>\n       </plugin>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n     </plugins>\n     <pluginManagement>\n       <plugins>\n@@ -478,12 +473,6 @@\n               </execution>\n             </executions>\n           </plugin>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n         </plugins>\n       </build>\n     </profile>"
    }
  ],
  "diff": "diff --git a/.github/workflows/ci.yml b/.github/workflows/ci.yml\nindex 5cc5821d6b76..4db524b8663d 100644\n--- a/.github/workflows/ci.yml\n+++ b/.github/workflows/ci.yml\n@@ -83,10 +83,10 @@ jobs:\n           # The publish-snapshot workflow doesn't run tests, so we don't have to care which version Maven would select for that step.\n           java-version: 24\n           distribution: 'temurin'\n-          server-id: sonatype-nexus-snapshots\n+          cache: 'maven'\n+          server-id: central\n           server-username: CI_DEPLOY_USERNAME\n           server-password: CI_DEPLOY_PASSWORD\n-          cache: 'maven'\n       - name: 'Publish'\n         env:\n           CI_DEPLOY_USERNAME: ${{ secrets.CI_DEPLOY_USERNAME }}\ndiff --git a/android/guava-bom/pom.xml b/android/guava-bom/pom.xml\nindex 39bc030bddd5..7a83854afa74 100644\n--- a/android/guava-bom/pom.xml\n+++ b/android/guava-bom/pom.xml\n@@ -29,13 +29,6 @@\n     <url>https://github.com/google/guava/issues</url>\n   </issueManagement>\n \n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-  </distributionManagement>\n-\n   <dependencyManagement>\n     <dependencies>\n       <dependency>\n@@ -51,19 +44,14 @@\n     </dependencies>\n   </dependencyManagement>\n \n-  <profiles>\n-    <profile>\n-      <id>sonatype-oss-release</id>\n-      <build>\n-        <plugins>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n-        </plugins>\n-      </build>\n-    </profile>\n-  </profiles>\n+  <build>\n+    <plugins>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n+    </plugins>\n+  </build>\n </project>\ndiff --git a/android/guava-tests/pom.xml b/android/guava-tests/pom.xml\nindex 9e2c0cdf4249..ad5835cb303a 100644\n--- a/android/guava-tests/pom.xml\n+++ b/android/guava-tests/pom.xml\n@@ -97,7 +97,6 @@\n       <plugin>\n         <groupId>org.sonatype.central</groupId>\n         <artifactId>central-publishing-maven-plugin</artifactId>\n-        <!-- TODO(cpovirk): Set a plugin version here, or find a different way to skip publishing for guava-tests. -->\n         <configuration>\n           <skipPublishing>true</skipPublishing>\n         </configuration>\ndiff --git a/android/pom.xml b/android/pom.xml\nindex 465a7aeb6f55..e5b9618b4b45 100644\n--- a/android/pom.xml\n+++ b/android/pom.xml\n@@ -52,17 +52,6 @@\n     <system>GitHub Actions</system>\n     <url>https://github.com/google/guava/actions</url>\n   </ciManagement>\n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-    <site>\n-      <id>guava-site</id>\n-      <name>Guava Documentation Site</name>\n-      <url>scp://dummy.server/dontinstall/usestaging</url>\n-    </site>\n-  </distributionManagement>\n   <properties>\n     <!--\n     When building Guava, you can pass (e.g.) `-Dsurefire.toolchain.version=21` to change which version to run tests under.\n@@ -164,6 +153,12 @@\n           </execution>\n         </executions>\n       </plugin>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n     </plugins>\n     <pluginManagement>\n       <plugins>\n@@ -483,12 +478,6 @@\n               </execution>\n             </executions>\n           </plugin>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n         </plugins>\n       </build>\n     </profile>\ndiff --git a/guava-bom/pom.xml b/guava-bom/pom.xml\nindex e1cbaa8c1e79..4c4eeecbd357 100644\n--- a/guava-bom/pom.xml\n+++ b/guava-bom/pom.xml\n@@ -29,13 +29,6 @@\n     <url>https://github.com/google/guava/issues</url>\n   </issueManagement>\n \n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-  </distributionManagement>\n-\n   <dependencyManagement>\n     <dependencies>\n       <dependency>\n@@ -56,19 +49,14 @@\n     </dependencies>\n   </dependencyManagement>\n \n-  <profiles>\n-    <profile>\n-      <id>sonatype-oss-release</id>\n-      <build>\n-        <plugins>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n-        </plugins>\n-      </build>\n-    </profile>\n-  </profiles>\n+  <build>\n+    <plugins>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n+    </plugins>\n+  </build>\n </project>\ndiff --git a/guava-tests/pom.xml b/guava-tests/pom.xml\nindex ce4a95f0bfc8..b7fe0d5aaf5d 100644\n--- a/guava-tests/pom.xml\n+++ b/guava-tests/pom.xml\n@@ -103,7 +103,6 @@\n       <plugin>\n         <groupId>org.sonatype.central</groupId>\n         <artifactId>central-publishing-maven-plugin</artifactId>\n-        <!-- TODO(cpovirk): Set a plugin version here, or find a different way to skip publishing for guava-tests. -->\n         <configuration>\n           <skipPublishing>true</skipPublishing>\n         </configuration>\ndiff --git a/pom.xml b/pom.xml\nindex 40d07594e9c4..df92795bfea3 100644\n--- a/pom.xml\n+++ b/pom.xml\n@@ -53,17 +53,6 @@\n     <system>GitHub Actions</system>\n     <url>https://github.com/google/guava/actions</url>\n   </ciManagement>\n-  <distributionManagement>\n-    <snapshotRepository>\n-      <id>sonatype-nexus-snapshots</id>\n-      <url>https://central.sonatype.com/repository/maven-snapshots/</url>\n-    </snapshotRepository>\n-    <site>\n-      <id>guava-site</id>\n-      <name>Guava Documentation Site</name>\n-      <url>scp://dummy.server/dontinstall/usestaging</url>\n-    </site>\n-  </distributionManagement>\n   <properties>\n     <!--\n     When building Guava, you can pass (e.g.) `-Dsurefire.toolchain.version=21` to change which version to run tests under.\n@@ -165,6 +154,12 @@\n           </execution>\n         </executions>\n       </plugin>\n+      <plugin>\n+        <groupId>org.sonatype.central</groupId>\n+        <artifactId>central-publishing-maven-plugin</artifactId>\n+        <version>0.8.0</version>\n+        <extensions>true</extensions>\n+      </plugin>\n     </plugins>\n     <pluginManagement>\n       <plugins>\n@@ -478,12 +473,6 @@\n               </execution>\n             </executions>\n           </plugin>\n-          <plugin>\n-            <groupId>org.sonatype.central</groupId>\n-            <artifactId>central-publishing-maven-plugin</artifactId>\n-            <version>0.8.0</version>\n-            <extensions>true</extensions>\n-          </plugin>\n         </plugins>\n       </build>\n     </profile>\n",
  "additions": 34,
  "deletions": 82,
  "changed_files": 7,
  "url": "https://github.com/google/guava/pull/7984",
  "mined_at": "2025-10-25T13:02:20.748319"
}