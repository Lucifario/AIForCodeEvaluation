{
  "id": 7400,
  "repository": "google/guava",
  "title": "Include `j2objc-annotations` in the Gradle runtime classpath.",
  "body": "Include `j2objc-annotations` in the Gradle runtime classpath.\n\nWhile that artifact contains no runtime-retention annotations, it does contain class-retention annotations (which could drive a runtime bytecode-rewriting agent). And, more practically, the Android Gradle Plugin has started reporting errors for `compileOnly` dependencies.\n\nFixes https://github.com/google/guava/issues/7397\n\nRelevant to https://github.com/firebase/firebase-android-sdk/issues/6232 and https://github.com/androidx/media/issues/1700\n\nRELNOTES=Added `j2objc-annotations` to the Gradle runtime classpath to avoid [an Android Gradle Plugin error](https://github.com/google/guava/issues/7397).\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2024-09-23T17:17:16+00:00",
  "created_at": "2024-09-23T16:22:31+00:00",
  "updated_at": "2025-09-16T13:09:19+00:00",
  "author": "copybara-service[bot]",
  "reviewers": [],
  "base_sha": "6a070d8046e929efb2915f2b3dedde8154c146ab",
  "head_sha": "a3b51888c2456350ab11694c28d7a72173f3b897",
  "review_comments": [],
  "pr_comments": [
    {
      "user": "nsoft",
      "body": "I think there is some chance that this has caused platform dependent differences in dependencies, which is a pretty scary thing for a java project, both in terms of reliable artifact packaging, and for tracking/documenting software licenses (NOTICE files etc). See https://github.com/nsoft/jesterj/issues/214 where it has become impossible to write a build that passes on both mac and linux - but this is going to be inconveniencing Apache Solr (and I expect many others) too... I haven't yet figured out what bit of pom magic is causing the OS mediated variation in runtime dependencies, but it's definitely not great to have this in runtimeClasspath.",
      "created_at": "2025-09-13T02:42:33+00:00"
    },
    {
      "user": "cpovirk",
      "body": "Hmm, that is no good :(\r\n\r\nMy hope would be that this PR would have _reduced_ the amount of weirdness going on: Instead of having `j2objc-annotation` sometimes automatically omitted from the runtime classpath, it would make it present there all the timeâ€”basically, make it a \"normal\" dependency. It would be interesting to know whether the problem would arise if we didn't provide a `module.json` at all. (I don't know how easy that is to test, though, unless maybe you can rewind to a version of Guava before we introduced `module.json`.)\r\n\r\nWould it be possible and helpful in your case to exclude the Guava dependency on `j2objc-annotations` (or demote it from runtime to compile-only if Gradle provides a way to do that)? I would expect that to work fine in nearly all cases; I've just hoped to leave that decision in the hands of users instead of assuming that that's what they want.\r\n\r\nI also saw your note in https://github.com/nsoft/jesterj/issues/214 about adding the documentation. Is this something that we would ideally do in `j2objc-annotations`, even if it wouldn't help with the specific problem you're facing?\r\n\r\nIs there any chance that some intentionally Linux-only part of your build pulls in `j2objc-annotations` version 3.1, which Gradle might consider to win out over 3.0 in a way that causes it to hide Guava's use of 3.0 entirely? If so, maybe we'll see something different with the upcoming Guava release, which will bump our dep to 3.1 (https://github.com/google/guava/pull/7970).",
      "created_at": "2025-09-14T21:04:10+00:00"
    },
    {
      "user": "nsoft",
      "body": "My build is definitely not _intending_ to do any thing platform specific. I was floored to discover this. As for references to documentation in the JesterJ issue, I am referring t JesterJ's documentation of which licenses it depends on and associated notice files (automatically generated by the build). I was not suggesting that you add documentation. \r\n\r\nIdeally one of us will figure out why `j2objc-annoatation` is showing up as a dependency on a macbook, but not on Crave.io linux build machines and not on my linux desktop. The mechanism for this remains a mystery despite several hours investigating. Once the mechanism is found, ideally the build/metadata/gradle/whatever can be patched. \r\n\r\nAll I really want is consistency. ",
      "created_at": "2025-09-16T13:09:19+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "guava/module.json",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "patch": "@@ -133,6 +133,13 @@\n           \"version\": {\n             \"requires\": \"${errorprone.version}\"\n           }\n+        },\n+        {\n+          \"group\": \"com.google.j2objc\",\n+          \"module\": \"j2objc-annotations\",\n+          \"version\": {\n+            \"requires\": \"${j2objc.version}\"\n+          }\n         }\n       ],\n       \"files\": [\n@@ -272,6 +279,13 @@\n           \"version\": {\n             \"requires\": \"${errorprone.version}\"\n           }\n+        },\n+        {\n+          \"group\": \"com.google.j2objc\",\n+          \"module\": \"j2objc-annotations\",\n+          \"version\": {\n+            \"requires\": \"${j2objc.version}\"\n+          }\n         }\n       ],\n       \"files\": ["
    },
    {
      "filename": "integration-tests/gradle/build.gradle.kts",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "patch": "@@ -8,6 +8,7 @@ val expectedReducedRuntimeClasspathAndroidVersion =\n   setOf(\n     \"guava-${guavaVersionJre.replace(\"jre\", \"android\")}.jar\",\n     \"failureaccess-1.0.2.jar\",\n+    \"j2objc-annotations-3.0.0.jar\",\n     \"jsr305-3.0.2.jar\",\n     \"checker-qual-3.43.0.jar\",\n     \"error_prone_annotations-2.28.0.jar\",\n@@ -17,15 +18,14 @@ val expectedReducedRuntimeClasspathJreVersion =\n   setOf(\n     \"guava-$guavaVersionJre.jar\",\n     \"failureaccess-1.0.2.jar\",\n+    \"j2objc-annotations-3.0.0.jar\",\n     \"jsr305-3.0.2.jar\",\n     \"checker-qual-3.43.0.jar\",\n     \"error_prone_annotations-2.28.0.jar\",\n     \"listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar\"\n   )\n-val expectedCompileClasspathAndroidVersion =\n-  expectedReducedRuntimeClasspathAndroidVersion + setOf(\"j2objc-annotations-3.0.0.jar\")\n-val expectedCompileClasspathJreVersion =\n-  expectedReducedRuntimeClasspathJreVersion + setOf(\"j2objc-annotations-3.0.0.jar\")\n+val expectedCompileClasspathAndroidVersion = expectedReducedRuntimeClasspathAndroidVersion\n+val expectedCompileClasspathJreVersion = expectedReducedRuntimeClasspathJreVersion\n \n val extraLegacyDependencies = setOf(\"google-collections-1.0.jar\")\n "
    }
  ],
  "diff": "diff --git a/guava/module.json b/guava/module.json\nindex 0e7e5d85d087..c125a282dedf 100644\n--- a/guava/module.json\n+++ b/guava/module.json\n@@ -133,6 +133,13 @@\n           \"version\": {\n             \"requires\": \"${errorprone.version}\"\n           }\n+        },\n+        {\n+          \"group\": \"com.google.j2objc\",\n+          \"module\": \"j2objc-annotations\",\n+          \"version\": {\n+            \"requires\": \"${j2objc.version}\"\n+          }\n         }\n       ],\n       \"files\": [\n@@ -272,6 +279,13 @@\n           \"version\": {\n             \"requires\": \"${errorprone.version}\"\n           }\n+        },\n+        {\n+          \"group\": \"com.google.j2objc\",\n+          \"module\": \"j2objc-annotations\",\n+          \"version\": {\n+            \"requires\": \"${j2objc.version}\"\n+          }\n         }\n       ],\n       \"files\": [\ndiff --git a/integration-tests/gradle/build.gradle.kts b/integration-tests/gradle/build.gradle.kts\nindex 46e37a047da7..f2830db76f36 100644\n--- a/integration-tests/gradle/build.gradle.kts\n+++ b/integration-tests/gradle/build.gradle.kts\n@@ -8,6 +8,7 @@ val expectedReducedRuntimeClasspathAndroidVersion =\n   setOf(\n     \"guava-${guavaVersionJre.replace(\"jre\", \"android\")}.jar\",\n     \"failureaccess-1.0.2.jar\",\n+    \"j2objc-annotations-3.0.0.jar\",\n     \"jsr305-3.0.2.jar\",\n     \"checker-qual-3.43.0.jar\",\n     \"error_prone_annotations-2.28.0.jar\",\n@@ -17,15 +18,14 @@ val expectedReducedRuntimeClasspathJreVersion =\n   setOf(\n     \"guava-$guavaVersionJre.jar\",\n     \"failureaccess-1.0.2.jar\",\n+    \"j2objc-annotations-3.0.0.jar\",\n     \"jsr305-3.0.2.jar\",\n     \"checker-qual-3.43.0.jar\",\n     \"error_prone_annotations-2.28.0.jar\",\n     \"listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar\"\n   )\n-val expectedCompileClasspathAndroidVersion =\n-  expectedReducedRuntimeClasspathAndroidVersion + setOf(\"j2objc-annotations-3.0.0.jar\")\n-val expectedCompileClasspathJreVersion =\n-  expectedReducedRuntimeClasspathJreVersion + setOf(\"j2objc-annotations-3.0.0.jar\")\n+val expectedCompileClasspathAndroidVersion = expectedReducedRuntimeClasspathAndroidVersion\n+val expectedCompileClasspathJreVersion = expectedReducedRuntimeClasspathJreVersion\n \n val extraLegacyDependencies = setOf(\"google-collections-1.0.jar\")\n \n",
  "additions": 18,
  "deletions": 4,
  "changed_files": 2,
  "url": "https://github.com/google/guava/pull/7400",
  "mined_at": "2025-10-25T13:02:51.398738"
}