{
  "id": 8010,
  "repository": "google/guava",
  "title": "Add a missing `@Nullable` annotation identified by [`RedundantNullCheck`](https://github.com/google/error-prone/pull/5121).",
  "body": "Add a missing `@Nullable` annotation identified by [`RedundantNullCheck`](https://github.com/google/error-prone/pull/5121).\n\nAlso, use that check as motivation to finally make `AbstractBiMap` more understandable to nullness checkers. While in the area, I also made `inverse` be `private`. That required changing a reference in a subclass in the file to use `super.inverse`. As I understand it from my experience in https://github.com/google/guava/commit/856123ecc6f550759be8d5eb6c395553781e609d, a `private` field like `inverse` is [accessible](https://docs.oracle.com/javase/specs/jls/se24/html/jls-6.html#jls-6.6.1) but not inherited ([1](https://docs.oracle.com/javase/specs/jls/se24/html/jls-8.html#d5e13771), [2](https://docs.oracle.com/javase/specs/jls/se24/html/jls-8.html#jls-8.2)).\n\n(And marginally simplify a couple `AbstractBiMap` subclasses by removing unnecessary type arguments.)\n\nRELNOTES=n/a\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-09-22T15:50:56+00:00",
  "created_at": "2025-09-22T13:42:09+00:00",
  "updated_at": "2025-09-22T15:50:57+00:00",
  "author": "copybara-service[bot]",
  "reviewers": [],
  "base_sha": "b94bd32f1923996261c0363b0a57283be391d87d",
  "head_sha": "125fd027c2174ebadee04944bdc9a73a6f0de295",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "android/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -85,7 +85,7 @@ final long estimateSize() {\n       return spliterator.estimateSize();\n     }\n \n-    final Comparator<? super E> getComparator() {\n+    final @Nullable Comparator<? super E> getComparator() {\n       return spliterator.getComparator();\n     }\n "
    },
    {
      "filename": "android/guava/src/com/google/common/collect/AbstractBiMap.java",
      "status": "modified",
      "additions": 13,
      "deletions": 13,
      "changes": 26,
      "patch": "@@ -52,16 +52,14 @@\n abstract class AbstractBiMap<K extends @Nullable Object, V extends @Nullable Object>\n     extends ForwardingMap<K, V> implements BiMap<K, V>, Serializable {\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n   private transient Map<K, V> delegate;\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n-  @RetainedWith\n-  transient AbstractBiMap<V, K> inverse;\n+  @RetainedWith private transient AbstractBiMap<V, K> inverse;\n \n   /** Package-private constructor for creating a map-backed bimap. */\n   AbstractBiMap(Map<K, V> forward, Map<V, K> backward) {\n-    setDelegates(forward, backward);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n   }\n \n   /** Private constructor for inverse bimap. */\n@@ -90,17 +88,19 @@ V checkValue(@ParametricNullness V value) {\n   }\n \n   /**\n-   * Specifies the delegate maps going in each direction. Called by the constructor and by\n-   * subclasses during deserialization.\n+   * Specifies the delegate maps going in each direction. Called by subclasses during\n+   * deserialization.\n    */\n   void setDelegates(Map<K, V> forward, Map<V, K> backward) {\n-    checkState(delegate == null);\n-    checkState(inverse == null);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n+  }\n+\n+  private AbstractBiMap<V, K> checkMapsAndMakeInverse(Map<K, V> forward, Map<V, K> backward) {\n     checkArgument(forward.isEmpty());\n     checkArgument(backward.isEmpty());\n     checkArgument(forward != backward);\n-    delegate = forward;\n-    inverse = makeInverse(backward);\n+    return makeInverse(backward);\n   }\n \n   AbstractBiMap<V, K> makeInverse(Map<V, K> backward) {\n@@ -450,13 +450,13 @@ private static final class Inverse<K extends @Nullable Object, V extends @Nullab\n     @Override\n     @ParametricNullness\n     K checkKey(@ParametricNullness K key) {\n-      return inverse.checkValue(key);\n+      return super.inverse.checkValue(key);\n     }\n \n     @Override\n     @ParametricNullness\n     V checkValue(@ParametricNullness V value) {\n-      return inverse.checkKey(value);\n+      return super.inverse.checkKey(value);\n     }\n \n     /**"
    },
    {
      "filename": "android/guava/src/com/google/common/collect/EnumBiMap.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -154,7 +154,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n     keyTypeOrObjectUnderJ2cl = (Class<K>) requireNonNull(stream.readObject());\n     valueTypeOrObjectUnderJ2cl = (Class<V>) requireNonNull(stream.readObject());\n     setDelegates(\n-        new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new EnumMap<V, K>(valueTypeOrObjectUnderJ2cl));\n+        new EnumMap<>(keyTypeOrObjectUnderJ2cl), new EnumMap<>(valueTypeOrObjectUnderJ2cl));\n     Serialization.populateMap(this, stream);\n   }\n "
    },
    {
      "filename": "android/guava/src/com/google/common/collect/EnumHashBiMap.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -131,7 +131,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n      * the number of entries in the map, as that makes it easy for hostile inputs to trigger lots of\n      * allocation窶馬ot that any program should be deserializing hostile inputs to begin with!)\n      */\n-    setDelegates(new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new HashMap<V, K>());\n+    setDelegates(new EnumMap<>(keyTypeOrObjectUnderJ2cl), new HashMap<>());\n     Serialization.populateMap(this, stream);\n   }\n "
    },
    {
      "filename": "guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -83,7 +83,7 @@ final long estimateSize() {\n       return spliterator.estimateSize();\n     }\n \n-    final Comparator<? super E> getComparator() {\n+    final @Nullable Comparator<? super E> getComparator() {\n       return spliterator.getComparator();\n     }\n "
    },
    {
      "filename": "guava/src/com/google/common/collect/AbstractBiMap.java",
      "status": "modified",
      "additions": 13,
      "deletions": 13,
      "changes": 26,
      "patch": "@@ -53,16 +53,14 @@\n abstract class AbstractBiMap<K extends @Nullable Object, V extends @Nullable Object>\n     extends ForwardingMap<K, V> implements BiMap<K, V>, Serializable {\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n   private transient Map<K, V> delegate;\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n-  @RetainedWith\n-  transient AbstractBiMap<V, K> inverse;\n+  @RetainedWith private transient AbstractBiMap<V, K> inverse;\n \n   /** Package-private constructor for creating a map-backed bimap. */\n   AbstractBiMap(Map<K, V> forward, Map<V, K> backward) {\n-    setDelegates(forward, backward);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n   }\n \n   /** Private constructor for inverse bimap. */\n@@ -91,17 +89,19 @@ V checkValue(@ParametricNullness V value) {\n   }\n \n   /**\n-   * Specifies the delegate maps going in each direction. Called by the constructor and by\n-   * subclasses during deserialization.\n+   * Specifies the delegate maps going in each direction. Called by subclasses during\n+   * deserialization.\n    */\n   void setDelegates(Map<K, V> forward, Map<V, K> backward) {\n-    checkState(delegate == null);\n-    checkState(inverse == null);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n+  }\n+\n+  private AbstractBiMap<V, K> checkMapsAndMakeInverse(Map<K, V> forward, Map<V, K> backward) {\n     checkArgument(forward.isEmpty());\n     checkArgument(backward.isEmpty());\n     checkArgument(forward != backward);\n-    delegate = forward;\n-    inverse = makeInverse(backward);\n+    return makeInverse(backward);\n   }\n \n   AbstractBiMap<V, K> makeInverse(Map<V, K> backward) {\n@@ -474,13 +474,13 @@ private static final class Inverse<K extends @Nullable Object, V extends @Nullab\n     @Override\n     @ParametricNullness\n     K checkKey(@ParametricNullness K key) {\n-      return inverse.checkValue(key);\n+      return super.inverse.checkValue(key);\n     }\n \n     @Override\n     @ParametricNullness\n     V checkValue(@ParametricNullness V value) {\n-      return inverse.checkKey(value);\n+      return super.inverse.checkKey(value);\n     }\n \n     /**"
    },
    {
      "filename": "guava/src/com/google/common/collect/EnumBiMap.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -154,7 +154,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n     keyTypeOrObjectUnderJ2cl = (Class<K>) requireNonNull(stream.readObject());\n     valueTypeOrObjectUnderJ2cl = (Class<V>) requireNonNull(stream.readObject());\n     setDelegates(\n-        new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new EnumMap<V, K>(valueTypeOrObjectUnderJ2cl));\n+        new EnumMap<>(keyTypeOrObjectUnderJ2cl), new EnumMap<>(valueTypeOrObjectUnderJ2cl));\n     Serialization.populateMap(this, stream);\n   }\n "
    },
    {
      "filename": "guava/src/com/google/common/collect/EnumHashBiMap.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -131,7 +131,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n      * the number of entries in the map, as that makes it easy for hostile inputs to trigger lots of\n      * allocation窶馬ot that any program should be deserializing hostile inputs to begin with!)\n      */\n-    setDelegates(new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new HashMap<V, K>());\n+    setDelegates(new EnumMap<>(keyTypeOrObjectUnderJ2cl), new HashMap<>());\n     Serialization.populateMap(this, stream);\n   }\n "
    }
  ],
  "diff": "diff --git a/android/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java b/android/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java\nindex 1e937420e804..93d455c2e624 100644\n--- a/android/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java\n+++ b/android/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java\n@@ -85,7 +85,7 @@ final long estimateSize() {\n       return spliterator.estimateSize();\n     }\n \n-    final Comparator<? super E> getComparator() {\n+    final @Nullable Comparator<? super E> getComparator() {\n       return spliterator.getComparator();\n     }\n \ndiff --git a/android/guava/src/com/google/common/collect/AbstractBiMap.java b/android/guava/src/com/google/common/collect/AbstractBiMap.java\nindex e871fd1ca66e..82297c800adc 100644\n--- a/android/guava/src/com/google/common/collect/AbstractBiMap.java\n+++ b/android/guava/src/com/google/common/collect/AbstractBiMap.java\n@@ -52,16 +52,14 @@\n abstract class AbstractBiMap<K extends @Nullable Object, V extends @Nullable Object>\n     extends ForwardingMap<K, V> implements BiMap<K, V>, Serializable {\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n   private transient Map<K, V> delegate;\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n-  @RetainedWith\n-  transient AbstractBiMap<V, K> inverse;\n+  @RetainedWith private transient AbstractBiMap<V, K> inverse;\n \n   /** Package-private constructor for creating a map-backed bimap. */\n   AbstractBiMap(Map<K, V> forward, Map<V, K> backward) {\n-    setDelegates(forward, backward);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n   }\n \n   /** Private constructor for inverse bimap. */\n@@ -90,17 +88,19 @@ V checkValue(@ParametricNullness V value) {\n   }\n \n   /**\n-   * Specifies the delegate maps going in each direction. Called by the constructor and by\n-   * subclasses during deserialization.\n+   * Specifies the delegate maps going in each direction. Called by subclasses during\n+   * deserialization.\n    */\n   void setDelegates(Map<K, V> forward, Map<V, K> backward) {\n-    checkState(delegate == null);\n-    checkState(inverse == null);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n+  }\n+\n+  private AbstractBiMap<V, K> checkMapsAndMakeInverse(Map<K, V> forward, Map<V, K> backward) {\n     checkArgument(forward.isEmpty());\n     checkArgument(backward.isEmpty());\n     checkArgument(forward != backward);\n-    delegate = forward;\n-    inverse = makeInverse(backward);\n+    return makeInverse(backward);\n   }\n \n   AbstractBiMap<V, K> makeInverse(Map<V, K> backward) {\n@@ -450,13 +450,13 @@ private static final class Inverse<K extends @Nullable Object, V extends @Nullab\n     @Override\n     @ParametricNullness\n     K checkKey(@ParametricNullness K key) {\n-      return inverse.checkValue(key);\n+      return super.inverse.checkValue(key);\n     }\n \n     @Override\n     @ParametricNullness\n     V checkValue(@ParametricNullness V value) {\n-      return inverse.checkKey(value);\n+      return super.inverse.checkKey(value);\n     }\n \n     /**\ndiff --git a/android/guava/src/com/google/common/collect/EnumBiMap.java b/android/guava/src/com/google/common/collect/EnumBiMap.java\nindex 21a164b431bf..06ba92ee3d06 100644\n--- a/android/guava/src/com/google/common/collect/EnumBiMap.java\n+++ b/android/guava/src/com/google/common/collect/EnumBiMap.java\n@@ -154,7 +154,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n     keyTypeOrObjectUnderJ2cl = (Class<K>) requireNonNull(stream.readObject());\n     valueTypeOrObjectUnderJ2cl = (Class<V>) requireNonNull(stream.readObject());\n     setDelegates(\n-        new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new EnumMap<V, K>(valueTypeOrObjectUnderJ2cl));\n+        new EnumMap<>(keyTypeOrObjectUnderJ2cl), new EnumMap<>(valueTypeOrObjectUnderJ2cl));\n     Serialization.populateMap(this, stream);\n   }\n \ndiff --git a/android/guava/src/com/google/common/collect/EnumHashBiMap.java b/android/guava/src/com/google/common/collect/EnumHashBiMap.java\nindex 6412e5137ca3..de3242e89afa 100644\n--- a/android/guava/src/com/google/common/collect/EnumHashBiMap.java\n+++ b/android/guava/src/com/google/common/collect/EnumHashBiMap.java\n@@ -131,7 +131,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n      * the number of entries in the map, as that makes it easy for hostile inputs to trigger lots of\n      * allocation窶馬ot that any program should be deserializing hostile inputs to begin with!)\n      */\n-    setDelegates(new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new HashMap<V, K>());\n+    setDelegates(new EnumMap<>(keyTypeOrObjectUnderJ2cl), new HashMap<>());\n     Serialization.populateMap(this, stream);\n   }\n \ndiff --git a/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java b/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java\nindex cbc7bab17a82..1f47f2a0fd7f 100644\n--- a/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java\n+++ b/guava-testlib/src/com/google/common/collect/testing/SpliteratorTester.java\n@@ -83,7 +83,7 @@ final long estimateSize() {\n       return spliterator.estimateSize();\n     }\n \n-    final Comparator<? super E> getComparator() {\n+    final @Nullable Comparator<? super E> getComparator() {\n       return spliterator.getComparator();\n     }\n \ndiff --git a/guava/src/com/google/common/collect/AbstractBiMap.java b/guava/src/com/google/common/collect/AbstractBiMap.java\nindex c9395dc79596..657df64227da 100644\n--- a/guava/src/com/google/common/collect/AbstractBiMap.java\n+++ b/guava/src/com/google/common/collect/AbstractBiMap.java\n@@ -53,16 +53,14 @@\n abstract class AbstractBiMap<K extends @Nullable Object, V extends @Nullable Object>\n     extends ForwardingMap<K, V> implements BiMap<K, V>, Serializable {\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n   private transient Map<K, V> delegate;\n \n-  @SuppressWarnings(\"nullness:initialization.field.uninitialized\") // For J2KT (lateinit)\n-  @RetainedWith\n-  transient AbstractBiMap<V, K> inverse;\n+  @RetainedWith private transient AbstractBiMap<V, K> inverse;\n \n   /** Package-private constructor for creating a map-backed bimap. */\n   AbstractBiMap(Map<K, V> forward, Map<V, K> backward) {\n-    setDelegates(forward, backward);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n   }\n \n   /** Private constructor for inverse bimap. */\n@@ -91,17 +89,19 @@ V checkValue(@ParametricNullness V value) {\n   }\n \n   /**\n-   * Specifies the delegate maps going in each direction. Called by the constructor and by\n-   * subclasses during deserialization.\n+   * Specifies the delegate maps going in each direction. Called by subclasses during\n+   * deserialization.\n    */\n   void setDelegates(Map<K, V> forward, Map<V, K> backward) {\n-    checkState(delegate == null);\n-    checkState(inverse == null);\n+    inverse = checkMapsAndMakeInverse(forward, backward);\n+    delegate = forward;\n+  }\n+\n+  private AbstractBiMap<V, K> checkMapsAndMakeInverse(Map<K, V> forward, Map<V, K> backward) {\n     checkArgument(forward.isEmpty());\n     checkArgument(backward.isEmpty());\n     checkArgument(forward != backward);\n-    delegate = forward;\n-    inverse = makeInverse(backward);\n+    return makeInverse(backward);\n   }\n \n   AbstractBiMap<V, K> makeInverse(Map<V, K> backward) {\n@@ -474,13 +474,13 @@ private static final class Inverse<K extends @Nullable Object, V extends @Nullab\n     @Override\n     @ParametricNullness\n     K checkKey(@ParametricNullness K key) {\n-      return inverse.checkValue(key);\n+      return super.inverse.checkValue(key);\n     }\n \n     @Override\n     @ParametricNullness\n     V checkValue(@ParametricNullness V value) {\n-      return inverse.checkKey(value);\n+      return super.inverse.checkKey(value);\n     }\n \n     /**\ndiff --git a/guava/src/com/google/common/collect/EnumBiMap.java b/guava/src/com/google/common/collect/EnumBiMap.java\nindex 21a164b431bf..06ba92ee3d06 100644\n--- a/guava/src/com/google/common/collect/EnumBiMap.java\n+++ b/guava/src/com/google/common/collect/EnumBiMap.java\n@@ -154,7 +154,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n     keyTypeOrObjectUnderJ2cl = (Class<K>) requireNonNull(stream.readObject());\n     valueTypeOrObjectUnderJ2cl = (Class<V>) requireNonNull(stream.readObject());\n     setDelegates(\n-        new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new EnumMap<V, K>(valueTypeOrObjectUnderJ2cl));\n+        new EnumMap<>(keyTypeOrObjectUnderJ2cl), new EnumMap<>(valueTypeOrObjectUnderJ2cl));\n     Serialization.populateMap(this, stream);\n   }\n \ndiff --git a/guava/src/com/google/common/collect/EnumHashBiMap.java b/guava/src/com/google/common/collect/EnumHashBiMap.java\nindex 6412e5137ca3..de3242e89afa 100644\n--- a/guava/src/com/google/common/collect/EnumHashBiMap.java\n+++ b/guava/src/com/google/common/collect/EnumHashBiMap.java\n@@ -131,7 +131,7 @@ private void readObject(ObjectInputStream stream) throws IOException, ClassNotFo\n      * the number of entries in the map, as that makes it easy for hostile inputs to trigger lots of\n      * allocation窶馬ot that any program should be deserializing hostile inputs to begin with!)\n      */\n-    setDelegates(new EnumMap<K, V>(keyTypeOrObjectUnderJ2cl), new HashMap<V, K>());\n+    setDelegates(new EnumMap<>(keyTypeOrObjectUnderJ2cl), new HashMap<>());\n     Serialization.populateMap(this, stream);\n   }\n \n",
  "additions": 32,
  "deletions": 32,
  "changed_files": 8,
  "url": "https://github.com/google/guava/pull/8010",
  "mined_at": "2025-10-25T13:01:05.104684"
}