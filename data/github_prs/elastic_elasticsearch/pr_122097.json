{
  "id": 122097,
  "repository": "elastic/elasticsearch",
  "title": "Fix test failures for long YAML xContent",
  "body": "Some search response and aggregations tests can create very large xContent objects over 3Mb in size. Parsing these works for JSON and other xContent types, but snakeyaml limits the input size to 3Mb since version 1.32 which can lead to test failures for very large inputs.\r\n\r\nThis change adds a length check in case we test YAML xContent and creates new test instances if the length is to large.\r\n\r\nCloses #121666\r\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-02-11T11:16:02+00:00",
  "created_at": "2025-02-07T21:04:30+00:00",
  "updated_at": "2025-10-24T18:14:18+00:00",
  "author": "cbuescher",
  "reviewers": [
    "javanna"
  ],
  "base_sha": "cfc9369bfb5f1efc0008558644f723b2faa71893",
  "head_sha": "a528a1a8f317f6662847934c39420fba55276dc0",
  "review_comments": [
    {
      "user": "javanna",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-02-10T10:15:05+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-search-foundations (Team:Search Foundations)",
      "created_at": "2025-02-07T21:04:54+00:00"
    },
    {
      "user": "cbuescher",
      "body": "Note that while the same 3Mb Yaml limit [exists on 8x and `main` branches ](https://github.com/elastic/elasticsearch/issues/122022), this doesn't create test issues because the tests fixed here don't create large aggregations any longer.",
      "created_at": "2025-02-07T21:05:47+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "server/src/test/java/org/elasticsearch/action/search/SearchResponseTests.java",
      "status": "modified",
      "additions": 21,
      "deletions": 3,
      "changes": 24,
      "patch": "@@ -43,6 +43,7 @@\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n+import java.util.function.Supplier;\n \n import static java.util.Collections.emptyList;\n import static java.util.Collections.singletonMap;\n@@ -144,7 +145,7 @@ static SearchResponse.Clusters randomClusters() {\n      * compare xContent, so we omit it here\n      */\n     public void testFromXContent() throws IOException {\n-        doFromXContentTestWithRandomFields(createTestItem(), false);\n+        doFromXContentTestWithRandomFields(this::createTestItem, false);\n     }\n \n     /**\n@@ -154,11 +155,16 @@ public void testFromXContent() throws IOException {\n      * fields to SearchHits, Aggregations etc... is tested in their own tests\n      */\n     public void testFromXContentWithRandomFields() throws IOException {\n-        doFromXContentTestWithRandomFields(createMinimalTestItem(), true);\n+        doFromXContentTestWithRandomFields(this::createMinimalTestItem, true);\n     }\n \n-    private void doFromXContentTestWithRandomFields(SearchResponse response, boolean addRandomFields) throws IOException {\n+    private void doFromXContentTestWithRandomFields(Supplier<SearchResponse> responseSupplier, boolean addRandomFields) throws IOException {\n+        SearchResponse response = responseSupplier.get();\n         XContentType xcontentType = randomFrom(XContentType.values());\n+        if (xcontentType.equals(XContentType.YAML) && isLargeResponse(response)) {\n+            // restrict YAML xContent response to < 3MB because of limit in snakeyaml input\n+            response = randomValueOtherThanMany(SearchResponseTests::isLargeResponse, responseSupplier);\n+        }\n         boolean humanReadable = randomBoolean();\n         final ToXContent.Params params = new ToXContent.MapParams(singletonMap(RestSearchAction.TYPED_KEYS_PARAM, \"true\"));\n         BytesReference originalBytes = toShuffledXContent(response, xcontentType, params, humanReadable);\n@@ -190,6 +196,10 @@ public void testFromXContentWithFailures() throws IOException {\n         }\n         SearchResponse response = createTestItem(failures);\n         XContentType xcontentType = randomFrom(XContentType.values());\n+        if (xcontentType.equals(XContentType.YAML) && isLargeResponse(response)) {\n+            // restrict YAML xContent response to < 3MB because of limit in snakeyaml input\n+            response = randomValueOtherThanMany(SearchResponseTests::isLargeResponse, () -> createTestItem(failures));\n+        }\n         final ToXContent.Params params = new ToXContent.MapParams(singletonMap(RestSearchAction.TYPED_KEYS_PARAM, \"true\"));\n         BytesReference originalBytes = toShuffledXContent(response, xcontentType, params, randomBoolean());\n         try (XContentParser parser = createParser(xcontentType.xContent(), originalBytes)) {\n@@ -216,6 +226,14 @@ public void testFromXContentWithFailures() throws IOException {\n         }\n     }\n \n+    /**\n+     * returns true if the response object string is larger than 3 MB since this might create issues with YAML\n+     * xContent parsing\n+     */\n+    private static boolean isLargeResponse(SearchResponse response) {\n+        return Strings.toString(response).length() > 3 * 1024 * 1024;\n+    }\n+\n     public void testToXContent() {\n         SearchHit hit = new SearchHit(1, \"id1\", new Text(\"type\"), Collections.emptyMap(), Collections.emptyMap());\n         hit.score(2.0f);"
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "patch": "@@ -9,6 +9,7 @@\n package org.elasticsearch.search.aggregations;\n \n import org.elasticsearch.common.ParsingException;\n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.bytes.BytesReference;\n import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.rest.action.search.RestSearchAction;\n@@ -207,6 +208,11 @@ private void parseAndAssert(boolean addRandomFields) throws IOException {\n         XContentType xContentType = randomFrom(XContentType.values());\n         final ToXContent.Params params = new ToXContent.MapParams(singletonMap(RestSearchAction.TYPED_KEYS_PARAM, \"true\"));\n         Aggregations aggregations = createTestInstance();\n+        if (xContentType.equals(XContentType.YAML) && isLargeAgg(aggregations)) {\n+            // restrict YAML xContent response to < 3MB because of limit in snakeyaml input\n+            aggregations = randomValueOtherThanMany(AggregationsTests::isLargeAgg, this::createTestInstance);\n+        }\n+\n         BytesReference originalBytes = toShuffledXContent(aggregations, xContentType, params, randomBoolean());\n         BytesReference mutated;\n         if (addRandomFields) {\n@@ -252,6 +258,14 @@ private void parseAndAssert(boolean addRandomFields) throws IOException {\n         }\n     }\n \n+    /**\n+     * returns true if the aggregation object string is larger than 3 MB since this might create issues with YAML\n+     * xContent parsing\n+     */\n+    private static boolean isLargeAgg(Aggregations agg) {\n+        return Strings.toString(agg).length() > 3 * 1024 * 1024;\n+    }\n+\n     public void testParsingExceptionOnUnknownAggregation() throws IOException {\n         XContentBuilder builder = XContentFactory.jsonBuilder();\n         builder.startObject();"
    }
  ],
  "diff": "diff --git a/server/src/test/java/org/elasticsearch/action/search/SearchResponseTests.java b/server/src/test/java/org/elasticsearch/action/search/SearchResponseTests.java\nindex 1b0b9c853f6ce..90591250f8058 100644\n--- a/server/src/test/java/org/elasticsearch/action/search/SearchResponseTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/search/SearchResponseTests.java\n@@ -43,6 +43,7 @@\n import java.util.ArrayList;\n import java.util.Collections;\n import java.util.List;\n+import java.util.function.Supplier;\n \n import static java.util.Collections.emptyList;\n import static java.util.Collections.singletonMap;\n@@ -144,7 +145,7 @@ static SearchResponse.Clusters randomClusters() {\n      * compare xContent, so we omit it here\n      */\n     public void testFromXContent() throws IOException {\n-        doFromXContentTestWithRandomFields(createTestItem(), false);\n+        doFromXContentTestWithRandomFields(this::createTestItem, false);\n     }\n \n     /**\n@@ -154,11 +155,16 @@ public void testFromXContent() throws IOException {\n      * fields to SearchHits, Aggregations etc... is tested in their own tests\n      */\n     public void testFromXContentWithRandomFields() throws IOException {\n-        doFromXContentTestWithRandomFields(createMinimalTestItem(), true);\n+        doFromXContentTestWithRandomFields(this::createMinimalTestItem, true);\n     }\n \n-    private void doFromXContentTestWithRandomFields(SearchResponse response, boolean addRandomFields) throws IOException {\n+    private void doFromXContentTestWithRandomFields(Supplier<SearchResponse> responseSupplier, boolean addRandomFields) throws IOException {\n+        SearchResponse response = responseSupplier.get();\n         XContentType xcontentType = randomFrom(XContentType.values());\n+        if (xcontentType.equals(XContentType.YAML) && isLargeResponse(response)) {\n+            // restrict YAML xContent response to < 3MB because of limit in snakeyaml input\n+            response = randomValueOtherThanMany(SearchResponseTests::isLargeResponse, responseSupplier);\n+        }\n         boolean humanReadable = randomBoolean();\n         final ToXContent.Params params = new ToXContent.MapParams(singletonMap(RestSearchAction.TYPED_KEYS_PARAM, \"true\"));\n         BytesReference originalBytes = toShuffledXContent(response, xcontentType, params, humanReadable);\n@@ -190,6 +196,10 @@ public void testFromXContentWithFailures() throws IOException {\n         }\n         SearchResponse response = createTestItem(failures);\n         XContentType xcontentType = randomFrom(XContentType.values());\n+        if (xcontentType.equals(XContentType.YAML) && isLargeResponse(response)) {\n+            // restrict YAML xContent response to < 3MB because of limit in snakeyaml input\n+            response = randomValueOtherThanMany(SearchResponseTests::isLargeResponse, () -> createTestItem(failures));\n+        }\n         final ToXContent.Params params = new ToXContent.MapParams(singletonMap(RestSearchAction.TYPED_KEYS_PARAM, \"true\"));\n         BytesReference originalBytes = toShuffledXContent(response, xcontentType, params, randomBoolean());\n         try (XContentParser parser = createParser(xcontentType.xContent(), originalBytes)) {\n@@ -216,6 +226,14 @@ public void testFromXContentWithFailures() throws IOException {\n         }\n     }\n \n+    /**\n+     * returns true if the response object string is larger than 3 MB since this might create issues with YAML\n+     * xContent parsing\n+     */\n+    private static boolean isLargeResponse(SearchResponse response) {\n+        return Strings.toString(response).length() > 3 * 1024 * 1024;\n+    }\n+\n     public void testToXContent() {\n         SearchHit hit = new SearchHit(1, \"id1\", new Text(\"type\"), Collections.emptyMap(), Collections.emptyMap());\n         hit.score(2.0f);\ndiff --git a/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java b/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java\nindex b80932381ab7f..e92d38d4f168c 100644\n--- a/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java\n+++ b/server/src/test/java/org/elasticsearch/search/aggregations/AggregationsTests.java\n@@ -9,6 +9,7 @@\n package org.elasticsearch.search.aggregations;\n \n import org.elasticsearch.common.ParsingException;\n+import org.elasticsearch.common.Strings;\n import org.elasticsearch.common.bytes.BytesReference;\n import org.elasticsearch.common.xcontent.XContentHelper;\n import org.elasticsearch.rest.action.search.RestSearchAction;\n@@ -207,6 +208,11 @@ private void parseAndAssert(boolean addRandomFields) throws IOException {\n         XContentType xContentType = randomFrom(XContentType.values());\n         final ToXContent.Params params = new ToXContent.MapParams(singletonMap(RestSearchAction.TYPED_KEYS_PARAM, \"true\"));\n         Aggregations aggregations = createTestInstance();\n+        if (xContentType.equals(XContentType.YAML) && isLargeAgg(aggregations)) {\n+            // restrict YAML xContent response to < 3MB because of limit in snakeyaml input\n+            aggregations = randomValueOtherThanMany(AggregationsTests::isLargeAgg, this::createTestInstance);\n+        }\n+\n         BytesReference originalBytes = toShuffledXContent(aggregations, xContentType, params, randomBoolean());\n         BytesReference mutated;\n         if (addRandomFields) {\n@@ -252,6 +258,14 @@ private void parseAndAssert(boolean addRandomFields) throws IOException {\n         }\n     }\n \n+    /**\n+     * returns true if the aggregation object string is larger than 3 MB since this might create issues with YAML\n+     * xContent parsing\n+     */\n+    private static boolean isLargeAgg(Aggregations agg) {\n+        return Strings.toString(agg).length() > 3 * 1024 * 1024;\n+    }\n+\n     public void testParsingExceptionOnUnknownAggregation() throws IOException {\n         XContentBuilder builder = XContentFactory.jsonBuilder();\n         builder.startObject();\n",
  "additions": 35,
  "deletions": 3,
  "changed_files": 2,
  "url": "https://github.com/elastic/elasticsearch/pull/122097",
  "mined_at": "2025-10-25T13:15:04.805382"
}