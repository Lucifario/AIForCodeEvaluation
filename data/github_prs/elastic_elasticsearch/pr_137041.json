{
  "id": 137041,
  "repository": "elastic/elasticsearch",
  "title": "ESQL: Precise definition for interface required in hoisting rules used for remote ENRICH",
  "body": "* Rename CardinalityPreserving -> Streaming\r\n* Reword the definition and give a precise, formal version of it so we can more easily check it against new commands.\r\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-23T16:04:08+00:00",
  "created_at": "2025-10-23T14:56:31+00:00",
  "updated_at": "2025-10-23T16:05:26+00:00",
  "author": "alex-spies",
  "reviewers": [
    "alex-spies",
    "smalyshev"
  ],
  "base_sha": "93d08aaf3dc6c1924e32e5500abcf14cf0c53815",
  "head_sha": "62ca52e10adcda4b04508021f4ac6c65cdc4c1d4",
  "review_comments": [
    {
      "user": "smalyshev",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T15:19:27+00:00"
    },
    {
      "user": "smalyshev",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-10-23T15:19:34+00:00"
    },
    {
      "user": "alex-spies",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T15:28:29+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-analytical-engine (Team:Analytics)",
      "created_at": "2025-10-23T14:56:56+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "## ðŸ’š Backport successful\n| Status | Branch | Result |\n|:------:|:------:|:------:|\n| âœ… |  [9.2](https://github.com/elastic/elasticsearch/pull/137048)  | [<img src=\"https://img.shields.io/github/pulls/detail/state/elastic/elasticsearch/137048\">](https://github.com/elastic/elasticsearch/pull/137048) |",
      "created_at": "2025-10-23T16:05:26+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichLimit.java",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "patch": "@@ -8,12 +8,12 @@\n package org.elasticsearch.xpack.esql.optimizer.rules.logical;\n \n import org.elasticsearch.xpack.esql.optimizer.LogicalOptimizerContext;\n-import org.elasticsearch.xpack.esql.plan.logical.CardinalityPreserving;\n import org.elasticsearch.xpack.esql.plan.logical.Enrich;\n import org.elasticsearch.xpack.esql.plan.logical.ExecutesOn;\n import org.elasticsearch.xpack.esql.plan.logical.Limit;\n import org.elasticsearch.xpack.esql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.esql.plan.logical.PipelineBreaker;\n+import org.elasticsearch.xpack.esql.plan.logical.Streaming;\n \n import java.util.Collections;\n import java.util.Comparator;\n@@ -46,8 +46,8 @@ protected LogicalPlan rule(Enrich en, LogicalOptimizerContext ctx) {\n                     seenLimits.add(l);\n                     return;\n                 }\n-                if ((p instanceof CardinalityPreserving) == false // can change the number of rows, so we can't just pull a limit from\n-                                                                  // under it\n+                if ((p instanceof Streaming) == false // can change the number of rows, so we can't just pull a limit from\n+                                                      // under it\n                     // this will fail the verifier anyway, so no need to continue\n                     || (p instanceof ExecutesOn ex && ex.executesOn() == ExecutesOn.ExecuteLocation.COORDINATOR)\n                 // This is essentially another remote enrich - let it take care of its own limits"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichTopN.java",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "patch": "@@ -15,13 +15,13 @@\n import org.elasticsearch.xpack.esql.core.expression.NamedExpression;\n import org.elasticsearch.xpack.esql.core.util.Holder;\n import org.elasticsearch.xpack.esql.expression.Order;\n-import org.elasticsearch.xpack.esql.plan.logical.CardinalityPreserving;\n import org.elasticsearch.xpack.esql.plan.logical.Enrich;\n import org.elasticsearch.xpack.esql.plan.logical.Eval;\n import org.elasticsearch.xpack.esql.plan.logical.ExecutesOn;\n import org.elasticsearch.xpack.esql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.esql.plan.logical.PipelineBreaker;\n import org.elasticsearch.xpack.esql.plan.logical.Project;\n+import org.elasticsearch.xpack.esql.plan.logical.Streaming;\n import org.elasticsearch.xpack.esql.plan.logical.TopN;\n import org.elasticsearch.xpack.esql.plan.logical.UnaryPlan;\n \n@@ -132,8 +132,8 @@ protected LogicalPlan rule(Enrich en) {\n                         return new Project(en.source(), copyTop, outputs);\n                     }\n                 }\n-                if ((plan instanceof CardinalityPreserving) == false // can change the number of rows, so we can't just pull a TopN from\n-                                                                     // under it\n+                if ((plan instanceof Streaming) == false // can change the number of rows, so we can't just pull a TopN from\n+                                                         // under it\n                     // this will fail the verifier anyway, so no need to continue\n                     || (plan instanceof ExecutesOn ex && ex.executesOn() == ExecutesOn.ExecuteLocation.COORDINATOR)\n                     // This is another remote Enrich, it can handle its own limits"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/CardinalityPreserving.java",
      "status": "removed",
      "additions": 0,
      "deletions": 34,
      "changes": 34,
      "patch": "@@ -1,34 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0; you may not use this file except in compliance with the Elastic License\n- * 2.0.\n- */\n-\n-package org.elasticsearch.xpack.esql.plan.logical;\n-\n-/**\n- * This interface marks a command which does not add or remove rows, and is neutral towards limit aggregation.\n- * This means that this sequence:\n- *  ```\n- *  ... LIMIT X | MY_COMMAND\n- *  ```\n- *  is safe to replace with this sequence:\n- *  ```\n- *  ... local LIMIT X | MY_COMMAND | LIMIT X\n- *  Where the local limit is applied only on the node.\n- *  ```\n- *  It is not true, for example, for WHERE:\n- *  ```\n- *  ... LIMIT X | WHERE side=\"dark\"\n- *  ```\n- *  If the first X rows do not contain any \"dark\" rows, the result is empty, however if we switch:\n- *  ```\n- *  ... local LIMIT X | WHERE side=\"dark\" | LIMIT X\n- *  ```\n- *  and we have N nodes, then the first N*X rows may contain \"dark\" rows, and the final result is not empty in this case.\n- * <br>\n- * This property is important for processing Limit and TopN with remote operations such as remote ENRICH, since it allows\n- * us to localize the limits without changing the semantics.\n- */\n-public interface CardinalityPreserving {}"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Drop.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -17,7 +17,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Drop extends UnaryPlan implements TelemetryAware, CardinalityPreserving, SortAgnostic {\n+public class Drop extends UnaryPlan implements TelemetryAware, Streaming, SortAgnostic {\n     private final List<NamedExpression> removals;\n \n     public Drop(Source source, LogicalPlan child, List<NamedExpression> removals) {"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Enrich.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -51,7 +51,7 @@ public class Enrich extends UnaryPlan\n         PostOptimizationVerificationAware.CoordinatorOnly,\n         PostAnalysisVerificationAware,\n         TelemetryAware,\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic,\n         ExecutesOn {\n     public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry("
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Eval.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -41,7 +41,7 @@ public class Eval extends UnaryPlan\n         GeneratingPlan<Eval>,\n         PostAnalysisVerificationAware,\n         TelemetryAware,\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic {\n     public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(LogicalPlan.class, \"Eval\", Eval::new);\n "
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Insist.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -18,7 +18,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Insist extends UnaryPlan implements SurrogateLogicalPlan, CardinalityPreserving {\n+public class Insist extends UnaryPlan implements SurrogateLogicalPlan, Streaming {\n     private final List<? extends Attribute> insistedAttributes;\n     private @Nullable List<Attribute> lazyOutput = null;\n "
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Keep.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -15,7 +15,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Keep extends Project implements TelemetryAware, CardinalityPreserving, SortAgnostic {\n+public class Keep extends Project implements TelemetryAware, Streaming, SortAgnostic {\n \n     public Keep(Source source, LogicalPlan child, List<? extends NamedExpression> projections) {\n         super(source, child, projections);"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Project.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -27,7 +27,7 @@\n /**\n  * A {@code Project} is a {@code Plan} with one child. In {@code FROM idx | KEEP x, y}, the {@code KEEP} statement is a Project.\n  */\n-public class Project extends UnaryPlan implements CardinalityPreserving, SortAgnostic {\n+public class Project extends UnaryPlan implements Streaming, SortAgnostic {\n     public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(LogicalPlan.class, \"Project\", Project::new);\n \n     private final List<? extends NamedExpression> projections;"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/RegexExtract.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -28,7 +28,7 @@ public abstract class RegexExtract extends UnaryPlan\n     implements\n         GeneratingPlan<RegexExtract>,\n         PostAnalysisVerificationAware,\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic {\n     protected final Expression input;\n     protected final List<Attribute> extractedFields;"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Rename.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -22,7 +22,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Rename extends UnaryPlan implements TelemetryAware, CardinalityPreserving, SortAgnostic {\n+public class Rename extends UnaryPlan implements TelemetryAware, Streaming, SortAgnostic {\n \n     private final List<Alias> renamings;\n "
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Streaming.java",
      "status": "added",
      "additions": 56,
      "deletions": 0,
      "changes": 56,
      "patch": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.plan.logical;\n+\n+/**\n+ * This interface marks commands which do not add or remove rows and aren't sensitive to the exact order of the rows.\n+ * This is required to decide whether a command is compatible with\n+ * {@link org.elasticsearch.xpack.esql.optimizer.rules.logical.HoistRemoteEnrichLimit} and\n+ * {@link org.elasticsearch.xpack.esql.optimizer.rules.logical.HoistRemoteEnrichTopN}.\n+ * <p>\n+ * For the most part, such commands can be thought of to be operating on a row-by-row basis. A more formal definition is that this command\n+ * can be run on data nodes and this sequence\n+ *  <pre>{@code\n+ *  ... LIMIT X | MY_COMMAND\n+ *  }</pre>\n+ *  is safe to be replaced by this sequence\n+ *  <pre>{@code\n+ *  ... local LIMIT X | MY_COMMAND | LIMIT X\n+ *  }</pre>\n+ *  where \"local\" means that it's correct to apply the limit only on the data node, without a corresponding reduction on the coordinator.\n+ *  See {@link Limit#local()}.\n+ *  <p>\n+ *  We also require the same condition to hold for {@code TopN}, that is, the following are equivalent\n+ *  <pre>{@code\n+ *  ... TOP N [field1, ..., fieldN] | MY_COMMAND\n+ *  ... local TOP N [field1, ..., fieldN] | MY_COMMAND | TOP N [field1, ..., fieldN]\n+ *  }</pre>\n+ *  as long as MY_COMMAND preserves the columns that we order by.\n+ *  <p>\n+ *  Most commands that satisfy this will also satisfy the simpler (but stronger) conditions that the following are equivalent:\n+ *  <pre>{@code\n+ *  ... LIMIT X | MY_COMMAND\n+ *  ... MY_COMMAND | LIMIT X\n+ *\n+ *  and\n+ *\n+ * ... TOP N [field1, ..., fieldN] | MY_COMMAND\n+ * ... | MY_COMMAND | TOP N [field1, ..., fieldN]\n+ *  }</pre>\n+ *  <p>\n+ *  It is not true, for example, for WHERE:\n+ *  <pre>{@code\n+ *  ... TOP X [field] | WHERE side=\"dark\"\n+ *  }</pre>\n+ *  If the first X rows do not contain any \"dark\" rows, the result is empty, however if we switch:\n+ *  <pre>{@code\n+ *  ... local TOP X [field] | WHERE side=\"dark\" | TOP X [field]\n+ *  }</pre>\n+ *  and we have N nodes, then the first N*X rows may contain \"dark\" rows, and the final result is not empty in this case.\n+ */\n+public interface Streaming {}"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/inference/InferencePlan.java",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "patch": "@@ -13,10 +13,10 @@\n import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.plan.GeneratingPlan;\n-import org.elasticsearch.xpack.esql.plan.logical.CardinalityPreserving;\n import org.elasticsearch.xpack.esql.plan.logical.ExecutesOn;\n import org.elasticsearch.xpack.esql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.esql.plan.logical.SortAgnostic;\n+import org.elasticsearch.xpack.esql.plan.logical.Streaming;\n import org.elasticsearch.xpack.esql.plan.logical.UnaryPlan;\n \n import java.io.IOException;\n@@ -25,7 +25,7 @@\n \n public abstract class InferencePlan<PlanType extends InferencePlan<PlanType>> extends UnaryPlan\n     implements\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic,\n         GeneratingPlan<InferencePlan<PlanType>>,\n         ExecutesOn.Coordinator {"
    }
  ],
  "diff": "diff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichLimit.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichLimit.java\nindex 8915777e3ec36..e6e46596bab10 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichLimit.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichLimit.java\n@@ -8,12 +8,12 @@\n package org.elasticsearch.xpack.esql.optimizer.rules.logical;\n \n import org.elasticsearch.xpack.esql.optimizer.LogicalOptimizerContext;\n-import org.elasticsearch.xpack.esql.plan.logical.CardinalityPreserving;\n import org.elasticsearch.xpack.esql.plan.logical.Enrich;\n import org.elasticsearch.xpack.esql.plan.logical.ExecutesOn;\n import org.elasticsearch.xpack.esql.plan.logical.Limit;\n import org.elasticsearch.xpack.esql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.esql.plan.logical.PipelineBreaker;\n+import org.elasticsearch.xpack.esql.plan.logical.Streaming;\n \n import java.util.Collections;\n import java.util.Comparator;\n@@ -46,8 +46,8 @@ protected LogicalPlan rule(Enrich en, LogicalOptimizerContext ctx) {\n                     seenLimits.add(l);\n                     return;\n                 }\n-                if ((p instanceof CardinalityPreserving) == false // can change the number of rows, so we can't just pull a limit from\n-                                                                  // under it\n+                if ((p instanceof Streaming) == false // can change the number of rows, so we can't just pull a limit from\n+                                                      // under it\n                     // this will fail the verifier anyway, so no need to continue\n                     || (p instanceof ExecutesOn ex && ex.executesOn() == ExecutesOn.ExecuteLocation.COORDINATOR)\n                 // This is essentially another remote enrich - let it take care of its own limits\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichTopN.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichTopN.java\nindex df13ca20b954b..7ddb464b50b0e 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichTopN.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/optimizer/rules/logical/HoistRemoteEnrichTopN.java\n@@ -15,13 +15,13 @@\n import org.elasticsearch.xpack.esql.core.expression.NamedExpression;\n import org.elasticsearch.xpack.esql.core.util.Holder;\n import org.elasticsearch.xpack.esql.expression.Order;\n-import org.elasticsearch.xpack.esql.plan.logical.CardinalityPreserving;\n import org.elasticsearch.xpack.esql.plan.logical.Enrich;\n import org.elasticsearch.xpack.esql.plan.logical.Eval;\n import org.elasticsearch.xpack.esql.plan.logical.ExecutesOn;\n import org.elasticsearch.xpack.esql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.esql.plan.logical.PipelineBreaker;\n import org.elasticsearch.xpack.esql.plan.logical.Project;\n+import org.elasticsearch.xpack.esql.plan.logical.Streaming;\n import org.elasticsearch.xpack.esql.plan.logical.TopN;\n import org.elasticsearch.xpack.esql.plan.logical.UnaryPlan;\n \n@@ -132,8 +132,8 @@ protected LogicalPlan rule(Enrich en) {\n                         return new Project(en.source(), copyTop, outputs);\n                     }\n                 }\n-                if ((plan instanceof CardinalityPreserving) == false // can change the number of rows, so we can't just pull a TopN from\n-                                                                     // under it\n+                if ((plan instanceof Streaming) == false // can change the number of rows, so we can't just pull a TopN from\n+                                                         // under it\n                     // this will fail the verifier anyway, so no need to continue\n                     || (plan instanceof ExecutesOn ex && ex.executesOn() == ExecutesOn.ExecuteLocation.COORDINATOR)\n                     // This is another remote Enrich, it can handle its own limits\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/CardinalityPreserving.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/CardinalityPreserving.java\ndeleted file mode 100644\nindex 89e554989db28..0000000000000\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/CardinalityPreserving.java\n+++ /dev/null\n@@ -1,34 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0; you may not use this file except in compliance with the Elastic License\n- * 2.0.\n- */\n-\n-package org.elasticsearch.xpack.esql.plan.logical;\n-\n-/**\n- * This interface marks a command which does not add or remove rows, and is neutral towards limit aggregation.\n- * This means that this sequence:\n- *  ```\n- *  ... LIMIT X | MY_COMMAND\n- *  ```\n- *  is safe to replace with this sequence:\n- *  ```\n- *  ... local LIMIT X | MY_COMMAND | LIMIT X\n- *  Where the local limit is applied only on the node.\n- *  ```\n- *  It is not true, for example, for WHERE:\n- *  ```\n- *  ... LIMIT X | WHERE side=\"dark\"\n- *  ```\n- *  If the first X rows do not contain any \"dark\" rows, the result is empty, however if we switch:\n- *  ```\n- *  ... local LIMIT X | WHERE side=\"dark\" | LIMIT X\n- *  ```\n- *  and we have N nodes, then the first N*X rows may contain \"dark\" rows, and the final result is not empty in this case.\n- * <br>\n- * This property is important for processing Limit and TopN with remote operations such as remote ENRICH, since it allows\n- * us to localize the limits without changing the semantics.\n- */\n-public interface CardinalityPreserving {}\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Drop.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Drop.java\nindex 6412aa1890994..b40b690514b92 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Drop.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Drop.java\n@@ -17,7 +17,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Drop extends UnaryPlan implements TelemetryAware, CardinalityPreserving, SortAgnostic {\n+public class Drop extends UnaryPlan implements TelemetryAware, Streaming, SortAgnostic {\n     private final List<NamedExpression> removals;\n \n     public Drop(Source source, LogicalPlan child, List<NamedExpression> removals) {\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Enrich.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Enrich.java\nindex 89d7c5ba81234..cf8b0b5d3e709 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Enrich.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Enrich.java\n@@ -51,7 +51,7 @@ public class Enrich extends UnaryPlan\n         PostOptimizationVerificationAware.CoordinatorOnly,\n         PostAnalysisVerificationAware,\n         TelemetryAware,\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic,\n         ExecutesOn {\n     public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Eval.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Eval.java\nindex d9ac0e720dd1f..33efd1d9d0806 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Eval.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Eval.java\n@@ -41,7 +41,7 @@ public class Eval extends UnaryPlan\n         GeneratingPlan<Eval>,\n         PostAnalysisVerificationAware,\n         TelemetryAware,\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic {\n     public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(LogicalPlan.class, \"Eval\", Eval::new);\n \ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Insist.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Insist.java\nindex 8601ef456bef9..63ca4e1099a5f 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Insist.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Insist.java\n@@ -18,7 +18,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Insist extends UnaryPlan implements SurrogateLogicalPlan, CardinalityPreserving {\n+public class Insist extends UnaryPlan implements SurrogateLogicalPlan, Streaming {\n     private final List<? extends Attribute> insistedAttributes;\n     private @Nullable List<Attribute> lazyOutput = null;\n \ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Keep.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Keep.java\nindex 4428e5a4ebe34..f680ef9fbc64e 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Keep.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Keep.java\n@@ -15,7 +15,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Keep extends Project implements TelemetryAware, CardinalityPreserving, SortAgnostic {\n+public class Keep extends Project implements TelemetryAware, Streaming, SortAgnostic {\n \n     public Keep(Source source, LogicalPlan child, List<? extends NamedExpression> projections) {\n         super(source, child, projections);\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Project.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Project.java\nindex 74a99a0212349..e9334b1f99fbc 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Project.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Project.java\n@@ -27,7 +27,7 @@\n /**\n  * A {@code Project} is a {@code Plan} with one child. In {@code FROM idx | KEEP x, y}, the {@code KEEP} statement is a Project.\n  */\n-public class Project extends UnaryPlan implements CardinalityPreserving, SortAgnostic {\n+public class Project extends UnaryPlan implements Streaming, SortAgnostic {\n     public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(LogicalPlan.class, \"Project\", Project::new);\n \n     private final List<? extends NamedExpression> projections;\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/RegexExtract.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/RegexExtract.java\nindex 04720da6dca26..9bb8e1a70e3f8 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/RegexExtract.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/RegexExtract.java\n@@ -28,7 +28,7 @@ public abstract class RegexExtract extends UnaryPlan\n     implements\n         GeneratingPlan<RegexExtract>,\n         PostAnalysisVerificationAware,\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic {\n     protected final Expression input;\n     protected final List<Attribute> extractedFields;\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Rename.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Rename.java\nindex 9fe49b50eeee3..e89319da3d1d4 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Rename.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Rename.java\n@@ -22,7 +22,7 @@\n import java.util.List;\n import java.util.Objects;\n \n-public class Rename extends UnaryPlan implements TelemetryAware, CardinalityPreserving, SortAgnostic {\n+public class Rename extends UnaryPlan implements TelemetryAware, Streaming, SortAgnostic {\n \n     private final List<Alias> renamings;\n \ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Streaming.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Streaming.java\nnew file mode 100644\nindex 0000000000000..e1e025aecc3a4\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/Streaming.java\n@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.plan.logical;\n+\n+/**\n+ * This interface marks commands which do not add or remove rows and aren't sensitive to the exact order of the rows.\n+ * This is required to decide whether a command is compatible with\n+ * {@link org.elasticsearch.xpack.esql.optimizer.rules.logical.HoistRemoteEnrichLimit} and\n+ * {@link org.elasticsearch.xpack.esql.optimizer.rules.logical.HoistRemoteEnrichTopN}.\n+ * <p>\n+ * For the most part, such commands can be thought of to be operating on a row-by-row basis. A more formal definition is that this command\n+ * can be run on data nodes and this sequence\n+ *  <pre>{@code\n+ *  ... LIMIT X | MY_COMMAND\n+ *  }</pre>\n+ *  is safe to be replaced by this sequence\n+ *  <pre>{@code\n+ *  ... local LIMIT X | MY_COMMAND | LIMIT X\n+ *  }</pre>\n+ *  where \"local\" means that it's correct to apply the limit only on the data node, without a corresponding reduction on the coordinator.\n+ *  See {@link Limit#local()}.\n+ *  <p>\n+ *  We also require the same condition to hold for {@code TopN}, that is, the following are equivalent\n+ *  <pre>{@code\n+ *  ... TOP N [field1, ..., fieldN] | MY_COMMAND\n+ *  ... local TOP N [field1, ..., fieldN] | MY_COMMAND | TOP N [field1, ..., fieldN]\n+ *  }</pre>\n+ *  as long as MY_COMMAND preserves the columns that we order by.\n+ *  <p>\n+ *  Most commands that satisfy this will also satisfy the simpler (but stronger) conditions that the following are equivalent:\n+ *  <pre>{@code\n+ *  ... LIMIT X | MY_COMMAND\n+ *  ... MY_COMMAND | LIMIT X\n+ *\n+ *  and\n+ *\n+ * ... TOP N [field1, ..., fieldN] | MY_COMMAND\n+ * ... | MY_COMMAND | TOP N [field1, ..., fieldN]\n+ *  }</pre>\n+ *  <p>\n+ *  It is not true, for example, for WHERE:\n+ *  <pre>{@code\n+ *  ... TOP X [field] | WHERE side=\"dark\"\n+ *  }</pre>\n+ *  If the first X rows do not contain any \"dark\" rows, the result is empty, however if we switch:\n+ *  <pre>{@code\n+ *  ... local TOP X [field] | WHERE side=\"dark\" | TOP X [field]\n+ *  }</pre>\n+ *  and we have N nodes, then the first N*X rows may contain \"dark\" rows, and the final result is not empty in this case.\n+ */\n+public interface Streaming {}\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/inference/InferencePlan.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/inference/InferencePlan.java\nindex 9756c0b5a8176..2b40bbebfbcd3 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/inference/InferencePlan.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/plan/logical/inference/InferencePlan.java\n@@ -13,10 +13,10 @@\n import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.plan.GeneratingPlan;\n-import org.elasticsearch.xpack.esql.plan.logical.CardinalityPreserving;\n import org.elasticsearch.xpack.esql.plan.logical.ExecutesOn;\n import org.elasticsearch.xpack.esql.plan.logical.LogicalPlan;\n import org.elasticsearch.xpack.esql.plan.logical.SortAgnostic;\n+import org.elasticsearch.xpack.esql.plan.logical.Streaming;\n import org.elasticsearch.xpack.esql.plan.logical.UnaryPlan;\n \n import java.io.IOException;\n@@ -25,7 +25,7 @@\n \n public abstract class InferencePlan<PlanType extends InferencePlan<PlanType>> extends UnaryPlan\n     implements\n-        CardinalityPreserving,\n+        Streaming,\n         SortAgnostic,\n         GeneratingPlan<InferencePlan<PlanType>>,\n         ExecutesOn.Coordinator {\n",
  "additions": 72,
  "deletions": 50,
  "changed_files": 13,
  "url": "https://github.com/elastic/elasticsearch/pull/137041",
  "mined_at": "2025-10-25T13:42:45.659973"
}