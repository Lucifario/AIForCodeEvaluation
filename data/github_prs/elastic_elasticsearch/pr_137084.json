{
  "id": 137084,
  "repository": "elastic/elasticsearch",
  "title": "[ML] Fix JobsAndModelsIT",
  "body": "This PR removes assertion `assertRecentLastTaskStateChangeTime` at the end of the test. \r\n\r\nThis assertion is not required for the core purpose of the test to verify that:\r\n- Jobs and models don't get allocated to the same node when they don't fit\r\n- Both eventually get allocated to different nodes when capacity allows\r\n\r\nAt the same time, it introduce the dependency on how busy the CI is when running the test. \r\n\r\nCloses [#103588](https://github.com/elastic/elasticsearch/issues/103588)",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T13:26:15+00:00",
  "created_at": "2025-10-24T08:45:55+00:00",
  "updated_at": "2025-10-24T13:27:42+00:00",
  "author": "valeriy42",
  "reviewers": [
    "copilot-pull-request-reviewer[bot]",
    "prwhelan"
  ],
  "base_sha": "7e9049e74cdc397431bb9203595c7434d20ffca2",
  "head_sha": "d3ca98f0263c72a4e37513ee759a6e234eff152d",
  "review_comments": [
    {
      "user": "copilot-pull-request-reviewer[bot]",
      "state": "COMMENTED",
      "body": "## Pull Request Overview\n\nThis PR fixes flaky test behavior in `JobsAndModelsIT` by removing a time-dependent assertion that was causing test instability. The test's core purposeâ€”verifying that jobs and models are properly allocated to different nodes when capacity constraints existâ€”is preserved, while the problematic timing assertion that introduced CI environment dependencies has been removed.\n\n**Key Changes:**\n- Removed the `@AwaitsFix` annotation marking the test as flaky\n- Removed the `assertRecentLastTaskStateChangeTime` call that caused timing-dependent failures\n- Cleaned up unused imports (`MlTasks`, `Duration`, `ChronoUnit`)\n\n\n\n\n\n---\n\n<sub>**Tip:** Customize your code reviews with copilot-instructions.md. <a href=\"/elastic/elasticsearch/new/main/.github?filename=copilot-instructions.md\" class=\"Link--inTextBlock\" target=\"_blank\" rel=\"noopener noreferrer\">Create the file</a> or <a href=\"https://docs.github.com/en/copilot/customizing-copilot/adding-repository-custom-instructions-for-github-copilot\" class=\"Link--inTextBlock\" target=\"_blank\" rel=\"noopener noreferrer\">learn how to get started</a>.</sub>",
      "submitted_at": "2025-10-24T09:26:02+00:00"
    },
    {
      "user": "prwhelan",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-10-24T13:18:42+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/ml-core (Team:ML)",
      "created_at": "2025-10-24T09:26:35+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "## ðŸ’š Backport successful\n| Status | Branch | Result |\n|:------:|:------:|:------:|\n| âœ… |  [9.2](https://github.com/elastic/elasticsearch/pull/137101)  | [<img src=\"https://img.shields.io/github/pulls/detail/state/elastic/elasticsearch/137101\">](https://github.com/elastic/elasticsearch/pull/137101) |\n| âœ… |  [9.1](https://github.com/elastic/elasticsearch/pull/137102)  | [<img src=\"https://img.shields.io/github/pulls/detail/state/elastic/elasticsearch/137102\">](https://github.com/elastic/elasticsearch/pull/137102) |",
      "created_at": "2025-10-24T13:27:42+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java",
      "status": "modified",
      "additions": 0,
      "deletions": 6,
      "changes": 6,
      "patch": "@@ -16,7 +16,6 @@\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.json.JsonXContent;\n-import org.elasticsearch.xpack.core.ml.MlTasks;\n import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n import org.elasticsearch.xpack.core.ml.action.GetJobsStatsAction;\n import org.elasticsearch.xpack.core.ml.action.GetTrainedModelsStatsAction;\n@@ -38,8 +37,6 @@\n import org.elasticsearch.xpack.ml.inference.persistence.TrainedModelDefinitionDoc;\n import org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase;\n \n-import java.time.Duration;\n-import java.time.temporal.ChronoUnit;\n import java.util.List;\n import java.util.Set;\n \n@@ -59,7 +56,6 @@\n @ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST, numDataNodes = 0)\n public class JobsAndModelsIT extends BaseMlIntegTestCase {\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/103588\")\n     public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_ShouldNotAllocateBothOnSameNode() throws Exception {\n         // This test starts 2 ML nodes and then starts an anomaly detection job and a\n         // trained model deployment that do not both fit in one node. We then proceed\n@@ -237,8 +233,6 @@ public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_Should\n             assertThat(jobStats.getNode(), is(not(equalTo(modelStats.getDeploymentStats().getNodeStats().get(0).getNode()))));\n         });\n \n-        assertRecentLastTaskStateChangeTime(MlTasks.jobTaskId(jobId), Duration.of(10, ChronoUnit.SECONDS), null);\n-\n         // Clean up\n         client().execute(CloseJobAction.INSTANCE, new CloseJobAction.Request(jobId).setForce(true)).actionGet();\n         client().execute(StopTrainedModelDeploymentAction.INSTANCE, new StopTrainedModelDeploymentAction.Request(model.getModelId()))"
    }
  ],
  "diff": "diff --git a/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java b/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java\nindex a1b001cb168ef..4a70759a04fc1 100644\n--- a/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java\n+++ b/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java\n@@ -16,7 +16,6 @@\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.json.JsonXContent;\n-import org.elasticsearch.xpack.core.ml.MlTasks;\n import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n import org.elasticsearch.xpack.core.ml.action.GetJobsStatsAction;\n import org.elasticsearch.xpack.core.ml.action.GetTrainedModelsStatsAction;\n@@ -38,8 +37,6 @@\n import org.elasticsearch.xpack.ml.inference.persistence.TrainedModelDefinitionDoc;\n import org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase;\n \n-import java.time.Duration;\n-import java.time.temporal.ChronoUnit;\n import java.util.List;\n import java.util.Set;\n \n@@ -59,7 +56,6 @@\n @ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST, numDataNodes = 0)\n public class JobsAndModelsIT extends BaseMlIntegTestCase {\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/103588\")\n     public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_ShouldNotAllocateBothOnSameNode() throws Exception {\n         // This test starts 2 ML nodes and then starts an anomaly detection job and a\n         // trained model deployment that do not both fit in one node. We then proceed\n@@ -237,8 +233,6 @@ public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_Should\n             assertThat(jobStats.getNode(), is(not(equalTo(modelStats.getDeploymentStats().getNodeStats().get(0).getNode()))));\n         });\n \n-        assertRecentLastTaskStateChangeTime(MlTasks.jobTaskId(jobId), Duration.of(10, ChronoUnit.SECONDS), null);\n-\n         // Clean up\n         client().execute(CloseJobAction.INSTANCE, new CloseJobAction.Request(jobId).setForce(true)).actionGet();\n         client().execute(StopTrainedModelDeploymentAction.INSTANCE, new StopTrainedModelDeploymentAction.Request(model.getModelId()))\n",
  "additions": 0,
  "deletions": 6,
  "changed_files": 1,
  "url": "https://github.com/elastic/elasticsearch/pull/137084",
  "mined_at": "2025-10-25T13:24:06.626476"
}