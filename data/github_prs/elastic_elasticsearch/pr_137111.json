{
  "id": 137111,
  "repository": "elastic/elasticsearch",
  "title": "Remove `auto_expand_replicas` setting during index clone in `searchable_snapshot`",
  "body": "In #133954, we modified the `searchable_snapshot` ILM action to clone the index with 0 replicas before performing the force-merge. We didn't take the `index.auto_expand_replicas` setting into account, which could result in the clone having indices after all. That's harmless, as it merely nullifies the optimization of that PR, but we should remove the setting to ensure we achieve the intended optimizations.",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T16:15:42+00:00",
  "created_at": "2025-10-24T14:51:02+00:00",
  "updated_at": "2025-10-24T16:16:53+00:00",
  "author": "nielsbauman",
  "reviewers": [
    "nielsbauman",
    "masseyke",
    "szybia"
  ],
  "base_sha": "4e2b41664b71c1ae34a7445618a25ede04d9c0ff",
  "head_sha": "dc1e9d88f328e355162817d6204a1e14e4d90c7f",
  "review_comments": [
    {
      "user": "szybia",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T15:08:02+00:00"
    },
    {
      "user": "masseyke",
      "state": "APPROVED",
      "body": "LGTM",
      "submitted_at": "2025-10-24T15:10:51+00:00"
    },
    {
      "user": "masseyke",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T15:11:48+00:00"
    },
    {
      "user": "nielsbauman",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T15:15:21+00:00"
    },
    {
      "user": "szybia",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T15:24:25+00:00"
    },
    {
      "user": "nielsbauman",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T15:27:23+00:00"
    },
    {
      "user": "masseyke",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T15:39:43+00:00"
    },
    {
      "user": "szybia",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-10-24T15:45:25+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-data-management (Team:Data Management)",
      "created_at": "2025-10-24T14:51:27+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "Hi @nielsbauman, I've created a changelog YAML for you.",
      "created_at": "2025-10-24T14:51:56+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "## ðŸ’š Backport successful\n| Status | Branch | Result |\n|:------:|:------:|:------:|\n| âœ… |  [9.2](https://github.com/elastic/elasticsearch/pull/137120)  | [<img src=\"https://img.shields.io/github/pulls/detail/state/elastic/elasticsearch/137120\">](https://github.com/elastic/elasticsearch/pull/137120) |",
      "created_at": "2025-10-24T16:16:53+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "docs/changelog/137111.yaml",
      "status": "added",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "patch": "@@ -0,0 +1,5 @@\n+pr: 137111\n+summary: Remove `auto_expand_replicas` setting during index clone in `searchable_snapshot`\n+area: ILM+SLM\n+type: bug\n+issues: []"
    },
    {
      "filename": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/SearchableSnapshotAction.java",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "patch": "@@ -78,7 +78,11 @@ public class SearchableSnapshotAction implements LifecycleAction {\n         indexName,\n         state) -> state.forceMergeCloneIndexName() != null ? state.forceMergeCloneIndexName() : indexName;\n \n-    private static final Settings CLONE_SETTINGS = Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0).build();\n+    /** The cloned index should have 0 replicas, so we also need to remove the auto_expand_replicas setting if present. */\n+    private static final Settings CLONE_SETTINGS = Settings.builder()\n+        .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+        .put(IndexMetadata.SETTING_AUTO_EXPAND_REPLICAS, (String) null)\n+        .build();\n     private static final Function<IndexMetadata, Settings> CLONE_SETTINGS_SUPPLIER = indexMetadata -> CLONE_SETTINGS;\n \n     private static final ConstructingObjectParser<SearchableSnapshotAction, Void> PARSER = new ConstructingObjectParser<>("
    },
    {
      "filename": "x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/actions/SearchableSnapshotActionIT.java",
      "status": "modified",
      "additions": 7,
      "deletions": 1,
      "changes": 8,
      "patch": "@@ -1033,11 +1033,17 @@ private String prepareDataStreamWithDocs(String phase, int numberOfPrimaries, in\n         createSnapshotRepo(client(), snapshotRepo, randomBoolean());\n         createNewSingletonPolicy(client(), policy, phase, new SearchableSnapshotAction(snapshotRepo, true));\n \n+        final var indexSettings = indexSettings(numberOfPrimaries, numberOfReplicas);\n+        // Randomly enable auto-expand replicas to test that we remove the setting for the clone with 0 replicas.\n+        if (numberOfReplicas > 0 && randomBoolean()) {\n+            logger.info(\"--> enabling auto-expand replicas on backing index\");\n+            indexSettings.put(IndexMetadata.SETTING_AUTO_EXPAND_REPLICAS, \"1-all\");\n+        }\n         createComposableTemplate(\n             client(),\n             randomAlphaOfLengthBetween(5, 10).toLowerCase(Locale.ROOT),\n             dataStream,\n-            new Template(indexSettings(numberOfPrimaries, numberOfReplicas).build(), null, null)\n+            new Template(indexSettings.build(), null, null)\n         );\n         for (int i = 0; i < randomIntBetween(5, 10); i++) {\n             indexDocument(client(), dataStream, true);"
    }
  ],
  "diff": "diff --git a/docs/changelog/137111.yaml b/docs/changelog/137111.yaml\nnew file mode 100644\nindex 0000000000000..3122a54e673ed\n--- /dev/null\n+++ b/docs/changelog/137111.yaml\n@@ -0,0 +1,5 @@\n+pr: 137111\n+summary: Remove `auto_expand_replicas` setting during index clone in `searchable_snapshot`\n+area: ILM+SLM\n+type: bug\n+issues: []\ndiff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/SearchableSnapshotAction.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/SearchableSnapshotAction.java\nindex d3c7b0cb52730..61d26dfa4af09 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/SearchableSnapshotAction.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/SearchableSnapshotAction.java\n@@ -78,7 +78,11 @@ public class SearchableSnapshotAction implements LifecycleAction {\n         indexName,\n         state) -> state.forceMergeCloneIndexName() != null ? state.forceMergeCloneIndexName() : indexName;\n \n-    private static final Settings CLONE_SETTINGS = Settings.builder().put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0).build();\n+    /** The cloned index should have 0 replicas, so we also need to remove the auto_expand_replicas setting if present. */\n+    private static final Settings CLONE_SETTINGS = Settings.builder()\n+        .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+        .put(IndexMetadata.SETTING_AUTO_EXPAND_REPLICAS, (String) null)\n+        .build();\n     private static final Function<IndexMetadata, Settings> CLONE_SETTINGS_SUPPLIER = indexMetadata -> CLONE_SETTINGS;\n \n     private static final ConstructingObjectParser<SearchableSnapshotAction, Void> PARSER = new ConstructingObjectParser<>(\ndiff --git a/x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/actions/SearchableSnapshotActionIT.java b/x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/actions/SearchableSnapshotActionIT.java\nindex 63108dd3cbcf6..df04dbc6a8a6c 100644\n--- a/x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/actions/SearchableSnapshotActionIT.java\n+++ b/x-pack/plugin/ilm/qa/multi-node/src/javaRestTest/java/org/elasticsearch/xpack/ilm/actions/SearchableSnapshotActionIT.java\n@@ -1033,11 +1033,17 @@ private String prepareDataStreamWithDocs(String phase, int numberOfPrimaries, in\n         createSnapshotRepo(client(), snapshotRepo, randomBoolean());\n         createNewSingletonPolicy(client(), policy, phase, new SearchableSnapshotAction(snapshotRepo, true));\n \n+        final var indexSettings = indexSettings(numberOfPrimaries, numberOfReplicas);\n+        // Randomly enable auto-expand replicas to test that we remove the setting for the clone with 0 replicas.\n+        if (numberOfReplicas > 0 && randomBoolean()) {\n+            logger.info(\"--> enabling auto-expand replicas on backing index\");\n+            indexSettings.put(IndexMetadata.SETTING_AUTO_EXPAND_REPLICAS, \"1-all\");\n+        }\n         createComposableTemplate(\n             client(),\n             randomAlphaOfLengthBetween(5, 10).toLowerCase(Locale.ROOT),\n             dataStream,\n-            new Template(indexSettings(numberOfPrimaries, numberOfReplicas).build(), null, null)\n+            new Template(indexSettings.build(), null, null)\n         );\n         for (int i = 0; i < randomIntBetween(5, 10); i++) {\n             indexDocument(client(), dataStream, true);\n",
  "additions": 17,
  "deletions": 2,
  "changed_files": 3,
  "url": "https://github.com/elastic/elasticsearch/pull/137111",
  "mined_at": "2025-10-25T13:16:51.949135"
}