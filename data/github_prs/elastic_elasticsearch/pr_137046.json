{
  "id": 137046,
  "repository": "elastic/elasticsearch",
  "title": "[9.1] Migrate watcher REST tests to new test framework. (#136690)",
  "body": "Backports the following commits to 9.1:\n - Migrate watcher REST tests to new test framework. (#136690)",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T11:25:40+00:00",
  "created_at": "2025-10-23T15:37:01+00:00",
  "updated_at": "2025-10-24T11:26:03+00:00",
  "author": "mosche",
  "reviewers": [],
  "base_sha": "5ac721097395631b395dd7128e29742a62cad710",
  "head_sha": "61361cc4a94b155edede94fcf664e446c2935b0b",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "build-tools-internal/src/main/java/org/elasticsearch/gradle/internal/RestrictedBuildApiService.java",
      "status": "modified",
      "additions": 0,
      "deletions": 2,
      "changes": 2,
      "patch": "@@ -92,8 +92,6 @@ private static ListMultimap<Class<?>, String> createLegacyRestTestBasePluginUsag\n         map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:transform:qa:multi-cluster-tests-with-security\");\n         map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:transform:qa:multi-node-tests\");\n         map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:transform:qa:single-node-tests\");\n-        map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:watcher:qa:rest\");\n-        map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:watcher:qa:with-security\");\n         return map;\n     }\n "
    },
    {
      "filename": "x-pack/plugin/watcher/build.gradle",
      "status": "modified",
      "additions": 30,
      "deletions": 3,
      "changes": 33,
      "patch": "@@ -1,11 +1,15 @@\n apply plugin: 'elasticsearch.internal-es-plugin'\n apply plugin: 'elasticsearch.internal-cluster-test'\n+apply plugin: 'elasticsearch.internal-java-rest-test'\n+apply plugin: 'elasticsearch.internal-yaml-rest-test'\n+apply plugin: 'elasticsearch.internal-test-artifact'\n+\n esplugin {\n   name = 'x-pack-watcher'\n   description = 'Elasticsearch Expanded Pack Plugin - Watcher'\n-  classname ='org.elasticsearch.xpack.watcher.Watcher'\n-  hasNativeController =false\n-  requiresKeystore =false\n+  classname = 'org.elasticsearch.xpack.watcher.Watcher'\n+  hasNativeController = false\n+  requiresKeystore = false\n   extendedPlugins = ['x-pack-core', 'lang-painless']\n }\n \n@@ -15,6 +19,16 @@ base {\n \n ext.compactProfile = 'full'\n \n+restResources {\n+  restApi {\n+    include '_common', 'cluster', 'index', 'indices', 'get', 'nodes', 'search', 'watcher', 'security', 'xpack',\n+      'put_script', 'ingest', 'count', 'xpack'\n+  }\n+  restTests {\n+    includeXpack 'watcher'\n+  }\n+}\n+\n tasks.named(\"dependencyLicenses\").configure {\n   mapping from: /owasp-java-html-sanitizer.*/, to: 'owasp-java-html-sanitizer'\n }\n@@ -44,6 +58,19 @@ dependencies {\n   testImplementation 'com.google.code.findbugs:jsr305:3.0.2'\n \n   internalClusterTestImplementation project(\":modules:analysis-common\")\n+\n+  javaRestTestImplementation project(':x-pack:qa')\n+  yamlRestTestImplementation project(':x-pack:qa')\n+\n+  clusterModules project(':modules:analysis-common')\n+  clusterModules project(':modules:ingest-common')\n+  clusterModules project(':modules:lang-mustache')\n+  clusterModules project(':modules:lang-painless')\n+  clusterModules project(xpackModule('ilm'))\n+}\n+\n+artifacts {\n+  restXpackTests(new File(projectDir, \"src/yamlRestTest/resources/rest-api-spec/test\"))\n }\n \n // classes are missing, e.g. com.ibm.icu.lang.UCharacter"
    },
    {
      "filename": "x-pack/plugin/watcher/qa/build.gradle",
      "status": "removed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/qa/common/build.gradle",
      "status": "removed",
      "additions": 0,
      "deletions": 6,
      "changes": 6,
      "patch": "@@ -1,6 +0,0 @@\n-apply plugin: 'elasticsearch.java'\n-\n-dependencies {\n-  implementation project(':test:yaml-rest-runner')\n-}\n-"
    },
    {
      "filename": "x-pack/plugin/watcher/qa/rest/build.gradle",
      "status": "removed",
      "additions": 0,
      "deletions": 42,
      "changes": 42,
      "patch": "@@ -1,42 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0; you may not use this file except in compliance with the Elastic License\n- * 2.0.\n- */\n-\n-apply plugin: 'elasticsearch.legacy-java-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-compat-test'\n-\n-dependencies {\n-  yamlRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(':x-pack:qa')\n-}\n-\n-artifacts {\n-  restXpackTests(new File(projectDir, \"src/yamlRestTest/resources/rest-api-spec/test\"))\n-}\n-\n-restResources {\n-  restApi {\n-    include '_common', 'cluster', 'nodes', 'search', 'get', 'indices',\n-                'index', 'put_script', 'ingest', 'count', 'watcher', 'xpack'\n-  }\n-}\n-\n-testClusters.configureEach {\n-  testDistribution = 'DEFAULT'\n-  setting 'xpack.security.enabled', 'false'\n-  setting 'xpack.ml.enabled', 'false'\n-  setting 'xpack.license.self_generated.type', 'trial'\n-  setting 'logger.org.elasticsearch.xpack.watcher', 'DEBUG'\n-}\n-\n-if (buildParams.inFipsJvm){\n-  // Test clusters run with security disabled\n-  tasks.named(\"javaRestTest\").configure{enabled = false }\n-  tasks.named(\"yamlRestTest\").configure{enabled = false }\n-}\n-"
    },
    {
      "filename": "x-pack/plugin/watcher/qa/with-security/build.gradle",
      "status": "removed",
      "additions": 0,
      "deletions": 39,
      "changes": 39,
      "patch": "@@ -1,39 +0,0 @@\n-apply plugin: 'elasticsearch.legacy-java-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-compat-test'\n-\n-dependencies {\n-  yamlRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(':x-pack:qa')\n-  yamlRestTestImplementation project(':x-pack:qa')\n-  restXpackTestConfig project(path: ':x-pack:plugin:watcher:qa:rest', configuration: 'restXpackTests')\n-}\n-\n-restResources {\n-  restApi {\n-    include '_common', 'cluster', 'index', 'indices', 'get', 'nodes', 'search', 'watcher', 'security', 'xpack'\n-  }\n-  restTests {\n-    includeXpack 'watcher'\n-  }\n-}\n-\n-testClusters.configureEach {\n-  testDistribution = 'DEFAULT'\n-  setting 'xpack.ml.enabled', 'false'\n-  setting 'xpack.security.enabled', 'true'\n-  // settings to test settings filtering on\n-  setting 'xpack.notification.email.account._email.smtp.host', 'host.domain'\n-  setting 'xpack.notification.email.account._email.smtp.port', '587'\n-  setting 'xpack.notification.email.account._email.smtp.user', '_user'\n-  keystore 'xpack.notification.email.account._email.smtp.secure_password', '_passwd'\n-  setting 'xpack.license.self_generated.type', 'trial'\n-  setting 'logger.org.elasticsearch.xpack.watcher', 'debug'\n-  setting 'logger.org.elasticsearch.xpack.core.watcher', 'debug'\n-  rolesFile file('roles.yml')\n-  user username: \"test_admin\", password: \"x-pack-test-password\"\n-  user username: \"x_pack_rest_user\", password: \"x-pack-test-password\", role: \"watcher_manager\"\n-  user username: \"watcher_manager\", password: \"x-pack-test-password\", role: \"watcher_manager\"\n-  user username: \"powerless_user\", password: \"x-pack-test-password\", role: \"crappy_role\"\n-}"
    },
    {
      "filename": "x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityClientYamlTestSuiteIT.java",
      "status": "removed",
      "additions": 0,
      "deletions": 53,
      "changes": 53,
      "patch": "@@ -1,53 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0; you may not use this file except in compliance with the Elastic License\n- * 2.0.\n- */\n-package org.elasticsearch.smoketest;\n-\n-import com.carrotsearch.randomizedtesting.annotations.Name;\n-import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n-\n-import org.elasticsearch.client.Request;\n-import org.elasticsearch.common.settings.SecureString;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.util.concurrent.ThreadContext;\n-import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n-import org.elasticsearch.xpack.watcher.WatcherYamlSuiteTestCase;\n-import org.junit.Before;\n-\n-public class SmokeTestWatcherWithSecurityClientYamlTestSuiteIT extends WatcherYamlSuiteTestCase {\n-\n-    private static final String TEST_ADMIN_USERNAME = \"test_admin\";\n-    private static final String TEST_ADMIN_PASSWORD = \"x-pack-test-password\";\n-\n-    public SmokeTestWatcherWithSecurityClientYamlTestSuiteIT(@Name(\"yaml\") ClientYamlTestCandidate testCandidate) {\n-        super(testCandidate);\n-    }\n-\n-    @ParametersFactory\n-    public static Iterable<Object[]> parameters() throws Exception {\n-        return createParameters();\n-    }\n-\n-    @Before\n-    public void beforeTest() throws Exception {\n-        // create one document in this index, so we can test in the YAML tests, that the index cannot be accessed\n-        Request request = new Request(\"PUT\", \"/index_not_allowed_to_read/_doc/1\");\n-        request.setJsonEntity(\"{\\\"foo\\\":\\\"bar\\\"}\");\n-        adminClient().performRequest(request);\n-    }\n-\n-    @Override\n-    protected Settings restClientSettings() {\n-        String token = basicAuthHeaderValue(\"watcher_manager\", new SecureString(\"x-pack-test-password\".toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n-    @Override\n-    protected Settings restAdminSettings() {\n-        String token = basicAuthHeaderValue(TEST_ADMIN_USERNAME, new SecureString(TEST_ADMIN_PASSWORD.toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-}"
    },
    {
      "filename": "x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java",
      "status": "renamed",
      "additions": 8,
      "deletions": 17,
      "changes": 25,
      "patch": "@@ -10,13 +10,11 @@\n import org.elasticsearch.client.Response;\n import org.elasticsearch.client.ResponseException;\n import org.elasticsearch.common.Strings;\n-import org.elasticsearch.common.settings.SecureString;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n import org.elasticsearch.test.rest.ObjectPath;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.XContentType;\n-import org.elasticsearch.xpack.watcher.WatcherRestTestCase;\n+import org.junit.ClassRule;\n \n import java.io.IOException;\n import java.util.Map;\n@@ -31,19 +29,12 @@\n \n public class SmokeTestWatcherTestSuiteIT extends WatcherRestTestCase {\n \n-    private static final String TEST_ADMIN_USERNAME = \"test_admin\";\n-    private static final String TEST_ADMIN_PASSWORD = \"x-pack-test-password\";\n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().build();\n \n     @Override\n-    protected Settings restClientSettings() {\n-        String token = basicAuthHeaderValue(\"watcher_manager\", new SecureString(\"x-pack-test-password\".toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n-    @Override\n-    protected Settings restAdminSettings() {\n-        String token = basicAuthHeaderValue(TEST_ADMIN_USERNAME, new SecureString(TEST_ADMIN_PASSWORD.toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n     }\n \n     @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/52453\")\n@@ -79,8 +70,8 @@ public void testMonitorClusterHealth() throws Exception {\n                 .field(\"scheme\", \"http\")\n                 .startObject(\"auth\")\n                 .startObject(\"basic\")\n-                .field(\"username\", TEST_ADMIN_USERNAME)\n-                .field(\"password\", TEST_ADMIN_PASSWORD)\n+                .field(\"username\", ADMIN_USER)\n+                .field(\"password\", TEST_PASSWORD)\n                 .endObject()\n                 .endObject()\n                 .endObject()"
    },
    {
      "filename": "x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java",
      "status": "renamed",
      "additions": 14,
      "deletions": 19,
      "changes": 33,
      "patch": "@@ -11,13 +11,12 @@\n import org.elasticsearch.client.Response;\n import org.elasticsearch.client.ResponseException;\n import org.elasticsearch.common.Strings;\n-import org.elasticsearch.common.settings.SecureString;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.util.resource.Resource;\n import org.elasticsearch.test.rest.ObjectPath;\n import org.elasticsearch.xcontent.XContentBuilder;\n-import org.elasticsearch.xpack.watcher.WatcherRestTestCase;\n import org.junit.Before;\n+import org.junit.ClassRule;\n \n import java.io.IOException;\n import java.util.Map;\n@@ -31,11 +30,19 @@\n \n public class SmokeTestWatcherWithSecurityIT extends WatcherRestTestCase {\n \n-    private static final String TEST_ADMIN_USERNAME = \"test_admin\";\n-    private static final String TEST_ADMIN_PASSWORD = \"x-pack-test-password\";\n-\n     private String watchId = randomAlphaOfLength(20);\n \n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().setting(\"xpack.security.enabled\", \"true\")\n+        .rolesFile(Resource.fromClasspath(\"roles.yml\"))\n+        .user(WATCHER_USER, TEST_PASSWORD, \"watcher_manager\", false)\n+        .build();\n+\n+    @Override\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n+    }\n+\n     @Before\n     public void beforeTest() throws Exception {\n         Request deleteRequest = new Request(\"DELETE\", \"/my_test_index\");\n@@ -53,18 +60,6 @@ public void beforeTest() throws Exception {\n         adminClient().performRequest(createNotAllowedDoc);\n     }\n \n-    @Override\n-    protected Settings restClientSettings() {\n-        String token = basicAuthHeaderValue(\"watcher_manager\", new SecureString(\"x-pack-test-password\".toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n-    @Override\n-    protected Settings restAdminSettings() {\n-        String token = basicAuthHeaderValue(TEST_ADMIN_USERNAME, new SecureString(TEST_ADMIN_PASSWORD.toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n     public void testSearchInputHasPermissions() throws Exception {\n         try (XContentBuilder builder = jsonBuilder()) {\n             builder.startObject();"
    },
    {
      "filename": "x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/WatcherRestTestCase.java",
      "status": "renamed",
      "additions": 36,
      "deletions": 1,
      "changes": 37,
      "patch": "@@ -4,11 +4,16 @@\n  * 2.0; you may not use this file except in compliance with the Elastic License\n  * 2.0.\n  */\n-package org.elasticsearch.xpack.watcher;\n+package org.elasticsearch.smoketest;\n \n import org.elasticsearch.client.Request;\n import org.elasticsearch.client.Response;\n+import org.elasticsearch.common.settings.SecureString;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.local.LocalClusterSpecBuilder;\n import org.elasticsearch.test.rest.ESRestTestCase;\n import org.elasticsearch.test.rest.ObjectPath;\n import org.junit.After;\n@@ -26,6 +31,36 @@\n  */\n public abstract class WatcherRestTestCase extends ESRestTestCase {\n \n+    static final String ADMIN_USER = \"test_admin\";\n+    static final String WATCHER_USER = \"watcher_manager\";\n+    static final String TEST_PASSWORD = \"x-pack-test-password\";\n+\n+    static LocalClusterSpecBuilder<ElasticsearchCluster> watcherClusterSpec() {\n+        return ElasticsearchCluster.local()\n+            .module(\"x-pack-watcher\")\n+            .module(\"x-pack-ilm\")\n+            .module(\"ingest-common\")\n+            .module(\"analysis-common\")\n+            .module(\"lang-mustache\")\n+            .setting(\"xpack.ml.enabled\", \"false\")\n+            .setting(\"xpack.license.self_generated.type\", \"trial\")\n+            .setting(\"logger.org.elasticsearch.xpack.watcher\", \"debug\")\n+            .setting(\"logger.org.elasticsearch.xpack.core.watcher\", \"debug\")\n+            .user(ADMIN_USER, TEST_PASSWORD, \"superuser\", true);\n+    }\n+\n+    @Override\n+    protected Settings restClientSettings() {\n+        String token = basicAuthHeaderValue(WATCHER_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n+    @Override\n+    protected Settings restAdminSettings() {\n+        String token = basicAuthHeaderValue(ADMIN_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n     @Before\n     public final void startWatcher() throws Exception {\n         ESTestCase.assertBusy(() -> {"
    },
    {
      "filename": "x-pack/plugin/watcher/src/javaRestTest/resources/roles.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java",
      "status": "renamed",
      "additions": 17,
      "deletions": 1,
      "changes": 18,
      "patch": "@@ -6,8 +6,11 @@\n  */\n package org.elasticsearch.smoketest;\n \n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n-import org.elasticsearch.xpack.watcher.WatcherYamlSuiteTestCase;\n+import org.junit.ClassRule;\n \n /**\n  * Runs the YAML rest tests against an external cluster\n@@ -16,4 +19,17 @@ public class WatcherYamlRestIT extends WatcherYamlSuiteTestCase {\n     public WatcherYamlRestIT(ClientYamlTestCandidate testCandidate) {\n         super(testCandidate);\n     }\n+\n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().build();\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() throws Exception {\n+        return createParameters(new String[] { \"mustache\", \"painless\", \"watcher\" });\n+    }\n+\n+    @Override\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n+    }\n }"
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestWithSecurityIT.java",
      "status": "added",
      "additions": 54,
      "deletions": 0,
      "changes": 54,
      "patch": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+package org.elasticsearch.smoketest;\n+\n+import com.carrotsearch.randomizedtesting.annotations.Name;\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.util.resource.Resource;\n+import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+\n+public class WatcherYamlRestWithSecurityIT extends WatcherYamlSuiteTestCase {\n+\n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().setting(\"xpack.security.enabled\", \"true\")\n+        .rolesFile(Resource.fromClasspath(\"roles.yml\"))\n+        .user(WATCHER_USER, TEST_PASSWORD, \"watcher_manager\", false)\n+        .user(\"x_pack_rest_user\", TEST_PASSWORD, \"watcher_manager\", false)\n+        // settings to test settings filtering on\n+        .setting(\"xpack.notification.email.account._email.smtp.host\", \"host.domain\")\n+        .setting(\"xpack.notification.email.account._email.smtp.port\", \"587\")\n+        .setting(\"xpack.notification.email.account._email.smtp.user\", \"_user\")\n+        .keystore(\"xpack.notification.email.account._email.smtp.secure_password\", \"_passwd\")\n+        .build();\n+\n+    @Override\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n+    }\n+\n+    public WatcherYamlRestWithSecurityIT(@Name(\"yaml\") ClientYamlTestCandidate testCandidate) {\n+        super(testCandidate);\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() throws Exception {\n+        return createParameters(new String[] { \"security\" });\n+    }\n+\n+    @Before\n+    public void beforeTest() throws Exception {\n+        // create one document in this index, so we can test in the YAML tests, that the index cannot be accessed\n+        Request request = new Request(\"PUT\", \"/index_not_allowed_to_read/_doc/1\");\n+        request.setJsonEntity(\"{\\\"foo\\\":\\\"bar\\\"}\");\n+        adminClient().performRequest(request);\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlSuiteTestCase.java",
      "status": "renamed",
      "additions": 59,
      "deletions": 2,
      "changes": 61,
      "patch": "@@ -4,23 +4,31 @@\n  * 2.0; you may not use this file except in compliance with the Elastic License\n  * 2.0.\n  */\n-package org.elasticsearch.xpack.watcher;\n+package org.elasticsearch.smoketest;\n \n import com.carrotsearch.randomizedtesting.annotations.Name;\n import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n \n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.common.settings.SecureString;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.local.LocalClusterSpecBuilder;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+import org.elasticsearch.test.rest.ObjectPath;\n import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n import org.elasticsearch.test.rest.yaml.ClientYamlTestResponse;\n import org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase;\n import org.junit.After;\n import org.junit.Before;\n \n+import java.io.IOException;\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.TimeUnit;\n \n-import static org.elasticsearch.xpack.watcher.WatcherRestTestCase.deleteAllWatcherData;\n import static org.hamcrest.Matchers.is;\n \n /**\n@@ -31,11 +39,42 @@ public WatcherYamlSuiteTestCase(@Name(\"yaml\") ClientYamlTestCandidate testCandid\n         super(testCandidate);\n     }\n \n+    static final String ADMIN_USER = \"test_admin\";\n+    static final String WATCHER_USER = \"watcher_manager\";\n+    static final String TEST_PASSWORD = \"x-pack-test-password\";\n+\n+    static LocalClusterSpecBuilder<ElasticsearchCluster> watcherClusterSpec() {\n+        return ElasticsearchCluster.local()\n+            .module(\"x-pack-watcher\")\n+            .module(\"x-pack-ilm\")\n+            .module(\"ingest-common\")\n+            .module(\"analysis-common\")\n+            .module(\"lang-mustache\")\n+            .module(\"lang-painless\")\n+            .setting(\"xpack.ml.enabled\", \"false\")\n+            .setting(\"xpack.license.self_generated.type\", \"trial\")\n+            .setting(\"logger.org.elasticsearch.xpack.watcher\", \"debug\")\n+            .setting(\"logger.org.elasticsearch.xpack.core.watcher\", \"debug\")\n+            .user(ADMIN_USER, TEST_PASSWORD, \"superuser\", true);\n+    }\n+\n     @ParametersFactory\n     public static Iterable<Object[]> parameters() throws Exception {\n         return ESClientYamlSuiteTestCase.createParameters();\n     }\n \n+    @Override\n+    protected Settings restClientSettings() {\n+        String token = basicAuthHeaderValue(WATCHER_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n+    @Override\n+    protected Settings restAdminSettings() {\n+        String token = basicAuthHeaderValue(ADMIN_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n     @Before\n     public final void startWatcher() throws Exception {\n         ESTestCase.assertBusy(() -> {\n@@ -93,4 +132,22 @@ public final void stopWatcher() throws Exception {\n         }, 60, TimeUnit.SECONDS);\n         deleteAllWatcherData();\n     }\n+\n+    static void deleteAllWatcherData() throws IOException {\n+        var queryWatchesRequest = new Request(\"GET\", \"/_watcher/_query/watches\");\n+        var response = ObjectPath.createFromResponse(ESRestTestCase.adminClient().performRequest(queryWatchesRequest));\n+\n+        int totalCount = response.evaluate(\"count\");\n+        List<Map<?, ?>> watches = response.evaluate(\"watches\");\n+        assert watches.size() == totalCount : \"number of watches returned is unequal to the total number of watches\";\n+        for (Map<?, ?> watch : watches) {\n+            String id = (String) watch.get(\"_id\");\n+            var deleteWatchRequest = new Request(\"DELETE\", \"/_watcher/watch/\" + id);\n+            assertOK(ESRestTestCase.adminClient().performRequest(deleteWatchRequest));\n+        }\n+\n+        var deleteWatchHistoryRequest = new Request(\"DELETE\", \".watcher-history-*\");\n+        deleteWatchHistoryRequest.addParameter(\"ignore_unavailable\", \"true\");\n+        ESRestTestCase.adminClient().performRequest(deleteWatchHistoryRequest);\n+    }\n }"
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/10_webhook.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/20_array_access.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/25_array_compare.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/30_search_input.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/40_search_transform.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/50_webhook_url_escaping.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/60_template_with_params.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/20_minimal_body.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/30_inline_watch.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/40_exception.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/50_update_scripts.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/60_chain_input_with_transform.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/70_json_in_watch.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/10_insufficient_privs.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/20_settings_filter.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/20_test_run_as_execute_watch.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/20_ack_individual_action.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/30_reset_ack_after_unmet_condition.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/40_reset_ack_after_unmet_action_condition.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/20_transform.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/30_throttled.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/40_ignore_condition.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/50_action_mode.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/60_http_input.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/70_invalid.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/80_foreach.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/90_painless_sha.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/20_missing.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/30_with_chain_input.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/11_timezoned_schedules.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/20_put_watch_with_throttle_period.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/30_put_watch_with_action_throttle_period.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/40_put_watch_as_inactive.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/50_email_attachment_validation.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/60_put_watch_with_action_condition.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/70_put_watch_with_index_action_using_id.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_auto_create_index.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_ensure_watch_gets_overwritten_without_version.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/91_search_total_hits_as_int.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/92_put_watch_with_indices_options.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/93_put_watch_with_reporting_interval.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/query_watches/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/settings_endpoints/10_watcher_settings.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/start_watcher/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/stats/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/stop_watcher/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/usage/10_basic.yml",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "patch": null
    },
    {
      "filename": "x-pack/plugin/watcher/src/yamlRestTest/resources/roles.yml",
      "status": "added",
      "additions": 40,
      "deletions": 0,
      "changes": 40,
      "patch": "@@ -0,0 +1,40 @@\n+admin:\n+  cluster:\n+    - all\n+  indices:\n+    - names: '*'\n+      privileges:\n+        - all\n+\n+watcher_manager:\n+  cluster:\n+    - manage\n+  indices:\n+    - names: '.watch*'\n+      privileges:\n+        - all\n+    # this index gets created by one of the watcher yaml tests\n+    # and is needed for a search transform, so we have to create it as part of the test\n+    - names: 'my_test_index'\n+      privileges:\n+        - all\n+  run_as:\n+    - powerless_user\n+    - watcher_manager\n+    - x_pack_rest_user\n+\n+watcher_monitor:\n+  cluster:\n+    - monitor\n+  indices:\n+    - names: '.watcher-history-*'\n+      privileges:\n+        - read\n+\n+crappy_role:\n+  cluster:\n+    - cluster:monitor/nodes/info\n+    - cluster:monitor/health\n+    - cluster:monitor/nodes/liveness\n+    - cluster:monitor/main\n+"
    },
    {
      "filename": "x-pack/rest-resources-zip/build.gradle",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -30,7 +30,7 @@ dependencies {\n   platinumTests project(path: ':x-pack:plugin:eql:qa:rest', configuration: 'restXpackTests')\n   platinumTests project(path: ':x-pack:plugin:ent-search', configuration: 'restXpackTests')\n   platinumTests project(path: ':x-pack:plugin:inference', configuration: 'restXpackTests')\n-  platinumTests project(path: ':x-pack:plugin:watcher:qa:rest', configuration: 'restXpackTests')\n+  platinumTests project(path: ':x-pack:plugin:watcher', configuration: 'restXpackTests')\n   platinumCompatTests project(path: ':x-pack:plugin', configuration: 'restCompatTests')\n   platinumCompatTests project(path: ':x-pack:plugin:eql:qa:rest', configuration: 'restCompatTests')\n }"
    }
  ],
  "diff": "diff --git a/build-tools-internal/src/main/java/org/elasticsearch/gradle/internal/RestrictedBuildApiService.java b/build-tools-internal/src/main/java/org/elasticsearch/gradle/internal/RestrictedBuildApiService.java\nindex 4e9f08bc48f38..d6f6e07f78c88 100644\n--- a/build-tools-internal/src/main/java/org/elasticsearch/gradle/internal/RestrictedBuildApiService.java\n+++ b/build-tools-internal/src/main/java/org/elasticsearch/gradle/internal/RestrictedBuildApiService.java\n@@ -92,8 +92,6 @@ private static ListMultimap<Class<?>, String> createLegacyRestTestBasePluginUsag\n         map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:transform:qa:multi-cluster-tests-with-security\");\n         map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:transform:qa:multi-node-tests\");\n         map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:transform:qa:single-node-tests\");\n-        map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:watcher:qa:rest\");\n-        map.put(LegacyRestTestBasePlugin.class, \":x-pack:plugin:watcher:qa:with-security\");\n         return map;\n     }\n \ndiff --git a/x-pack/plugin/watcher/build.gradle b/x-pack/plugin/watcher/build.gradle\nindex f541ca4be58c5..a4ea624b9553d 100644\n--- a/x-pack/plugin/watcher/build.gradle\n+++ b/x-pack/plugin/watcher/build.gradle\n@@ -1,11 +1,15 @@\n apply plugin: 'elasticsearch.internal-es-plugin'\n apply plugin: 'elasticsearch.internal-cluster-test'\n+apply plugin: 'elasticsearch.internal-java-rest-test'\n+apply plugin: 'elasticsearch.internal-yaml-rest-test'\n+apply plugin: 'elasticsearch.internal-test-artifact'\n+\n esplugin {\n   name = 'x-pack-watcher'\n   description = 'Elasticsearch Expanded Pack Plugin - Watcher'\n-  classname ='org.elasticsearch.xpack.watcher.Watcher'\n-  hasNativeController =false\n-  requiresKeystore =false\n+  classname = 'org.elasticsearch.xpack.watcher.Watcher'\n+  hasNativeController = false\n+  requiresKeystore = false\n   extendedPlugins = ['x-pack-core', 'lang-painless']\n }\n \n@@ -15,6 +19,16 @@ base {\n \n ext.compactProfile = 'full'\n \n+restResources {\n+  restApi {\n+    include '_common', 'cluster', 'index', 'indices', 'get', 'nodes', 'search', 'watcher', 'security', 'xpack',\n+      'put_script', 'ingest', 'count', 'xpack'\n+  }\n+  restTests {\n+    includeXpack 'watcher'\n+  }\n+}\n+\n tasks.named(\"dependencyLicenses\").configure {\n   mapping from: /owasp-java-html-sanitizer.*/, to: 'owasp-java-html-sanitizer'\n }\n@@ -44,6 +58,19 @@ dependencies {\n   testImplementation 'com.google.code.findbugs:jsr305:3.0.2'\n \n   internalClusterTestImplementation project(\":modules:analysis-common\")\n+\n+  javaRestTestImplementation project(':x-pack:qa')\n+  yamlRestTestImplementation project(':x-pack:qa')\n+\n+  clusterModules project(':modules:analysis-common')\n+  clusterModules project(':modules:ingest-common')\n+  clusterModules project(':modules:lang-mustache')\n+  clusterModules project(':modules:lang-painless')\n+  clusterModules project(xpackModule('ilm'))\n+}\n+\n+artifacts {\n+  restXpackTests(new File(projectDir, \"src/yamlRestTest/resources/rest-api-spec/test\"))\n }\n \n // classes are missing, e.g. com.ibm.icu.lang.UCharacter\ndiff --git a/x-pack/plugin/watcher/qa/build.gradle b/x-pack/plugin/watcher/qa/build.gradle\ndeleted file mode 100644\nindex e69de29bb2d1d..0000000000000\ndiff --git a/x-pack/plugin/watcher/qa/common/build.gradle b/x-pack/plugin/watcher/qa/common/build.gradle\ndeleted file mode 100644\nindex fdf48dbad255c..0000000000000\n--- a/x-pack/plugin/watcher/qa/common/build.gradle\n+++ /dev/null\n@@ -1,6 +0,0 @@\n-apply plugin: 'elasticsearch.java'\n-\n-dependencies {\n-  implementation project(':test:yaml-rest-runner')\n-}\n-\ndiff --git a/x-pack/plugin/watcher/qa/rest/build.gradle b/x-pack/plugin/watcher/qa/rest/build.gradle\ndeleted file mode 100644\nindex 2d5fc8349b5e0..0000000000000\n--- a/x-pack/plugin/watcher/qa/rest/build.gradle\n+++ /dev/null\n@@ -1,42 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0; you may not use this file except in compliance with the Elastic License\n- * 2.0.\n- */\n-\n-apply plugin: 'elasticsearch.legacy-java-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-compat-test'\n-\n-dependencies {\n-  yamlRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(':x-pack:qa')\n-}\n-\n-artifacts {\n-  restXpackTests(new File(projectDir, \"src/yamlRestTest/resources/rest-api-spec/test\"))\n-}\n-\n-restResources {\n-  restApi {\n-    include '_common', 'cluster', 'nodes', 'search', 'get', 'indices',\n-                'index', 'put_script', 'ingest', 'count', 'watcher', 'xpack'\n-  }\n-}\n-\n-testClusters.configureEach {\n-  testDistribution = 'DEFAULT'\n-  setting 'xpack.security.enabled', 'false'\n-  setting 'xpack.ml.enabled', 'false'\n-  setting 'xpack.license.self_generated.type', 'trial'\n-  setting 'logger.org.elasticsearch.xpack.watcher', 'DEBUG'\n-}\n-\n-if (buildParams.inFipsJvm){\n-  // Test clusters run with security disabled\n-  tasks.named(\"javaRestTest\").configure{enabled = false }\n-  tasks.named(\"yamlRestTest\").configure{enabled = false }\n-}\n-\ndiff --git a/x-pack/plugin/watcher/qa/with-security/build.gradle b/x-pack/plugin/watcher/qa/with-security/build.gradle\ndeleted file mode 100644\nindex 5c01573e09417..0000000000000\n--- a/x-pack/plugin/watcher/qa/with-security/build.gradle\n+++ /dev/null\n@@ -1,39 +0,0 @@\n-apply plugin: 'elasticsearch.legacy-java-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-test'\n-apply plugin: 'elasticsearch.legacy-yaml-rest-compat-test'\n-\n-dependencies {\n-  yamlRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(path: ':x-pack:plugin:watcher:qa:common')\n-  javaRestTestImplementation project(':x-pack:qa')\n-  yamlRestTestImplementation project(':x-pack:qa')\n-  restXpackTestConfig project(path: ':x-pack:plugin:watcher:qa:rest', configuration: 'restXpackTests')\n-}\n-\n-restResources {\n-  restApi {\n-    include '_common', 'cluster', 'index', 'indices', 'get', 'nodes', 'search', 'watcher', 'security', 'xpack'\n-  }\n-  restTests {\n-    includeXpack 'watcher'\n-  }\n-}\n-\n-testClusters.configureEach {\n-  testDistribution = 'DEFAULT'\n-  setting 'xpack.ml.enabled', 'false'\n-  setting 'xpack.security.enabled', 'true'\n-  // settings to test settings filtering on\n-  setting 'xpack.notification.email.account._email.smtp.host', 'host.domain'\n-  setting 'xpack.notification.email.account._email.smtp.port', '587'\n-  setting 'xpack.notification.email.account._email.smtp.user', '_user'\n-  keystore 'xpack.notification.email.account._email.smtp.secure_password', '_passwd'\n-  setting 'xpack.license.self_generated.type', 'trial'\n-  setting 'logger.org.elasticsearch.xpack.watcher', 'debug'\n-  setting 'logger.org.elasticsearch.xpack.core.watcher', 'debug'\n-  rolesFile file('roles.yml')\n-  user username: \"test_admin\", password: \"x-pack-test-password\"\n-  user username: \"x_pack_rest_user\", password: \"x-pack-test-password\", role: \"watcher_manager\"\n-  user username: \"watcher_manager\", password: \"x-pack-test-password\", role: \"watcher_manager\"\n-  user username: \"powerless_user\", password: \"x-pack-test-password\", role: \"crappy_role\"\n-}\ndiff --git a/x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityClientYamlTestSuiteIT.java b/x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityClientYamlTestSuiteIT.java\ndeleted file mode 100644\nindex 78e2f8ad8cd7f..0000000000000\n--- a/x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityClientYamlTestSuiteIT.java\n+++ /dev/null\n@@ -1,53 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0; you may not use this file except in compliance with the Elastic License\n- * 2.0.\n- */\n-package org.elasticsearch.smoketest;\n-\n-import com.carrotsearch.randomizedtesting.annotations.Name;\n-import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n-\n-import org.elasticsearch.client.Request;\n-import org.elasticsearch.common.settings.SecureString;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.util.concurrent.ThreadContext;\n-import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n-import org.elasticsearch.xpack.watcher.WatcherYamlSuiteTestCase;\n-import org.junit.Before;\n-\n-public class SmokeTestWatcherWithSecurityClientYamlTestSuiteIT extends WatcherYamlSuiteTestCase {\n-\n-    private static final String TEST_ADMIN_USERNAME = \"test_admin\";\n-    private static final String TEST_ADMIN_PASSWORD = \"x-pack-test-password\";\n-\n-    public SmokeTestWatcherWithSecurityClientYamlTestSuiteIT(@Name(\"yaml\") ClientYamlTestCandidate testCandidate) {\n-        super(testCandidate);\n-    }\n-\n-    @ParametersFactory\n-    public static Iterable<Object[]> parameters() throws Exception {\n-        return createParameters();\n-    }\n-\n-    @Before\n-    public void beforeTest() throws Exception {\n-        // create one document in this index, so we can test in the YAML tests, that the index cannot be accessed\n-        Request request = new Request(\"PUT\", \"/index_not_allowed_to_read/_doc/1\");\n-        request.setJsonEntity(\"{\\\"foo\\\":\\\"bar\\\"}\");\n-        adminClient().performRequest(request);\n-    }\n-\n-    @Override\n-    protected Settings restClientSettings() {\n-        String token = basicAuthHeaderValue(\"watcher_manager\", new SecureString(\"x-pack-test-password\".toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n-    @Override\n-    protected Settings restAdminSettings() {\n-        String token = basicAuthHeaderValue(TEST_ADMIN_USERNAME, new SecureString(TEST_ADMIN_PASSWORD.toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-}\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java b/x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java\nsimilarity index 90%\nrename from x-pack/plugin/watcher/qa/rest/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java\nrename to x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java\nindex d201ee13a05c8..6b6946fa48a32 100644\n--- a/x-pack/plugin/watcher/qa/rest/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java\n+++ b/x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherTestSuiteIT.java\n@@ -10,13 +10,11 @@\n import org.elasticsearch.client.Response;\n import org.elasticsearch.client.ResponseException;\n import org.elasticsearch.common.Strings;\n-import org.elasticsearch.common.settings.SecureString;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n import org.elasticsearch.test.rest.ObjectPath;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.XContentType;\n-import org.elasticsearch.xpack.watcher.WatcherRestTestCase;\n+import org.junit.ClassRule;\n \n import java.io.IOException;\n import java.util.Map;\n@@ -31,19 +29,12 @@\n \n public class SmokeTestWatcherTestSuiteIT extends WatcherRestTestCase {\n \n-    private static final String TEST_ADMIN_USERNAME = \"test_admin\";\n-    private static final String TEST_ADMIN_PASSWORD = \"x-pack-test-password\";\n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().build();\n \n     @Override\n-    protected Settings restClientSettings() {\n-        String token = basicAuthHeaderValue(\"watcher_manager\", new SecureString(\"x-pack-test-password\".toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n-    @Override\n-    protected Settings restAdminSettings() {\n-        String token = basicAuthHeaderValue(TEST_ADMIN_USERNAME, new SecureString(TEST_ADMIN_PASSWORD.toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n     }\n \n     @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/52453\")\n@@ -79,8 +70,8 @@ public void testMonitorClusterHealth() throws Exception {\n                 .field(\"scheme\", \"http\")\n                 .startObject(\"auth\")\n                 .startObject(\"basic\")\n-                .field(\"username\", TEST_ADMIN_USERNAME)\n-                .field(\"password\", TEST_ADMIN_PASSWORD)\n+                .field(\"username\", ADMIN_USER)\n+                .field(\"password\", TEST_PASSWORD)\n                 .endObject()\n                 .endObject()\n                 .endObject()\ndiff --git a/x-pack/plugin/watcher/qa/with-security/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java b/x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java\nsimilarity index 94%\nrename from x-pack/plugin/watcher/qa/with-security/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java\nrename to x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java\nindex a0d2560aa2406..0284d4b4bc500 100644\n--- a/x-pack/plugin/watcher/qa/with-security/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java\n+++ b/x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java\n@@ -11,13 +11,12 @@\n import org.elasticsearch.client.Response;\n import org.elasticsearch.client.ResponseException;\n import org.elasticsearch.common.Strings;\n-import org.elasticsearch.common.settings.SecureString;\n-import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.util.resource.Resource;\n import org.elasticsearch.test.rest.ObjectPath;\n import org.elasticsearch.xcontent.XContentBuilder;\n-import org.elasticsearch.xpack.watcher.WatcherRestTestCase;\n import org.junit.Before;\n+import org.junit.ClassRule;\n \n import java.io.IOException;\n import java.util.Map;\n@@ -31,11 +30,19 @@\n \n public class SmokeTestWatcherWithSecurityIT extends WatcherRestTestCase {\n \n-    private static final String TEST_ADMIN_USERNAME = \"test_admin\";\n-    private static final String TEST_ADMIN_PASSWORD = \"x-pack-test-password\";\n-\n     private String watchId = randomAlphaOfLength(20);\n \n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().setting(\"xpack.security.enabled\", \"true\")\n+        .rolesFile(Resource.fromClasspath(\"roles.yml\"))\n+        .user(WATCHER_USER, TEST_PASSWORD, \"watcher_manager\", false)\n+        .build();\n+\n+    @Override\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n+    }\n+\n     @Before\n     public void beforeTest() throws Exception {\n         Request deleteRequest = new Request(\"DELETE\", \"/my_test_index\");\n@@ -53,18 +60,6 @@ public void beforeTest() throws Exception {\n         adminClient().performRequest(createNotAllowedDoc);\n     }\n \n-    @Override\n-    protected Settings restClientSettings() {\n-        String token = basicAuthHeaderValue(\"watcher_manager\", new SecureString(\"x-pack-test-password\".toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n-    @Override\n-    protected Settings restAdminSettings() {\n-        String token = basicAuthHeaderValue(TEST_ADMIN_USERNAME, new SecureString(TEST_ADMIN_PASSWORD.toCharArray()));\n-        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n-    }\n-\n     public void testSearchInputHasPermissions() throws Exception {\n         try (XContentBuilder builder = jsonBuilder()) {\n             builder.startObject();\ndiff --git a/x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java b/x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/WatcherRestTestCase.java\nsimilarity index 72%\nrename from x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java\nrename to x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/WatcherRestTestCase.java\nindex 19f1133e4f14f..95e6a09dc5bde 100644\n--- a/x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java\n+++ b/x-pack/plugin/watcher/src/javaRestTest/java/org/elasticsearch/smoketest/WatcherRestTestCase.java\n@@ -4,11 +4,16 @@\n  * 2.0; you may not use this file except in compliance with the Elastic License\n  * 2.0.\n  */\n-package org.elasticsearch.xpack.watcher;\n+package org.elasticsearch.smoketest;\n \n import org.elasticsearch.client.Request;\n import org.elasticsearch.client.Response;\n+import org.elasticsearch.common.settings.SecureString;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.local.LocalClusterSpecBuilder;\n import org.elasticsearch.test.rest.ESRestTestCase;\n import org.elasticsearch.test.rest.ObjectPath;\n import org.junit.After;\n@@ -26,6 +31,36 @@\n  */\n public abstract class WatcherRestTestCase extends ESRestTestCase {\n \n+    static final String ADMIN_USER = \"test_admin\";\n+    static final String WATCHER_USER = \"watcher_manager\";\n+    static final String TEST_PASSWORD = \"x-pack-test-password\";\n+\n+    static LocalClusterSpecBuilder<ElasticsearchCluster> watcherClusterSpec() {\n+        return ElasticsearchCluster.local()\n+            .module(\"x-pack-watcher\")\n+            .module(\"x-pack-ilm\")\n+            .module(\"ingest-common\")\n+            .module(\"analysis-common\")\n+            .module(\"lang-mustache\")\n+            .setting(\"xpack.ml.enabled\", \"false\")\n+            .setting(\"xpack.license.self_generated.type\", \"trial\")\n+            .setting(\"logger.org.elasticsearch.xpack.watcher\", \"debug\")\n+            .setting(\"logger.org.elasticsearch.xpack.core.watcher\", \"debug\")\n+            .user(ADMIN_USER, TEST_PASSWORD, \"superuser\", true);\n+    }\n+\n+    @Override\n+    protected Settings restClientSettings() {\n+        String token = basicAuthHeaderValue(WATCHER_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n+    @Override\n+    protected Settings restAdminSettings() {\n+        String token = basicAuthHeaderValue(ADMIN_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n     @Before\n     public final void startWatcher() throws Exception {\n         ESTestCase.assertBusy(() -> {\ndiff --git a/x-pack/plugin/watcher/qa/with-security/roles.yml b/x-pack/plugin/watcher/src/javaRestTest/resources/roles.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/with-security/roles.yml\nrename to x-pack/plugin/watcher/src/javaRestTest/resources/roles.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java b/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java\nsimilarity index 52%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java\nrename to x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java\nindex 368a30ece9405..255df7be55722 100644\n--- a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java\n+++ b/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestIT.java\n@@ -6,8 +6,11 @@\n  */\n package org.elasticsearch.smoketest;\n \n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n-import org.elasticsearch.xpack.watcher.WatcherYamlSuiteTestCase;\n+import org.junit.ClassRule;\n \n /**\n  * Runs the YAML rest tests against an external cluster\n@@ -16,4 +19,17 @@ public class WatcherYamlRestIT extends WatcherYamlSuiteTestCase {\n     public WatcherYamlRestIT(ClientYamlTestCandidate testCandidate) {\n         super(testCandidate);\n     }\n+\n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().build();\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() throws Exception {\n+        return createParameters(new String[] { \"mustache\", \"painless\", \"watcher\" });\n+    }\n+\n+    @Override\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n+    }\n }\ndiff --git a/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestWithSecurityIT.java b/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestWithSecurityIT.java\nnew file mode 100644\nindex 0000000000000..8120349e6d6e3\n--- /dev/null\n+++ b/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlRestWithSecurityIT.java\n@@ -0,0 +1,54 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+package org.elasticsearch.smoketest;\n+\n+import com.carrotsearch.randomizedtesting.annotations.Name;\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.util.resource.Resource;\n+import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+\n+public class WatcherYamlRestWithSecurityIT extends WatcherYamlSuiteTestCase {\n+\n+    @ClassRule\n+    public static ElasticsearchCluster cluster = watcherClusterSpec().setting(\"xpack.security.enabled\", \"true\")\n+        .rolesFile(Resource.fromClasspath(\"roles.yml\"))\n+        .user(WATCHER_USER, TEST_PASSWORD, \"watcher_manager\", false)\n+        .user(\"x_pack_rest_user\", TEST_PASSWORD, \"watcher_manager\", false)\n+        // settings to test settings filtering on\n+        .setting(\"xpack.notification.email.account._email.smtp.host\", \"host.domain\")\n+        .setting(\"xpack.notification.email.account._email.smtp.port\", \"587\")\n+        .setting(\"xpack.notification.email.account._email.smtp.user\", \"_user\")\n+        .keystore(\"xpack.notification.email.account._email.smtp.secure_password\", \"_passwd\")\n+        .build();\n+\n+    @Override\n+    protected String getTestRestCluster() {\n+        return cluster.getHttpAddresses();\n+    }\n+\n+    public WatcherYamlRestWithSecurityIT(@Name(\"yaml\") ClientYamlTestCandidate testCandidate) {\n+        super(testCandidate);\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() throws Exception {\n+        return createParameters(new String[] { \"security\" });\n+    }\n+\n+    @Before\n+    public void beforeTest() throws Exception {\n+        // create one document in this index, so we can test in the YAML tests, that the index cannot be accessed\n+        Request request = new Request(\"PUT\", \"/index_not_allowed_to_read/_doc/1\");\n+        request.setJsonEntity(\"{\\\"foo\\\":\\\"bar\\\"}\");\n+        adminClient().performRequest(request);\n+    }\n+}\ndiff --git a/x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherYamlSuiteTestCase.java b/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlSuiteTestCase.java\nsimilarity index 59%\nrename from x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherYamlSuiteTestCase.java\nrename to x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlSuiteTestCase.java\nindex ddcf976c84572..631b7bbc7d168 100644\n--- a/x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherYamlSuiteTestCase.java\n+++ b/x-pack/plugin/watcher/src/yamlRestTest/java/org/elasticsearch/smoketest/WatcherYamlSuiteTestCase.java\n@@ -4,23 +4,31 @@\n  * 2.0; you may not use this file except in compliance with the Elastic License\n  * 2.0.\n  */\n-package org.elasticsearch.xpack.watcher;\n+package org.elasticsearch.smoketest;\n \n import com.carrotsearch.randomizedtesting.annotations.Name;\n import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n \n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.common.settings.SecureString;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.test.cluster.ElasticsearchCluster;\n+import org.elasticsearch.test.cluster.local.LocalClusterSpecBuilder;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+import org.elasticsearch.test.rest.ObjectPath;\n import org.elasticsearch.test.rest.yaml.ClientYamlTestCandidate;\n import org.elasticsearch.test.rest.yaml.ClientYamlTestResponse;\n import org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase;\n import org.junit.After;\n import org.junit.Before;\n \n+import java.io.IOException;\n import java.util.List;\n import java.util.Map;\n import java.util.concurrent.TimeUnit;\n \n-import static org.elasticsearch.xpack.watcher.WatcherRestTestCase.deleteAllWatcherData;\n import static org.hamcrest.Matchers.is;\n \n /**\n@@ -31,11 +39,42 @@ public WatcherYamlSuiteTestCase(@Name(\"yaml\") ClientYamlTestCandidate testCandid\n         super(testCandidate);\n     }\n \n+    static final String ADMIN_USER = \"test_admin\";\n+    static final String WATCHER_USER = \"watcher_manager\";\n+    static final String TEST_PASSWORD = \"x-pack-test-password\";\n+\n+    static LocalClusterSpecBuilder<ElasticsearchCluster> watcherClusterSpec() {\n+        return ElasticsearchCluster.local()\n+            .module(\"x-pack-watcher\")\n+            .module(\"x-pack-ilm\")\n+            .module(\"ingest-common\")\n+            .module(\"analysis-common\")\n+            .module(\"lang-mustache\")\n+            .module(\"lang-painless\")\n+            .setting(\"xpack.ml.enabled\", \"false\")\n+            .setting(\"xpack.license.self_generated.type\", \"trial\")\n+            .setting(\"logger.org.elasticsearch.xpack.watcher\", \"debug\")\n+            .setting(\"logger.org.elasticsearch.xpack.core.watcher\", \"debug\")\n+            .user(ADMIN_USER, TEST_PASSWORD, \"superuser\", true);\n+    }\n+\n     @ParametersFactory\n     public static Iterable<Object[]> parameters() throws Exception {\n         return ESClientYamlSuiteTestCase.createParameters();\n     }\n \n+    @Override\n+    protected Settings restClientSettings() {\n+        String token = basicAuthHeaderValue(WATCHER_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n+    @Override\n+    protected Settings restAdminSettings() {\n+        String token = basicAuthHeaderValue(ADMIN_USER, new SecureString(TEST_PASSWORD.toCharArray()));\n+        return Settings.builder().put(ThreadContext.PREFIX + \".Authorization\", token).build();\n+    }\n+\n     @Before\n     public final void startWatcher() throws Exception {\n         ESTestCase.assertBusy(() -> {\n@@ -93,4 +132,22 @@ public final void stopWatcher() throws Exception {\n         }, 60, TimeUnit.SECONDS);\n         deleteAllWatcherData();\n     }\n+\n+    static void deleteAllWatcherData() throws IOException {\n+        var queryWatchesRequest = new Request(\"GET\", \"/_watcher/_query/watches\");\n+        var response = ObjectPath.createFromResponse(ESRestTestCase.adminClient().performRequest(queryWatchesRequest));\n+\n+        int totalCount = response.evaluate(\"count\");\n+        List<Map<?, ?>> watches = response.evaluate(\"watches\");\n+        assert watches.size() == totalCount : \"number of watches returned is unequal to the total number of watches\";\n+        for (Map<?, ?> watch : watches) {\n+            String id = (String) watch.get(\"_id\");\n+            var deleteWatchRequest = new Request(\"DELETE\", \"/_watcher/watch/\" + id);\n+            assertOK(ESRestTestCase.adminClient().performRequest(deleteWatchRequest));\n+        }\n+\n+        var deleteWatchHistoryRequest = new Request(\"DELETE\", \".watcher-history-*\");\n+        deleteWatchHistoryRequest.addParameter(\"ignore_unavailable\", \"true\");\n+        ESRestTestCase.adminClient().performRequest(deleteWatchHistoryRequest);\n+    }\n }\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/10_webhook.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/10_webhook.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/10_webhook.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/10_webhook.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/20_array_access.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/20_array_access.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/20_array_access.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/20_array_access.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/25_array_compare.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/25_array_compare.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/25_array_compare.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/25_array_compare.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/30_search_input.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/30_search_input.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/30_search_input.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/30_search_input.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/40_search_transform.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/40_search_transform.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/40_search_transform.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/40_search_transform.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/50_webhook_url_escaping.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/50_webhook_url_escaping.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/50_webhook_url_escaping.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/50_webhook_url_escaping.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/60_template_with_params.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/60_template_with_params.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/mustache/60_template_with_params.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/mustache/60_template_with_params.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/20_minimal_body.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/20_minimal_body.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/20_minimal_body.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/20_minimal_body.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/30_inline_watch.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/30_inline_watch.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/30_inline_watch.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/30_inline_watch.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/40_exception.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/40_exception.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/40_exception.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/40_exception.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/50_update_scripts.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/50_update_scripts.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/50_update_scripts.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/50_update_scripts.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/60_chain_input_with_transform.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/60_chain_input_with_transform.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/60_chain_input_with_transform.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/60_chain_input_with_transform.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/70_json_in_watch.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/70_json_in_watch.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/painless/70_json_in_watch.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/painless/70_json_in_watch.yml\ndiff --git a/x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/resources/rest-api-spec/test/watcher/security/10_insufficient_privs.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/10_insufficient_privs.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/resources/rest-api-spec/test/watcher/security/10_insufficient_privs.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/10_insufficient_privs.yml\ndiff --git a/x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/resources/rest-api-spec/test/watcher/security/20_settings_filter.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/20_settings_filter.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/resources/rest-api-spec/test/watcher/security/20_settings_filter.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/20_settings_filter.yml\ndiff --git a/x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/resources/rest-api-spec/test/watcher/security/20_test_run_as_execute_watch.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/20_test_run_as_execute_watch.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/with-security/src/yamlRestTest/resources/rest-api-spec/test/watcher/security/20_test_run_as_execute_watch.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/security/20_test_run_as_execute_watch.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/20_ack_individual_action.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/20_ack_individual_action.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/20_ack_individual_action.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/20_ack_individual_action.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/30_reset_ack_after_unmet_condition.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/30_reset_ack_after_unmet_condition.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/30_reset_ack_after_unmet_condition.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/30_reset_ack_after_unmet_condition.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/40_reset_ack_after_unmet_action_condition.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/40_reset_ack_after_unmet_action_condition.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/40_reset_ack_after_unmet_action_condition.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/ack_watch/40_reset_ack_after_unmet_action_condition.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/activate_watch/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/delete_watch/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/20_transform.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/20_transform.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/20_transform.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/20_transform.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/30_throttled.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/30_throttled.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/30_throttled.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/30_throttled.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/40_ignore_condition.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/40_ignore_condition.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/40_ignore_condition.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/40_ignore_condition.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/50_action_mode.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/50_action_mode.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/50_action_mode.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/50_action_mode.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/60_http_input.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/60_http_input.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/60_http_input.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/60_http_input.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/70_invalid.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/70_invalid.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/70_invalid.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/70_invalid.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/80_foreach.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/80_foreach.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/80_foreach.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/80_foreach.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/90_painless_sha.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/90_painless_sha.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/90_painless_sha.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/execute_watch/90_painless_sha.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/20_missing.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/20_missing.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/20_missing.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/20_missing.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/30_with_chain_input.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/30_with_chain_input.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/30_with_chain_input.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/get_watch/30_with_chain_input.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/11_timezoned_schedules.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/11_timezoned_schedules.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/11_timezoned_schedules.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/11_timezoned_schedules.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/20_put_watch_with_throttle_period.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/20_put_watch_with_throttle_period.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/20_put_watch_with_throttle_period.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/20_put_watch_with_throttle_period.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/30_put_watch_with_action_throttle_period.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/30_put_watch_with_action_throttle_period.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/30_put_watch_with_action_throttle_period.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/30_put_watch_with_action_throttle_period.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/40_put_watch_as_inactive.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/40_put_watch_as_inactive.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/40_put_watch_as_inactive.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/40_put_watch_as_inactive.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/50_email_attachment_validation.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/50_email_attachment_validation.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/50_email_attachment_validation.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/50_email_attachment_validation.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/60_put_watch_with_action_condition.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/60_put_watch_with_action_condition.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/60_put_watch_with_action_condition.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/60_put_watch_with_action_condition.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/70_put_watch_with_index_action_using_id.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/70_put_watch_with_index_action_using_id.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/70_put_watch_with_index_action_using_id.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/70_put_watch_with_index_action_using_id.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/80_put_get_watch_with_passwords.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_auto_create_index.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_auto_create_index.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_auto_create_index.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_auto_create_index.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_ensure_watch_gets_overwritten_without_version.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_ensure_watch_gets_overwritten_without_version.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_ensure_watch_gets_overwritten_without_version.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/90_ensure_watch_gets_overwritten_without_version.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/91_search_total_hits_as_int.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/91_search_total_hits_as_int.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/91_search_total_hits_as_int.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/91_search_total_hits_as_int.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/92_put_watch_with_indices_options.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/92_put_watch_with_indices_options.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/92_put_watch_with_indices_options.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/92_put_watch_with_indices_options.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/93_put_watch_with_reporting_interval.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/93_put_watch_with_reporting_interval.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/93_put_watch_with_reporting_interval.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/put_watch/93_put_watch_with_reporting_interval.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/query_watches/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/query_watches/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/query_watches/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/query_watches/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/settings_endpoints/10_watcher_settings.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/settings_endpoints/10_watcher_settings.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/settings_endpoints/10_watcher_settings.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/settings_endpoints/10_watcher_settings.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/start_watcher/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/start_watcher/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/start_watcher/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/start_watcher/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/stats/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/stats/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/stats/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/stats/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/stop_watcher/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/stop_watcher/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/stop_watcher/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/stop_watcher/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/usage/10_basic.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/usage/10_basic.yml\nsimilarity index 100%\nrename from x-pack/plugin/watcher/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/watcher/usage/10_basic.yml\nrename to x-pack/plugin/watcher/src/yamlRestTest/resources/rest-api-spec/test/watcher/usage/10_basic.yml\ndiff --git a/x-pack/plugin/watcher/src/yamlRestTest/resources/roles.yml b/x-pack/plugin/watcher/src/yamlRestTest/resources/roles.yml\nnew file mode 100644\nindex 0000000000000..b52fe6c5c5914\n--- /dev/null\n+++ b/x-pack/plugin/watcher/src/yamlRestTest/resources/roles.yml\n@@ -0,0 +1,40 @@\n+admin:\n+  cluster:\n+    - all\n+  indices:\n+    - names: '*'\n+      privileges:\n+        - all\n+\n+watcher_manager:\n+  cluster:\n+    - manage\n+  indices:\n+    - names: '.watch*'\n+      privileges:\n+        - all\n+    # this index gets created by one of the watcher yaml tests\n+    # and is needed for a search transform, so we have to create it as part of the test\n+    - names: 'my_test_index'\n+      privileges:\n+        - all\n+  run_as:\n+    - powerless_user\n+    - watcher_manager\n+    - x_pack_rest_user\n+\n+watcher_monitor:\n+  cluster:\n+    - monitor\n+  indices:\n+    - names: '.watcher-history-*'\n+      privileges:\n+        - read\n+\n+crappy_role:\n+  cluster:\n+    - cluster:monitor/nodes/info\n+    - cluster:monitor/health\n+    - cluster:monitor/nodes/liveness\n+    - cluster:monitor/main\n+\ndiff --git a/x-pack/rest-resources-zip/build.gradle b/x-pack/rest-resources-zip/build.gradle\nindex 18b3d71957f1c..a2cf209e12fe4 100644\n--- a/x-pack/rest-resources-zip/build.gradle\n+++ b/x-pack/rest-resources-zip/build.gradle\n@@ -30,7 +30,7 @@ dependencies {\n   platinumTests project(path: ':x-pack:plugin:eql:qa:rest', configuration: 'restXpackTests')\n   platinumTests project(path: ':x-pack:plugin:ent-search', configuration: 'restXpackTests')\n   platinumTests project(path: ':x-pack:plugin:inference', configuration: 'restXpackTests')\n-  platinumTests project(path: ':x-pack:plugin:watcher:qa:rest', configuration: 'restXpackTests')\n+  platinumTests project(path: ':x-pack:plugin:watcher', configuration: 'restXpackTests')\n   platinumCompatTests project(path: ':x-pack:plugin', configuration: 'restCompatTests')\n   platinumCompatTests project(path: ':x-pack:plugin:eql:qa:rest', configuration: 'restCompatTests')\n }\n",
  "additions": 259,
  "deletions": 186,
  "changed_files": 71,
  "url": "https://github.com/elastic/elasticsearch/pull/137046",
  "mined_at": "2025-10-25T13:27:56.970837"
}