{
  "id": 136231,
  "repository": "elastic/elasticsearch",
  "title": "Return a better error message when Timestamp is renamed in TS queries",
  "body": "Resolves https://github.com/elastic/elasticsearch/issues/134994\r\n\r\nAfter discussing this more on https://github.com/elastic/elasticsearch/pull/136062, we have decided queries that rename the `@timestamp` field should fail with a clear error message.\r\n\r\nThis relates to https://github.com/elastic/elasticsearch/issues/136772\r\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T13:53:20+00:00",
  "created_at": "2025-10-08T21:17:56+00:00",
  "updated_at": "2025-10-24T18:54:40+00:00",
  "author": "not-napoleon",
  "reviewers": [
    "not-napoleon",
    "dnhatn"
  ],
  "base_sha": "7e9049e74cdc397431bb9203595c7434d20ffca2",
  "head_sha": "f5c9e241cf7875fd60100b6481365b4a762cbab5",
  "review_comments": [
    {
      "user": "not-napoleon",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T14:05:55+00:00"
    },
    {
      "user": "dnhatn",
      "state": "APPROVED",
      "body": "I left some nits, but this looks good. Can you also change to `UnresolvedTimestamp` for LastOverTime, FirstOverTime, Increase, Irate, Delta, and IDelta? Thank you, Mark!",
      "submitted_at": "2025-10-21T21:00:17+00:00"
    },
    {
      "user": "not-napoleon",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T15:31:51+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Hi @not-napoleon, I've created a changelog YAML for you.",
      "created_at": "2025-10-08T21:18:33+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-storage-engine (Team:StorageEngine)",
      "created_at": "2025-10-21T20:29:27+00:00"
    },
    {
      "user": "not-napoleon",
      "body": "@elasticmachine run elasticsearch-ci/part-3",
      "created_at": "2025-10-22T19:16:29+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "## üíî Backport failed\n| Status | Branch | Result |\n|:------:|:------:|:------:|\n| ‚ùå |  9.2  | Commit could not be cherrypicked due to conflicts |\n\nYou can use [sqren/backport](https://github.com/sqren/backport) to manually backport by running `backport --upstream elastic/elasticsearch --pr 136231`",
      "created_at": "2025-10-24T13:54:31+00:00"
    },
    {
      "user": "not-napoleon",
      "body": "manual backport PR: https://github.com/elastic/elasticsearch/pull/137112",
      "created_at": "2025-10-24T18:54:30+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "docs/changelog/136231.yaml",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "patch": "@@ -0,0 +1,6 @@\n+pr: 136231\n+summary: Return a better error message when Timestamp is renamed in TS queries\n+area: ES|QL\n+type: bug\n+issues:\n+ - 134994"
    },
    {
      "filename": "x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/capabilities/Unresolvable.java",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "patch": "@@ -15,5 +15,8 @@ default boolean resolved() {\n         return false;\n     }\n \n+    /**\n+     * NOTE: Any non-null return value from this method indicates that the item in question could not be resolved.\n+     */\n     String unresolvedMessage();\n }"
    },
    {
      "filename": "x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedAttribute.java",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "patch": "@@ -31,9 +31,9 @@\n  */\n public class UnresolvedAttribute extends Attribute implements Unresolvable {\n     private final boolean customMessage;\n-    private final String unresolvedMsg;\n+    protected final String unresolvedMsg;\n     // TODO: unused and always null, remove this.\n-    private final Object resolutionMetadata;\n+    protected final Object resolutionMetadata;\n \n     // TODO: Check usage of constructors without qualifiers, that's likely where qualifiers need to be plugged into resolution logic.\n     public UnresolvedAttribute(Source source, String name) {\n@@ -86,7 +86,7 @@ public String getWriteableName() {\n     }\n \n     @Override\n-    protected NodeInfo<UnresolvedAttribute> info() {\n+    protected NodeInfo<? extends UnresolvedAttribute> info() {\n         return NodeInfo.create(this, UnresolvedAttribute::new, qualifier(), name(), id(), unresolvedMsg, resolutionMetadata);\n     }\n "
    },
    {
      "filename": "x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedTimestamp.java",
      "status": "added",
      "additions": 71,
      "deletions": 0,
      "changes": 71,
      "patch": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.core.expression;\n+\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+\n+import java.util.Objects;\n+\n+public class UnresolvedTimestamp extends UnresolvedAttribute {\n+    private final String errorMessage;\n+\n+    public UnresolvedTimestamp(Source source, String errorMessage) {\n+        this(source, null, MetadataAttribute.TIMESTAMP_FIELD, null, null, null, errorMessage);\n+    }\n+\n+    public UnresolvedTimestamp(\n+        Source source,\n+        String qualifier,\n+        String name,\n+        NameId id,\n+        String unresolvedMessage,\n+        Object resolutionMetadata,\n+        String errorMessage\n+    ) {\n+        super(source, qualifier, name, id, unresolvedMessage, resolutionMetadata);\n+        this.errorMessage = errorMessage;\n+    }\n+\n+    @Override\n+    protected NodeInfo<UnresolvedTimestamp> info() {\n+        return NodeInfo.create(\n+            this,\n+            UnresolvedTimestamp::new,\n+            qualifier(),\n+            name(),\n+            id(),\n+            super.unresolvedMessage(),\n+            resolutionMetadata(),\n+            errorMessage\n+        );\n+    }\n+\n+    @Override\n+    public UnresolvedTimestamp withUnresolvedMessage(String unresolvedMessage) {\n+        return new UnresolvedTimestamp(source(), qualifier(), name(), id(), unresolvedMessage, resolutionMetadata(), errorMessage);\n+    }\n+\n+    @Override\n+    public String unresolvedMessage() {\n+        if (super.unresolvedMessage() != null) {\n+            return errorMessage;\n+        }\n+        return null;\n+    }\n+\n+    @Override\n+    protected int innerHashCode(boolean ignoreIds) {\n+        return Objects.hash(super.innerHashCode(ignoreIds), errorMessage);\n+    }\n+\n+    @Override\n+    protected boolean innerEquals(Object o, boolean ignoreIds) {\n+        return super.innerEquals(o, ignoreIds) && Objects.equals(errorMessage, ((UnresolvedTimestamp) o).errorMessage);\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec",
      "status": "modified",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "patch": "@@ -593,3 +593,52 @@ max_cost:integer | pod:keyword | time_bucket:datetime     | max_cluster_cost:int\n 1209             | three       | 2024-05-10T00:00:00.000Z | 1209                     | staging\n 973              | two         | 2024-05-10T00:00:00.000Z | 1209                     | staging\n ;\n+\n+Max of Rate with Bucket\n+required_capability: ts_command_v0\n+\n+TS k8s\n+| STATS maxRate = max(rate(network.total_cost))  BY tbucket = bucket(@timestamp, 1hour) \n+;\n+\n+maxRate:double | tbucket:datetime\n+0.058979885057471274 | 2024-05-10T00:00:00.000Z\n+;\n+\n+Max of Rate with Bucket, rename _tsid\n+required_capability: ts_command_v0\n+\n+TS k8s METADATA _tsid\n+| RENAME _tsid AS newTsid\n+| STATS maxRate = max(rate(network.total_cost))  BY tbucket = bucket(@timestamp, 1hour) \n+;\n+\n+maxRate:double | tbucket:datetime\n+0.058979885057471274 | 2024-05-10T00:00:00.000Z\n+;\n+\n+Max of Rate with Bucket, drop _tsid\n+required_capability: ts_command_v0\n+\n+TS k8s METADATA _tsid\n+| DROP _tsid\n+| STATS maxRate = max(rate(network.total_cost))  BY tbucket = bucket(@timestamp, 1hour) \n+;\n+\n+maxRate:double | tbucket:datetime\n+0.058979885057471274 | 2024-05-10T00:00:00.000Z\n+;\n+\n+\n+Rename timestamp when aggs don't require timestamp\n+required_capability: ts_command_v0\n+\n+TS k8s \n+| RENAME @timestamp AS newTs \n+| STATS mx = max(max_over_time(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\n+;\n+\n+mx:integer | tbucket:datetime\n+1716       | 2024-05-10T00:00:00.000Z\n+;\n+"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "patch": "@@ -1461,6 +1461,10 @@ public enum Cap {\n          */\n         TS_COMMAND_V0(),\n \n+        /**\n+         * Custom error for renamed timestamp\n+         */\n+        TS_RENAME_TIMESTAMP_ERROR_MESSAGE,\n         /**\n          * Add support for counter doubles, ints, and longs in first_ and last_over_time\n          */"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "patch": "@@ -1137,6 +1137,7 @@ private Attribute maybeResolveAttribute(UnresolvedAttribute ua, List<Attribute>\n         }\n \n         private static Attribute maybeResolveAttribute(UnresolvedAttribute ua, List<Attribute> childrenOutput, Logger logger) {\n+            // if we already tried and failed to resolve this attribute, don't try again\n             if (ua.customMessage()) {\n                 return ua;\n             }\n@@ -1149,7 +1150,7 @@ private Attribute resolveAttribute(UnresolvedAttribute ua, List<Attribute> child\n \n         private static Attribute resolveAttribute(UnresolvedAttribute ua, List<Attribute> childrenOutput, Logger logger) {\n             Attribute resolved = ua;\n-            var named = resolveAgainstList(ua, childrenOutput);\n+            List<Attribute> named = resolveAgainstList(ua, childrenOutput);\n             // if resolved, return it; otherwise keep it in place to be resolved later\n             if (named.size() == 1) {\n                 resolved = named.get(0);"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Delta.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -51,7 +51,11 @@ public class Delta extends TimeSeriesAggregateFunction implements OptionalArgume\n         examples = { @Example(file = \"k8s-timeseries-delta\", tag = \"delta\") }\n     )\n     public Delta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Delta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Delta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field, Expression timestamp) {"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/FirstOverTime.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -17,7 +17,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -60,7 +60,11 @@ public FirstOverTime(\n         Source source,\n         @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\", \"long\", \"integer\", \"double\" }) Expression field\n     ) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"First Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public FirstOverTime(Source source, Expression field, Expression timestamp) {"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Idelta.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -53,7 +53,11 @@ public class Idelta extends TimeSeriesAggregateFunction implements OptionalArgum\n         examples = { @Example(file = \"k8s-timeseries-idelta\", tag = \"idelta\") }\n     )\n     public Idelta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"IDelta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Idelta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field, Expression timestamp) {"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Increase.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -59,7 +59,11 @@ public Increase(\n         Source source,\n         @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\" }) Expression field\n     ) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Increase aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Increase("
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Irate.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -52,7 +52,11 @@ public class Irate extends TimeSeriesAggregateFunction implements OptionalArgume\n         examples = { @Example(file = \"k8s-timeseries-irate\", tag = \"irate\") }\n     )\n     public Irate(Source source, @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Irate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Irate("
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/LastOverTime.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -18,7 +18,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -64,7 +64,11 @@ public LastOverTime(\n             type = { \"counter_long\", \"counter_integer\", \"counter_double\", \"long\", \"integer\", \"double\", \"_tsid\" }\n         ) Expression field\n     ) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Last Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public LastOverTime(Source source, Expression field, Expression timestamp) {"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Rate.java",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "patch": "@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -56,7 +56,11 @@ public class Rate extends TimeSeriesAggregateFunction implements OptionalArgumen\n     )\n \n     public Rate(Source source, @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Rate("
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/grouping/TBucket.java",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "patch": "@@ -10,8 +10,7 @@\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.compute.operator.EvalOperator;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n-import org.elasticsearch.xpack.esql.core.expression.MetadataAttribute;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -65,7 +64,11 @@ public TBucket(\n         Source source,\n         @Param(name = \"buckets\", type = { \"date_period\", \"time_duration\" }, description = \"Desired bucket size.\") Expression buckets\n     ) {\n-        this(source, buckets, new UnresolvedAttribute(source, MetadataAttribute.TIMESTAMP_FIELD));\n+        this(\n+            source,\n+            buckets,\n+            new UnresolvedTimestamp(source, \"TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public TBucket(Source source, Expression buckets, Expression timestamp) {"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/AnalyzerTestUtils.java",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "patch": "@@ -366,6 +366,10 @@ public static IndexResolution tsdbIndexResolution() {\n         return loadMapping(\"tsdb-mapping.json\", \"test\");\n     }\n \n+    public static IndexResolution k8sIndexResolution() {\n+        return loadMapping(\"k8s-mappings.json\", \"k8s\");\n+    }\n+\n     public static <E> E randomValueOtherThanTest(Predicate<E> exclude, Supplier<E> supplier) {\n         while (true) {\n             E value = supplier.get();"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/VerifierTests.java",
      "status": "modified",
      "additions": 140,
      "deletions": 2,
      "changes": 142,
      "patch": "@@ -10,15 +10,19 @@\n import org.elasticsearch.Build;\n import org.elasticsearch.TransportVersion;\n import org.elasticsearch.common.Strings;\n+import org.elasticsearch.index.IndexMode;\n import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.esql.EsqlTestUtils;\n import org.elasticsearch.xpack.esql.VerificationException;\n import org.elasticsearch.xpack.esql.action.EsqlCapabilities;\n import org.elasticsearch.xpack.esql.core.InvalidArgumentException;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n import org.elasticsearch.xpack.esql.core.type.DataTypeConverter;\n import org.elasticsearch.xpack.esql.core.type.EsField;\n import org.elasticsearch.xpack.esql.core.type.InvalidMappedField;\n import org.elasticsearch.xpack.esql.core.type.UnsupportedEsField;\n+import org.elasticsearch.xpack.esql.expression.function.EsqlFunctionRegistry;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Kql;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Match;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.MatchPhrase;\n@@ -31,6 +35,7 @@\n import org.elasticsearch.xpack.esql.parser.ParsingException;\n import org.elasticsearch.xpack.esql.parser.QueryParam;\n import org.elasticsearch.xpack.esql.parser.QueryParams;\n+import org.elasticsearch.xpack.esql.plan.IndexPattern;\n \n import java.util.ArrayList;\n import java.util.LinkedHashMap;\n@@ -40,10 +45,14 @@\n import java.util.Map;\n import java.util.Set;\n \n+import static org.elasticsearch.xpack.esql.EsqlTestUtils.TEST_VERIFIER;\n+import static org.elasticsearch.xpack.esql.EsqlTestUtils.emptyInferenceResolution;\n import static org.elasticsearch.xpack.esql.EsqlTestUtils.paramAsConstant;\n+import static org.elasticsearch.xpack.esql.EsqlTestUtils.testAnalyzerContext;\n import static org.elasticsearch.xpack.esql.EsqlTestUtils.withDefaultLimitWarning;\n import static org.elasticsearch.xpack.esql.analysis.Analyzer.ESQL_LOOKUP_JOIN_FULL_TEXT_FUNCTION;\n import static org.elasticsearch.xpack.esql.analysis.AnalyzerTestUtils.TEXT_EMBEDDING_INFERENCE_ID;\n+import static org.elasticsearch.xpack.esql.analysis.AnalyzerTestUtils.defaultLookupResolution;\n import static org.elasticsearch.xpack.esql.analysis.AnalyzerTestUtils.loadMapping;\n import static org.elasticsearch.xpack.esql.core.type.DataType.BOOLEAN;\n import static org.elasticsearch.xpack.esql.core.type.DataType.CARTESIAN_POINT;\n@@ -88,7 +97,24 @@ public class VerifierTests extends ESTestCase {\n     private final Analyzer sampleDataAnalyzer = AnalyzerTestUtils.analyzer(loadMapping(\"mapping-sample_data.json\", \"test\"));\n     private final Analyzer oddSampleDataAnalyzer = AnalyzerTestUtils.analyzer(loadMapping(\"mapping-odd-timestamp.json\", \"test\"));\n     private final Analyzer tsdb = AnalyzerTestUtils.analyzer(AnalyzerTestUtils.tsdbIndexResolution());\n-\n+    private Analyzer k8s;\n+    {\n+        // Load Time Series mappings for these tests\n+        Map<String, EsField> mappingK8s = EsqlTestUtils.loadMapping(\"k8s-mappings.json\");\n+        EsIndex k8sIndex = new EsIndex(\"k8s\", mappingK8s, Map.of(\"k8s\", IndexMode.TIME_SERIES));\n+        IndexResolution getIndexResult = IndexResolution.valid(k8sIndex);\n+        k8s = new Analyzer(\n+            testAnalyzerContext(\n+                EsqlTestUtils.TEST_CFG,\n+                new EsqlFunctionRegistry(),\n+                Map.of(new IndexPattern(Source.EMPTY, \"k8s\"), getIndexResult),\n+                defaultLookupResolution(),\n+                new EnrichResolution(),\n+                emptyInferenceResolution()\n+            ),\n+            TEST_VERIFIER\n+        );\n+    }\n     private final List<String> TIME_DURATIONS = List.of(\"millisecond\", \"second\", \"minute\", \"hour\");\n     private final List<String> DATE_PERIODS = List.of(\"day\", \"week\", \"month\", \"year\");\n \n@@ -1160,6 +1186,108 @@ public void testGroupByCounter() {\n         );\n     }\n \n+    public void testRenameOrDropTimestmapWithRate() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(rate(network.total_cost))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(rate(network.total_cost))\", k8s),\n+            equalTo(\"1:38: Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithLastOverTime() {\n+        assertThat(\n+            error(\n+                \"TS k8s | RENAME @timestamp AS newTs | STATS max(last_over_time(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\",\n+                k8s\n+            ),\n+            equalTo(\"1:49: Last Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(last_over_time(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Last Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithFirstOverTime() {\n+        assertThat(\n+            error(\n+                \"TS k8s | RENAME @timestamp AS newTs | STATS max(first_over_time(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\",\n+                k8s\n+            ),\n+            equalTo(\"1:49: First Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(first_over_time(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: First Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithIncrease() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(increase(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Increase aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(increase(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Increase aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithIRate() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(irate(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Irate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(irate(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Irate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithDelta() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(delta(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Delta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(delta(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Delta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithIDelta() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(idelta(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: IDelta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(idelta(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: IDelta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestampWithTBucket() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(max_over_time(network.eth0.tx))  BY tbucket = tbucket(1hour)\", k8s),\n+            equalTo(\"1:95: TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(max_over_time(network.eth0.tx)) BY tbucket = tbucket(1hour)\", k8s),\n+            equalTo(\"1:83: TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n     public void testAggsResolutionWithUnresolvedGroupings() {\n         String agg_func = randomFrom(\n             new String[] { \"avg\", \"count\", \"count_distinct\", \"min\", \"max\", \"median\", \"median_absolute_deviation\", \"sum\", \"values\" }\n@@ -2605,7 +2733,10 @@ public void testToIPInvalidOptions() {\n     }\n \n     public void testInvalidTBucketCalls() {\n-        assertThat(error(\"from test | stats max(emp_no) by tbucket(1 hour)\"), equalTo(\"1:34: Unknown column [@timestamp]\"));\n+        assertThat(\n+            error(\"from test | stats max(emp_no) by tbucket(1 hour)\"),\n+            equalTo(\"1:34: TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n         assertThat(\n             error(\"from test | stats max(event_duration) by tbucket()\", sampleDataAnalyzer, ParsingException.class),\n             equalTo(\"1:42: error building [tbucket]: expects exactly one argument\")\n@@ -2901,6 +3032,13 @@ STATS max(max_over_time(network.connections)) BY host, time_bucket = bucket(@tim\n             can only be used after STATS when used with TS command\"\"\"));\n     }\n \n+    public void testInlineStatsWithRateNotAllowed() {\n+        assertThat(error(\"TS test | INLINE STATS max(60 * rate(network.bytes_in)), max(network.connections)\", tsdb), equalTo(\"\"\"\n+            1:11: INLINE STATS [INLINE STATS max(60 * rate(network.bytes_in)), max(network.connections)] \\\n+            can only be used after STATS when used with TS command\"\"\"));\n+\n+    }\n+\n     public void testLimitBeforeInlineStats_WithTS() {\n         assumeTrue(\"LIMIT before INLINE STATS limitation check\", EsqlCapabilities.Cap.FORBID_LIMIT_BEFORE_INLINE_STATS.isEnabled());\n         assertThat("
    },
    {
      "filename": "x-pack/plugin/src/yamlRestTest/resources/rest-api-spec/test/esql/40_tsdb.yml",
      "status": "modified",
      "additions": 25,
      "deletions": 0,
      "changes": 25,
      "patch": "@@ -837,3 +837,28 @@ TS Command grouping on text field:\n   - match: {values.2.0: 530604797}\n   - match: {values.2.1: \"why cant i hold all these text\"}\n   - match: {values.2.2: \"2021-04-28T18:00:00.000Z\"}\n+\n+---\n+error on rename timestamp:\n+  - requires:\n+      test_runner_features: [ capabilities ]\n+      capabilities:\n+        - method: POST\n+          path: /_query\n+          parameters: [ ]\n+          capabilities: [ ts_command_v0, ts_rename_timestamp_error_message ]\n+      reason: \"TS specific check\"\n+\n+  - do:\n+      allowed_warnings_regex:\n+        - \"No limit defined, adding default limit of \\\\[.*\\\\]\"\n+      catch: bad_request\n+      esql.query:\n+        body:\n+          query: |\n+            TS test\n+            | RENAME @timestamp AS newTs\n+            | STATS max(rate(k8s.pod.network.tx))  BY tbucket = bucket(newTs, 1hour)\n+\n+  - match: { error.reason: \"Found 1 problem\\nline 3:13: Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\" }\n+"
    }
  ],
  "diff": "diff --git a/docs/changelog/136231.yaml b/docs/changelog/136231.yaml\nnew file mode 100644\nindex 0000000000000..f2e365ca2d480\n--- /dev/null\n+++ b/docs/changelog/136231.yaml\n@@ -0,0 +1,6 @@\n+pr: 136231\n+summary: Return a better error message when Timestamp is renamed in TS queries\n+area: ES|QL\n+type: bug\n+issues:\n+ - 134994\ndiff --git a/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/capabilities/Unresolvable.java b/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/capabilities/Unresolvable.java\nindex 11bfe4df35e3a..21bbc23bb20df 100644\n--- a/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/capabilities/Unresolvable.java\n+++ b/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/capabilities/Unresolvable.java\n@@ -15,5 +15,8 @@ default boolean resolved() {\n         return false;\n     }\n \n+    /**\n+     * NOTE: Any non-null return value from this method indicates that the item in question could not be resolved.\n+     */\n     String unresolvedMessage();\n }\ndiff --git a/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedAttribute.java b/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedAttribute.java\nindex ff19c06cbec9d..ec1bb882a46b8 100644\n--- a/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedAttribute.java\n+++ b/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedAttribute.java\n@@ -31,9 +31,9 @@\n  */\n public class UnresolvedAttribute extends Attribute implements Unresolvable {\n     private final boolean customMessage;\n-    private final String unresolvedMsg;\n+    protected final String unresolvedMsg;\n     // TODO: unused and always null, remove this.\n-    private final Object resolutionMetadata;\n+    protected final Object resolutionMetadata;\n \n     // TODO: Check usage of constructors without qualifiers, that's likely where qualifiers need to be plugged into resolution logic.\n     public UnresolvedAttribute(Source source, String name) {\n@@ -86,7 +86,7 @@ public String getWriteableName() {\n     }\n \n     @Override\n-    protected NodeInfo<UnresolvedAttribute> info() {\n+    protected NodeInfo<? extends UnresolvedAttribute> info() {\n         return NodeInfo.create(this, UnresolvedAttribute::new, qualifier(), name(), id(), unresolvedMsg, resolutionMetadata);\n     }\n \ndiff --git a/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedTimestamp.java b/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedTimestamp.java\nnew file mode 100644\nindex 0000000000000..b86d9b1a41567\n--- /dev/null\n+++ b/x-pack/plugin/esql-core/src/main/java/org/elasticsearch/xpack/esql/core/expression/UnresolvedTimestamp.java\n@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.core.expression;\n+\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+\n+import java.util.Objects;\n+\n+public class UnresolvedTimestamp extends UnresolvedAttribute {\n+    private final String errorMessage;\n+\n+    public UnresolvedTimestamp(Source source, String errorMessage) {\n+        this(source, null, MetadataAttribute.TIMESTAMP_FIELD, null, null, null, errorMessage);\n+    }\n+\n+    public UnresolvedTimestamp(\n+        Source source,\n+        String qualifier,\n+        String name,\n+        NameId id,\n+        String unresolvedMessage,\n+        Object resolutionMetadata,\n+        String errorMessage\n+    ) {\n+        super(source, qualifier, name, id, unresolvedMessage, resolutionMetadata);\n+        this.errorMessage = errorMessage;\n+    }\n+\n+    @Override\n+    protected NodeInfo<UnresolvedTimestamp> info() {\n+        return NodeInfo.create(\n+            this,\n+            UnresolvedTimestamp::new,\n+            qualifier(),\n+            name(),\n+            id(),\n+            super.unresolvedMessage(),\n+            resolutionMetadata(),\n+            errorMessage\n+        );\n+    }\n+\n+    @Override\n+    public UnresolvedTimestamp withUnresolvedMessage(String unresolvedMessage) {\n+        return new UnresolvedTimestamp(source(), qualifier(), name(), id(), unresolvedMessage, resolutionMetadata(), errorMessage);\n+    }\n+\n+    @Override\n+    public String unresolvedMessage() {\n+        if (super.unresolvedMessage() != null) {\n+            return errorMessage;\n+        }\n+        return null;\n+    }\n+\n+    @Override\n+    protected int innerHashCode(boolean ignoreIds) {\n+        return Objects.hash(super.innerHashCode(ignoreIds), errorMessage);\n+    }\n+\n+    @Override\n+    protected boolean innerEquals(Object o, boolean ignoreIds) {\n+        return super.innerEquals(o, ignoreIds) && Objects.equals(errorMessage, ((UnresolvedTimestamp) o).errorMessage);\n+    }\n+}\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec\nindex 4109312b16f1c..033d89f0cb54d 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec\n@@ -593,3 +593,52 @@ max_cost:integer | pod:keyword | time_bucket:datetime     | max_cluster_cost:int\n 1209             | three       | 2024-05-10T00:00:00.000Z | 1209                     | staging\n 973              | two         | 2024-05-10T00:00:00.000Z | 1209                     | staging\n ;\n+\n+Max of Rate with Bucket\n+required_capability: ts_command_v0\n+\n+TS k8s\n+| STATS maxRate = max(rate(network.total_cost))  BY tbucket = bucket(@timestamp, 1hour) \n+;\n+\n+maxRate:double | tbucket:datetime\n+0.058979885057471274 | 2024-05-10T00:00:00.000Z\n+;\n+\n+Max of Rate with Bucket, rename _tsid\n+required_capability: ts_command_v0\n+\n+TS k8s METADATA _tsid\n+| RENAME _tsid AS newTsid\n+| STATS maxRate = max(rate(network.total_cost))  BY tbucket = bucket(@timestamp, 1hour) \n+;\n+\n+maxRate:double | tbucket:datetime\n+0.058979885057471274 | 2024-05-10T00:00:00.000Z\n+;\n+\n+Max of Rate with Bucket, drop _tsid\n+required_capability: ts_command_v0\n+\n+TS k8s METADATA _tsid\n+| DROP _tsid\n+| STATS maxRate = max(rate(network.total_cost))  BY tbucket = bucket(@timestamp, 1hour) \n+;\n+\n+maxRate:double | tbucket:datetime\n+0.058979885057471274 | 2024-05-10T00:00:00.000Z\n+;\n+\n+\n+Rename timestamp when aggs don't require timestamp\n+required_capability: ts_command_v0\n+\n+TS k8s \n+| RENAME @timestamp AS newTs \n+| STATS mx = max(max_over_time(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\n+;\n+\n+mx:integer | tbucket:datetime\n+1716       | 2024-05-10T00:00:00.000Z\n+;\n+\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\nindex e637481c7e058..9d5e41df38f3d 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n@@ -1461,6 +1461,10 @@ public enum Cap {\n          */\n         TS_COMMAND_V0(),\n \n+        /**\n+         * Custom error for renamed timestamp\n+         */\n+        TS_RENAME_TIMESTAMP_ERROR_MESSAGE,\n         /**\n          * Add support for counter doubles, ints, and longs in first_ and last_over_time\n          */\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java\nindex 2ffe4ebb56299..dfab95275f2d2 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/analysis/Analyzer.java\n@@ -1137,6 +1137,7 @@ private Attribute maybeResolveAttribute(UnresolvedAttribute ua, List<Attribute>\n         }\n \n         private static Attribute maybeResolveAttribute(UnresolvedAttribute ua, List<Attribute> childrenOutput, Logger logger) {\n+            // if we already tried and failed to resolve this attribute, don't try again\n             if (ua.customMessage()) {\n                 return ua;\n             }\n@@ -1149,7 +1150,7 @@ private Attribute resolveAttribute(UnresolvedAttribute ua, List<Attribute> child\n \n         private static Attribute resolveAttribute(UnresolvedAttribute ua, List<Attribute> childrenOutput, Logger logger) {\n             Attribute resolved = ua;\n-            var named = resolveAgainstList(ua, childrenOutput);\n+            List<Attribute> named = resolveAgainstList(ua, childrenOutput);\n             // if resolved, return it; otherwise keep it in place to be resolved later\n             if (named.size() == 1) {\n                 resolved = named.get(0);\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Delta.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Delta.java\nindex f1883499a59cf..dcba073e5fb9a 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Delta.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Delta.java\n@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -51,7 +51,11 @@ public class Delta extends TimeSeriesAggregateFunction implements OptionalArgume\n         examples = { @Example(file = \"k8s-timeseries-delta\", tag = \"delta\") }\n     )\n     public Delta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Delta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Delta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field, Expression timestamp) {\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/FirstOverTime.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/FirstOverTime.java\nindex 9270c8d301b4e..095764c4371bc 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/FirstOverTime.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/FirstOverTime.java\n@@ -17,7 +17,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -60,7 +60,11 @@ public FirstOverTime(\n         Source source,\n         @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\", \"long\", \"integer\", \"double\" }) Expression field\n     ) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"First Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public FirstOverTime(Source source, Expression field, Expression timestamp) {\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Idelta.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Idelta.java\nindex a6950439e541f..bed8a7842e407 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Idelta.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Idelta.java\n@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -53,7 +53,11 @@ public class Idelta extends TimeSeriesAggregateFunction implements OptionalArgum\n         examples = { @Example(file = \"k8s-timeseries-idelta\", tag = \"idelta\") }\n     )\n     public Idelta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"IDelta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Idelta(Source source, @Param(name = \"field\", type = { \"long\", \"integer\", \"double\" }) Expression field, Expression timestamp) {\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Increase.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Increase.java\nindex eb5089b86f0fe..661bdeddd5ee2 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Increase.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Increase.java\n@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -59,7 +59,11 @@ public Increase(\n         Source source,\n         @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\" }) Expression field\n     ) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Increase aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Increase(\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Irate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Irate.java\nindex d75e4456f7f06..79391fbf1f4fb 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Irate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Irate.java\n@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -52,7 +52,11 @@ public class Irate extends TimeSeriesAggregateFunction implements OptionalArgume\n         examples = { @Example(file = \"k8s-timeseries-irate\", tag = \"irate\") }\n     )\n     public Irate(Source source, @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Irate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Irate(\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/LastOverTime.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/LastOverTime.java\nindex e754c83dd9d90..14da771971be5 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/LastOverTime.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/LastOverTime.java\n@@ -18,7 +18,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -64,7 +64,11 @@ public LastOverTime(\n             type = { \"counter_long\", \"counter_integer\", \"counter_double\", \"long\", \"integer\", \"double\", \"_tsid\" }\n         ) Expression field\n     ) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Last Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public LastOverTime(Source source, Expression field, Expression timestamp) {\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Rate.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Rate.java\nindex a3406959931be..e773ed84c22c3 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Rate.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Rate.java\n@@ -16,7 +16,7 @@\n import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n import org.elasticsearch.xpack.esql.core.expression.Literal;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -56,7 +56,11 @@ public class Rate extends TimeSeriesAggregateFunction implements OptionalArgumen\n     )\n \n     public Rate(Source source, @Param(name = \"field\", type = { \"counter_long\", \"counter_integer\", \"counter_double\" }) Expression field) {\n-        this(source, field, new UnresolvedAttribute(source, \"@timestamp\"));\n+        this(\n+            source,\n+            field,\n+            new UnresolvedTimestamp(source, \"Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public Rate(\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/grouping/TBucket.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/grouping/TBucket.java\nindex f20e3420b9055..5e2307459abd4 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/grouping/TBucket.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/grouping/TBucket.java\n@@ -10,8 +10,7 @@\n import org.elasticsearch.common.io.stream.StreamOutput;\n import org.elasticsearch.compute.operator.EvalOperator;\n import org.elasticsearch.xpack.esql.core.expression.Expression;\n-import org.elasticsearch.xpack.esql.core.expression.MetadataAttribute;\n-import org.elasticsearch.xpack.esql.core.expression.UnresolvedAttribute;\n+import org.elasticsearch.xpack.esql.core.expression.UnresolvedTimestamp;\n import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n@@ -65,7 +64,11 @@ public TBucket(\n         Source source,\n         @Param(name = \"buckets\", type = { \"date_period\", \"time_duration\" }, description = \"Desired bucket size.\") Expression buckets\n     ) {\n-        this(source, buckets, new UnresolvedAttribute(source, MetadataAttribute.TIMESTAMP_FIELD));\n+        this(\n+            source,\n+            buckets,\n+            new UnresolvedTimestamp(source, \"TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n     }\n \n     public TBucket(Source source, Expression buckets, Expression timestamp) {\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/AnalyzerTestUtils.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/AnalyzerTestUtils.java\nindex 9afc89b8cd8a8..8ebd4279bdf51 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/AnalyzerTestUtils.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/AnalyzerTestUtils.java\n@@ -366,6 +366,10 @@ public static IndexResolution tsdbIndexResolution() {\n         return loadMapping(\"tsdb-mapping.json\", \"test\");\n     }\n \n+    public static IndexResolution k8sIndexResolution() {\n+        return loadMapping(\"k8s-mappings.json\", \"k8s\");\n+    }\n+\n     public static <E> E randomValueOtherThanTest(Predicate<E> exclude, Supplier<E> supplier) {\n         while (true) {\n             E value = supplier.get();\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/VerifierTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/VerifierTests.java\nindex 9d05b33d81c01..b28372046f4ca 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/VerifierTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/analysis/VerifierTests.java\n@@ -10,15 +10,19 @@\n import org.elasticsearch.Build;\n import org.elasticsearch.TransportVersion;\n import org.elasticsearch.common.Strings;\n+import org.elasticsearch.index.IndexMode;\n import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.esql.EsqlTestUtils;\n import org.elasticsearch.xpack.esql.VerificationException;\n import org.elasticsearch.xpack.esql.action.EsqlCapabilities;\n import org.elasticsearch.xpack.esql.core.InvalidArgumentException;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n import org.elasticsearch.xpack.esql.core.type.DataType;\n import org.elasticsearch.xpack.esql.core.type.DataTypeConverter;\n import org.elasticsearch.xpack.esql.core.type.EsField;\n import org.elasticsearch.xpack.esql.core.type.InvalidMappedField;\n import org.elasticsearch.xpack.esql.core.type.UnsupportedEsField;\n+import org.elasticsearch.xpack.esql.expression.function.EsqlFunctionRegistry;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Kql;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Match;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.MatchPhrase;\n@@ -31,6 +35,7 @@\n import org.elasticsearch.xpack.esql.parser.ParsingException;\n import org.elasticsearch.xpack.esql.parser.QueryParam;\n import org.elasticsearch.xpack.esql.parser.QueryParams;\n+import org.elasticsearch.xpack.esql.plan.IndexPattern;\n \n import java.util.ArrayList;\n import java.util.LinkedHashMap;\n@@ -40,10 +45,14 @@\n import java.util.Map;\n import java.util.Set;\n \n+import static org.elasticsearch.xpack.esql.EsqlTestUtils.TEST_VERIFIER;\n+import static org.elasticsearch.xpack.esql.EsqlTestUtils.emptyInferenceResolution;\n import static org.elasticsearch.xpack.esql.EsqlTestUtils.paramAsConstant;\n+import static org.elasticsearch.xpack.esql.EsqlTestUtils.testAnalyzerContext;\n import static org.elasticsearch.xpack.esql.EsqlTestUtils.withDefaultLimitWarning;\n import static org.elasticsearch.xpack.esql.analysis.Analyzer.ESQL_LOOKUP_JOIN_FULL_TEXT_FUNCTION;\n import static org.elasticsearch.xpack.esql.analysis.AnalyzerTestUtils.TEXT_EMBEDDING_INFERENCE_ID;\n+import static org.elasticsearch.xpack.esql.analysis.AnalyzerTestUtils.defaultLookupResolution;\n import static org.elasticsearch.xpack.esql.analysis.AnalyzerTestUtils.loadMapping;\n import static org.elasticsearch.xpack.esql.core.type.DataType.BOOLEAN;\n import static org.elasticsearch.xpack.esql.core.type.DataType.CARTESIAN_POINT;\n@@ -88,7 +97,24 @@ public class VerifierTests extends ESTestCase {\n     private final Analyzer sampleDataAnalyzer = AnalyzerTestUtils.analyzer(loadMapping(\"mapping-sample_data.json\", \"test\"));\n     private final Analyzer oddSampleDataAnalyzer = AnalyzerTestUtils.analyzer(loadMapping(\"mapping-odd-timestamp.json\", \"test\"));\n     private final Analyzer tsdb = AnalyzerTestUtils.analyzer(AnalyzerTestUtils.tsdbIndexResolution());\n-\n+    private Analyzer k8s;\n+    {\n+        // Load Time Series mappings for these tests\n+        Map<String, EsField> mappingK8s = EsqlTestUtils.loadMapping(\"k8s-mappings.json\");\n+        EsIndex k8sIndex = new EsIndex(\"k8s\", mappingK8s, Map.of(\"k8s\", IndexMode.TIME_SERIES));\n+        IndexResolution getIndexResult = IndexResolution.valid(k8sIndex);\n+        k8s = new Analyzer(\n+            testAnalyzerContext(\n+                EsqlTestUtils.TEST_CFG,\n+                new EsqlFunctionRegistry(),\n+                Map.of(new IndexPattern(Source.EMPTY, \"k8s\"), getIndexResult),\n+                defaultLookupResolution(),\n+                new EnrichResolution(),\n+                emptyInferenceResolution()\n+            ),\n+            TEST_VERIFIER\n+        );\n+    }\n     private final List<String> TIME_DURATIONS = List.of(\"millisecond\", \"second\", \"minute\", \"hour\");\n     private final List<String> DATE_PERIODS = List.of(\"day\", \"week\", \"month\", \"year\");\n \n@@ -1160,6 +1186,108 @@ public void testGroupByCounter() {\n         );\n     }\n \n+    public void testRenameOrDropTimestmapWithRate() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(rate(network.total_cost))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(rate(network.total_cost))\", k8s),\n+            equalTo(\"1:38: Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithLastOverTime() {\n+        assertThat(\n+            error(\n+                \"TS k8s | RENAME @timestamp AS newTs | STATS max(last_over_time(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\",\n+                k8s\n+            ),\n+            equalTo(\"1:49: Last Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(last_over_time(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Last Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithFirstOverTime() {\n+        assertThat(\n+            error(\n+                \"TS k8s | RENAME @timestamp AS newTs | STATS max(first_over_time(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\",\n+                k8s\n+            ),\n+            equalTo(\"1:49: First Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(first_over_time(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: First Over Time aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithIncrease() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(increase(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Increase aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(increase(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Increase aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithIRate() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(irate(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Irate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(irate(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Irate aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithDelta() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(delta(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: Delta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(delta(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: Delta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestmapWithIDelta() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(idelta(network.eth0.tx))  BY tbucket = bucket(newTs, 1hour)\", k8s),\n+            equalTo(\"1:49: IDelta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(idelta(network.eth0.tx))\", k8s),\n+            equalTo(\"1:38: IDelta aggregation requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n+    public void testRenameOrDropTimestampWithTBucket() {\n+        assertThat(\n+            error(\"TS k8s | RENAME @timestamp AS newTs | STATS max(max_over_time(network.eth0.tx))  BY tbucket = tbucket(1hour)\", k8s),\n+            equalTo(\"1:95: TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+\n+        assertThat(\n+            error(\"TS k8s | DROP @timestamp | STATS max(max_over_time(network.eth0.tx)) BY tbucket = tbucket(1hour)\", k8s),\n+            equalTo(\"1:83: TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n+    }\n+\n     public void testAggsResolutionWithUnresolvedGroupings() {\n         String agg_func = randomFrom(\n             new String[] { \"avg\", \"count\", \"count_distinct\", \"min\", \"max\", \"median\", \"median_absolute_deviation\", \"sum\", \"values\" }\n@@ -2605,7 +2733,10 @@ public void testToIPInvalidOptions() {\n     }\n \n     public void testInvalidTBucketCalls() {\n-        assertThat(error(\"from test | stats max(emp_no) by tbucket(1 hour)\"), equalTo(\"1:34: Unknown column [@timestamp]\"));\n+        assertThat(\n+            error(\"from test | stats max(emp_no) by tbucket(1 hour)\"),\n+            equalTo(\"1:34: TBucket function requires @timestamp field, but @timestamp was renamed or dropped\")\n+        );\n         assertThat(\n             error(\"from test | stats max(event_duration) by tbucket()\", sampleDataAnalyzer, ParsingException.class),\n             equalTo(\"1:42: error building [tbucket]: expects exactly one argument\")\n@@ -2901,6 +3032,13 @@ STATS max(max_over_time(network.connections)) BY host, time_bucket = bucket(@tim\n             can only be used after STATS when used with TS command\"\"\"));\n     }\n \n+    public void testInlineStatsWithRateNotAllowed() {\n+        assertThat(error(\"TS test | INLINE STATS max(60 * rate(network.bytes_in)), max(network.connections)\", tsdb), equalTo(\"\"\"\n+            1:11: INLINE STATS [INLINE STATS max(60 * rate(network.bytes_in)), max(network.connections)] \\\n+            can only be used after STATS when used with TS command\"\"\"));\n+\n+    }\n+\n     public void testLimitBeforeInlineStats_WithTS() {\n         assumeTrue(\"LIMIT before INLINE STATS limitation check\", EsqlCapabilities.Cap.FORBID_LIMIT_BEFORE_INLINE_STATS.isEnabled());\n         assertThat(\ndiff --git a/x-pack/plugin/src/yamlRestTest/resources/rest-api-spec/test/esql/40_tsdb.yml b/x-pack/plugin/src/yamlRestTest/resources/rest-api-spec/test/esql/40_tsdb.yml\nindex 0478548f51da1..7f8ebb5b7f09d 100644\n--- a/x-pack/plugin/src/yamlRestTest/resources/rest-api-spec/test/esql/40_tsdb.yml\n+++ b/x-pack/plugin/src/yamlRestTest/resources/rest-api-spec/test/esql/40_tsdb.yml\n@@ -837,3 +837,28 @@ TS Command grouping on text field:\n   - match: {values.2.0: 530604797}\n   - match: {values.2.1: \"why cant i hold all these text\"}\n   - match: {values.2.2: \"2021-04-28T18:00:00.000Z\"}\n+\n+---\n+error on rename timestamp:\n+  - requires:\n+      test_runner_features: [ capabilities ]\n+      capabilities:\n+        - method: POST\n+          path: /_query\n+          parameters: [ ]\n+          capabilities: [ ts_command_v0, ts_rename_timestamp_error_message ]\n+      reason: \"TS specific check\"\n+\n+  - do:\n+      allowed_warnings_regex:\n+        - \"No limit defined, adding default limit of \\\\[.*\\\\]\"\n+      catch: bad_request\n+      esql.query:\n+        body:\n+          query: |\n+            TS test\n+            | RENAME @timestamp AS newTs\n+            | STATS max(rate(k8s.pod.network.tx))  BY tbucket = bucket(newTs, 1hour)\n+\n+  - match: { error.reason: \"Found 1 problem\\nline 3:13: Rate aggregation requires @timestamp field, but @timestamp was renamed or dropped\" }\n+\n",
  "additions": 355,
  "deletions": 23,
  "changed_files": 18,
  "url": "https://github.com/elastic/elasticsearch/pull/136231",
  "mined_at": "2025-10-25T13:13:49.084749"
}