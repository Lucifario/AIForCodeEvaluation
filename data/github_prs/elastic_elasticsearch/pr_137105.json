{
  "id": 137105,
  "repository": "elastic/elasticsearch",
  "title": "[9.2] [ML] Fix DatafeedJobsIT#testDatafeedTimingStats_DatafeedRecreated (#137086)",
  "body": "Backports the following commits to 9.2:\n - [ML] Fix DatafeedJobsIT#testDatafeedTimingStats_DatafeedRecreated (#137086)",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T14:26:29+00:00",
  "created_at": "2025-10-24T13:29:54+00:00",
  "updated_at": "2025-10-24T14:26:52+00:00",
  "author": "valeriy42",
  "reviewers": [],
  "base_sha": "fa16bca8eb6ac67e800fcec837300425b81bb714",
  "head_sha": "f87fcce2fea08bda61c29468a0a57b428fc43c38",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java",
      "status": "modified",
      "additions": 11,
      "deletions": 8,
      "changes": 19,
      "patch": "@@ -7,7 +7,6 @@\n package org.elasticsearch.xpack.ml.integration;\n \n import org.apache.logging.log4j.Level;\n-import org.apache.lucene.tests.util.LuceneTestCase;\n import org.elasticsearch.ElasticsearchException;\n import org.elasticsearch.ElasticsearchStatusException;\n import org.elasticsearch.ResourceNotFoundException;\n@@ -232,7 +231,6 @@ public void testLookbackOnlyRuntimeMapping() throws Exception {\n         waitUntilJobIsClosed(jobBuilder.getId());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/63973\")\n     public void testDatafeedTimingStats_DatafeedRecreated() throws Exception {\n         client().admin().indices().prepareCreate(\"data\").setMapping(\"time\", \"type=date\").get();\n         long numDocs = randomIntBetween(32, 2048);\n@@ -254,11 +252,17 @@ public void testDatafeedTimingStats_DatafeedRecreated() throws Exception {\n             // Datafeed did not do anything yet, hence search_count is equal to 0.\n             assertDatafeedStats(datafeedId, DatafeedState.STOPPED, job.getId(), equalTo(0L));\n             startDatafeed(datafeedId, 0L, now.toEpochMilli());\n-            assertBusy(() -> {\n-                assertThat(getDataCounts(job.getId()).getProcessedRecordCount(), equalTo(numDocs));\n-                // Datafeed processed numDocs documents so search_count must be greater than 0.\n-                assertDatafeedStats(datafeedId, DatafeedState.STOPPED, job.getId(), greaterThan(0L));\n-            }, 60, TimeUnit.SECONDS);\n+\n+            // First, wait for data processing to complete\n+            assertBusy(() -> { assertThat(getDataCounts(job.getId()).getProcessedRecordCount(), equalTo(numDocs)); }, 60, TimeUnit.SECONDS);\n+            // Then, wait for datafeed timing stats to be persisted\n+            // Datafeed processed numDocs documents so search_count must be greater than 0.\n+            assertBusy(\n+                () -> { assertDatafeedStats(datafeedId, DatafeedState.STOPPED, job.getId(), greaterThan(0L)); },\n+                30,\n+                TimeUnit.SECONDS\n+            );\n+\n             deleteDatafeed(datafeedId);\n             waitUntilJobIsClosed(job.getId());\n         };\n@@ -788,7 +792,6 @@ private void startRealtime(String jobId, Integer maxEmptySearches) throws Except\n         }, 30, TimeUnit.SECONDS);\n     }\n \n-    @LuceneTestCase.AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/105239\")\n     public void testStartDatafeed_GivenTimeout_Returns408() throws Exception {\n         client().admin().indices().prepareCreate(\"data-1\").setMapping(\"time\", \"type=date\").get();\n         long numDocs = 100;"
    }
  ],
  "diff": "diff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java\nindex caba356f82ee2..185547926c817 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java\n@@ -7,7 +7,6 @@\n package org.elasticsearch.xpack.ml.integration;\n \n import org.apache.logging.log4j.Level;\n-import org.apache.lucene.tests.util.LuceneTestCase;\n import org.elasticsearch.ElasticsearchException;\n import org.elasticsearch.ElasticsearchStatusException;\n import org.elasticsearch.ResourceNotFoundException;\n@@ -232,7 +231,6 @@ public void testLookbackOnlyRuntimeMapping() throws Exception {\n         waitUntilJobIsClosed(jobBuilder.getId());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/63973\")\n     public void testDatafeedTimingStats_DatafeedRecreated() throws Exception {\n         client().admin().indices().prepareCreate(\"data\").setMapping(\"time\", \"type=date\").get();\n         long numDocs = randomIntBetween(32, 2048);\n@@ -254,11 +252,17 @@ public void testDatafeedTimingStats_DatafeedRecreated() throws Exception {\n             // Datafeed did not do anything yet, hence search_count is equal to 0.\n             assertDatafeedStats(datafeedId, DatafeedState.STOPPED, job.getId(), equalTo(0L));\n             startDatafeed(datafeedId, 0L, now.toEpochMilli());\n-            assertBusy(() -> {\n-                assertThat(getDataCounts(job.getId()).getProcessedRecordCount(), equalTo(numDocs));\n-                // Datafeed processed numDocs documents so search_count must be greater than 0.\n-                assertDatafeedStats(datafeedId, DatafeedState.STOPPED, job.getId(), greaterThan(0L));\n-            }, 60, TimeUnit.SECONDS);\n+\n+            // First, wait for data processing to complete\n+            assertBusy(() -> { assertThat(getDataCounts(job.getId()).getProcessedRecordCount(), equalTo(numDocs)); }, 60, TimeUnit.SECONDS);\n+            // Then, wait for datafeed timing stats to be persisted\n+            // Datafeed processed numDocs documents so search_count must be greater than 0.\n+            assertBusy(\n+                () -> { assertDatafeedStats(datafeedId, DatafeedState.STOPPED, job.getId(), greaterThan(0L)); },\n+                30,\n+                TimeUnit.SECONDS\n+            );\n+\n             deleteDatafeed(datafeedId);\n             waitUntilJobIsClosed(job.getId());\n         };\n@@ -788,7 +792,6 @@ private void startRealtime(String jobId, Integer maxEmptySearches) throws Except\n         }, 30, TimeUnit.SECONDS);\n     }\n \n-    @LuceneTestCase.AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/105239\")\n     public void testStartDatafeed_GivenTimeout_Returns408() throws Exception {\n         client().admin().indices().prepareCreate(\"data-1\").setMapping(\"time\", \"type=date\").get();\n         long numDocs = 100;\n",
  "additions": 11,
  "deletions": 8,
  "changed_files": 1,
  "url": "https://github.com/elastic/elasticsearch/pull/137105",
  "mined_at": "2025-10-25T13:20:52.881875"
}