{
  "id": 136915,
  "repository": "elastic/elasticsearch",
  "title": "Implement native synthetic source for normalized keywords",
  "body": "Currently, when a synthetic source index has a keyword field with a normalizer, the original, non-normalized value of the field is stored in _ignored_source so that the original source can be reconstructed. However, this can create significant storage overhead as we are essentially double-storing the value.\r\n\r\nThis PR adds a new boolean keyword mapper parameter `normalizer_skip_store_original_value`. When this value is set, the original value is not stored in _ignored_source and is instead discarded. The source will be reconstructed using the normalized value.\r\n\r\nFor custom normalizers, this parameter will default to `false` and the original value will be stored. However, for the built-in `lowercase` normalizer, the parameter will default to `true` and the original value will not be stored. \r\n\r\nThis is a breaking change as previously keyword field mappers with the lowercase normalizer would default to storing the original value.\r\n\r\nRelates to #124369.",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-23T17:44:28+00:00",
  "created_at": "2025-10-21T21:29:09+00:00",
  "updated_at": "2025-10-23T17:44:29+00:00",
  "author": "jordan-powers",
  "reviewers": [
    "martijnvg",
    "jordan-powers",
    "Kubik42"
  ],
  "base_sha": "08c1e1b1ddfd05da75156c75ab016653e4034af7",
  "head_sha": "e198bdde89089d7d066ab6a6e15ffb1b9fdae067",
  "review_comments": [
    {
      "user": "Kubik42",
      "state": "COMMENTED",
      "body": "Nice! Looks good to me for the most part. \r\n\r\nOne concern I have is around naming- \"skip_store\" combined with false, results in a double negative, which might be a bit unclear to customers. Perhaps we can drop \"skip\" and instead flip the default around like so:\r\n\r\n```\r\nnormalizer_store_original_value = true (default)\r\nnormalizer_store_original_value = false\r\n```",
      "submitted_at": "2025-10-22T19:51:12+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T20:00:41+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T20:01:33+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T20:10:58+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T20:15:52+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T20:33:12+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T21:14:57+00:00"
    },
    {
      "user": "jordan-powers",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T21:17:07+00:00"
    },
    {
      "user": "martijnvg",
      "state": "APPROVED",
      "body": "Left one small testing comment, LGTM otherwise.",
      "submitted_at": "2025-10-23T09:52:57+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-storage-engine (Team:StorageEngine)",
      "created_at": "2025-10-21T21:29:33+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "Hi @jordan-powers, I've created a changelog YAML for you. *Note* that since this PR is labelled `>breaking`, you need to update the changelog YAML to fill out the extended information sections.",
      "created_at": "2025-10-21T21:29:34+00:00"
    },
    {
      "user": "jordan-powers",
      "body": "Yeah, I went back and forth on whether to name it `normalizer_skip_store_original_value` with a default of `false`, or `normalizer_store_original_value` with a default of `true`. I settled on `normalizer_skip_store_original_value` because I felt that this feature is additional functionality the user is opting-in to, and when opting-in it makes more sense to be setting a value to `true`.\r\n\r\nBut really I could justify either name for the parameter, so if calling it `normalizer_store_original_value` makes more sense to people I'm happy to switch it.",
      "created_at": "2025-10-22T20:20:44+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "docs/changelog/136915.yaml",
      "status": "added",
      "additions": 16,
      "deletions": 0,
      "changes": 16,
      "patch": "@@ -0,0 +1,16 @@\n+pr: 136915\n+summary: Implement native synthetic source for normalized keywords\n+area: Mapping\n+type: breaking\n+issues: []\n+breaking:\n+  title: Implement native synthetic source for normalized keywords\n+  area: Mapping\n+  details: \"This adds a new mapping parameter `normalizer_skip_store_original_value` to keyword fields. When this\\\n+  \\ parameter is set, and synthetic_source is enabled, keyword fields with configured normalizers will not store the\\\n+  \\ original non-normalized value in _ignored_source, and will instead use the normalized value to reconstruct the\\\n+  \\ source. This parameter enabled by default for the built-in `lowercase` normalizer, and is disabled by default for\\\n+  \\ other custom normalizers.\"\n+  impact: \"Keyword fields using the `lowercase` normalizer will return the normalized value in the source when synthetic\\\n+    \\ source is enabled.\"\n+  notable: false"
    },
    {
      "filename": "rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mget/90_synthetic_source.yml",
      "status": "modified",
      "additions": 264,
      "deletions": 0,
      "changes": 264,
      "patch": "@@ -138,6 +138,270 @@ keyword with normalizer:\n         keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n         keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n \n+---\n+keyword with non-lowercase normalizer:\n+  - do:\n+      indices.create:\n+        index: test-keyword-with-normalizer\n+        body:\n+          settings:\n+            analysis:\n+              normalizer:\n+                test_normalizer:\n+                  type: custom\n+                  filter:\n+                    - asciifolding\n+                    - uppercase\n+            index:\n+              mapping.source.mode: synthetic\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+                normalizer: test_normalizer\n+              keyword_with_skip_store:\n+                type: keyword\n+                normalizer: test_normalizer\n+                normalizer_skip_store_original_value: true\n+              keyword_with_ignore_above:\n+                type: keyword\n+                normalizer: test_normalizer\n+                ignore_above: 10\n+              keyword_without_doc_values:\n+                type: keyword\n+                normalizer: test_normalizer\n+                doc_values: false\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 1\n+        body:\n+          keyword: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+          keyword_with_skip_store: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+          keyword_with_ignore_above: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+          keyword_without_doc_values: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 2\n+        body:\n+          keyword: \"The five BØXING wìzårds jümp Quickly\"\n+          keyword_with_skip_store: \"The five BØXING wìzårds jümp Quickly\"\n+          keyword_with_ignore_above: \"The five BØXING wìzårds jümp Quickly\"\n+          keyword_without_doc_values: \"The five BØXING wìzårds jümp Quickly\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 3\n+        body:\n+          keyword: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_with_skip_store: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_with_ignore_above: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_without_doc_values: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+\n+  - do:\n+      mget:\n+        index: test-keyword-with-normalizer\n+        body:\n+          ids:    [ 1, 2, 3 ]\n+  - match: { docs.0._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.0._id: \"1\" }\n+  - match:\n+      docs.0._source:\n+        keyword: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+        keyword_with_skip_store: \"THE QUICK BROWN FOX JUMPS OVER THE LAZY DOG\"\n+        keyword_with_ignore_above: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+        keyword_without_doc_values: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+\n+  - match: { docs.1._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.1._id: \"2\" }\n+  - match:\n+      docs.1._source:\n+        keyword: \"The five BØXING wìzårds jümp Quickly\"\n+        keyword_with_skip_store: \"THE FIVE BOXING WIZARDS JUMP QUICKLY\"\n+        keyword_with_ignore_above: \"The five BØXING wìzårds jümp Quickly\"\n+        keyword_without_doc_values: \"The five BØXING wìzårds jümp Quickly\"\n+\n+  - match: { docs.2._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.2._id: \"3\" }\n+  - match:\n+      docs.2._source:\n+        keyword: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_with_skip_store: [ \"DO OR DO NOT, THERE IS NO TRY\", \"MAY THE FORCE BE WITH YOU!\" ]\n+        keyword_with_ignore_above: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_without_doc_values: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+\n+---\n+keyword with normalizer and skip store original value:\n+  - do:\n+      indices.create:\n+        index: test-keyword-with-normalizer\n+        body:\n+          settings:\n+            analysis:\n+              normalizer:\n+                lowercase:\n+                  type: custom\n+                  filter:\n+                    - lowercase\n+            index:\n+              mapping.source.mode: synthetic\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+                normalizer: lowercase\n+                normalizer_skip_store_original_value: true\n+              keyword_with_ignore_above:\n+                type: keyword\n+                normalizer: lowercase\n+                normalizer_skip_store_original_value: true\n+                ignore_above: 10\n+              keyword_without_doc_values:\n+                type: keyword\n+                normalizer: lowercase\n+                normalizer_skip_store_original_value: true\n+                doc_values: false\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 1\n+        body:\n+          keyword: \"the quick brown fox jumps over the lazy dog\"\n+          keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+          keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 2\n+        body:\n+          keyword: \"the five boxing wizards jump quickly\"\n+          keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+          keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 3\n+        body:\n+          keyword: [ \"may the force be with you!\", \"do or do not, there is no try\" ]\n+          keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n+  - do:\n+      mget:\n+        index: test-keyword-with-normalizer\n+        body:\n+          ids:    [ 1, 2, 3 ]\n+  - match: { docs.0._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.0._id: \"1\" }\n+  - match:\n+      docs.0._source:\n+        keyword: \"the quick brown fox jumps over the lazy dog\"\n+        keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+        keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - match: { docs.1._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.1._id: \"2\" }\n+  - match:\n+      docs.1._source:\n+        keyword: \"the five boxing wizards jump quickly\"\n+        keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+        keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - match: { docs.2._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.2._id: \"3\" }\n+  - match:\n+      docs.2._source:\n+        keyword: [ \"do or do not, there is no try\", \"may the force be with you!\" ]\n+        keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n+---\n+\n+keyword with built-in normalizer:\n+  - do:\n+      indices.create:\n+        index: test-keyword-with-normalizer\n+        body:\n+          settings:\n+            index:\n+              mapping.source.mode: synthetic\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+                normalizer: lowercase\n+              keyword_with_ignore_above:\n+                type: keyword\n+                normalizer: lowercase\n+                ignore_above: 10\n+              keyword_without_doc_values:\n+                type: keyword\n+                normalizer: lowercase\n+                doc_values: false\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 1\n+        body:\n+          keyword: \"the quick brown fox jumps over the lazy dog\"\n+          keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+          keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 2\n+        body:\n+          keyword: \"the five boxing wizards jump quickly\"\n+          keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+          keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 3\n+        body:\n+          keyword: [ \"may the force be with you!\", \"do or do not, there is no try\" ]\n+          keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n+  - do:\n+      mget:\n+        index: test-keyword-with-normalizer\n+        body:\n+          ids:    [ 1, 2, 3 ]\n+  - match: { docs.0._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.0._id: \"1\" }\n+  - match:\n+      docs.0._source:\n+        keyword: \"the quick brown fox jumps over the lazy dog\"\n+        keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+        keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - match: { docs.1._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.1._id: \"2\" }\n+  - match:\n+      docs.1._source:\n+        keyword: \"the five boxing wizards jump quickly\"\n+        keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+        keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - match: { docs.2._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.2._id: \"3\" }\n+  - match:\n+      docs.2._source:\n+        keyword: [ \"do or do not, there is no try\", \"may the force be with you!\" ]\n+        keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n ---\n stored text:\n   - requires:"
    },
    {
      "filename": "server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java",
      "status": "modified",
      "additions": 19,
      "deletions": 3,
      "changes": 22,
      "patch": "@@ -47,6 +47,7 @@\n import org.elasticsearch.index.IndexVersion;\n import org.elasticsearch.index.IndexVersions;\n import org.elasticsearch.index.analysis.IndexAnalyzers;\n+import org.elasticsearch.index.analysis.LowercaseNormalizer;\n import org.elasticsearch.index.analysis.NamedAnalyzer;\n import org.elasticsearch.index.fielddata.FieldData;\n import org.elasticsearch.index.fielddata.FieldDataContext;\n@@ -191,6 +192,7 @@ public static final class Builder extends FieldMapper.DimensionBuilder {\n         );\n \n         private final Parameter<String> normalizer;\n+        private final Parameter<Boolean> normalizerSkipStoreOriginalValue;\n \n         private final Parameter<Boolean> splitQueriesOnWhitespace = Parameter.boolParam(\n             \"split_queries_on_whitespace\",\n@@ -278,6 +280,14 @@ private Builder(\n                 m -> toType(m).normalizerName,\n                 null\n             ).acceptsNull();\n+            this.normalizerSkipStoreOriginalValue = Parameter.boolParam(\n+                \"normalizer_skip_store_original_value\",\n+                false,\n+                m -> ((KeywordFieldMapper) m).isNormalizerSkipStoreOriginalValue(),\n+                () -> \"lowercase\".equals(normalizer.getValue())\n+                    && indexAnalyzers.getNormalizer(normalizer.getValue()).analyzer() instanceof LowercaseNormalizer\n+            ).setSerializerCheck((includeDefaults, isConfigured, value) -> includeDefaults || isConfigured || value);\n+\n             this.script.precludesParameters(nullValue);\n             addScriptValidation(script, indexed, hasDocValues);\n \n@@ -407,6 +417,7 @@ protected Parameter<?>[] getParameters() {\n                 hasNorms,\n                 similarity,\n                 normalizer,\n+                normalizerSkipStoreOriginalValue,\n                 splitQueriesOnWhitespace,\n                 script,\n                 onScriptError,\n@@ -1110,6 +1121,7 @@ public Query automatonQuery(\n     private final String indexOptions;\n     private final FieldType fieldType;\n     private final String normalizerName;\n+    private final boolean normalizerSkipStoreOriginalValue;\n     private final boolean splitQueriesOnWhitespace;\n     private final Script script;\n     private final ScriptCompiler scriptCompiler;\n@@ -1140,6 +1152,7 @@ private KeywordFieldMapper(\n         this.indexOptions = builder.indexOptions.getValue();\n         this.fieldType = freezeAndDeduplicateFieldType(fieldType);\n         this.normalizerName = builder.normalizer.getValue();\n+        this.normalizerSkipStoreOriginalValue = builder.normalizerSkipStoreOriginalValue.getValue();\n         this.splitQueriesOnWhitespace = builder.splitQueriesOnWhitespace.getValue();\n         this.script = builder.script.get();\n         this.indexAnalyzers = builder.indexAnalyzers;\n@@ -1164,6 +1177,10 @@ public String getOffsetFieldName() {\n         return offsetsFieldName;\n     }\n \n+    public boolean isNormalizerSkipStoreOriginalValue() {\n+        return normalizerSkipStoreOriginalValue;\n+    }\n+\n     protected void parseCreateField(DocumentParserContext context) throws IOException {\n         var value = context.parser().optimizedTextOrNull();\n \n@@ -1343,9 +1360,8 @@ boolean hasNormalizer() {\n \n     @Override\n     protected SyntheticSourceSupport syntheticSourceSupport() {\n-        if (hasNormalizer()) {\n-            // NOTE: no matter if we have doc values or not we use fallback synthetic source\n-            // to store the original value whose doc values would be altered by the normalizer\n+        if (hasNormalizer() && normalizerSkipStoreOriginalValue == false) {\n+            // NOTE: we use fallback synthetic source to store the original value since the doc values would be altered by the normalizer\n             return SyntheticSourceSupport.FALLBACK;\n         }\n "
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/index/mapper/KeywordFieldMapperTests.java",
      "status": "modified",
      "additions": 48,
      "deletions": 1,
      "changes": 49,
      "patch": "@@ -576,6 +576,48 @@ public void testNormalizerNamedDefault() throws IOException {\n         assertEquals(new BytesRef(\"foo\"), doc.rootDoc().getField(\"field2\").binaryValue());\n     }\n \n+    public void testNormalizerSyntheticSourceKeepOriginalValue() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(\n+                b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\").field(\"normalizer_skip_store_original_value\", false)\n+            )\n+        );\n+        assertEquals(\"{\\\"field\\\":\\\"AbC\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n+    public void testNormalizerSyntheticSourceSkipStoreOriginalValue() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(\n+                b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\").field(\"normalizer_skip_store_original_value\", true)\n+            )\n+        );\n+        assertEquals(\"{\\\"field\\\":\\\"abc\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n+    public void testSkipStoreOriginalValueForLowercaseNormalizer() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\"))\n+        );\n+\n+        var keywordMapper = mapper.mappingLookup().getMapper(\"field\");\n+        assertThat(keywordMapper, Matchers.instanceOf(KeywordFieldMapper.class));\n+        assertTrue(((KeywordFieldMapper) keywordMapper).isNormalizerSkipStoreOriginalValue());\n+\n+        assertEquals(\"{\\\"field\\\":\\\"abc\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n+    public void testSkipStoreOriginalValueForCustomNormalizer() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"other_lowercase\"))\n+        );\n+\n+        var keywordMapper = mapper.mappingLookup().getMapper(\"field\");\n+        assertThat(keywordMapper, Matchers.instanceOf(KeywordFieldMapper.class));\n+        assertFalse(((KeywordFieldMapper) keywordMapper).isNormalizerSkipStoreOriginalValue());\n+\n+        assertEquals(\"{\\\"field\\\":\\\"AbC\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n     public void testParsesKeywordNestedEmptyObjectStrict() throws IOException {\n         DocumentMapper defaultMapper = createDocumentMapper(fieldMapping(this::minimalMapping));\n \n@@ -623,7 +665,11 @@ public void testParsesKeywordNullStrict() throws IOException {\n     }\n \n     public void testUpdateNormalizer() throws IOException {\n-        MapperService mapperService = createMapperService(fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\")));\n+        MapperService mapperService = createMapperService(\n+            fieldMapping(\n+                b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\").field(\"normalizer_skip_store_original_value\", false)\n+            )\n+        );\n         IllegalArgumentException e = expectThrows(\n             IllegalArgumentException.class,\n             () -> merge(mapperService, fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"other_lowercase\")))\n@@ -841,6 +887,7 @@ public void testLegacyField() throws Exception {\n             b.startObject(\"mykeyw\");\n             b.field(\"type\", \"keyword\");\n             b.field(\"normalizer\", \"lowercase\");\n+            b.field(\"normalizer_skip_store_original_value\", false);\n             b.endObject();\n         }));\n         assertThat(service.fieldType(\"mykeyw\"), instanceOf(KeywordFieldMapper.KeywordFieldType.class));"
    }
  ],
  "diff": "diff --git a/docs/changelog/136915.yaml b/docs/changelog/136915.yaml\nnew file mode 100644\nindex 0000000000000..5ad20e260e767\n--- /dev/null\n+++ b/docs/changelog/136915.yaml\n@@ -0,0 +1,16 @@\n+pr: 136915\n+summary: Implement native synthetic source for normalized keywords\n+area: Mapping\n+type: breaking\n+issues: []\n+breaking:\n+  title: Implement native synthetic source for normalized keywords\n+  area: Mapping\n+  details: \"This adds a new mapping parameter `normalizer_skip_store_original_value` to keyword fields. When this\\\n+  \\ parameter is set, and synthetic_source is enabled, keyword fields with configured normalizers will not store the\\\n+  \\ original non-normalized value in _ignored_source, and will instead use the normalized value to reconstruct the\\\n+  \\ source. This parameter enabled by default for the built-in `lowercase` normalizer, and is disabled by default for\\\n+  \\ other custom normalizers.\"\n+  impact: \"Keyword fields using the `lowercase` normalizer will return the normalized value in the source when synthetic\\\n+    \\ source is enabled.\"\n+  notable: false\ndiff --git a/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mget/90_synthetic_source.yml b/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mget/90_synthetic_source.yml\nindex 8485aba0ecc6a..779a0b5c8fb4d 100644\n--- a/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mget/90_synthetic_source.yml\n+++ b/rest-api-spec/src/yamlRestTest/resources/rest-api-spec/test/mget/90_synthetic_source.yml\n@@ -138,6 +138,270 @@ keyword with normalizer:\n         keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n         keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n \n+---\n+keyword with non-lowercase normalizer:\n+  - do:\n+      indices.create:\n+        index: test-keyword-with-normalizer\n+        body:\n+          settings:\n+            analysis:\n+              normalizer:\n+                test_normalizer:\n+                  type: custom\n+                  filter:\n+                    - asciifolding\n+                    - uppercase\n+            index:\n+              mapping.source.mode: synthetic\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+                normalizer: test_normalizer\n+              keyword_with_skip_store:\n+                type: keyword\n+                normalizer: test_normalizer\n+                normalizer_skip_store_original_value: true\n+              keyword_with_ignore_above:\n+                type: keyword\n+                normalizer: test_normalizer\n+                ignore_above: 10\n+              keyword_without_doc_values:\n+                type: keyword\n+                normalizer: test_normalizer\n+                doc_values: false\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 1\n+        body:\n+          keyword: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+          keyword_with_skip_store: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+          keyword_with_ignore_above: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+          keyword_without_doc_values: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 2\n+        body:\n+          keyword: \"The five BØXING wìzårds jümp Quickly\"\n+          keyword_with_skip_store: \"The five BØXING wìzårds jümp Quickly\"\n+          keyword_with_ignore_above: \"The five BØXING wìzårds jümp Quickly\"\n+          keyword_without_doc_values: \"The five BØXING wìzårds jümp Quickly\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 3\n+        body:\n+          keyword: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_with_skip_store: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_with_ignore_above: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_without_doc_values: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+\n+  - do:\n+      mget:\n+        index: test-keyword-with-normalizer\n+        body:\n+          ids:    [ 1, 2, 3 ]\n+  - match: { docs.0._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.0._id: \"1\" }\n+  - match:\n+      docs.0._source:\n+        keyword: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+        keyword_with_skip_store: \"THE QUICK BROWN FOX JUMPS OVER THE LAZY DOG\"\n+        keyword_with_ignore_above: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+        keyword_without_doc_values: \"the Quìck Brøwn Fox jumps over the låzy Dog\"\n+\n+  - match: { docs.1._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.1._id: \"2\" }\n+  - match:\n+      docs.1._source:\n+        keyword: \"The five BØXING wìzårds jümp Quickly\"\n+        keyword_with_skip_store: \"THE FIVE BOXING WIZARDS JUMP QUICKLY\"\n+        keyword_with_ignore_above: \"The five BØXING wìzårds jümp Quickly\"\n+        keyword_without_doc_values: \"The five BØXING wìzårds jümp Quickly\"\n+\n+  - match: { docs.2._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.2._id: \"3\" }\n+  - match:\n+      docs.2._source:\n+        keyword: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_with_skip_store: [ \"DO OR DO NOT, THERE IS NO TRY\", \"MAY THE FORCE BE WITH YOU!\" ]\n+        keyword_with_ignore_above: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_without_doc_values: [ \"Mây the FORCE bè with Yoü!\", \"Do or Do Not, There is no Try\" ]\n+\n+---\n+keyword with normalizer and skip store original value:\n+  - do:\n+      indices.create:\n+        index: test-keyword-with-normalizer\n+        body:\n+          settings:\n+            analysis:\n+              normalizer:\n+                lowercase:\n+                  type: custom\n+                  filter:\n+                    - lowercase\n+            index:\n+              mapping.source.mode: synthetic\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+                normalizer: lowercase\n+                normalizer_skip_store_original_value: true\n+              keyword_with_ignore_above:\n+                type: keyword\n+                normalizer: lowercase\n+                normalizer_skip_store_original_value: true\n+                ignore_above: 10\n+              keyword_without_doc_values:\n+                type: keyword\n+                normalizer: lowercase\n+                normalizer_skip_store_original_value: true\n+                doc_values: false\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 1\n+        body:\n+          keyword: \"the quick brown fox jumps over the lazy dog\"\n+          keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+          keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 2\n+        body:\n+          keyword: \"the five boxing wizards jump quickly\"\n+          keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+          keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 3\n+        body:\n+          keyword: [ \"may the force be with you!\", \"do or do not, there is no try\" ]\n+          keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n+  - do:\n+      mget:\n+        index: test-keyword-with-normalizer\n+        body:\n+          ids:    [ 1, 2, 3 ]\n+  - match: { docs.0._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.0._id: \"1\" }\n+  - match:\n+      docs.0._source:\n+        keyword: \"the quick brown fox jumps over the lazy dog\"\n+        keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+        keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - match: { docs.1._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.1._id: \"2\" }\n+  - match:\n+      docs.1._source:\n+        keyword: \"the five boxing wizards jump quickly\"\n+        keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+        keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - match: { docs.2._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.2._id: \"3\" }\n+  - match:\n+      docs.2._source:\n+        keyword: [ \"do or do not, there is no try\", \"may the force be with you!\" ]\n+        keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n+---\n+\n+keyword with built-in normalizer:\n+  - do:\n+      indices.create:\n+        index: test-keyword-with-normalizer\n+        body:\n+          settings:\n+            index:\n+              mapping.source.mode: synthetic\n+          mappings:\n+            properties:\n+              keyword:\n+                type: keyword\n+                normalizer: lowercase\n+              keyword_with_ignore_above:\n+                type: keyword\n+                normalizer: lowercase\n+                ignore_above: 10\n+              keyword_without_doc_values:\n+                type: keyword\n+                normalizer: lowercase\n+                doc_values: false\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 1\n+        body:\n+          keyword: \"the quick brown fox jumps over the lazy dog\"\n+          keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+          keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 2\n+        body:\n+          keyword: \"the five boxing wizards jump quickly\"\n+          keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+          keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - do:\n+      index:\n+        index: test-keyword-with-normalizer\n+        id: 3\n+        body:\n+          keyword: [ \"may the force be with you!\", \"do or do not, there is no try\" ]\n+          keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+          keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n+  - do:\n+      mget:\n+        index: test-keyword-with-normalizer\n+        body:\n+          ids:    [ 1, 2, 3 ]\n+  - match: { docs.0._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.0._id: \"1\" }\n+  - match:\n+      docs.0._source:\n+        keyword: \"the quick brown fox jumps over the lazy dog\"\n+        keyword_with_ignore_above: \"the Quick Brown Fox jumps over the lazy Dog\"\n+        keyword_without_doc_values: \"the Quick Brown Fox jumps over the lazy Dog\"\n+\n+  - match: { docs.1._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.1._id: \"2\" }\n+  - match:\n+      docs.1._source:\n+        keyword: \"the five boxing wizards jump quickly\"\n+        keyword_with_ignore_above: \"The five BOXING wizards jump Quickly\"\n+        keyword_without_doc_values: \"The five BOXING wizards jump Quickly\"\n+\n+  - match: { docs.2._index: \"test-keyword-with-normalizer\" }\n+  - match: { docs.2._id: \"3\" }\n+  - match:\n+      docs.2._source:\n+        keyword: [ \"do or do not, there is no try\", \"may the force be with you!\" ]\n+        keyword_with_ignore_above: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+        keyword_without_doc_values: [ \"May the FORCE be with You!\", \"Do or Do Not, There is no Try\" ]\n+\n ---\n stored text:\n   - requires:\ndiff --git a/server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java\nindex 18d748713fa64..13b5bf71ebe61 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java\n@@ -47,6 +47,7 @@\n import org.elasticsearch.index.IndexVersion;\n import org.elasticsearch.index.IndexVersions;\n import org.elasticsearch.index.analysis.IndexAnalyzers;\n+import org.elasticsearch.index.analysis.LowercaseNormalizer;\n import org.elasticsearch.index.analysis.NamedAnalyzer;\n import org.elasticsearch.index.fielddata.FieldData;\n import org.elasticsearch.index.fielddata.FieldDataContext;\n@@ -191,6 +192,7 @@ public static final class Builder extends FieldMapper.DimensionBuilder {\n         );\n \n         private final Parameter<String> normalizer;\n+        private final Parameter<Boolean> normalizerSkipStoreOriginalValue;\n \n         private final Parameter<Boolean> splitQueriesOnWhitespace = Parameter.boolParam(\n             \"split_queries_on_whitespace\",\n@@ -278,6 +280,14 @@ private Builder(\n                 m -> toType(m).normalizerName,\n                 null\n             ).acceptsNull();\n+            this.normalizerSkipStoreOriginalValue = Parameter.boolParam(\n+                \"normalizer_skip_store_original_value\",\n+                false,\n+                m -> ((KeywordFieldMapper) m).isNormalizerSkipStoreOriginalValue(),\n+                () -> \"lowercase\".equals(normalizer.getValue())\n+                    && indexAnalyzers.getNormalizer(normalizer.getValue()).analyzer() instanceof LowercaseNormalizer\n+            ).setSerializerCheck((includeDefaults, isConfigured, value) -> includeDefaults || isConfigured || value);\n+\n             this.script.precludesParameters(nullValue);\n             addScriptValidation(script, indexed, hasDocValues);\n \n@@ -407,6 +417,7 @@ protected Parameter<?>[] getParameters() {\n                 hasNorms,\n                 similarity,\n                 normalizer,\n+                normalizerSkipStoreOriginalValue,\n                 splitQueriesOnWhitespace,\n                 script,\n                 onScriptError,\n@@ -1110,6 +1121,7 @@ public Query automatonQuery(\n     private final String indexOptions;\n     private final FieldType fieldType;\n     private final String normalizerName;\n+    private final boolean normalizerSkipStoreOriginalValue;\n     private final boolean splitQueriesOnWhitespace;\n     private final Script script;\n     private final ScriptCompiler scriptCompiler;\n@@ -1140,6 +1152,7 @@ private KeywordFieldMapper(\n         this.indexOptions = builder.indexOptions.getValue();\n         this.fieldType = freezeAndDeduplicateFieldType(fieldType);\n         this.normalizerName = builder.normalizer.getValue();\n+        this.normalizerSkipStoreOriginalValue = builder.normalizerSkipStoreOriginalValue.getValue();\n         this.splitQueriesOnWhitespace = builder.splitQueriesOnWhitespace.getValue();\n         this.script = builder.script.get();\n         this.indexAnalyzers = builder.indexAnalyzers;\n@@ -1164,6 +1177,10 @@ public String getOffsetFieldName() {\n         return offsetsFieldName;\n     }\n \n+    public boolean isNormalizerSkipStoreOriginalValue() {\n+        return normalizerSkipStoreOriginalValue;\n+    }\n+\n     protected void parseCreateField(DocumentParserContext context) throws IOException {\n         var value = context.parser().optimizedTextOrNull();\n \n@@ -1343,9 +1360,8 @@ boolean hasNormalizer() {\n \n     @Override\n     protected SyntheticSourceSupport syntheticSourceSupport() {\n-        if (hasNormalizer()) {\n-            // NOTE: no matter if we have doc values or not we use fallback synthetic source\n-            // to store the original value whose doc values would be altered by the normalizer\n+        if (hasNormalizer() && normalizerSkipStoreOriginalValue == false) {\n+            // NOTE: we use fallback synthetic source to store the original value since the doc values would be altered by the normalizer\n             return SyntheticSourceSupport.FALLBACK;\n         }\n \ndiff --git a/server/src/test/java/org/elasticsearch/index/mapper/KeywordFieldMapperTests.java b/server/src/test/java/org/elasticsearch/index/mapper/KeywordFieldMapperTests.java\nindex 845b2c498e252..69118286eb40f 100644\n--- a/server/src/test/java/org/elasticsearch/index/mapper/KeywordFieldMapperTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/mapper/KeywordFieldMapperTests.java\n@@ -576,6 +576,48 @@ public void testNormalizerNamedDefault() throws IOException {\n         assertEquals(new BytesRef(\"foo\"), doc.rootDoc().getField(\"field2\").binaryValue());\n     }\n \n+    public void testNormalizerSyntheticSourceKeepOriginalValue() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(\n+                b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\").field(\"normalizer_skip_store_original_value\", false)\n+            )\n+        );\n+        assertEquals(\"{\\\"field\\\":\\\"AbC\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n+    public void testNormalizerSyntheticSourceSkipStoreOriginalValue() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(\n+                b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\").field(\"normalizer_skip_store_original_value\", true)\n+            )\n+        );\n+        assertEquals(\"{\\\"field\\\":\\\"abc\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n+    public void testSkipStoreOriginalValueForLowercaseNormalizer() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\"))\n+        );\n+\n+        var keywordMapper = mapper.mappingLookup().getMapper(\"field\");\n+        assertThat(keywordMapper, Matchers.instanceOf(KeywordFieldMapper.class));\n+        assertTrue(((KeywordFieldMapper) keywordMapper).isNormalizerSkipStoreOriginalValue());\n+\n+        assertEquals(\"{\\\"field\\\":\\\"abc\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n+    public void testSkipStoreOriginalValueForCustomNormalizer() throws IOException {\n+        MapperService mapper = createSytheticSourceMapperService(\n+            fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"other_lowercase\"))\n+        );\n+\n+        var keywordMapper = mapper.mappingLookup().getMapper(\"field\");\n+        assertThat(keywordMapper, Matchers.instanceOf(KeywordFieldMapper.class));\n+        assertFalse(((KeywordFieldMapper) keywordMapper).isNormalizerSkipStoreOriginalValue());\n+\n+        assertEquals(\"{\\\"field\\\":\\\"AbC\\\"}\", syntheticSource(mapper.documentMapper(), b -> b.field(\"field\", \"AbC\")));\n+    }\n+\n     public void testParsesKeywordNestedEmptyObjectStrict() throws IOException {\n         DocumentMapper defaultMapper = createDocumentMapper(fieldMapping(this::minimalMapping));\n \n@@ -623,7 +665,11 @@ public void testParsesKeywordNullStrict() throws IOException {\n     }\n \n     public void testUpdateNormalizer() throws IOException {\n-        MapperService mapperService = createMapperService(fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\")));\n+        MapperService mapperService = createMapperService(\n+            fieldMapping(\n+                b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"lowercase\").field(\"normalizer_skip_store_original_value\", false)\n+            )\n+        );\n         IllegalArgumentException e = expectThrows(\n             IllegalArgumentException.class,\n             () -> merge(mapperService, fieldMapping(b -> b.field(\"type\", \"keyword\").field(\"normalizer\", \"other_lowercase\")))\n@@ -841,6 +887,7 @@ public void testLegacyField() throws Exception {\n             b.startObject(\"mykeyw\");\n             b.field(\"type\", \"keyword\");\n             b.field(\"normalizer\", \"lowercase\");\n+            b.field(\"normalizer_skip_store_original_value\", false);\n             b.endObject();\n         }));\n         assertThat(service.fieldType(\"mykeyw\"), instanceOf(KeywordFieldMapper.KeywordFieldType.class));\n",
  "additions": 347,
  "deletions": 4,
  "changed_files": 4,
  "url": "https://github.com/elastic/elasticsearch/pull/136915",
  "mined_at": "2025-10-25T13:40:04.718028"
}