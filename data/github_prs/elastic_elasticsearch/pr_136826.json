{
  "id": 136826,
  "repository": "elastic/elasticsearch",
  "title": "Remove trappy master-node timeouts in `o.e.x.core.action`",
  "body": "Migrates the set-reset-mode and set-upgrade-mode actions to use explicit\r\nmaster-node timeouts. Also moves the test-only `XContent` parsers into\r\nthe test suite.\r\n\r\nRelates #107984",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T20:32:56+00:00",
  "created_at": "2025-10-20T16:14:45+00:00",
  "updated_at": "2025-10-24T20:33:00+00:00",
  "author": "DaveCTurner",
  "reviewers": [
    "DaveCTurner",
    "prwhelan"
  ],
  "base_sha": "4e2b41664b71c1ae34a7445618a25ede04d9c0ff",
  "head_sha": "cba329bebda4426da31a4fcf286591481899acac",
  "review_comments": [
    {
      "user": "prwhelan",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-10-24T17:14:56+00:00"
    },
    {
      "user": "DaveCTurner",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T20:25:59+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/ml-core (Team:ML)",
      "created_at": "2025-10-20T16:15:20+00:00"
    },
    {
      "user": "DaveCTurner",
      "body": "Ah bear with me here, I thought the acked flag didn't matter but it seems it does.",
      "created_at": "2025-10-20T16:59:32+00:00"
    },
    {
      "user": "DaveCTurner",
      "body": "Ok @prwhelan this is good to go now.",
      "created_at": "2025-10-24T15:01:37+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequest.java",
      "status": "modified",
      "additions": 17,
      "deletions": 23,
      "changes": 40,
      "patch": "@@ -8,10 +8,10 @@\n package org.elasticsearch.xpack.core.action;\n \n import org.elasticsearch.action.support.master.AcknowledgedRequest;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.xcontent.ConstructingObjectParser;\n-import org.elasticsearch.xcontent.ParseField;\n+import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.xcontent.ToXContent;\n import org.elasticsearch.xcontent.ToXContentObject;\n import org.elasticsearch.xcontent.XContentBuilder;\n@@ -20,31 +20,23 @@\n import java.util.Objects;\n \n public class SetResetModeActionRequest extends AcknowledgedRequest<SetResetModeActionRequest> implements ToXContentObject {\n-    public static SetResetModeActionRequest enabled() {\n-        return new SetResetModeActionRequest(true, false);\n+\n+    public static SetResetModeActionRequest enabled(TimeValue masterNodeTimeout) {\n+        return new SetResetModeActionRequest(masterNodeTimeout, true, false);\n     }\n \n-    public static SetResetModeActionRequest disabled(boolean deleteMetadata) {\n-        return new SetResetModeActionRequest(false, deleteMetadata);\n+    public static SetResetModeActionRequest disabled(TimeValue masterNodeTimeout, boolean deleteMetadata) {\n+        return new SetResetModeActionRequest(masterNodeTimeout, false, deleteMetadata);\n     }\n \n     private final boolean enabled;\n     private final boolean deleteMetadata;\n \n-    private static final ParseField ENABLED = new ParseField(\"enabled\");\n-    private static final ParseField DELETE_METADATA = new ParseField(\"delete_metadata\");\n-    public static final ConstructingObjectParser<SetResetModeActionRequest, Void> PARSER = new ConstructingObjectParser<>(\n-        \"set_reset_mode_action_request\",\n-        a -> new SetResetModeActionRequest((Boolean) a[0], (Boolean) a[1])\n-    );\n-\n-    static {\n-        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n-        PARSER.declareBoolean(ConstructingObjectParser.optionalConstructorArg(), DELETE_METADATA);\n-    }\n+    static final String ENABLED_FIELD_NAME = \"enabled\";\n+    static final String DELETE_METADATA_FIELD_NAME = \"delete_metadata\";\n \n-    SetResetModeActionRequest(boolean enabled, Boolean deleteMetadata) {\n-        super(TRAPPY_IMPLICIT_DEFAULT_MASTER_NODE_TIMEOUT, DEFAULT_ACK_TIMEOUT);\n+    SetResetModeActionRequest(TimeValue masterNodeTimeout, boolean enabled, Boolean deleteMetadata) {\n+        super(masterNodeTimeout, MasterNodeRequest.INFINITE_MASTER_NODE_TIMEOUT /* wait indefinitely for acks */);\n         this.enabled = enabled;\n         this.deleteMetadata = deleteMetadata != null && deleteMetadata;\n     }\n@@ -72,7 +64,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(enabled, deleteMetadata);\n+        return Objects.hash(masterNodeTimeout(), enabled, deleteMetadata);\n     }\n \n     @Override\n@@ -84,15 +76,17 @@ public boolean equals(Object obj) {\n             return false;\n         }\n         SetResetModeActionRequest other = (SetResetModeActionRequest) obj;\n-        return Objects.equals(enabled, other.enabled) && Objects.equals(deleteMetadata, other.deleteMetadata);\n+        return Objects.equals(masterNodeTimeout(), other.masterNodeTimeout())\n+            && Objects.equals(enabled, other.enabled)\n+            && Objects.equals(deleteMetadata, other.deleteMetadata);\n     }\n \n     @Override\n     public XContentBuilder toXContent(XContentBuilder builder, ToXContent.Params params) throws IOException {\n         builder.startObject();\n-        builder.field(ENABLED.getPreferredName(), enabled);\n+        builder.field(ENABLED_FIELD_NAME, enabled);\n         if (enabled == false) {\n-            builder.field(DELETE_METADATA.getPreferredName(), deleteMetadata);\n+            builder.field(DELETE_METADATA_FIELD_NAME, deleteMetadata);\n         }\n         builder.endObject();\n         return builder;"
    },
    {
      "filename": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetUpgradeModeActionRequest.java",
      "status": "modified",
      "additions": 8,
      "deletions": 17,
      "changes": 25,
      "patch": "@@ -10,8 +10,7 @@\n import org.elasticsearch.action.support.master.AcknowledgedRequest;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.xcontent.ConstructingObjectParser;\n-import org.elasticsearch.xcontent.ParseField;\n+import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.xcontent.ToXContentObject;\n import org.elasticsearch.xcontent.XContentBuilder;\n \n@@ -22,18 +21,8 @@ public class SetUpgradeModeActionRequest extends AcknowledgedRequest<SetUpgradeM\n \n     private final boolean enabled;\n \n-    private static final ParseField ENABLED = new ParseField(\"enabled\");\n-    public static final ConstructingObjectParser<SetUpgradeModeActionRequest, Void> PARSER = new ConstructingObjectParser<>(\n-        \"set_upgrade_mode_action_request\",\n-        a -> new SetUpgradeModeActionRequest((Boolean) a[0])\n-    );\n-\n-    static {\n-        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n-    }\n-\n-    public SetUpgradeModeActionRequest(boolean enabled) {\n-        super(TRAPPY_IMPLICIT_DEFAULT_MASTER_NODE_TIMEOUT, DEFAULT_ACK_TIMEOUT);\n+    public SetUpgradeModeActionRequest(TimeValue masterNodeTimeout, TimeValue ackTimeout, boolean enabled) {\n+        super(masterNodeTimeout, ackTimeout);\n         this.enabled = enabled;\n     }\n \n@@ -54,7 +43,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(enabled);\n+        return Objects.hash(masterNodeTimeout(), ackTimeout(), enabled);\n     }\n \n     @Override\n@@ -66,13 +55,15 @@ public boolean equals(Object obj) {\n             return false;\n         }\n         SetUpgradeModeActionRequest other = (SetUpgradeModeActionRequest) obj;\n-        return enabled == other.enabled();\n+        return Objects.equals(masterNodeTimeout(), other.masterNodeTimeout())\n+            && Objects.equals(ackTimeout(), other.ackTimeout())\n+            && enabled == other.enabled();\n     }\n \n     @Override\n     public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n         builder.startObject();\n-        builder.field(ENABLED.getPreferredName(), enabled);\n+        builder.field(\"enabled\", enabled);\n         builder.endObject();\n         return builder;\n     }"
    },
    {
      "filename": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeAction.java",
      "status": "modified",
      "additions": 3,
      "deletions": 14,
      "changes": 17,
      "patch": "@@ -9,8 +9,7 @@\n import org.elasticsearch.action.ActionType;\n import org.elasticsearch.action.support.master.AcknowledgedResponse;\n import org.elasticsearch.common.io.stream.StreamInput;\n-import org.elasticsearch.xcontent.ConstructingObjectParser;\n-import org.elasticsearch.xcontent.ParseField;\n+import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.xpack.core.action.SetUpgradeModeActionRequest;\n \n import java.io.IOException;\n@@ -26,18 +25,8 @@ private SetUpgradeModeAction() {\n \n     public static class Request extends SetUpgradeModeActionRequest {\n \n-        private static final ParseField ENABLED = new ParseField(\"enabled\");\n-        public static final ConstructingObjectParser<Request, Void> PARSER = new ConstructingObjectParser<>(\n-            NAME,\n-            a -> new Request((Boolean) a[0])\n-        );\n-\n-        static {\n-            PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n-        }\n-\n-        public Request(boolean enabled) {\n-            super(enabled);\n+        public Request(TimeValue masterNodeTimeout, TimeValue ackTimeout, boolean enabled) {\n+            super(masterNodeTimeout, ackTimeout, enabled);\n         }\n \n         public Request(StreamInput in) throws IOException {"
    },
    {
      "filename": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/AbstractTransportSetUpgradeModeActionTests.java",
      "status": "modified",
      "additions": 18,
      "deletions": 8,
      "changes": 26,
      "patch": "@@ -174,19 +174,29 @@ private static class TestTransportSetUpgradeModeAction extends AbstractTransport\n         }\n \n         public void runWithoutWaiting(boolean upgrade) throws Exception {\n-            masterOperation(mock(), new SetUpgradeModeActionRequest(upgrade), ClusterState.EMPTY_STATE, ActionListener.noop());\n+            masterOperation(\n+                mock(),\n+                new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, upgrade),\n+                ClusterState.EMPTY_STATE,\n+                ActionListener.noop()\n+            );\n         }\n \n         public Tuple<AcknowledgedResponse, Exception> run(boolean upgrade) throws Exception {\n             AtomicReference<Tuple<AcknowledgedResponse, Exception>> response = new AtomicReference<>();\n             CountDownLatch latch = new CountDownLatch(1);\n-            masterOperation(mock(), new SetUpgradeModeActionRequest(upgrade), ClusterState.EMPTY_STATE, ActionListener.wrap(r -> {\n-                response.set(Tuple.tuple(r, null));\n-                latch.countDown();\n-            }, e -> {\n-                response.set(Tuple.tuple(null, e));\n-                latch.countDown();\n-            }));\n+            masterOperation(\n+                mock(),\n+                new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, upgrade),\n+                ClusterState.EMPTY_STATE,\n+                ActionListener.wrap(r -> {\n+                    response.set(Tuple.tuple(r, null));\n+                    latch.countDown();\n+                }, e -> {\n+                    response.set(Tuple.tuple(null, e));\n+                    latch.countDown();\n+                })\n+            );\n             assertTrue(\"Failed to run TestTransportSetUpgradeModeAction in 10s\", latch.await(10, TimeUnit.SECONDS));\n             return response.get();\n         }"
    },
    {
      "filename": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequestTests.java",
      "status": "modified",
      "additions": 18,
      "deletions": 2,
      "changes": 20,
      "patch": "@@ -8,14 +8,16 @@\n \n import org.elasticsearch.common.io.stream.Writeable;\n import org.elasticsearch.test.AbstractXContentSerializingTestCase;\n+import org.elasticsearch.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentParser;\n \n public class SetResetModeActionRequestTests extends AbstractXContentSerializingTestCase<SetResetModeActionRequest> {\n \n     @Override\n     protected SetResetModeActionRequest createTestInstance() {\n         boolean enabled = randomBoolean();\n-        return new SetResetModeActionRequest(enabled, enabled == false && randomBoolean());\n+        return new SetResetModeActionRequest(TEST_REQUEST_TIMEOUT, enabled, enabled == false && randomBoolean());\n     }\n \n     @Override\n@@ -30,6 +32,20 @@ protected Writeable.Reader<SetResetModeActionRequest> instanceReader() {\n \n     @Override\n     protected SetResetModeActionRequest doParseInstance(XContentParser parser) {\n-        return SetResetModeActionRequest.PARSER.apply(parser, null);\n+        return PARSER.apply(parser, null);\n     }\n+\n+    public static final ConstructingObjectParser<SetResetModeActionRequest, Void> PARSER = new ConstructingObjectParser<>(\n+        \"set_reset_mode_action_request\",\n+        a -> new SetResetModeActionRequest(TEST_REQUEST_TIMEOUT, (Boolean) a[0], (Boolean) a[1])\n+    );\n+\n+    static {\n+        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), new ParseField(SetResetModeActionRequest.ENABLED_FIELD_NAME));\n+        PARSER.declareBoolean(\n+            ConstructingObjectParser.optionalConstructorArg(),\n+            new ParseField(SetResetModeActionRequest.DELETE_METADATA_FIELD_NAME)\n+        );\n+    }\n+\n }"
    },
    {
      "filename": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeActionRequestTests.java",
      "status": "modified",
      "additions": 15,
      "deletions": 2,
      "changes": 17,
      "patch": "@@ -8,14 +8,26 @@\n \n import org.elasticsearch.common.io.stream.Writeable;\n import org.elasticsearch.test.AbstractXContentSerializingTestCase;\n+import org.elasticsearch.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentParser;\n import org.elasticsearch.xpack.core.ml.action.SetUpgradeModeAction.Request;\n \n public class SetUpgradeModeActionRequestTests extends AbstractXContentSerializingTestCase<Request> {\n \n+    private static final ParseField ENABLED = new ParseField(\"enabled\");\n+    public static final ConstructingObjectParser<Request, Void> PARSER = new ConstructingObjectParser<>(\n+        SetUpgradeModeAction.NAME,\n+        a -> new Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, (Boolean) a[0])\n+    );\n+\n+    static {\n+        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n+    }\n+\n     @Override\n     protected Request createTestInstance() {\n-        return new Request(randomBoolean());\n+        return new Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, randomBoolean());\n     }\n \n     @Override\n@@ -30,6 +42,7 @@ protected Writeable.Reader<Request> instanceReader() {\n \n     @Override\n     protected Request doParseInstance(XContentParser parser) {\n-        return Request.PARSER.apply(parser, null);\n+        return PARSER.apply(parser, null);\n     }\n+\n }"
    },
    {
      "filename": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeIntegTestCase.java",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "patch": "@@ -283,8 +283,10 @@ protected void cleanUpResources() {\n     }\n \n     protected void setUpgradeModeTo(boolean enabled) {\n-        AcknowledgedResponse response = client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(enabled))\n-            .actionGet();\n+        AcknowledgedResponse response = client().execute(\n+            SetUpgradeModeAction.INSTANCE,\n+            new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, enabled)\n+        ).actionGet();\n         assertThat(response.isAcknowledged(), is(true));\n         assertThat(upgradeMode(), is(enabled));\n     }"
    },
    {
      "filename": "x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/AnnotationIndexIT.java",
      "status": "modified",
      "additions": 24,
      "deletions": 12,
      "changes": 36,
      "patch": "@@ -90,7 +90,8 @@ public void testReindexingWithNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -112,7 +113,8 @@ public void testReindexingWithNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         // Ask a few times to increase the chance of failure if the .ml-annotations index is created when no other ML index exists\n         for (int i = 0; i < 10; ++i) {\n@@ -133,7 +135,8 @@ public void testReindexingWithoutNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -155,7 +158,8 @@ public void testReindexingWithoutNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         // Ask a few times to increase the chance of failure if the .ml-annotations index is created when no other ML index exists\n         for (int i = 0; i < 10; ++i) {\n@@ -176,7 +180,8 @@ public void testReindexingWithLostAliasesWithNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -194,7 +199,8 @@ public void testReindexingWithLostAliasesWithNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         assertBusy(() -> {\n             assertFalse(annotationsIndexExists(AnnotationIndex.LATEST_INDEX_NAME));\n@@ -214,7 +220,8 @@ public void testReindexingWithLostAliasesWithoutNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -232,7 +239,8 @@ public void testReindexingWithLostAliasesWithoutNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         assertBusy(() -> {\n             assertFalse(annotationsIndexExists(AnnotationIndex.LATEST_INDEX_NAME));\n@@ -284,7 +292,8 @@ public void testAliasesMovedFromOldToNew() throws Exception {\n \n     public void testNotCreatedWhenAfterOtherMlIndexAndUpgradeInProgress() throws Exception {\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         try {\n             // Creating a document in the .ml-notifications-000002 index would normally cause .ml-annotations\n@@ -305,13 +314,16 @@ public void testNotCreatedWhenAfterOtherMlIndexAndUpgradeInProgress() throws Exc\n                 }\n             });\n         } finally {\n-            client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+            client().execute(\n+                SetUpgradeModeAction.INSTANCE,\n+                new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false)\n+            ).actionGet();\n         }\n     }\n \n     public void testNotCreatedWhenAfterOtherMlIndexAndResetInProgress() throws Exception {\n \n-        client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled()).actionGet();\n+        client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(TEST_REQUEST_TIMEOUT)).actionGet();\n \n         try {\n \n@@ -329,7 +341,7 @@ public void testNotCreatedWhenAfterOtherMlIndexAndResetInProgress() throws Excep\n                 assertEquals(0, numberOfAnnotationsAliases());\n             });\n         } finally {\n-            client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.disabled(true)).actionGet();\n+            client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.disabled(TEST_REQUEST_TIMEOUT, true)).actionGet();\n         }\n     }\n "
    },
    {
      "filename": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java",
      "status": "modified",
      "additions": 28,
      "deletions": 16,
      "changes": 44,
      "patch": "@@ -2057,7 +2057,11 @@ public void prepareForIndicesMigration(ProjectMetadata project, Client client, A\n         Client originClient = new OriginSettingClient(client, ML_ORIGIN);\n         originClient.execute(\n             SetUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeAction.Request(true),\n+            new SetUpgradeModeAction.Request(\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                true\n+            ),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(Collections.singletonMap(\"already_in_upgrade_mode\", false)))\n         );\n     }\n@@ -2074,7 +2078,11 @@ public void indicesMigrationComplete(Map<String, Object> preUpgradeMetadata, Cli\n         Client originClient = new OriginSettingClient(client, ML_ORIGIN);\n         originClient.execute(\n             SetUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeAction.Request(false),\n+            new SetUpgradeModeAction.Request(\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                false\n+            ),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(r.isAcknowledged()))\n         );\n     }\n@@ -2153,23 +2161,27 @@ public void cleanUpFeature(\n \n         ActionListener<ResetFeatureStateResponse.ResetFeatureStateStatus> unsetResetModeListener = ActionListener.wrap(success -> {\n \n-            client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.disabled(true), ActionListener.wrap(resetSuccess -> {\n-                finalListener.onResponse(success);\n-                logger.info(\"Finished machine learning feature reset\");\n-            }, resetFailure -> {\n-                logger.error(\"failed to disable reset mode after state otherwise successful machine learning reset\", resetFailure);\n-                finalListener.onFailure(\n-                    ExceptionsHelper.serverError(\n-                        \"failed to disable reset mode after state otherwise successful machine learning reset\",\n-                        resetFailure\n-                    )\n-                );\n-            }));\n+            client.execute(\n+                SetResetModeAction.INSTANCE,\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, true),\n+                ActionListener.wrap(resetSuccess -> {\n+                    finalListener.onResponse(success);\n+                    logger.info(\"Finished machine learning feature reset\");\n+                }, resetFailure -> {\n+                    logger.error(\"failed to disable reset mode after state otherwise successful machine learning reset\", resetFailure);\n+                    finalListener.onFailure(\n+                        ExceptionsHelper.serverError(\n+                            \"failed to disable reset mode after state otherwise successful machine learning reset\",\n+                            resetFailure\n+                        )\n+                    );\n+                })\n+            );\n         }, failure -> {\n             logger.error(\"failed to reset machine learning\", failure);\n             client.execute(\n                 SetResetModeAction.INSTANCE,\n-                SetResetModeActionRequest.disabled(false),\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, false),\n                 ActionListener.wrap(resetSuccess -> finalListener.onFailure(failure), resetFailure -> {\n                     logger.error(\"failed to disable reset mode after state clean up failure\", resetFailure);\n                     finalListener.onFailure(failure);\n@@ -2353,7 +2365,7 @@ public void cleanUpFeature(\n         }, finalListener::onFailure);\n \n         // Indicate that a reset is now in progress\n-        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(), afterResetModeSet);\n+        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(masterNodeTimeout), afterResetModeSet);\n     }\n \n     @Override"
    },
    {
      "filename": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestSetUpgradeModeAction.java",
      "status": "modified",
      "additions": 5,
      "deletions": 3,
      "changes": 8,
      "patch": "@@ -37,9 +37,11 @@ public String getName() {\n \n     @Override\n     protected RestChannelConsumer prepareRequest(RestRequest restRequest, NodeClient client) throws IOException {\n-        SetUpgradeModeAction.Request request = new SetUpgradeModeAction.Request(restRequest.paramAsBoolean(\"enabled\", false));\n-        request.ackTimeout(getAckTimeout(restRequest));\n-        request.masterNodeTimeout(getMasterNodeTimeout(restRequest));\n+        SetUpgradeModeAction.Request request = new SetUpgradeModeAction.Request(\n+            getMasterNodeTimeout(restRequest),\n+            getAckTimeout(restRequest),\n+            restRequest.paramAsBoolean(\"enabled\", false)\n+        );\n         return channel -> client.execute(SetUpgradeModeAction.INSTANCE, request, new RestToXContentListener<>(channel));\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/MachineLearningTests.java",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "patch": "@@ -77,7 +77,7 @@ public void testPrePostSystemIndexUpgrade_givenNotInUpgradeMode() throws IOExcep\n             assertThat(response.get(), equalTo(Collections.singletonMap(\"already_in_upgrade_mode\", false)));\n             verify(client).execute(\n                 same(SetUpgradeModeAction.INSTANCE),\n-                eq(new SetUpgradeModeAction.Request(true)),\n+                eq(new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true)),\n                 any(ActionListener.class)\n             );\n \n@@ -89,7 +89,7 @@ public void testPrePostSystemIndexUpgrade_givenNotInUpgradeMode() throws IOExcep\n \n             verify(client).execute(\n                 same(SetUpgradeModeAction.INSTANCE),\n-                eq(new SetUpgradeModeAction.Request(false)),\n+                eq(new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false)),\n                 any(ActionListener.class)\n             );\n         } finally {"
    },
    {
      "filename": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java",
      "status": "modified",
      "additions": 5,
      "deletions": 5,
      "changes": 10,
      "patch": "@@ -197,7 +197,7 @@ public void prepareForIndicesMigration(ProjectMetadata project, Client client, A\n         var originClient = new OriginSettingClient(client, TRANSFORM_ORIGIN);\n         originClient.execute(\n             SetTransformUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeActionRequest(true),\n+            new SetUpgradeModeActionRequest(HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, true),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(Map.of(\"already_in_upgrade_mode\", false)))\n         );\n     }\n@@ -214,7 +214,7 @@ public void indicesMigrationComplete(Map<String, Object> preUpgradeMetadata, Cli\n         var originClient = new OriginSettingClient(client, TRANSFORM_ORIGIN);\n         originClient.execute(\n             SetTransformUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeActionRequest(false),\n+            new SetUpgradeModeActionRequest(HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, false),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(r.isAcknowledged()))\n         );\n     }\n@@ -450,7 +450,7 @@ public void cleanUpFeature(\n             }\n             client.execute(\n                 SetResetModeAction.INSTANCE,\n-                SetResetModeActionRequest.disabled(true),\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, true),\n                 ActionListener.wrap(resetSuccess -> finalListener.onResponse(success), resetFailure -> {\n                     logger.error(\"failed to disable reset mode after otherwise successful transform reset\", resetFailure);\n                     finalListener.onFailure(\n@@ -465,7 +465,7 @@ public void cleanUpFeature(\n         },\n             failure -> client.execute(\n                 SetResetModeAction.INSTANCE,\n-                SetResetModeActionRequest.disabled(false),\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, false),\n                 ActionListener.wrap(resetSuccess -> finalListener.onFailure(failure), resetFailure -> {\n                     logger.error(TransformMessages.getMessage(FAILED_TO_UNSET_RESET_MODE, \"a failed feature reset\"), resetFailure);\n                     Exception ex = new ElasticsearchException(\n@@ -549,7 +549,7 @@ public void cleanUpFeature(\n             client.execute(StopTransformAction.INSTANCE, stopTransformsRequest, afterStoppingTransforms);\n         }, finalListener::onFailure);\n \n-        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(), afterResetModeSet);\n+        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(masterNodeTimeout), afterResetModeSet);\n     }\n \n     @Override"
    },
    {
      "filename": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/rest/action/RestSetTransformUpgradeModeAction.java",
      "status": "modified",
      "additions": 5,
      "deletions": 3,
      "changes": 8,
      "patch": "@@ -39,9 +39,11 @@ public String getName() {\n \n     @Override\n     protected RestChannelConsumer prepareRequest(RestRequest restRequest, NodeClient client) throws IOException {\n-        SetUpgradeModeActionRequest request = new SetUpgradeModeActionRequest(restRequest.paramAsBoolean(\"enabled\", false));\n-        request.ackTimeout(getAckTimeout(restRequest));\n-        request.masterNodeTimeout(getMasterNodeTimeout(restRequest));\n+        final var request = new SetUpgradeModeActionRequest(\n+            getMasterNodeTimeout(restRequest),\n+            getAckTimeout(restRequest),\n+            restRequest.paramAsBoolean(\"enabled\", false)\n+        );\n         return channel -> client.execute(SetTransformUpgradeModeAction.INSTANCE, request, new RestToXContentListener<>(channel));\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformTests.java",
      "status": "modified",
      "additions": 10,
      "deletions": 2,
      "changes": 12,
      "patch": "@@ -50,15 +50,23 @@ public void testSetTransformUpgradeMode() {\n             transformPlugin.prepareForIndicesMigration(emptyProject(), client, ActionTestUtils.assertNoFailureListener(response::set));\n \n             assertThat(response.get(), equalTo(Collections.singletonMap(\"already_in_upgrade_mode\", false)));\n-            verify(client).execute(same(SetTransformUpgradeModeAction.INSTANCE), eq(new SetUpgradeModeActionRequest(true)), any());\n+            verify(client).execute(\n+                same(SetTransformUpgradeModeAction.INSTANCE),\n+                eq(new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true)),\n+                any()\n+            );\n \n             transformPlugin.indicesMigrationComplete(\n                 response.get(),\n                 client,\n                 ActionTestUtils.assertNoFailureListener(ESTestCase::assertTrue)\n             );\n \n-            verify(client).execute(same(SetTransformUpgradeModeAction.INSTANCE), eq(new SetUpgradeModeActionRequest(false)), any());\n+            verify(client).execute(\n+                same(SetTransformUpgradeModeAction.INSTANCE),\n+                eq(new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false)),\n+                any()\n+            );\n         } finally {\n             terminate(threadPool);\n         }"
    },
    {
      "filename": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/action/TransportSetTransformUpgradeModeActionTests.java",
      "status": "modified",
      "additions": 17,
      "deletions": 7,
      "changes": 24,
      "patch": "@@ -104,10 +104,16 @@ private ClusterState state(boolean upgradeMode) {\n     }\n \n     public void testCreateUpdatedState() {\n-        var updatedState = action.createUpdatedState(new SetUpgradeModeActionRequest(true), state(false));\n+        var updatedState = action.createUpdatedState(\n+            new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true),\n+            state(false)\n+        );\n         assertTrue(TransformMetadata.upgradeMode(updatedState));\n \n-        updatedState = action.createUpdatedState(new SetUpgradeModeActionRequest(false), state(true));\n+        updatedState = action.createUpdatedState(\n+            new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false),\n+            state(true)\n+        );\n         assertFalse(TransformMetadata.upgradeMode(updatedState));\n     }\n \n@@ -150,7 +156,7 @@ public void testUpgradeModeWithNoTransformTasks() throws InterruptedException {\n \n     private void upgradeModeSuccessfullyChanged(ClusterState state, ActionListener<AcknowledgedResponse> listener)\n         throws InterruptedException {\n-        upgradeModeSuccessfullyChanged(new SetUpgradeModeActionRequest(true), state, listener);\n+        upgradeModeSuccessfullyChanged(new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true), state, listener);\n     }\n \n     private void upgradeModeSuccessfullyChanged(\n@@ -197,9 +203,13 @@ public void testDisableUpgradeMode() throws InterruptedException {\n             listener.onResponse(true);\n             return null;\n         }).when(persistentTasksService).waitForPersistentTasksCondition(any(), any(), any(), any());\n-        upgradeModeSuccessfullyChanged(new SetUpgradeModeActionRequest(false), stateWithTransformTask(), assertNoFailureListener(r -> {\n-            assertThat(r, is(AcknowledgedResponse.TRUE));\n-            verify(clusterService, never()).submitUnbatchedStateUpdateTask(eq(\"unassign persistent task from any node\"), any());\n-        }));\n+        upgradeModeSuccessfullyChanged(\n+            new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false),\n+            stateWithTransformTask(),\n+            assertNoFailureListener(r -> {\n+                assertThat(r, is(AcknowledgedResponse.TRUE));\n+                verify(clusterService, never()).submitUnbatchedStateUpdateTask(eq(\"unassign persistent task from any node\"), any());\n+            })\n+        );\n     }\n }"
    }
  ],
  "diff": "diff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequest.java\nindex 6270c27ac463f..f285c49c7a1d4 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequest.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequest.java\n@@ -8,10 +8,10 @@\n package org.elasticsearch.xpack.core.action;\n \n import org.elasticsearch.action.support.master.AcknowledgedRequest;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.xcontent.ConstructingObjectParser;\n-import org.elasticsearch.xcontent.ParseField;\n+import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.xcontent.ToXContent;\n import org.elasticsearch.xcontent.ToXContentObject;\n import org.elasticsearch.xcontent.XContentBuilder;\n@@ -20,31 +20,23 @@\n import java.util.Objects;\n \n public class SetResetModeActionRequest extends AcknowledgedRequest<SetResetModeActionRequest> implements ToXContentObject {\n-    public static SetResetModeActionRequest enabled() {\n-        return new SetResetModeActionRequest(true, false);\n+\n+    public static SetResetModeActionRequest enabled(TimeValue masterNodeTimeout) {\n+        return new SetResetModeActionRequest(masterNodeTimeout, true, false);\n     }\n \n-    public static SetResetModeActionRequest disabled(boolean deleteMetadata) {\n-        return new SetResetModeActionRequest(false, deleteMetadata);\n+    public static SetResetModeActionRequest disabled(TimeValue masterNodeTimeout, boolean deleteMetadata) {\n+        return new SetResetModeActionRequest(masterNodeTimeout, false, deleteMetadata);\n     }\n \n     private final boolean enabled;\n     private final boolean deleteMetadata;\n \n-    private static final ParseField ENABLED = new ParseField(\"enabled\");\n-    private static final ParseField DELETE_METADATA = new ParseField(\"delete_metadata\");\n-    public static final ConstructingObjectParser<SetResetModeActionRequest, Void> PARSER = new ConstructingObjectParser<>(\n-        \"set_reset_mode_action_request\",\n-        a -> new SetResetModeActionRequest((Boolean) a[0], (Boolean) a[1])\n-    );\n-\n-    static {\n-        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n-        PARSER.declareBoolean(ConstructingObjectParser.optionalConstructorArg(), DELETE_METADATA);\n-    }\n+    static final String ENABLED_FIELD_NAME = \"enabled\";\n+    static final String DELETE_METADATA_FIELD_NAME = \"delete_metadata\";\n \n-    SetResetModeActionRequest(boolean enabled, Boolean deleteMetadata) {\n-        super(TRAPPY_IMPLICIT_DEFAULT_MASTER_NODE_TIMEOUT, DEFAULT_ACK_TIMEOUT);\n+    SetResetModeActionRequest(TimeValue masterNodeTimeout, boolean enabled, Boolean deleteMetadata) {\n+        super(masterNodeTimeout, MasterNodeRequest.INFINITE_MASTER_NODE_TIMEOUT /* wait indefinitely for acks */);\n         this.enabled = enabled;\n         this.deleteMetadata = deleteMetadata != null && deleteMetadata;\n     }\n@@ -72,7 +64,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(enabled, deleteMetadata);\n+        return Objects.hash(masterNodeTimeout(), enabled, deleteMetadata);\n     }\n \n     @Override\n@@ -84,15 +76,17 @@ public boolean equals(Object obj) {\n             return false;\n         }\n         SetResetModeActionRequest other = (SetResetModeActionRequest) obj;\n-        return Objects.equals(enabled, other.enabled) && Objects.equals(deleteMetadata, other.deleteMetadata);\n+        return Objects.equals(masterNodeTimeout(), other.masterNodeTimeout())\n+            && Objects.equals(enabled, other.enabled)\n+            && Objects.equals(deleteMetadata, other.deleteMetadata);\n     }\n \n     @Override\n     public XContentBuilder toXContent(XContentBuilder builder, ToXContent.Params params) throws IOException {\n         builder.startObject();\n-        builder.field(ENABLED.getPreferredName(), enabled);\n+        builder.field(ENABLED_FIELD_NAME, enabled);\n         if (enabled == false) {\n-            builder.field(DELETE_METADATA.getPreferredName(), deleteMetadata);\n+            builder.field(DELETE_METADATA_FIELD_NAME, deleteMetadata);\n         }\n         builder.endObject();\n         return builder;\ndiff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetUpgradeModeActionRequest.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetUpgradeModeActionRequest.java\nindex 98e30b284c21a..665f9fed4e8db 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetUpgradeModeActionRequest.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/action/SetUpgradeModeActionRequest.java\n@@ -10,8 +10,7 @@\n import org.elasticsearch.action.support.master.AcknowledgedRequest;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n-import org.elasticsearch.xcontent.ConstructingObjectParser;\n-import org.elasticsearch.xcontent.ParseField;\n+import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.xcontent.ToXContentObject;\n import org.elasticsearch.xcontent.XContentBuilder;\n \n@@ -22,18 +21,8 @@ public class SetUpgradeModeActionRequest extends AcknowledgedRequest<SetUpgradeM\n \n     private final boolean enabled;\n \n-    private static final ParseField ENABLED = new ParseField(\"enabled\");\n-    public static final ConstructingObjectParser<SetUpgradeModeActionRequest, Void> PARSER = new ConstructingObjectParser<>(\n-        \"set_upgrade_mode_action_request\",\n-        a -> new SetUpgradeModeActionRequest((Boolean) a[0])\n-    );\n-\n-    static {\n-        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n-    }\n-\n-    public SetUpgradeModeActionRequest(boolean enabled) {\n-        super(TRAPPY_IMPLICIT_DEFAULT_MASTER_NODE_TIMEOUT, DEFAULT_ACK_TIMEOUT);\n+    public SetUpgradeModeActionRequest(TimeValue masterNodeTimeout, TimeValue ackTimeout, boolean enabled) {\n+        super(masterNodeTimeout, ackTimeout);\n         this.enabled = enabled;\n     }\n \n@@ -54,7 +43,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(enabled);\n+        return Objects.hash(masterNodeTimeout(), ackTimeout(), enabled);\n     }\n \n     @Override\n@@ -66,13 +55,15 @@ public boolean equals(Object obj) {\n             return false;\n         }\n         SetUpgradeModeActionRequest other = (SetUpgradeModeActionRequest) obj;\n-        return enabled == other.enabled();\n+        return Objects.equals(masterNodeTimeout(), other.masterNodeTimeout())\n+            && Objects.equals(ackTimeout(), other.ackTimeout())\n+            && enabled == other.enabled();\n     }\n \n     @Override\n     public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n         builder.startObject();\n-        builder.field(ENABLED.getPreferredName(), enabled);\n+        builder.field(\"enabled\", enabled);\n         builder.endObject();\n         return builder;\n     }\ndiff --git a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeAction.java b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeAction.java\nindex a67ae33e85801..3bfdd8985de37 100644\n--- a/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeAction.java\n+++ b/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeAction.java\n@@ -9,8 +9,7 @@\n import org.elasticsearch.action.ActionType;\n import org.elasticsearch.action.support.master.AcknowledgedResponse;\n import org.elasticsearch.common.io.stream.StreamInput;\n-import org.elasticsearch.xcontent.ConstructingObjectParser;\n-import org.elasticsearch.xcontent.ParseField;\n+import org.elasticsearch.core.TimeValue;\n import org.elasticsearch.xpack.core.action.SetUpgradeModeActionRequest;\n \n import java.io.IOException;\n@@ -26,18 +25,8 @@ private SetUpgradeModeAction() {\n \n     public static class Request extends SetUpgradeModeActionRequest {\n \n-        private static final ParseField ENABLED = new ParseField(\"enabled\");\n-        public static final ConstructingObjectParser<Request, Void> PARSER = new ConstructingObjectParser<>(\n-            NAME,\n-            a -> new Request((Boolean) a[0])\n-        );\n-\n-        static {\n-            PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n-        }\n-\n-        public Request(boolean enabled) {\n-            super(enabled);\n+        public Request(TimeValue masterNodeTimeout, TimeValue ackTimeout, boolean enabled) {\n+            super(masterNodeTimeout, ackTimeout, enabled);\n         }\n \n         public Request(StreamInput in) throws IOException {\ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/AbstractTransportSetUpgradeModeActionTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/AbstractTransportSetUpgradeModeActionTests.java\nindex 09d033cd9de24..7a8e895a825c5 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/AbstractTransportSetUpgradeModeActionTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/AbstractTransportSetUpgradeModeActionTests.java\n@@ -174,19 +174,29 @@ private static class TestTransportSetUpgradeModeAction extends AbstractTransport\n         }\n \n         public void runWithoutWaiting(boolean upgrade) throws Exception {\n-            masterOperation(mock(), new SetUpgradeModeActionRequest(upgrade), ClusterState.EMPTY_STATE, ActionListener.noop());\n+            masterOperation(\n+                mock(),\n+                new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, upgrade),\n+                ClusterState.EMPTY_STATE,\n+                ActionListener.noop()\n+            );\n         }\n \n         public Tuple<AcknowledgedResponse, Exception> run(boolean upgrade) throws Exception {\n             AtomicReference<Tuple<AcknowledgedResponse, Exception>> response = new AtomicReference<>();\n             CountDownLatch latch = new CountDownLatch(1);\n-            masterOperation(mock(), new SetUpgradeModeActionRequest(upgrade), ClusterState.EMPTY_STATE, ActionListener.wrap(r -> {\n-                response.set(Tuple.tuple(r, null));\n-                latch.countDown();\n-            }, e -> {\n-                response.set(Tuple.tuple(null, e));\n-                latch.countDown();\n-            }));\n+            masterOperation(\n+                mock(),\n+                new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, upgrade),\n+                ClusterState.EMPTY_STATE,\n+                ActionListener.wrap(r -> {\n+                    response.set(Tuple.tuple(r, null));\n+                    latch.countDown();\n+                }, e -> {\n+                    response.set(Tuple.tuple(null, e));\n+                    latch.countDown();\n+                })\n+            );\n             assertTrue(\"Failed to run TestTransportSetUpgradeModeAction in 10s\", latch.await(10, TimeUnit.SECONDS));\n             return response.get();\n         }\ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequestTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequestTests.java\nindex 9f5716ef49ab4..a5ee571bf860f 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequestTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/SetResetModeActionRequestTests.java\n@@ -8,6 +8,8 @@\n \n import org.elasticsearch.common.io.stream.Writeable;\n import org.elasticsearch.test.AbstractXContentSerializingTestCase;\n+import org.elasticsearch.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentParser;\n \n public class SetResetModeActionRequestTests extends AbstractXContentSerializingTestCase<SetResetModeActionRequest> {\n@@ -15,7 +17,7 @@ public class SetResetModeActionRequestTests extends AbstractXContentSerializingT\n     @Override\n     protected SetResetModeActionRequest createTestInstance() {\n         boolean enabled = randomBoolean();\n-        return new SetResetModeActionRequest(enabled, enabled == false && randomBoolean());\n+        return new SetResetModeActionRequest(TEST_REQUEST_TIMEOUT, enabled, enabled == false && randomBoolean());\n     }\n \n     @Override\n@@ -30,6 +32,20 @@ protected Writeable.Reader<SetResetModeActionRequest> instanceReader() {\n \n     @Override\n     protected SetResetModeActionRequest doParseInstance(XContentParser parser) {\n-        return SetResetModeActionRequest.PARSER.apply(parser, null);\n+        return PARSER.apply(parser, null);\n     }\n+\n+    public static final ConstructingObjectParser<SetResetModeActionRequest, Void> PARSER = new ConstructingObjectParser<>(\n+        \"set_reset_mode_action_request\",\n+        a -> new SetResetModeActionRequest(TEST_REQUEST_TIMEOUT, (Boolean) a[0], (Boolean) a[1])\n+    );\n+\n+    static {\n+        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), new ParseField(SetResetModeActionRequest.ENABLED_FIELD_NAME));\n+        PARSER.declareBoolean(\n+            ConstructingObjectParser.optionalConstructorArg(),\n+            new ParseField(SetResetModeActionRequest.DELETE_METADATA_FIELD_NAME)\n+        );\n+    }\n+\n }\ndiff --git a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeActionRequestTests.java b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeActionRequestTests.java\nindex 3b09fd60311e3..a7f2014296fbd 100644\n--- a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeActionRequestTests.java\n+++ b/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/action/SetUpgradeModeActionRequestTests.java\n@@ -8,14 +8,26 @@\n \n import org.elasticsearch.common.io.stream.Writeable;\n import org.elasticsearch.test.AbstractXContentSerializingTestCase;\n+import org.elasticsearch.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.xcontent.ParseField;\n import org.elasticsearch.xcontent.XContentParser;\n import org.elasticsearch.xpack.core.ml.action.SetUpgradeModeAction.Request;\n \n public class SetUpgradeModeActionRequestTests extends AbstractXContentSerializingTestCase<Request> {\n \n+    private static final ParseField ENABLED = new ParseField(\"enabled\");\n+    public static final ConstructingObjectParser<Request, Void> PARSER = new ConstructingObjectParser<>(\n+        SetUpgradeModeAction.NAME,\n+        a -> new Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, (Boolean) a[0])\n+    );\n+\n+    static {\n+        PARSER.declareBoolean(ConstructingObjectParser.constructorArg(), ENABLED);\n+    }\n+\n     @Override\n     protected Request createTestInstance() {\n-        return new Request(randomBoolean());\n+        return new Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, randomBoolean());\n     }\n \n     @Override\n@@ -30,6 +42,7 @@ protected Writeable.Reader<Request> instanceReader() {\n \n     @Override\n     protected Request doParseInstance(XContentParser parser) {\n-        return Request.PARSER.apply(parser, null);\n+        return PARSER.apply(parser, null);\n     }\n+\n }\ndiff --git a/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeIntegTestCase.java b/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeIntegTestCase.java\nindex d1afbc2bf751d..d929537a15e08 100644\n--- a/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeIntegTestCase.java\n+++ b/x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/MlNativeIntegTestCase.java\n@@ -283,8 +283,10 @@ protected void cleanUpResources() {\n     }\n \n     protected void setUpgradeModeTo(boolean enabled) {\n-        AcknowledgedResponse response = client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(enabled))\n-            .actionGet();\n+        AcknowledgedResponse response = client().execute(\n+            SetUpgradeModeAction.INSTANCE,\n+            new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, enabled)\n+        ).actionGet();\n         assertThat(response.isAcknowledged(), is(true));\n         assertThat(upgradeMode(), is(enabled));\n     }\ndiff --git a/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/AnnotationIndexIT.java b/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/AnnotationIndexIT.java\nindex 45fd7640fed59..1434453fb78ad 100644\n--- a/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/AnnotationIndexIT.java\n+++ b/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/AnnotationIndexIT.java\n@@ -90,7 +90,8 @@ public void testReindexingWithNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -112,7 +113,8 @@ public void testReindexingWithNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         // Ask a few times to increase the chance of failure if the .ml-annotations index is created when no other ML index exists\n         for (int i = 0; i < 10; ++i) {\n@@ -133,7 +135,8 @@ public void testReindexingWithoutNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -155,7 +158,8 @@ public void testReindexingWithoutNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         // Ask a few times to increase the chance of failure if the .ml-annotations index is created when no other ML index exists\n         for (int i = 0; i < 10; ++i) {\n@@ -176,7 +180,8 @@ public void testReindexingWithLostAliasesWithNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -194,7 +199,8 @@ public void testReindexingWithLostAliasesWithNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         assertBusy(() -> {\n             assertFalse(annotationsIndexExists(AnnotationIndex.LATEST_INDEX_NAME));\n@@ -214,7 +220,8 @@ public void testReindexingWithLostAliasesWithoutNodeInfo() throws Exception {\n             assertEquals(2, numberOfAnnotationsAliases());\n         });\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         String reindexedIndexName = \".reindexed-v7-ml-annotations-6\";\n         createReindexedIndex(reindexedIndexName);\n@@ -232,7 +239,8 @@ public void testReindexingWithLostAliasesWithoutNodeInfo() throws Exception {\n \n         indicesAdmin().aliases(indicesAliasesRequestBuilder.request()).actionGet();\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false))\n+            .actionGet();\n \n         assertBusy(() -> {\n             assertFalse(annotationsIndexExists(AnnotationIndex.LATEST_INDEX_NAME));\n@@ -284,7 +292,8 @@ public void testAliasesMovedFromOldToNew() throws Exception {\n \n     public void testNotCreatedWhenAfterOtherMlIndexAndUpgradeInProgress() throws Exception {\n \n-        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(true)).actionGet();\n+        client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true))\n+            .actionGet();\n \n         try {\n             // Creating a document in the .ml-notifications-000002 index would normally cause .ml-annotations\n@@ -305,13 +314,16 @@ public void testNotCreatedWhenAfterOtherMlIndexAndUpgradeInProgress() throws Exc\n                 }\n             });\n         } finally {\n-            client().execute(SetUpgradeModeAction.INSTANCE, new SetUpgradeModeAction.Request(false)).actionGet();\n+            client().execute(\n+                SetUpgradeModeAction.INSTANCE,\n+                new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false)\n+            ).actionGet();\n         }\n     }\n \n     public void testNotCreatedWhenAfterOtherMlIndexAndResetInProgress() throws Exception {\n \n-        client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled()).actionGet();\n+        client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(TEST_REQUEST_TIMEOUT)).actionGet();\n \n         try {\n \n@@ -329,7 +341,7 @@ public void testNotCreatedWhenAfterOtherMlIndexAndResetInProgress() throws Excep\n                 assertEquals(0, numberOfAnnotationsAliases());\n             });\n         } finally {\n-            client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.disabled(true)).actionGet();\n+            client().execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.disabled(TEST_REQUEST_TIMEOUT, true)).actionGet();\n         }\n     }\n \ndiff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\nindex 632c5bc17a611..532f9cf5c71d8 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MachineLearning.java\n@@ -2057,7 +2057,11 @@ public void prepareForIndicesMigration(ProjectMetadata project, Client client, A\n         Client originClient = new OriginSettingClient(client, ML_ORIGIN);\n         originClient.execute(\n             SetUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeAction.Request(true),\n+            new SetUpgradeModeAction.Request(\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                true\n+            ),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(Collections.singletonMap(\"already_in_upgrade_mode\", false)))\n         );\n     }\n@@ -2074,7 +2078,11 @@ public void indicesMigrationComplete(Map<String, Object> preUpgradeMetadata, Cli\n         Client originClient = new OriginSettingClient(client, ML_ORIGIN);\n         originClient.execute(\n             SetUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeAction.Request(false),\n+            new SetUpgradeModeAction.Request(\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                MachineLearning.HARD_CODED_MACHINE_LEARNING_MASTER_NODE_TIMEOUT,\n+                false\n+            ),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(r.isAcknowledged()))\n         );\n     }\n@@ -2153,23 +2161,27 @@ public void cleanUpFeature(\n \n         ActionListener<ResetFeatureStateResponse.ResetFeatureStateStatus> unsetResetModeListener = ActionListener.wrap(success -> {\n \n-            client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.disabled(true), ActionListener.wrap(resetSuccess -> {\n-                finalListener.onResponse(success);\n-                logger.info(\"Finished machine learning feature reset\");\n-            }, resetFailure -> {\n-                logger.error(\"failed to disable reset mode after state otherwise successful machine learning reset\", resetFailure);\n-                finalListener.onFailure(\n-                    ExceptionsHelper.serverError(\n-                        \"failed to disable reset mode after state otherwise successful machine learning reset\",\n-                        resetFailure\n-                    )\n-                );\n-            }));\n+            client.execute(\n+                SetResetModeAction.INSTANCE,\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, true),\n+                ActionListener.wrap(resetSuccess -> {\n+                    finalListener.onResponse(success);\n+                    logger.info(\"Finished machine learning feature reset\");\n+                }, resetFailure -> {\n+                    logger.error(\"failed to disable reset mode after state otherwise successful machine learning reset\", resetFailure);\n+                    finalListener.onFailure(\n+                        ExceptionsHelper.serverError(\n+                            \"failed to disable reset mode after state otherwise successful machine learning reset\",\n+                            resetFailure\n+                        )\n+                    );\n+                })\n+            );\n         }, failure -> {\n             logger.error(\"failed to reset machine learning\", failure);\n             client.execute(\n                 SetResetModeAction.INSTANCE,\n-                SetResetModeActionRequest.disabled(false),\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, false),\n                 ActionListener.wrap(resetSuccess -> finalListener.onFailure(failure), resetFailure -> {\n                     logger.error(\"failed to disable reset mode after state clean up failure\", resetFailure);\n                     finalListener.onFailure(failure);\n@@ -2353,7 +2365,7 @@ public void cleanUpFeature(\n         }, finalListener::onFailure);\n \n         // Indicate that a reset is now in progress\n-        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(), afterResetModeSet);\n+        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(masterNodeTimeout), afterResetModeSet);\n     }\n \n     @Override\ndiff --git a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestSetUpgradeModeAction.java b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestSetUpgradeModeAction.java\nindex 1d12a8b555225..c4992bc8faac0 100644\n--- a/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestSetUpgradeModeAction.java\n+++ b/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/rest/RestSetUpgradeModeAction.java\n@@ -37,9 +37,11 @@ public String getName() {\n \n     @Override\n     protected RestChannelConsumer prepareRequest(RestRequest restRequest, NodeClient client) throws IOException {\n-        SetUpgradeModeAction.Request request = new SetUpgradeModeAction.Request(restRequest.paramAsBoolean(\"enabled\", false));\n-        request.ackTimeout(getAckTimeout(restRequest));\n-        request.masterNodeTimeout(getMasterNodeTimeout(restRequest));\n+        SetUpgradeModeAction.Request request = new SetUpgradeModeAction.Request(\n+            getMasterNodeTimeout(restRequest),\n+            getAckTimeout(restRequest),\n+            restRequest.paramAsBoolean(\"enabled\", false)\n+        );\n         return channel -> client.execute(SetUpgradeModeAction.INSTANCE, request, new RestToXContentListener<>(channel));\n     }\n }\ndiff --git a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/MachineLearningTests.java b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/MachineLearningTests.java\nindex 9d77afb69209c..1e6f04eef5eab 100644\n--- a/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/MachineLearningTests.java\n+++ b/x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/MachineLearningTests.java\n@@ -77,7 +77,7 @@ public void testPrePostSystemIndexUpgrade_givenNotInUpgradeMode() throws IOExcep\n             assertThat(response.get(), equalTo(Collections.singletonMap(\"already_in_upgrade_mode\", false)));\n             verify(client).execute(\n                 same(SetUpgradeModeAction.INSTANCE),\n-                eq(new SetUpgradeModeAction.Request(true)),\n+                eq(new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true)),\n                 any(ActionListener.class)\n             );\n \n@@ -89,7 +89,7 @@ public void testPrePostSystemIndexUpgrade_givenNotInUpgradeMode() throws IOExcep\n \n             verify(client).execute(\n                 same(SetUpgradeModeAction.INSTANCE),\n-                eq(new SetUpgradeModeAction.Request(false)),\n+                eq(new SetUpgradeModeAction.Request(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false)),\n                 any(ActionListener.class)\n             );\n         } finally {\ndiff --git a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java\nindex 3738d037bcc5c..33d974205075e 100644\n--- a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java\n+++ b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/Transform.java\n@@ -197,7 +197,7 @@ public void prepareForIndicesMigration(ProjectMetadata project, Client client, A\n         var originClient = new OriginSettingClient(client, TRANSFORM_ORIGIN);\n         originClient.execute(\n             SetTransformUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeActionRequest(true),\n+            new SetUpgradeModeActionRequest(HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, true),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(Map.of(\"already_in_upgrade_mode\", false)))\n         );\n     }\n@@ -214,7 +214,7 @@ public void indicesMigrationComplete(Map<String, Object> preUpgradeMetadata, Cli\n         var originClient = new OriginSettingClient(client, TRANSFORM_ORIGIN);\n         originClient.execute(\n             SetTransformUpgradeModeAction.INSTANCE,\n-            new SetUpgradeModeActionRequest(false),\n+            new SetUpgradeModeActionRequest(HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, HARD_CODED_TRANSFORM_MASTER_NODE_TIMEOUT, false),\n             listener.delegateFailureAndWrap((l, r) -> l.onResponse(r.isAcknowledged()))\n         );\n     }\n@@ -450,7 +450,7 @@ public void cleanUpFeature(\n             }\n             client.execute(\n                 SetResetModeAction.INSTANCE,\n-                SetResetModeActionRequest.disabled(true),\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, true),\n                 ActionListener.wrap(resetSuccess -> finalListener.onResponse(success), resetFailure -> {\n                     logger.error(\"failed to disable reset mode after otherwise successful transform reset\", resetFailure);\n                     finalListener.onFailure(\n@@ -465,7 +465,7 @@ public void cleanUpFeature(\n         },\n             failure -> client.execute(\n                 SetResetModeAction.INSTANCE,\n-                SetResetModeActionRequest.disabled(false),\n+                SetResetModeActionRequest.disabled(masterNodeTimeout, false),\n                 ActionListener.wrap(resetSuccess -> finalListener.onFailure(failure), resetFailure -> {\n                     logger.error(TransformMessages.getMessage(FAILED_TO_UNSET_RESET_MODE, \"a failed feature reset\"), resetFailure);\n                     Exception ex = new ElasticsearchException(\n@@ -549,7 +549,7 @@ public void cleanUpFeature(\n             client.execute(StopTransformAction.INSTANCE, stopTransformsRequest, afterStoppingTransforms);\n         }, finalListener::onFailure);\n \n-        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(), afterResetModeSet);\n+        client.execute(SetResetModeAction.INSTANCE, SetResetModeActionRequest.enabled(masterNodeTimeout), afterResetModeSet);\n     }\n \n     @Override\ndiff --git a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/rest/action/RestSetTransformUpgradeModeAction.java b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/rest/action/RestSetTransformUpgradeModeAction.java\nindex f4e7606c1c1d4..aec09c2db2b9a 100644\n--- a/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/rest/action/RestSetTransformUpgradeModeAction.java\n+++ b/x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/rest/action/RestSetTransformUpgradeModeAction.java\n@@ -39,9 +39,11 @@ public String getName() {\n \n     @Override\n     protected RestChannelConsumer prepareRequest(RestRequest restRequest, NodeClient client) throws IOException {\n-        SetUpgradeModeActionRequest request = new SetUpgradeModeActionRequest(restRequest.paramAsBoolean(\"enabled\", false));\n-        request.ackTimeout(getAckTimeout(restRequest));\n-        request.masterNodeTimeout(getMasterNodeTimeout(restRequest));\n+        final var request = new SetUpgradeModeActionRequest(\n+            getMasterNodeTimeout(restRequest),\n+            getAckTimeout(restRequest),\n+            restRequest.paramAsBoolean(\"enabled\", false)\n+        );\n         return channel -> client.execute(SetTransformUpgradeModeAction.INSTANCE, request, new RestToXContentListener<>(channel));\n     }\n }\ndiff --git a/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformTests.java b/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformTests.java\nindex 5d04f026d9ef2..cabb694be30ea 100644\n--- a/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformTests.java\n+++ b/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformTests.java\n@@ -50,7 +50,11 @@ public void testSetTransformUpgradeMode() {\n             transformPlugin.prepareForIndicesMigration(emptyProject(), client, ActionTestUtils.assertNoFailureListener(response::set));\n \n             assertThat(response.get(), equalTo(Collections.singletonMap(\"already_in_upgrade_mode\", false)));\n-            verify(client).execute(same(SetTransformUpgradeModeAction.INSTANCE), eq(new SetUpgradeModeActionRequest(true)), any());\n+            verify(client).execute(\n+                same(SetTransformUpgradeModeAction.INSTANCE),\n+                eq(new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true)),\n+                any()\n+            );\n \n             transformPlugin.indicesMigrationComplete(\n                 response.get(),\n@@ -58,7 +62,11 @@ public void testSetTransformUpgradeMode() {\n                 ActionTestUtils.assertNoFailureListener(ESTestCase::assertTrue)\n             );\n \n-            verify(client).execute(same(SetTransformUpgradeModeAction.INSTANCE), eq(new SetUpgradeModeActionRequest(false)), any());\n+            verify(client).execute(\n+                same(SetTransformUpgradeModeAction.INSTANCE),\n+                eq(new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false)),\n+                any()\n+            );\n         } finally {\n             terminate(threadPool);\n         }\ndiff --git a/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/action/TransportSetTransformUpgradeModeActionTests.java b/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/action/TransportSetTransformUpgradeModeActionTests.java\nindex 33fad76117a53..cf20935c1011f 100644\n--- a/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/action/TransportSetTransformUpgradeModeActionTests.java\n+++ b/x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/action/TransportSetTransformUpgradeModeActionTests.java\n@@ -104,10 +104,16 @@ private ClusterState state(boolean upgradeMode) {\n     }\n \n     public void testCreateUpdatedState() {\n-        var updatedState = action.createUpdatedState(new SetUpgradeModeActionRequest(true), state(false));\n+        var updatedState = action.createUpdatedState(\n+            new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true),\n+            state(false)\n+        );\n         assertTrue(TransformMetadata.upgradeMode(updatedState));\n \n-        updatedState = action.createUpdatedState(new SetUpgradeModeActionRequest(false), state(true));\n+        updatedState = action.createUpdatedState(\n+            new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false),\n+            state(true)\n+        );\n         assertFalse(TransformMetadata.upgradeMode(updatedState));\n     }\n \n@@ -150,7 +156,7 @@ public void testUpgradeModeWithNoTransformTasks() throws InterruptedException {\n \n     private void upgradeModeSuccessfullyChanged(ClusterState state, ActionListener<AcknowledgedResponse> listener)\n         throws InterruptedException {\n-        upgradeModeSuccessfullyChanged(new SetUpgradeModeActionRequest(true), state, listener);\n+        upgradeModeSuccessfullyChanged(new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, true), state, listener);\n     }\n \n     private void upgradeModeSuccessfullyChanged(\n@@ -197,9 +203,13 @@ public void testDisableUpgradeMode() throws InterruptedException {\n             listener.onResponse(true);\n             return null;\n         }).when(persistentTasksService).waitForPersistentTasksCondition(any(), any(), any(), any());\n-        upgradeModeSuccessfullyChanged(new SetUpgradeModeActionRequest(false), stateWithTransformTask(), assertNoFailureListener(r -> {\n-            assertThat(r, is(AcknowledgedResponse.TRUE));\n-            verify(clusterService, never()).submitUnbatchedStateUpdateTask(eq(\"unassign persistent task from any node\"), any());\n-        }));\n+        upgradeModeSuccessfullyChanged(\n+            new SetUpgradeModeActionRequest(TEST_REQUEST_TIMEOUT, TEST_REQUEST_TIMEOUT, false),\n+            stateWithTransformTask(),\n+            assertNoFailureListener(r -> {\n+                assertThat(r, is(AcknowledgedResponse.TRUE));\n+                verify(clusterService, never()).submitUnbatchedStateUpdateTask(eq(\"unassign persistent task from any node\"), any());\n+            })\n+        );\n     }\n }\n",
  "additions": 179,
  "deletions": 118,
  "changed_files": 15,
  "url": "https://github.com/elastic/elasticsearch/pull/136826",
  "mined_at": "2025-10-25T13:13:04.212774"
}