{
  "id": 137107,
  "repository": "elastic/elasticsearch",
  "title": "[9.2] Unmute flaky csv-spec tests with more logging on warnings context (#137089)",
  "body": "This is a manual backport of #137089 to 9.2\r\n\r\nThese tests do not reproduce, even with reported random seeds. We are unmuting them in the hope that the additional logging will bring some clarity to the situation under which they fail.\r\n\r\nCloses #136285\r\nCloses #136068\r\n",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T14:37:09+00:00",
  "created_at": "2025-10-24T13:34:39+00:00",
  "updated_at": "2025-10-24T14:37:32+00:00",
  "author": "craigtaverner",
  "reviewers": [],
  "base_sha": "fa16bca8eb6ac67e800fcec837300425b81bb714",
  "head_sha": "a723220d1c8b01e12003c0a0f66378030a387be7",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "muted-tests.yml",
      "status": "modified",
      "additions": 0,
      "deletions": 15,
      "changes": 15,
      "patch": "@@ -414,9 +414,6 @@ tests:\n - class: org.elasticsearch.xpack.security.authc.AuthenticationServiceTests\n   method: testInvalidToken\n   issue: https://github.com/elastic/elasticsearch/issues/133328\n-- class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n-  method: test {csv-spec:change_point.Values null column}\n-  issue: https://github.com/elastic/elasticsearch/issues/133334\n - class: org.elasticsearch.xpack.search.CrossClusterAsyncSearchIT\n   method: testCancelViaExpirationOnRemoteResultsWithMinimizeRoundtrips\n   issue: https://github.com/elastic/elasticsearch/issues/127302\n@@ -438,18 +435,12 @@ tests:\n - class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n   method: test {csv-spec:fork.ForkBeforeStats}\n   issue: https://github.com/elastic/elasticsearch/issues/134100\n-- class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n-  method: test {csv-spec:spatial.ConvertFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/134104\n - class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n   method: test {csv-spec:fork.ForkWithMixOfCommands}\n   issue: https://github.com/elastic/elasticsearch/issues/134135\n - class: org.elasticsearch.xpack.esql.qa.single_node.GenerativeForkIT\n   method: test {csv-spec:inlinestats.MultiIndexInlinestatsOfMultiTypedField}\n   issue: https://github.com/elastic/elasticsearch/issues/133973\n-- class: org.elasticsearch.xpack.esql.qa.single_node.GenerativeForkIT\n-  method: test {csv-spec:spatial_shapes.ConvertFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/134254\n - class: org.elasticsearch.xpack.esql.expression.function.scalar.score.DecayTests\n   method: \"testEvaluateBlockWithNulls {TestCase=<double>, <double>, <double>, <_source> #11}\"\n   issue: https://github.com/elastic/elasticsearch/issues/134447\n@@ -468,9 +459,6 @@ tests:\n - class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n   method: test {csv-spec:fork.FiveFork}\n   issue: https://github.com/elastic/elasticsearch/issues/134560\n-- class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n-  method: test {csv-spec:spatial.ConvertCartesianFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/134635\n - class: org.elasticsearch.xpack.esql.analysis.AnalyzerTests\n   method: testDenseVectorImplicitCastingKnnQueryParams\n   issue: https://github.com/elastic/elasticsearch/issues/134639\n@@ -549,9 +537,6 @@ tests:\n - class: org.elasticsearch.gradle.TestClustersPluginFuncTest\n   method: override jdk usage via ES_JAVA_HOME for known jdk os incompatibilities\n   issue: https://github.com/elastic/elasticsearch/issues/135413\n-- class: org.elasticsearch.xpack.esql.qa.single_node.EsqlSpecIT\n-  method: test {csv-spec:spatial_shapes.ConvertCartesianShapeFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/135455\n - class: org.elasticsearch.xpack.esql.inference.textembedding.TextEmbeddingOperatorTests\n   method: testSimpleCircuitBreaking\n   issue: https://github.com/elastic/elasticsearch/issues/135569"
    },
    {
      "filename": "x-pack/plugin/esql/qa/server/src/main/java/org/elasticsearch/xpack/esql/qa/rest/RestEsqlTestCase.java",
      "status": "modified",
      "additions": 9,
      "deletions": 9,
      "changes": 18,
      "patch": "@@ -405,10 +405,10 @@ public void testCSVNoHeaderMode() throws IOException {\n         options.addHeader(\"Accept\", \"text/csv; header=absent\");\n         request.setOptions(options);\n         Response response = performRequest(request);\n-        assertWarnings(response, new AssertWarnings.NoWarnings());\n         HttpEntity entity = response.getEntity();\n         String actual = Streams.copyToString(new InputStreamReader(entity.getContent(), StandardCharsets.UTF_8));\n         assertEquals(\"keyword0,0\\r\\n\", actual);\n+        assertWarnings(response, new AssertWarnings.NoWarnings(), actual);\n     }\n \n     public void testOutOfRangeComparisons() throws IOException {\n@@ -1433,7 +1433,7 @@ public static Map<String, Object> runEsqlSync(\n         if (supportsAsyncHeadersFix) {\n             assertNoAsyncHeaders(response);\n         }\n-        assertWarnings(response, assertWarnings);\n+        assertWarnings(response, assertWarnings, json);\n \n         return json;\n     }\n@@ -1485,7 +1485,7 @@ public static Map<String, Object> runEsqlAsync(\n             if (profileLogger != null) {\n                 profileLogger.extractProfile(json, profileEnabled);\n             }\n-            assertWarnings(response, assertWarnings);\n+            assertWarnings(response, assertWarnings, json);\n             json.remove(\"is_running\"); // remove this to not mess up later map assertions\n             return Collections.unmodifiableMap(json);\n         } else {\n@@ -1498,7 +1498,7 @@ public static Map<String, Object> runEsqlAsync(\n                 if (profileLogger != null) {\n                     profileLogger.extractProfile(json, profileEnabled);\n                 }\n-                assertWarnings(response, assertWarnings);\n+                assertWarnings(response, assertWarnings, json);\n                 // we already have the results, but let's remember them so that we can compare to async get\n                 initialColumns = json.get(\"columns\");\n                 initialValues = json.get(\"values\");\n@@ -1538,7 +1538,7 @@ public static Map<String, Object> runEsqlAsync(\n         if (profileLogger != null) {\n             profileLogger.extractProfile(result, profileEnabled);\n         }\n-        assertWarnings(response, assertWarnings);\n+        assertWarnings(response, assertWarnings, result);\n         assertDeletable(id);\n         return removeAsyncProperties(result);\n     }\n@@ -1801,12 +1801,12 @@ static String runEsqlAsTextWithFormat(RequestObjectBuilder builder, String forma\n         }\n \n         Response response = performRequest(request);\n-        assertWarnings(response, new AssertWarnings.NoWarnings());\n         HttpEntity entity = response.getEntity();\n \n         // get the content, it could be empty because the request might have not completed\n         String initialValue = Streams.copyToString(new InputStreamReader(entity.getContent(), StandardCharsets.UTF_8));\n         String id = response.getHeader(\"X-Elasticsearch-Async-Id\");\n+        assertWarnings(response, new AssertWarnings.NoWarnings(), initialValue);\n \n         if (mode == SYNC) {\n             assertThat(id, is(emptyOrNullString()));\n@@ -1855,10 +1855,10 @@ static String runEsqlAsTextWithFormat(RequestObjectBuilder builder, String forma\n             // if `addParam` is false, `options` will already have an `Accept` header\n             getRequest.setOptions(options);\n             response = performRequest(getRequest);\n-            assertWarnings(response, new AssertWarnings.NoWarnings());\n             entity = response.getEntity();\n         }\n         String newValue = Streams.copyToString(new InputStreamReader(entity.getContent(), StandardCharsets.UTF_8));\n+        assertWarnings(response, new AssertWarnings.NoWarnings(), newValue);\n \n         // assert initial contents, if any, are the same as async get contents\n         if (initialValue != null && initialValue.isEmpty() == false) {\n@@ -1911,13 +1911,13 @@ static void assertNotPartial(Map<String, Object> answer) {\n         assertThat(reason, answer.get(\"is_partial\"), anyOf(nullValue(), is(false)));\n     }\n \n-    private static void assertWarnings(Response response, AssertWarnings assertWarnings) {\n+    private static void assertWarnings(Response response, AssertWarnings assertWarnings, Object context) {\n         List<String> warnings = new ArrayList<>(response.getWarnings());\n         warnings.removeAll(mutedWarnings());\n         if (shouldLog()) {\n             LOGGER.info(\"RESPONSE warnings (after muted)={}\", warnings);\n         }\n-        assertWarnings.assertWarnings(warnings);\n+        assertWarnings.assertWarnings(warnings, context);\n     }\n \n     private static Set<String> mutedWarnings() {"
    },
    {
      "filename": "x-pack/plugin/esql/qa/testFixtures/src/main/java/org/elasticsearch/xpack/esql/AssertWarnings.java",
      "status": "modified",
      "additions": 30,
      "deletions": 9,
      "changes": 39,
      "patch": "@@ -18,34 +18,55 @@\n  * How should we assert the warnings returned by ESQL.\n  */\n public interface AssertWarnings {\n-    void assertWarnings(List<String> warnings);\n+    void assertWarnings(List<String> warnings, Object context);\n+\n+    default String contextMessage(Object context) {\n+        if (context == null) {\n+            return \"\";\n+        }\n+        StringBuilder contextBuilder = new StringBuilder();\n+        contextBuilder.append(\"Context: \").append(context);\n+        if (contextBuilder.length() > 1000) {\n+            contextBuilder.setLength(1000);\n+            contextBuilder.append(\"...(truncated)\");\n+        }\n+        contextBuilder.append(\"\\n\");\n+        return contextBuilder.toString();\n+    }\n \n     record NoWarnings() implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n-            assertMap(warnings.stream().sorted().toList(), matchesList());\n+        public void assertWarnings(List<String> warnings, Object context) {\n+            assertMap(contextMessage(context), warnings.stream().sorted().toList(), matchesList());\n         }\n     }\n \n     record ExactStrings(List<String> expected) implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n-            assertMap(warnings.stream().sorted().toList(), matchesList(expected.stream().sorted().toList()));\n+        public void assertWarnings(List<String> warnings, Object context) {\n+            assertMap(contextMessage(context), warnings.stream().sorted().toList(), matchesList(expected.stream().sorted().toList()));\n         }\n     }\n \n     record DeduplicatedStrings(List<String> expected) implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n-            assertMap(warnings.stream().sorted().distinct().toList(), matchesList(expected.stream().sorted().toList()));\n+        public void assertWarnings(List<String> warnings, Object context) {\n+            assertMap(\n+                contextMessage(context),\n+                warnings.stream().sorted().distinct().toList(),\n+                matchesList(expected.stream().sorted().toList())\n+            );\n         }\n     }\n \n     record AllowedRegexes(List<Pattern> expected) implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n+        public void assertWarnings(List<String> warnings, Object context) {\n             for (String warning : warnings) {\n-                assertTrue(\"Unexpected warning: \" + warning, expected.stream().anyMatch(x -> x.matcher(warning).matches()));\n+                assertTrue(\n+                    contextMessage(context) + \"Unexpected warning: \" + warning,\n+                    expected.stream().anyMatch(x -> x.matcher(warning).matches())\n+                );\n             }\n         }\n     }"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/CsvTests.java",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "patch": "@@ -387,7 +387,7 @@ private void doTest() throws Exception {\n \n             var log = logResults() ? LOGGER : null;\n             assertResults(expected, actualResults, testCase.ignoreOrder, log);\n-            assertWarnings(actualResults.responseHeaders().getOrDefault(\"Warning\", List.of()));\n+            assertWarnings(actualResults.responseHeaders().getOrDefault(\"Warning\", List.of()), actualResults);\n         } finally {\n             Releasables.close(() -> Iterators.map(actualResults.pages().iterator(), p -> p::releaseBlocks));\n             // Give the breaker service some time to clear in case we got results before the rest of the driver had cleaned up\n@@ -673,7 +673,7 @@ private void opportunisticallyAssertPlanSerialization(PhysicalPlan plan) {\n         SerializationTestUtils.assertSerialization(plan, configuration);\n     }\n \n-    private void assertWarnings(List<String> warnings) {\n+    private void assertWarnings(List<String> warnings, Object context) {\n         List<String> normalized = new ArrayList<>(warnings.size());\n         for (String w : warnings) {\n             String normW = HeaderWarning.extractWarningValueFromWarningHeader(w, false);\n@@ -682,7 +682,7 @@ private void assertWarnings(List<String> warnings) {\n                 normalized.add(normW);\n             }\n         }\n-        testCase.assertWarnings(false).assertWarnings(normalized);\n+        testCase.assertWarnings(false).assertWarnings(normalized, context);\n     }\n \n     PlanRunner planRunner(BigArrays bigArrays, TestPhysicalOperationProviders physicalOperationProviders) {"
    }
  ],
  "diff": "diff --git a/muted-tests.yml b/muted-tests.yml\nindex 31531665fd329..7263fbf789d1d 100644\n--- a/muted-tests.yml\n+++ b/muted-tests.yml\n@@ -414,9 +414,6 @@ tests:\n - class: org.elasticsearch.xpack.security.authc.AuthenticationServiceTests\n   method: testInvalidToken\n   issue: https://github.com/elastic/elasticsearch/issues/133328\n-- class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n-  method: test {csv-spec:change_point.Values null column}\n-  issue: https://github.com/elastic/elasticsearch/issues/133334\n - class: org.elasticsearch.xpack.search.CrossClusterAsyncSearchIT\n   method: testCancelViaExpirationOnRemoteResultsWithMinimizeRoundtrips\n   issue: https://github.com/elastic/elasticsearch/issues/127302\n@@ -438,18 +435,12 @@ tests:\n - class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n   method: test {csv-spec:fork.ForkBeforeStats}\n   issue: https://github.com/elastic/elasticsearch/issues/134100\n-- class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n-  method: test {csv-spec:spatial.ConvertFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/134104\n - class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n   method: test {csv-spec:fork.ForkWithMixOfCommands}\n   issue: https://github.com/elastic/elasticsearch/issues/134135\n - class: org.elasticsearch.xpack.esql.qa.single_node.GenerativeForkIT\n   method: test {csv-spec:inlinestats.MultiIndexInlinestatsOfMultiTypedField}\n   issue: https://github.com/elastic/elasticsearch/issues/133973\n-- class: org.elasticsearch.xpack.esql.qa.single_node.GenerativeForkIT\n-  method: test {csv-spec:spatial_shapes.ConvertFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/134254\n - class: org.elasticsearch.xpack.esql.expression.function.scalar.score.DecayTests\n   method: \"testEvaluateBlockWithNulls {TestCase=<double>, <double>, <double>, <_source> #11}\"\n   issue: https://github.com/elastic/elasticsearch/issues/134447\n@@ -468,9 +459,6 @@ tests:\n - class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n   method: test {csv-spec:fork.FiveFork}\n   issue: https://github.com/elastic/elasticsearch/issues/134560\n-- class: org.elasticsearch.xpack.esql.ccq.MultiClusterSpecIT\n-  method: test {csv-spec:spatial.ConvertCartesianFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/134635\n - class: org.elasticsearch.xpack.esql.analysis.AnalyzerTests\n   method: testDenseVectorImplicitCastingKnnQueryParams\n   issue: https://github.com/elastic/elasticsearch/issues/134639\n@@ -549,9 +537,6 @@ tests:\n - class: org.elasticsearch.gradle.TestClustersPluginFuncTest\n   method: override jdk usage via ES_JAVA_HOME for known jdk os incompatibilities\n   issue: https://github.com/elastic/elasticsearch/issues/135413\n-- class: org.elasticsearch.xpack.esql.qa.single_node.EsqlSpecIT\n-  method: test {csv-spec:spatial_shapes.ConvertCartesianShapeFromStringParseError}\n-  issue: https://github.com/elastic/elasticsearch/issues/135455\n - class: org.elasticsearch.xpack.esql.inference.textembedding.TextEmbeddingOperatorTests\n   method: testSimpleCircuitBreaking\n   issue: https://github.com/elastic/elasticsearch/issues/135569\ndiff --git a/x-pack/plugin/esql/qa/server/src/main/java/org/elasticsearch/xpack/esql/qa/rest/RestEsqlTestCase.java b/x-pack/plugin/esql/qa/server/src/main/java/org/elasticsearch/xpack/esql/qa/rest/RestEsqlTestCase.java\nindex b098c4be0cdf3..f8fccc1339313 100644\n--- a/x-pack/plugin/esql/qa/server/src/main/java/org/elasticsearch/xpack/esql/qa/rest/RestEsqlTestCase.java\n+++ b/x-pack/plugin/esql/qa/server/src/main/java/org/elasticsearch/xpack/esql/qa/rest/RestEsqlTestCase.java\n@@ -405,10 +405,10 @@ public void testCSVNoHeaderMode() throws IOException {\n         options.addHeader(\"Accept\", \"text/csv; header=absent\");\n         request.setOptions(options);\n         Response response = performRequest(request);\n-        assertWarnings(response, new AssertWarnings.NoWarnings());\n         HttpEntity entity = response.getEntity();\n         String actual = Streams.copyToString(new InputStreamReader(entity.getContent(), StandardCharsets.UTF_8));\n         assertEquals(\"keyword0,0\\r\\n\", actual);\n+        assertWarnings(response, new AssertWarnings.NoWarnings(), actual);\n     }\n \n     public void testOutOfRangeComparisons() throws IOException {\n@@ -1433,7 +1433,7 @@ public static Map<String, Object> runEsqlSync(\n         if (supportsAsyncHeadersFix) {\n             assertNoAsyncHeaders(response);\n         }\n-        assertWarnings(response, assertWarnings);\n+        assertWarnings(response, assertWarnings, json);\n \n         return json;\n     }\n@@ -1485,7 +1485,7 @@ public static Map<String, Object> runEsqlAsync(\n             if (profileLogger != null) {\n                 profileLogger.extractProfile(json, profileEnabled);\n             }\n-            assertWarnings(response, assertWarnings);\n+            assertWarnings(response, assertWarnings, json);\n             json.remove(\"is_running\"); // remove this to not mess up later map assertions\n             return Collections.unmodifiableMap(json);\n         } else {\n@@ -1498,7 +1498,7 @@ public static Map<String, Object> runEsqlAsync(\n                 if (profileLogger != null) {\n                     profileLogger.extractProfile(json, profileEnabled);\n                 }\n-                assertWarnings(response, assertWarnings);\n+                assertWarnings(response, assertWarnings, json);\n                 // we already have the results, but let's remember them so that we can compare to async get\n                 initialColumns = json.get(\"columns\");\n                 initialValues = json.get(\"values\");\n@@ -1538,7 +1538,7 @@ public static Map<String, Object> runEsqlAsync(\n         if (profileLogger != null) {\n             profileLogger.extractProfile(result, profileEnabled);\n         }\n-        assertWarnings(response, assertWarnings);\n+        assertWarnings(response, assertWarnings, result);\n         assertDeletable(id);\n         return removeAsyncProperties(result);\n     }\n@@ -1801,12 +1801,12 @@ static String runEsqlAsTextWithFormat(RequestObjectBuilder builder, String forma\n         }\n \n         Response response = performRequest(request);\n-        assertWarnings(response, new AssertWarnings.NoWarnings());\n         HttpEntity entity = response.getEntity();\n \n         // get the content, it could be empty because the request might have not completed\n         String initialValue = Streams.copyToString(new InputStreamReader(entity.getContent(), StandardCharsets.UTF_8));\n         String id = response.getHeader(\"X-Elasticsearch-Async-Id\");\n+        assertWarnings(response, new AssertWarnings.NoWarnings(), initialValue);\n \n         if (mode == SYNC) {\n             assertThat(id, is(emptyOrNullString()));\n@@ -1855,10 +1855,10 @@ static String runEsqlAsTextWithFormat(RequestObjectBuilder builder, String forma\n             // if `addParam` is false, `options` will already have an `Accept` header\n             getRequest.setOptions(options);\n             response = performRequest(getRequest);\n-            assertWarnings(response, new AssertWarnings.NoWarnings());\n             entity = response.getEntity();\n         }\n         String newValue = Streams.copyToString(new InputStreamReader(entity.getContent(), StandardCharsets.UTF_8));\n+        assertWarnings(response, new AssertWarnings.NoWarnings(), newValue);\n \n         // assert initial contents, if any, are the same as async get contents\n         if (initialValue != null && initialValue.isEmpty() == false) {\n@@ -1911,13 +1911,13 @@ static void assertNotPartial(Map<String, Object> answer) {\n         assertThat(reason, answer.get(\"is_partial\"), anyOf(nullValue(), is(false)));\n     }\n \n-    private static void assertWarnings(Response response, AssertWarnings assertWarnings) {\n+    private static void assertWarnings(Response response, AssertWarnings assertWarnings, Object context) {\n         List<String> warnings = new ArrayList<>(response.getWarnings());\n         warnings.removeAll(mutedWarnings());\n         if (shouldLog()) {\n             LOGGER.info(\"RESPONSE warnings (after muted)={}\", warnings);\n         }\n-        assertWarnings.assertWarnings(warnings);\n+        assertWarnings.assertWarnings(warnings, context);\n     }\n \n     private static Set<String> mutedWarnings() {\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/java/org/elasticsearch/xpack/esql/AssertWarnings.java b/x-pack/plugin/esql/qa/testFixtures/src/main/java/org/elasticsearch/xpack/esql/AssertWarnings.java\nindex f606d36ee6b6c..b8a42879b8c19 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/java/org/elasticsearch/xpack/esql/AssertWarnings.java\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/java/org/elasticsearch/xpack/esql/AssertWarnings.java\n@@ -18,34 +18,55 @@\n  * How should we assert the warnings returned by ESQL.\n  */\n public interface AssertWarnings {\n-    void assertWarnings(List<String> warnings);\n+    void assertWarnings(List<String> warnings, Object context);\n+\n+    default String contextMessage(Object context) {\n+        if (context == null) {\n+            return \"\";\n+        }\n+        StringBuilder contextBuilder = new StringBuilder();\n+        contextBuilder.append(\"Context: \").append(context);\n+        if (contextBuilder.length() > 1000) {\n+            contextBuilder.setLength(1000);\n+            contextBuilder.append(\"...(truncated)\");\n+        }\n+        contextBuilder.append(\"\\n\");\n+        return contextBuilder.toString();\n+    }\n \n     record NoWarnings() implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n-            assertMap(warnings.stream().sorted().toList(), matchesList());\n+        public void assertWarnings(List<String> warnings, Object context) {\n+            assertMap(contextMessage(context), warnings.stream().sorted().toList(), matchesList());\n         }\n     }\n \n     record ExactStrings(List<String> expected) implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n-            assertMap(warnings.stream().sorted().toList(), matchesList(expected.stream().sorted().toList()));\n+        public void assertWarnings(List<String> warnings, Object context) {\n+            assertMap(contextMessage(context), warnings.stream().sorted().toList(), matchesList(expected.stream().sorted().toList()));\n         }\n     }\n \n     record DeduplicatedStrings(List<String> expected) implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n-            assertMap(warnings.stream().sorted().distinct().toList(), matchesList(expected.stream().sorted().toList()));\n+        public void assertWarnings(List<String> warnings, Object context) {\n+            assertMap(\n+                contextMessage(context),\n+                warnings.stream().sorted().distinct().toList(),\n+                matchesList(expected.stream().sorted().toList())\n+            );\n         }\n     }\n \n     record AllowedRegexes(List<Pattern> expected) implements AssertWarnings {\n         @Override\n-        public void assertWarnings(List<String> warnings) {\n+        public void assertWarnings(List<String> warnings, Object context) {\n             for (String warning : warnings) {\n-                assertTrue(\"Unexpected warning: \" + warning, expected.stream().anyMatch(x -> x.matcher(warning).matches()));\n+                assertTrue(\n+                    contextMessage(context) + \"Unexpected warning: \" + warning,\n+                    expected.stream().anyMatch(x -> x.matcher(warning).matches())\n+                );\n             }\n         }\n     }\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/CsvTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/CsvTests.java\nindex f9dfdc507bfd2..b21d11f96cfc0 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/CsvTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/CsvTests.java\n@@ -387,7 +387,7 @@ private void doTest() throws Exception {\n \n             var log = logResults() ? LOGGER : null;\n             assertResults(expected, actualResults, testCase.ignoreOrder, log);\n-            assertWarnings(actualResults.responseHeaders().getOrDefault(\"Warning\", List.of()));\n+            assertWarnings(actualResults.responseHeaders().getOrDefault(\"Warning\", List.of()), actualResults);\n         } finally {\n             Releasables.close(() -> Iterators.map(actualResults.pages().iterator(), p -> p::releaseBlocks));\n             // Give the breaker service some time to clear in case we got results before the rest of the driver had cleaned up\n@@ -673,7 +673,7 @@ private void opportunisticallyAssertPlanSerialization(PhysicalPlan plan) {\n         SerializationTestUtils.assertSerialization(plan, configuration);\n     }\n \n-    private void assertWarnings(List<String> warnings) {\n+    private void assertWarnings(List<String> warnings, Object context) {\n         List<String> normalized = new ArrayList<>(warnings.size());\n         for (String w : warnings) {\n             String normW = HeaderWarning.extractWarningValueFromWarningHeader(w, false);\n@@ -682,7 +682,7 @@ private void assertWarnings(List<String> warnings) {\n                 normalized.add(normW);\n             }\n         }\n-        testCase.assertWarnings(false).assertWarnings(normalized);\n+        testCase.assertWarnings(false).assertWarnings(normalized, context);\n     }\n \n     PlanRunner planRunner(BigArrays bigArrays, TestPhysicalOperationProviders physicalOperationProviders) {\n",
  "additions": 42,
  "deletions": 36,
  "changed_files": 4,
  "url": "https://github.com/elastic/elasticsearch/pull/137107",
  "mined_at": "2025-10-25T13:20:41.116166"
}