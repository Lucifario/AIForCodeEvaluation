{
  "id": 137078,
  "repository": "elastic/elasticsearch",
  "title": "Fix AsyncSearchErrorTraceIT_ testAsyncSearchFailingQueryErrorTraceFalse",
  "body": "The exception is thrown while attempting to acquire a shard lock. The key stack frames show that it occurs during the after-test checks (assertAfterTest), when ESIntegTestCase runs its â€œassert after testâ€ cleanup. At that point, itâ€™s trying to lock shard 0 of the .async-search index, but the shard is still in the starting state because the async task hasnâ€™t fully finished. As a result, the lock attempt times out after 5 seconds.\r\n\r\n```\r\nCaused by: org.elasticsearch.env.ShardLockObtainFailedException: [.async-search][0]: obtaining shard lock for [InternalTestCluster assert after test] timed out after [5000ms]; this shard lock is still held by a different instance of the shard and has been in state [starting shard] for [5.3s/5310ms] |  \r\n  | at org.elasticsearch.env.NodeEnvironment.shardLock(NodeEnvironment.java:895) |  \r\n  | at org.elasticsearch.test.InternalTestCluster.assertAfterTest(InternalTestCluster.java:2617) |  \r\n  | at org.elasticsearch.test.ESIntegTestCase.afterInternal(ESIntegTestCase.java:612) |  \r\n  | at org.elasticsearch.test.ESIntegTestCase.cleanUpCluster(ESIntegTestCase.java:2620) |  \r\n  | at jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:104) |  \r\n  | at java.lang.reflect.Method.invoke(Method.java:565) |  \r\n  | at com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1763) |  \r\n  | at com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:1004) |  \r\n  | at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36) |  \r\n  | at org.junit.rules.RunRules.evaluate(RunRules.java:20) |  \r\n  | at org.apache.lucene.tests.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:48) |  \r\n  | at org.apache.lucene.tests.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:43) |  \r\n  | at org.apache.lucene.tests.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:45) |  \r\n  | at org.apache.lucene.tests.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:60) |  \r\n  | at org.apache.lucene.tests.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:44)\r\n...\r\n```\r\n\r\nThe REST response returns is_running as a Boolean, but the code reads it as a String and evaluates true.equals(\"true\"), which is always false. As a result, the wait/poll step is skipped, and the test executes the assertion immediately. This creates a race condition where the async search has not yet finished propagating results between the data and coordinating nodes, causing ErrorTraceHelper.assertStackTraceCleared(..) to occasionally run too early and fail.\r\n\r\n```\r\n if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) \r\n```\r\n\r\nCloses #136986 #136691 ",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T16:13:37+00:00",
  "created_at": "2025-10-24T07:36:36+00:00",
  "updated_at": "2025-10-24T16:14:42+00:00",
  "author": "drempapis",
  "reviewers": [
    "benchaplin"
  ],
  "base_sha": "88d4704a9a48e0c58dcb16d7f6efac2612b12901",
  "head_sha": "daa99b44436b9bb0ffdc6754bb3f26f765e614da",
  "review_comments": [
    {
      "user": "benchaplin",
      "state": "APPROVED",
      "body": "Ha, nice catch! Resolves https://github.com/elastic/elasticsearch/issues/133010 as well?",
      "submitted_at": "2025-10-24T12:27:24+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-search-foundations (Team:Search Foundations)",
      "created_at": "2025-10-24T07:37:01+00:00"
    },
    {
      "user": "benchaplin",
      "body": "Hm, another note - I wrote these tests completely wrong! The assertions work in request handlers, meaning they should be set BEFORE the async search starts. I'll open a PR once you merge @drempapis...",
      "created_at": "2025-10-24T12:45:21+00:00"
    },
    {
      "user": "drempapis",
      "body": ">Ha, nice catch! Resolves https://github.com/elastic/elasticsearch/issues/133010 as well?\r\n\r\nIâ€™ve updated the test method `testAsyncSearchFailingQueryErrorTraceDefault` in this PR to address the same issue",
      "created_at": "2025-10-24T16:13:14+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "## ðŸ’š Backport successful\n| Status | Branch | Result |\n|:------:|:------:|:------:|\n| âœ… |  [9.2](https://github.com/elastic/elasticsearch/pull/137119)  | [<img src=\"https://img.shields.io/github/pulls/detail/state/elastic/elasticsearch/137119\">](https://github.com/elastic/elasticsearch/pull/137119) |",
      "created_at": "2025-10-24T16:14:42+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "muted-tests.yml",
      "status": "modified",
      "additions": 0,
      "deletions": 3,
      "changes": 3,
      "patch": "@@ -354,9 +354,6 @@ tests:\n - class: org.elasticsearch.search.CCSDuelIT\n   method: testTermsAggsWithProfile\n   issue: https://github.com/elastic/elasticsearch/issues/132880\n-- class: org.elasticsearch.xpack.search.AsyncSearchErrorTraceIT\n-  method: testAsyncSearchFailingQueryErrorTraceDefault\n-  issue: https://github.com/elastic/elasticsearch/issues/133010\n - class: org.elasticsearch.xpack.security.authc.AuthenticationServiceTests\n   method: testInvalidToken\n   issue: https://github.com/elastic/elasticsearch/issues/133328"
    },
    {
      "filename": "x-pack/plugin/async-search/src/internalClusterTest/java/org/elasticsearch/xpack/search/AsyncSearchErrorTraceIT.java",
      "status": "modified",
      "additions": 6,
      "deletions": 6,
      "changes": 12,
      "patch": "@@ -76,7 +76,7 @@ public void testAsyncSearchFailingQueryErrorTraceDefault() throws Exception {\n         createAsyncRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             awaitAsyncRequestDoneRunning(getAsyncRequest);\n@@ -103,7 +103,7 @@ public void testAsyncSearchFailingQueryErrorTraceTrue() throws Exception {\n         createAsyncRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"true\");\n@@ -131,7 +131,7 @@ public void testAsyncSearchFailingQueryErrorTraceFalse() throws Exception {\n         createAsyncRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"false\");\n@@ -172,7 +172,7 @@ public void testDataNodeLogsStackTrace() throws Exception {\n         try (var mockLog = MockLog.capture(SearchService.class)) {\n             ErrorTraceHelper.addSeenLoggingExpectations(numShards, mockLog, errorTriggeringIndex);\n             Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-            if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+            if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n                 String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n                 Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n                 // Use the same value of error_trace as the search request\n@@ -206,7 +206,7 @@ public void testAsyncSearchFailingQueryErrorTraceFalseOnSubmitAndTrueOnGet() thr\n         createAsyncSearchRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncSearchRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncSearchRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"true\");\n@@ -234,7 +234,7 @@ public void testAsyncSearchFailingQueryErrorTraceTrueOnSubmitAndFalseOnGet() thr\n         createAsyncSearchRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncSearchRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncSearchRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"false\");"
    }
  ],
  "diff": "diff --git a/muted-tests.yml b/muted-tests.yml\nindex 2e2bdb22d6a70..13f6f7ac21a12 100644\n--- a/muted-tests.yml\n+++ b/muted-tests.yml\n@@ -354,9 +354,6 @@ tests:\n - class: org.elasticsearch.search.CCSDuelIT\n   method: testTermsAggsWithProfile\n   issue: https://github.com/elastic/elasticsearch/issues/132880\n-- class: org.elasticsearch.xpack.search.AsyncSearchErrorTraceIT\n-  method: testAsyncSearchFailingQueryErrorTraceDefault\n-  issue: https://github.com/elastic/elasticsearch/issues/133010\n - class: org.elasticsearch.xpack.security.authc.AuthenticationServiceTests\n   method: testInvalidToken\n   issue: https://github.com/elastic/elasticsearch/issues/133328\ndiff --git a/x-pack/plugin/async-search/src/internalClusterTest/java/org/elasticsearch/xpack/search/AsyncSearchErrorTraceIT.java b/x-pack/plugin/async-search/src/internalClusterTest/java/org/elasticsearch/xpack/search/AsyncSearchErrorTraceIT.java\nindex c132d38dd2792..83e7cf9e12096 100644\n--- a/x-pack/plugin/async-search/src/internalClusterTest/java/org/elasticsearch/xpack/search/AsyncSearchErrorTraceIT.java\n+++ b/x-pack/plugin/async-search/src/internalClusterTest/java/org/elasticsearch/xpack/search/AsyncSearchErrorTraceIT.java\n@@ -76,7 +76,7 @@ public void testAsyncSearchFailingQueryErrorTraceDefault() throws Exception {\n         createAsyncRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             awaitAsyncRequestDoneRunning(getAsyncRequest);\n@@ -103,7 +103,7 @@ public void testAsyncSearchFailingQueryErrorTraceTrue() throws Exception {\n         createAsyncRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"true\");\n@@ -131,7 +131,7 @@ public void testAsyncSearchFailingQueryErrorTraceFalse() throws Exception {\n         createAsyncRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"false\");\n@@ -172,7 +172,7 @@ public void testDataNodeLogsStackTrace() throws Exception {\n         try (var mockLog = MockLog.capture(SearchService.class)) {\n             ErrorTraceHelper.addSeenLoggingExpectations(numShards, mockLog, errorTriggeringIndex);\n             Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncRequest);\n-            if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+            if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n                 String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n                 Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n                 // Use the same value of error_trace as the search request\n@@ -206,7 +206,7 @@ public void testAsyncSearchFailingQueryErrorTraceFalseOnSubmitAndTrueOnGet() thr\n         createAsyncSearchRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncSearchRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncSearchRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"true\");\n@@ -234,7 +234,7 @@ public void testAsyncSearchFailingQueryErrorTraceTrueOnSubmitAndFalseOnGet() thr\n         createAsyncSearchRequest.addParameter(\"keep_on_completion\", \"true\");\n         createAsyncSearchRequest.addParameter(\"wait_for_completion_timeout\", \"0ms\");\n         Map<String, Object> createAsyncResponseEntity = performRequestAndGetResponseEntity(createAsyncSearchRequest);\n-        if (createAsyncResponseEntity.get(\"is_running\").equals(\"true\")) {\n+        if (Boolean.TRUE.equals(createAsyncResponseEntity.get(\"is_running\"))) {\n             String asyncExecutionId = (String) createAsyncResponseEntity.get(\"id\");\n             Request getAsyncRequest = new Request(\"GET\", \"/_async_search/\" + asyncExecutionId);\n             getAsyncRequest.addParameter(\"error_trace\", \"false\");\n",
  "additions": 6,
  "deletions": 9,
  "changed_files": 2,
  "url": "https://github.com/elastic/elasticsearch/pull/137078",
  "mined_at": "2025-10-25T13:17:00.390678"
}