{
  "id": 137101,
  "repository": "elastic/elasticsearch",
  "title": "[9.2] [ML] Fix JobsAndModelsIT (#137084)",
  "body": "Backports the following commits to 9.2:\n - [ML] Fix JobsAndModelsIT (#137084)",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T14:20:19+00:00",
  "created_at": "2025-10-24T13:27:22+00:00",
  "updated_at": "2025-10-24T14:20:42+00:00",
  "author": "valeriy42",
  "reviewers": [],
  "base_sha": "fa16bca8eb6ac67e800fcec837300425b81bb714",
  "head_sha": "de99a46a57c01536ff2aa0f6bbd7b6b101b521b0",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java",
      "status": "modified",
      "additions": 0,
      "deletions": 6,
      "changes": 6,
      "patch": "@@ -16,7 +16,6 @@\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.json.JsonXContent;\n-import org.elasticsearch.xpack.core.ml.MlTasks;\n import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n import org.elasticsearch.xpack.core.ml.action.GetJobsStatsAction;\n import org.elasticsearch.xpack.core.ml.action.GetTrainedModelsStatsAction;\n@@ -38,8 +37,6 @@\n import org.elasticsearch.xpack.ml.inference.persistence.TrainedModelDefinitionDoc;\n import org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase;\n \n-import java.time.Duration;\n-import java.time.temporal.ChronoUnit;\n import java.util.List;\n import java.util.Set;\n \n@@ -59,7 +56,6 @@\n @ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST, numDataNodes = 0)\n public class JobsAndModelsIT extends BaseMlIntegTestCase {\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/103588\")\n     public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_ShouldNotAllocateBothOnSameNode() throws Exception {\n         // This test starts 2 ML nodes and then starts an anomaly detection job and a\n         // trained model deployment that do not both fit in one node. We then proceed\n@@ -237,8 +233,6 @@ public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_Should\n             assertThat(jobStats.getNode(), is(not(equalTo(modelStats.getDeploymentStats().getNodeStats().get(0).getNode()))));\n         });\n \n-        assertRecentLastTaskStateChangeTime(MlTasks.jobTaskId(jobId), Duration.of(10, ChronoUnit.SECONDS), null);\n-\n         // Clean up\n         client().execute(CloseJobAction.INSTANCE, new CloseJobAction.Request(jobId).setForce(true)).actionGet();\n         client().execute(StopTrainedModelDeploymentAction.INSTANCE, new StopTrainedModelDeploymentAction.Request(model.getModelId()))"
    }
  ],
  "diff": "diff --git a/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java b/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java\nindex a1b001cb168ef..4a70759a04fc1 100644\n--- a/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java\n+++ b/x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/JobsAndModelsIT.java\n@@ -16,7 +16,6 @@\n import org.elasticsearch.test.ESIntegTestCase;\n import org.elasticsearch.xcontent.XContentBuilder;\n import org.elasticsearch.xcontent.json.JsonXContent;\n-import org.elasticsearch.xpack.core.ml.MlTasks;\n import org.elasticsearch.xpack.core.ml.action.CloseJobAction;\n import org.elasticsearch.xpack.core.ml.action.GetJobsStatsAction;\n import org.elasticsearch.xpack.core.ml.action.GetTrainedModelsStatsAction;\n@@ -38,8 +37,6 @@\n import org.elasticsearch.xpack.ml.inference.persistence.TrainedModelDefinitionDoc;\n import org.elasticsearch.xpack.ml.support.BaseMlIntegTestCase;\n \n-import java.time.Duration;\n-import java.time.temporal.ChronoUnit;\n import java.util.List;\n import java.util.Set;\n \n@@ -59,7 +56,6 @@\n @ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST, numDataNodes = 0)\n public class JobsAndModelsIT extends BaseMlIntegTestCase {\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/103588\")\n     public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_ShouldNotAllocateBothOnSameNode() throws Exception {\n         // This test starts 2 ML nodes and then starts an anomaly detection job and a\n         // trained model deployment that do not both fit in one node. We then proceed\n@@ -237,8 +233,6 @@ public void testCluster_GivenAnomalyDetectionJobAndTrainedModelDeployment_Should\n             assertThat(jobStats.getNode(), is(not(equalTo(modelStats.getDeploymentStats().getNodeStats().get(0).getNode()))));\n         });\n \n-        assertRecentLastTaskStateChangeTime(MlTasks.jobTaskId(jobId), Duration.of(10, ChronoUnit.SECONDS), null);\n-\n         // Clean up\n         client().execute(CloseJobAction.INSTANCE, new CloseJobAction.Request(jobId).setForce(true)).actionGet();\n         client().execute(StopTrainedModelDeploymentAction.INSTANCE, new StopTrainedModelDeploymentAction.Request(model.getModelId()))\n",
  "additions": 0,
  "deletions": 6,
  "changed_files": 1,
  "url": "https://github.com/elastic/elasticsearch/pull/137101",
  "mined_at": "2025-10-25T13:21:06.076316"
}