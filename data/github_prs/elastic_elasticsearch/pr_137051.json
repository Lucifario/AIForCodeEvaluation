{
  "id": 137051,
  "repository": "elastic/elasticsearch",
  "title": "Fix test failure ES92GpuHnswSQVectorsFormatTests.",
  "body": "ES92GpuHnswSQVectorsFormatTests fails because it may choose not supported vector similarity function max_inner_product\r\n\r\nThis fixes this test to ensure only supported similarity metrics are picked for tests.\r\n\r\nThis change is already a part of 9.2.1 branch, so no backported is needed\r\n\r\nRelated to https://github.com/elastic/elasticsearch/pull/136881",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-23T19:25:11+00:00",
  "created_at": "2025-10-23T16:34:53+00:00",
  "updated_at": "2025-10-23T19:25:35+00:00",
  "author": "mayya-sharipova",
  "reviewers": [
    "benwtrent"
  ],
  "base_sha": "8cbccc6531529da7901e06cb6d86b2c5c7023d16",
  "head_sha": "038081bd7514a6edcc533f6ff11958c01db36620",
  "review_comments": [
    {
      "user": "benwtrent",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-10-23T17:02:03+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-search-relevance (Team:Search Relevance)",
      "created_at": "2025-10-23T16:35:35+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "patch": "@@ -97,9 +97,9 @@ public static DenseVectorFieldMapper.DenseVectorIndexOptions randomGpuSupportedI\n     }\n \n     public static DenseVectorFieldMapper.VectorSimilarity randomGPUSupportedSimilarity(\n-        DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions\n+        DenseVectorFieldMapper.VectorIndexType vectorIndexType\n     ) {\n-        if (indexOptions.getType() == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n+        if (vectorIndexType == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n             return randomFrom(VectorSimilarity.L2_NORM, VectorSimilarity.COSINE, VectorSimilarity.DOT_PRODUCT);\n         }\n         return randomFrom(VectorSimilarity.values());"
    },
    {
      "filename": "x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java",
      "status": "modified",
      "additions": 9,
      "deletions": 9,
      "changes": 18,
      "patch": "@@ -139,7 +139,7 @@ public void testFFOffGPUFormatNull() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\n@@ -158,7 +158,7 @@ public void testIndexSettingOnIndexTypeSupportedGPUSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNotNull(format);\n     }\n@@ -179,7 +179,7 @@ public void testIndexSettingOnIndexTypeNotSupportedThrows() {\n             () -> vectorsFormatProvider.getKnnVectorsFormat(\n                 settings,\n                 indexOptions,\n-                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n             )\n         );\n         assertThat(ex.getMessage(), startsWith(\"[index.vectors.indexing.use_gpu] doesn't support [index_options.type] of\"));\n@@ -201,7 +201,7 @@ public void testIndexSettingOnGPUNotSupportedThrows() {\n             () -> vectorsFormatProvider.getKnnVectorsFormat(\n                 settings,\n                 indexOptions,\n-                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n             )\n         );\n         assertThat(\n@@ -227,7 +227,7 @@ public void testIndexSettingOnGPUSupportThrowsRethrows() {\n             () -> vectorsFormatProvider.getKnnVectorsFormat(\n                 settings,\n                 indexOptions,\n-                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n             )\n         );\n         assertThat(\n@@ -250,7 +250,7 @@ public void testIndexSettingAutoIndexTypeSupportedGPUSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNotNull(format);\n     }\n@@ -269,7 +269,7 @@ public void testIndexSettingAutoGPUNotSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\n@@ -288,7 +288,7 @@ public void testIndexSettingAutoIndexTypeNotSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\n@@ -307,7 +307,7 @@ public void testIndexSettingOff() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }"
    },
    {
      "filename": "x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "patch": "@@ -13,6 +13,9 @@\n import org.apache.lucene.tests.util.LuceneTestCase;\n import org.apache.lucene.tests.util.TestUtil;\n import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.index.IndexVersion;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldMapper;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldTypeTests;\n import org.elasticsearch.xpack.gpu.GPUSupport;\n import org.junit.BeforeClass;\n \n@@ -39,7 +42,8 @@ protected Codec getCodec() {\n \n     @Override\n     protected VectorSimilarityFunction randomSimilarity() {\n-        return VectorSimilarityFunction.values()[random().nextInt(VectorSimilarityFunction.values().length)];\n+        return DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(DenseVectorFieldMapper.VectorIndexType.INT8_HNSW)\n+            .vectorSimilarityFunction(IndexVersion.current(), DenseVectorFieldMapper.ElementType.FLOAT);\n     }\n \n     @Override"
    }
  ],
  "diff": "diff --git a/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java b/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java\nindex 4a191fe0f5679..24db52cb10c0c 100644\n--- a/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java\n@@ -97,9 +97,9 @@ public static DenseVectorFieldMapper.DenseVectorIndexOptions randomGpuSupportedI\n     }\n \n     public static DenseVectorFieldMapper.VectorSimilarity randomGPUSupportedSimilarity(\n-        DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions\n+        DenseVectorFieldMapper.VectorIndexType vectorIndexType\n     ) {\n-        if (indexOptions.getType() == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n+        if (vectorIndexType == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n             return randomFrom(VectorSimilarity.L2_NORM, VectorSimilarity.COSINE, VectorSimilarity.DOT_PRODUCT);\n         }\n         return randomFrom(VectorSimilarity.values());\ndiff --git a/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java b/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java\nindex dd46a469dfbb0..29645f566a8e6 100644\n--- a/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java\n+++ b/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java\n@@ -139,7 +139,7 @@ public void testFFOffGPUFormatNull() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\n@@ -158,7 +158,7 @@ public void testIndexSettingOnIndexTypeSupportedGPUSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNotNull(format);\n     }\n@@ -179,7 +179,7 @@ public void testIndexSettingOnIndexTypeNotSupportedThrows() {\n             () -> vectorsFormatProvider.getKnnVectorsFormat(\n                 settings,\n                 indexOptions,\n-                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n             )\n         );\n         assertThat(ex.getMessage(), startsWith(\"[index.vectors.indexing.use_gpu] doesn't support [index_options.type] of\"));\n@@ -201,7 +201,7 @@ public void testIndexSettingOnGPUNotSupportedThrows() {\n             () -> vectorsFormatProvider.getKnnVectorsFormat(\n                 settings,\n                 indexOptions,\n-                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n             )\n         );\n         assertThat(\n@@ -227,7 +227,7 @@ public void testIndexSettingOnGPUSupportThrowsRethrows() {\n             () -> vectorsFormatProvider.getKnnVectorsFormat(\n                 settings,\n                 indexOptions,\n-                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n             )\n         );\n         assertThat(\n@@ -250,7 +250,7 @@ public void testIndexSettingAutoIndexTypeSupportedGPUSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNotNull(format);\n     }\n@@ -269,7 +269,7 @@ public void testIndexSettingAutoGPUNotSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\n@@ -288,7 +288,7 @@ public void testIndexSettingAutoIndexTypeNotSupported() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\n@@ -307,7 +307,7 @@ public void testIndexSettingOff() {\n         var format = vectorsFormatProvider.getKnnVectorsFormat(\n             settings,\n             indexOptions,\n-            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions)\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n         );\n         assertNull(format);\n     }\ndiff --git a/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java b/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java\nindex f1c13b15795c5..798cb726427ce 100644\n--- a/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java\n+++ b/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java\n@@ -13,6 +13,9 @@\n import org.apache.lucene.tests.util.LuceneTestCase;\n import org.apache.lucene.tests.util.TestUtil;\n import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.index.IndexVersion;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldMapper;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldTypeTests;\n import org.elasticsearch.xpack.gpu.GPUSupport;\n import org.junit.BeforeClass;\n \n@@ -39,7 +42,8 @@ protected Codec getCodec() {\n \n     @Override\n     protected VectorSimilarityFunction randomSimilarity() {\n-        return VectorSimilarityFunction.values()[random().nextInt(VectorSimilarityFunction.values().length)];\n+        return DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(DenseVectorFieldMapper.VectorIndexType.INT8_HNSW)\n+            .vectorSimilarityFunction(IndexVersion.current(), DenseVectorFieldMapper.ElementType.FLOAT);\n     }\n \n     @Override\n",
  "additions": 16,
  "deletions": 12,
  "changed_files": 3,
  "url": "https://github.com/elastic/elasticsearch/pull/137051",
  "mined_at": "2025-10-25T13:39:06.830085"
}