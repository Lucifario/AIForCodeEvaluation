{
  "id": 137032,
  "repository": "elastic/elasticsearch",
  "title": "ESQL: fix handling equality with MV constants properly",
  "body": "Deal with equality (and implicitly the IN operator) properly when it comes to multi-valued constants (literals): they should emit\r\na warning header, a contract set in place in the compute engine Evaluators.\r\n\r\nFixes https://github.com/elastic/elasticsearch/issues/136998\r\nFixes https://github.com/elastic/elasticsearch/issues/136939",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T14:45:25+00:00",
  "created_at": "2025-10-23T13:48:08+00:00",
  "updated_at": "2025-10-24T15:47:37+00:00",
  "author": "astefan",
  "reviewers": [
    "bpintea",
    "luigidellaquila",
    "astefan"
  ],
  "base_sha": "b05bf64670c10508269ea71fd21efa62f57f4233",
  "head_sha": "69cdb6b0b38c4f10c4ada0356c19eaee0455d2b6",
  "review_comments": [
    {
      "user": "astefan",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T13:49:08+00:00"
    },
    {
      "user": "luigidellaquila",
      "state": "APPROVED",
      "body": "LGTM, thanks @astefan!",
      "submitted_at": "2025-10-23T15:41:58+00:00"
    },
    {
      "user": "bpintea",
      "state": "APPROVED",
      "body": "This fixes the issues, but do we need to propagate the same to `EsqlBinaryComparison#translatable`? Thinking of things like `field > [1, 2]`.",
      "submitted_at": "2025-10-24T10:32:39+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-analytical-engine (Team:Analytics)",
      "created_at": "2025-10-23T13:48:33+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "Hi @astefan, I've created a changelog YAML for you.",
      "created_at": "2025-10-23T13:48:33+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "## ðŸ’š Backport successful\n| Status | Branch | Result |\n|:------:|:------:|:------:|\n| âœ… |  [9.2](https://github.com/elastic/elasticsearch/pull/137110)  | [<img src=\"https://img.shields.io/github/pulls/detail/state/elastic/elasticsearch/137110\">](https://github.com/elastic/elasticsearch/pull/137110) |",
      "created_at": "2025-10-24T14:46:37+00:00"
    },
    {
      "user": "astefan",
      "body": "> This fixes the issues, but do we need to propagate the same to `EsqlBinaryComparison#translatable`? Thinking of things like `field > [1, 2]`.\r\n\r\n@bpintea I'll explore this as part of a different PR. From a preliminary evaluation, this will be a refactoring type of PR. EsqlBinaryComparisons in general are handled by the fix in this PR, but it should indeed be handled in EsqlBinaryComparisons.",
      "created_at": "2025-10-24T15:47:37+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "docs/changelog/137032.yaml",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "patch": "@@ -0,0 +1,7 @@\n+pr: 137032\n+summary: Fix handling equality with MV constants properly\n+area: ES|QL\n+type: bug\n+issues:\n+ - 136998\n+ - 136939"
    },
    {
      "filename": "x-pack/plugin/esql/qa/testFixtures/src/main/resources/folding.csv-spec",
      "status": "modified",
      "additions": 66,
      "deletions": 0,
      "changes": 66,
      "patch": "@@ -103,3 +103,69 @@ a:s    | b:s      | x:i | y:s          | z:s\n \"some\" | \"string\" | 4   | \"somestring\" | \"anotherstring\"\n ;\n \n+mvBoolean_Equals_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| WHERE is_rehired == ([true, false])\n+| KEEP is_rehired\n+;\n+warning:Line 2:9: evaluation of [is_rehired == ([true, false])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    is_rehired:boolean\n+;\n+\n+computedBoolean_Equals_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| EVAL x = gender IS NULL\n+| WHERE x == [true, false]\n+| KEEP x\n+;\n+warning:Line 3:9: evaluation of [x == [true, false]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 3:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    x:boolean\n+;\n+\n+computedBoolean_Equals_SingleMultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| EVAL x = gender IS NULL\n+| WHERE x == [true]\n+| KEEP x\n+| LIMIT 1\n+;\n+\n+    x:boolean\n+    true\n+;\n+\n+mvDouble_IN_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| WHERE salary_change IN ([1,2,3])\n+| KEEP salary_change\n+;\n+warning:Line 2:9: evaluation of [salary_change IN ([1,2,3])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    salary_change:double\n+;\n+\n+mvDouble_Equals_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| WHERE salary_change == [1,2,3]\n+| KEEP salary_change\n+;\n+warning:Line 2:9: evaluation of [salary_change == [1,2,3]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    salary_change:double\n+;"
    },
    {
      "filename": "x-pack/plugin/esql/qa/testFixtures/src/main/resources/string.csv-spec",
      "status": "modified",
      "additions": 48,
      "deletions": 0,
      "changes": 48,
      "patch": "@@ -2582,6 +2582,54 @@ warning:Line 2:9: java.lang.IllegalArgumentException: single-value function enco\n 2023-10-23T13:55:01.544Z|Connected to 10.1.0.1\n ;\n \n+mvStringEqualsMultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM mv_text\n+| WHERE message == [\"Connected to 10.1.0.1\", \"Banana\"]\n+| KEEP @timestamp, message\n+;\n+warning:Line 2:9: evaluation of [message == [\\\"Connected to 10.1.0.1\\\", \\\"Banana\\\"]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    @timestamp:date     | message:text\n+;\n+\n+mvString_IN_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM mv_text\n+| WHERE message IN ([\"Connected to 10.1.0.1\", \"Banana\"])\n+| KEEP @timestamp, message\n+;\n+warning:Line 2:9: evaluation of [message IN ([\\\"Connected to 10.1.0.1\\\", \\\"Banana\\\"])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    @timestamp:date     | message:text\n+;\n+\n+mvKeyword_IN_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM employees\n+| WHERE job_positions IN ([\"Tech Lead\" , \"Data Scientist\", \"Senior Team Lead\"])\n+| KEEP emp_no, job_positions\n+;\n+warning:Line 2:9: evaluation of [job_positions IN ([\\\"Tech Lead\\\" , \\\"Data Scientist\\\", \\\"Senior Team Lead\\\"])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    emp_no:integer     | job_positions:keyword\n+;\n+\n+mvKeywordEqualsMultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM employees\n+| WHERE job_positions == [\"Tech Lead\" , \"Data Scientist\", \"Senior Team Lead\"]\n+| KEEP emp_no, job_positions\n+;\n+warning:Line 2:9: evaluation of [job_positions == [\\\"Tech Lead\\\" , \\\"Data Scientist\\\", \\\"Senior Team Lead\\\"]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    emp_no:integer     | job_positions:keyword\n+;\n+\n url_encode sample for docs\n required_capability: url_encode\n "
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "patch": "@@ -1580,6 +1580,7 @@ public enum Cap {\n          */\n         INLINE_STATS_WITH_NO_COLUMNS(INLINE_STATS.enabled),\n \n+        FIX_MV_CONSTANT_EQUALS_FIELD,\n         // Last capability should still have a comma for fewer merge conflicts when adding new ones :)\n         // This comment prevents the semicolon from being on the previous capability when Spotless formats the file.\n         ;"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/predicate/operator/comparison/Equals.java",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "patch": "@@ -27,6 +27,7 @@\n import org.elasticsearch.xpack.esql.querydsl.query.SingleValueQuery;\n \n import java.time.ZoneId;\n+import java.util.Collection;\n import java.util.Map;\n \n public class Equals extends EsqlBinaryComparison implements Negatable<EsqlBinaryComparison> {\n@@ -139,6 +140,12 @@ public Equals(Source source, Expression left, Expression right, ZoneId zoneId) {\n     @Override\n     public Translatable translatable(LucenePushdownPredicates pushdownPredicates) {\n         if (right() instanceof Literal lit) {\n+            // Multi-valued literals are not supported going further. This also makes sure that we are handling multi-valued literals with\n+            // a \"warning\" header, as well (see EqualsKeywordsEvaluator, for example, where lhs and rhs are both dealt with equally when\n+            // it comes to multi-value handling).\n+            if (lit.value() instanceof Collection<?>) {\n+                return Translatable.NO;\n+            }\n             if (left().dataType() == DataType.TEXT && left() instanceof FieldAttribute fa) {\n                 if (pushdownPredicates.canUseEqualityOnSyntheticSourceDelegate(fa, ((BytesRef) lit.value()).utf8ToString())) {\n                     return Translatable.YES_BUT_RECHECK_NEGATED;"
    }
  ],
  "diff": "diff --git a/docs/changelog/137032.yaml b/docs/changelog/137032.yaml\nnew file mode 100644\nindex 0000000000000..b569efd5cc343\n--- /dev/null\n+++ b/docs/changelog/137032.yaml\n@@ -0,0 +1,7 @@\n+pr: 137032\n+summary: Fix handling equality with MV constants properly\n+area: ES|QL\n+type: bug\n+issues:\n+ - 136998\n+ - 136939\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/folding.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/folding.csv-spec\nindex 4e35e0ba9efcf..dd5e0e7fa3345 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/folding.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/folding.csv-spec\n@@ -103,3 +103,69 @@ a:s    | b:s      | x:i | y:s          | z:s\n \"some\" | \"string\" | 4   | \"somestring\" | \"anotherstring\"\n ;\n \n+mvBoolean_Equals_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| WHERE is_rehired == ([true, false])\n+| KEEP is_rehired\n+;\n+warning:Line 2:9: evaluation of [is_rehired == ([true, false])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    is_rehired:boolean\n+;\n+\n+computedBoolean_Equals_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| EVAL x = gender IS NULL\n+| WHERE x == [true, false]\n+| KEEP x\n+;\n+warning:Line 3:9: evaluation of [x == [true, false]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 3:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    x:boolean\n+;\n+\n+computedBoolean_Equals_SingleMultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| EVAL x = gender IS NULL\n+| WHERE x == [true]\n+| KEEP x\n+| LIMIT 1\n+;\n+\n+    x:boolean\n+    true\n+;\n+\n+mvDouble_IN_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| WHERE salary_change IN ([1,2,3])\n+| KEEP salary_change\n+;\n+warning:Line 2:9: evaluation of [salary_change IN ([1,2,3])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    salary_change:double\n+;\n+\n+mvDouble_Equals_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+\n+FROM employees\n+| WHERE salary_change == [1,2,3]\n+| KEEP salary_change\n+;\n+warning:Line 2:9: evaluation of [salary_change == [1,2,3]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    salary_change:double\n+;\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/string.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/string.csv-spec\nindex 4d9ddb83ae301..c1ec0bcd1f639 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/string.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/string.csv-spec\n@@ -2582,6 +2582,54 @@ warning:Line 2:9: java.lang.IllegalArgumentException: single-value function enco\n 2023-10-23T13:55:01.544Z|Connected to 10.1.0.1\n ;\n \n+mvStringEqualsMultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM mv_text\n+| WHERE message == [\"Connected to 10.1.0.1\", \"Banana\"]\n+| KEEP @timestamp, message\n+;\n+warning:Line 2:9: evaluation of [message == [\\\"Connected to 10.1.0.1\\\", \\\"Banana\\\"]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    @timestamp:date     | message:text\n+;\n+\n+mvString_IN_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM mv_text\n+| WHERE message IN ([\"Connected to 10.1.0.1\", \"Banana\"])\n+| KEEP @timestamp, message\n+;\n+warning:Line 2:9: evaluation of [message IN ([\\\"Connected to 10.1.0.1\\\", \\\"Banana\\\"])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    @timestamp:date     | message:text\n+;\n+\n+mvKeyword_IN_MultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM employees\n+| WHERE job_positions IN ([\"Tech Lead\" , \"Data Scientist\", \"Senior Team Lead\"])\n+| KEEP emp_no, job_positions\n+;\n+warning:Line 2:9: evaluation of [job_positions IN ([\\\"Tech Lead\\\" , \\\"Data Scientist\\\", \\\"Senior Team Lead\\\"])] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    emp_no:integer     | job_positions:keyword\n+;\n+\n+mvKeywordEqualsMultiValueConstant\n+required_capability: fix_mv_constant_equals_field\n+FROM employees\n+| WHERE job_positions == [\"Tech Lead\" , \"Data Scientist\", \"Senior Team Lead\"]\n+| KEEP emp_no, job_positions\n+;\n+warning:Line 2:9: evaluation of [job_positions == [\\\"Tech Lead\\\" , \\\"Data Scientist\\\", \\\"Senior Team Lead\\\"]] failed, treating result as null. Only first 20 failures recorded.\n+warning:Line 2:9: java.lang.IllegalArgumentException: single-value function encountered multi-value\n+\n+    emp_no:integer     | job_positions:keyword\n+;\n+\n url_encode sample for docs\n required_capability: url_encode\n \ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\nindex 56a5d350a20be..f457bd9c6ce1b 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n@@ -1580,6 +1580,7 @@ public enum Cap {\n          */\n         INLINE_STATS_WITH_NO_COLUMNS(INLINE_STATS.enabled),\n \n+        FIX_MV_CONSTANT_EQUALS_FIELD,\n         // Last capability should still have a comma for fewer merge conflicts when adding new ones :)\n         // This comment prevents the semicolon from being on the previous capability when Spotless formats the file.\n         ;\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/predicate/operator/comparison/Equals.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/predicate/operator/comparison/Equals.java\nindex 63cda52368eb8..0ab0e3c20a2f9 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/predicate/operator/comparison/Equals.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/predicate/operator/comparison/Equals.java\n@@ -27,6 +27,7 @@\n import org.elasticsearch.xpack.esql.querydsl.query.SingleValueQuery;\n \n import java.time.ZoneId;\n+import java.util.Collection;\n import java.util.Map;\n \n public class Equals extends EsqlBinaryComparison implements Negatable<EsqlBinaryComparison> {\n@@ -139,6 +140,12 @@ public Equals(Source source, Expression left, Expression right, ZoneId zoneId) {\n     @Override\n     public Translatable translatable(LucenePushdownPredicates pushdownPredicates) {\n         if (right() instanceof Literal lit) {\n+            // Multi-valued literals are not supported going further. This also makes sure that we are handling multi-valued literals with\n+            // a \"warning\" header, as well (see EqualsKeywordsEvaluator, for example, where lhs and rhs are both dealt with equally when\n+            // it comes to multi-value handling).\n+            if (lit.value() instanceof Collection<?>) {\n+                return Translatable.NO;\n+            }\n             if (left().dataType() == DataType.TEXT && left() instanceof FieldAttribute fa) {\n                 if (pushdownPredicates.canUseEqualityOnSyntheticSourceDelegate(fa, ((BytesRef) lit.value()).utf8ToString())) {\n                     return Translatable.YES_BUT_RECHECK_NEGATED;\n",
  "additions": 129,
  "deletions": 0,
  "changed_files": 5,
  "url": "https://github.com/elastic/elasticsearch/pull/137032",
  "mined_at": "2025-10-25T13:17:33.219254"
}