{
  "id": 137082,
  "repository": "elastic/elasticsearch",
  "title": "ES|QL: Validate multiple GROK patterns individually",
  "body": "GROK now [accepts](https://github.com/elastic/elasticsearch/pull/136541) multiple patterns, and composes them in a single one. \r\nDue to the way the patterns a composed, the result could be a valid pattern, eve if single patterns are invalid.\r\n\r\nThis adds validation to the single patterns individually.\r\n\r\nRelates to: https://github.com/elastic/elasticsearch/issues/136750 \r\nThe fix applies only to ES|QL as this is a new feature; ingest pipelines have the same problem, but it's been like that for years, so it should probably be managed separately, as a breaking change.",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T10:13:26+00:00",
  "created_at": "2025-10-24T08:33:04+00:00",
  "updated_at": "2025-10-24T10:13:26+00:00",
  "author": "luigidellaquila",
  "reviewers": [
    "luigidellaquila",
    "ncordon"
  ],
  "base_sha": "70e7fa4da0b10dd2f32792b92fcafdc8bafc3b4a",
  "head_sha": "02455b3f2c98e70efa963118362868d4d7a7855b",
  "review_comments": [
    {
      "user": "ncordon",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T08:43:16+00:00"
    },
    {
      "user": "ncordon",
      "state": "APPROVED",
      "body": "",
      "submitted_at": "2025-10-24T08:43:53+00:00"
    },
    {
      "user": "luigidellaquila",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-24T08:51:24+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-analytical-engine (Team:Analytics)",
      "created_at": "2025-10-24T08:33:28+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "Hi @luigidellaquila, I've created a changelog YAML for you.",
      "created_at": "2025-10-24T08:33:51+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "docs/changelog/137082.yaml",
      "status": "added",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "patch": "@@ -0,0 +1,5 @@\n+pr: 137082\n+summary: Validate multiple GROK patterns individually\n+area: ES|QL\n+type: bug\n+issues: []"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/LogicalPlanBuilder.java",
      "status": "modified",
      "additions": 15,
      "deletions": 10,
      "changes": 25,
      "patch": "@@ -223,18 +223,23 @@ public PlanFactory visitGrokCommand(EsqlBaseParser.GrokCommandContext ctx) {\n                 .map(stringContext -> BytesRefs.toString(visitString(stringContext).fold(patternFoldContext)))\n                 .toList();\n \n-            String combinePattern = org.elasticsearch.grok.Grok.combinePatterns(patterns);\n-\n-            Grok.Parser grokParser;\n-            try {\n-                grokParser = Grok.pattern(source, combinePattern);\n-            } catch (SyntaxException e) {\n-                if (patterns.size() == 1) {\n-                    throw new ParsingException(source, \"Invalid GROK pattern [{}]: [{}]\", patterns.getFirst(), e.getMessage());\n-                } else {\n-                    throw new ParsingException(source, \"Invalid GROK patterns {}: [{}]\", patterns, e.getMessage());\n+            for (int i = 0; i < patterns.size(); i++) {\n+                String pattern = patterns.get(i);\n+\n+                // Validate each pattern individually,\n+                // as multiple invalid patterns could be combined to form a valid one\n+                // see https://github.com/elastic/elasticsearch/issues/136750\n+                try {\n+                    Grok.pattern(source, pattern);\n+                } catch (SyntaxException e) {\n+                    throw new ParsingException(source(ctx.string(i)), \"Invalid GROK pattern [{}]: [{}]\", pattern, e.getMessage());\n                 }\n             }\n+\n+            String combinePattern = org.elasticsearch.grok.Grok.combinePatterns(patterns);\n+\n+            Grok.Parser grokParser = Grok.pattern(source, combinePattern);\n+\n             validateGrokPattern(source, grokParser, combinePattern, patterns);\n             Grok result = new Grok(source(ctx), p, expression(ctx.primaryExpression()), grokParser);\n             return result;"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java",
      "status": "modified",
      "additions": 8,
      "deletions": 2,
      "changes": 10,
      "patch": "@@ -1322,7 +1322,7 @@ public void testGrokPattern() {\n \n         expectError(\n             \"row a = \\\"foo\\\" | GROK a \\\"(?P<justification>.+)\\\"\",\n-            \"line 1:17: Invalid GROK pattern [(?P<justification>.+)]: [undefined group option]\"\n+            \"line 1:24: Invalid GROK pattern [(?P<justification>.+)]: [undefined group option]\"\n         );\n \n         expectError(\n@@ -1333,8 +1333,14 @@ public void testGrokPattern() {\n \n         expectError(\n             \"row a = \\\"foo\\\" | GROK a \\\"%{WORD:foo}\\\", \\\"(?P<justification>.+)\\\"\",\n-            \"line 1:17: Invalid GROK patterns [%{WORD:foo}, (?P<justification>.+)]: [undefined group option]\"\n+            \"line 1:39: Invalid GROK pattern [(?P<justification>.+)]: [undefined group option]\"\n         );\n+\n+        // when combining the pattern, the resulting string could be valid, but the single patterns are invalid\n+        expectError(\"\"\"\n+            ROW a = \"foo bar\"\n+            | GROK a \"(%{WORD:word}\", \"x)\"\n+            \"\"\", \"line 2:10: Invalid GROK pattern [(%{WORD:word}]: [end pattern with unmatched parenthesis]\");\n     }\n \n     public void testLikeRLike() {"
    }
  ],
  "diff": "diff --git a/docs/changelog/137082.yaml b/docs/changelog/137082.yaml\nnew file mode 100644\nindex 0000000000000..ffb92a3876df1\n--- /dev/null\n+++ b/docs/changelog/137082.yaml\n@@ -0,0 +1,5 @@\n+pr: 137082\n+summary: Validate multiple GROK patterns individually\n+area: ES|QL\n+type: bug\n+issues: []\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/LogicalPlanBuilder.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/LogicalPlanBuilder.java\nindex 3caf9a9600f73..bdf89d08f93b6 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/LogicalPlanBuilder.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/parser/LogicalPlanBuilder.java\n@@ -223,18 +223,23 @@ public PlanFactory visitGrokCommand(EsqlBaseParser.GrokCommandContext ctx) {\n                 .map(stringContext -> BytesRefs.toString(visitString(stringContext).fold(patternFoldContext)))\n                 .toList();\n \n-            String combinePattern = org.elasticsearch.grok.Grok.combinePatterns(patterns);\n-\n-            Grok.Parser grokParser;\n-            try {\n-                grokParser = Grok.pattern(source, combinePattern);\n-            } catch (SyntaxException e) {\n-                if (patterns.size() == 1) {\n-                    throw new ParsingException(source, \"Invalid GROK pattern [{}]: [{}]\", patterns.getFirst(), e.getMessage());\n-                } else {\n-                    throw new ParsingException(source, \"Invalid GROK patterns {}: [{}]\", patterns, e.getMessage());\n+            for (int i = 0; i < patterns.size(); i++) {\n+                String pattern = patterns.get(i);\n+\n+                // Validate each pattern individually,\n+                // as multiple invalid patterns could be combined to form a valid one\n+                // see https://github.com/elastic/elasticsearch/issues/136750\n+                try {\n+                    Grok.pattern(source, pattern);\n+                } catch (SyntaxException e) {\n+                    throw new ParsingException(source(ctx.string(i)), \"Invalid GROK pattern [{}]: [{}]\", pattern, e.getMessage());\n                 }\n             }\n+\n+            String combinePattern = org.elasticsearch.grok.Grok.combinePatterns(patterns);\n+\n+            Grok.Parser grokParser = Grok.pattern(source, combinePattern);\n+\n             validateGrokPattern(source, grokParser, combinePattern, patterns);\n             Grok result = new Grok(source(ctx), p, expression(ctx.primaryExpression()), grokParser);\n             return result;\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java\nindex b61856ab5333e..a150e1270ac9d 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/parser/StatementParserTests.java\n@@ -1322,7 +1322,7 @@ public void testGrokPattern() {\n \n         expectError(\n             \"row a = \\\"foo\\\" | GROK a \\\"(?P<justification>.+)\\\"\",\n-            \"line 1:17: Invalid GROK pattern [(?P<justification>.+)]: [undefined group option]\"\n+            \"line 1:24: Invalid GROK pattern [(?P<justification>.+)]: [undefined group option]\"\n         );\n \n         expectError(\n@@ -1333,8 +1333,14 @@ public void testGrokPattern() {\n \n         expectError(\n             \"row a = \\\"foo\\\" | GROK a \\\"%{WORD:foo}\\\", \\\"(?P<justification>.+)\\\"\",\n-            \"line 1:17: Invalid GROK patterns [%{WORD:foo}, (?P<justification>.+)]: [undefined group option]\"\n+            \"line 1:39: Invalid GROK pattern [(?P<justification>.+)]: [undefined group option]\"\n         );\n+\n+        // when combining the pattern, the resulting string could be valid, but the single patterns are invalid\n+        expectError(\"\"\"\n+            ROW a = \"foo bar\"\n+            | GROK a \"(%{WORD:word}\", \"x)\"\n+            \"\"\", \"line 2:10: Invalid GROK pattern [(%{WORD:word}]: [end pattern with unmatched parenthesis]\");\n     }\n \n     public void testLikeRLike() {\n",
  "additions": 28,
  "deletions": 12,
  "changed_files": 3,
  "url": "https://github.com/elastic/elasticsearch/pull/137082",
  "mined_at": "2025-10-25T13:31:38.334681"
}