{
  "id": 137043,
  "repository": "elastic/elasticsearch",
  "title": "Disallow dot_product and max_inner_product for int8_hnsw GPU type ",
  "body": "\r\nFor int8_hnsw, during merges we get quantized vectors from Lucene files but dropping for each quantized vector its correction factor.  For cosine and euclidean metrics this correction factor is not important, but for dot_product and max_inner_product metrics, they are important. It means that that currently for dot_product and max_inner_product metrics, GPU graph building doesn't work well, and may produce bad recall. This PR does the following:\r\n\r\n- disallows max_inner_product  for int8\r\n- substitutes internally dot_product with cosine\r\n\r\nAlternatives: for most datasets (really majority), we can substitute dot_product with cosine. But there are some datasets that require max_inner_product, and for this our \"int8_hsnw\" will not work, and \"hnsw\" should be used instead\r\n\r\nBackport for #136881",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-23T19:27:35+00:00",
  "created_at": "2025-10-23T15:26:03+00:00",
  "updated_at": "2025-10-23T19:27:58+00:00",
  "author": "mayya-sharipova",
  "reviewers": [],
  "base_sha": "56fb21a701cca62a305b6c39c044ba891bf24c71",
  "head_sha": "7c18c9a3875e2f65f1236de1040c41a1d0e9fe91",
  "review_comments": [],
  "pr_comments": [],
  "files_changed": [
    {
      "filename": "docs/changelog/136881.yaml",
      "status": "added",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "patch": "@@ -0,0 +1,5 @@\n+pr: 136881\n+summary: Disallow `max_inner_product`, swap `dot_product` for `cosine` for int8_hnsw GPU type\n+area: Search\n+type: bug\n+issues: []"
    },
    {
      "filename": "server/src/main/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldMapper.java",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "patch": "@@ -2267,6 +2267,10 @@ public DenseVectorFieldType(\n             this.isSyntheticSource = isSyntheticSource;\n         }\n \n+        public VectorSimilarity similarity() {\n+            return similarity;\n+        }\n+\n         @Override\n         public String typeName() {\n             return CONTENT_TYPE;\n@@ -2863,7 +2867,7 @@ public KnnVectorsFormat getKnnVectorsFormatForField(KnnVectorsFormat defaultForm\n             // if plugins provided alternative KnnVectorsFormat for this indexOptions, use it instead of standard\n             KnnVectorsFormat extraKnnFormat = null;\n             for (VectorsFormatProvider vectorsFormatProvider : extraVectorsFormatProviders) {\n-                extraKnnFormat = vectorsFormatProvider.getKnnVectorsFormat(indexSettings, indexOptions);\n+                extraKnnFormat = vectorsFormatProvider.getKnnVectorsFormat(indexSettings, indexOptions, fieldType().similarity());\n                 if (extraKnnFormat != null) {\n                     break;\n                 }"
    },
    {
      "filename": "server/src/main/java/org/elasticsearch/index/mapper/vectors/VectorsFormatProvider.java",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "patch": "@@ -24,7 +24,12 @@ public interface VectorsFormatProvider {\n      *\n      * @param indexSettings The index settings.\n      * @param indexOptions The dense vector index options.\n+     * @param similarity The vector similarity function.\n      * @return A KnnVectorsFormat instance.\n      */\n-    KnnVectorsFormat getKnnVectorsFormat(IndexSettings indexSettings, DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions);\n+    KnnVectorsFormat getKnnVectorsFormat(\n+        IndexSettings indexSettings,\n+        DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions,\n+        DenseVectorFieldMapper.VectorSimilarity similarity\n+    );\n }"
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "patch": "@@ -96,6 +96,15 @@ public static DenseVectorFieldMapper.DenseVectorIndexOptions randomGpuSupportedI\n         );\n     }\n \n+    public static DenseVectorFieldMapper.VectorSimilarity randomGPUSupportedSimilarity(\n+        DenseVectorFieldMapper.VectorIndexType vectorIndexType\n+    ) {\n+        if (vectorIndexType == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n+            return randomFrom(VectorSimilarity.L2_NORM, VectorSimilarity.COSINE, VectorSimilarity.DOT_PRODUCT);\n+        }\n+        return randomFrom(VectorSimilarity.values());\n+    }\n+\n     public static DenseVectorFieldMapper.DenseVectorIndexOptions randomIndexOptionsAll() {\n         List<DenseVectorFieldMapper.DenseVectorIndexOptions> options = new ArrayList<>(\n             Arrays.asList("
    },
    {
      "filename": "x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUIndexIT.java",
      "status": "modified",
      "additions": 39,
      "deletions": 0,
      "changes": 39,
      "patch": "@@ -27,6 +27,7 @@\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoFailures;\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoFailuresAndResponse;\n+import static org.hamcrest.Matchers.containsString;\n \n @LuceneTestCase.SuppressCodecs(\"*\") // use our custom codec\n public class GPUIndexIT extends ESIntegTestCase {\n@@ -160,6 +161,44 @@ public void testSearchWithoutGPU() {\n         assertSearch(indexName, randomFloatVector(dims), numDocs);\n     }\n \n+    public void testInt8HnswMaxInnerProductProductFails() {\n+        String indexName = \"index_int8_max_inner_product_fails\";\n+        final int dims = randomIntBetween(4, 128);\n+\n+        Settings.Builder settingsBuilder = Settings.builder().put(indexSettings());\n+        settingsBuilder.put(\"index.number_of_shards\", 1);\n+        settingsBuilder.put(\"index.vectors.indexing.use_gpu\", true);\n+\n+        String mapping = String.format(Locale.ROOT, \"\"\"\n+            {\n+              \"properties\": {\n+                \"my_vector\": {\n+                  \"type\": \"dense_vector\",\n+                  \"dims\": %d,\n+                  \"similarity\": \"max_inner_product\",\n+                  \"index_options\": {\n+                    \"type\": \"int8_hnsw\"\n+                  }\n+                }\n+              }\n+            }\n+            \"\"\", dims);\n+\n+        // Index creation should succeed\n+        assertAcked(prepareCreate(indexName).setSettings(settingsBuilder.build()).setMapping(mapping));\n+        ensureGreen();\n+\n+        // Attempt to index a document and expect it to fail\n+        IllegalArgumentException ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> client().prepareIndex(indexName).setId(\"1\").setSource(\"my_vector\", randomFloatVector(dims)).get()\n+        );\n+        assertThat(\n+            ex.getMessage(),\n+            containsString(\"GPU vector indexing does not support [max_inner_product] similarity for [int8_hnsw] index type.\")\n+        );\n+    }\n+\n     private void createIndex(String indexName, int dims, boolean sorted) {\n         var settings = Settings.builder().put(indexSettings());\n         settings.put(\"index.number_of_shards\", 1);"
    },
    {
      "filename": "x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java",
      "status": "modified",
      "additions": 55,
      "deletions": 10,
      "changes": 65,
      "patch": "@@ -109,7 +109,7 @@ public void testFFOff() {\n         GPUPlugin gpuPlugin = internalCluster().getInstance(GPUPlugin.class);\n         VectorsFormatProvider vectorsFormatProvider = gpuPlugin.getVectorsFormatProvider();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(null, null);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(null, null, null);\n         assertNull(format);\n     }\n \n@@ -136,7 +136,11 @@ public void testFFOffGPUFormatNull() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \n@@ -151,7 +155,11 @@ public void testIndexSettingOnIndexTypeSupportedGPUSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNotNull(format);\n     }\n \n@@ -166,7 +174,14 @@ public void testIndexSettingOnIndexTypeNotSupportedThrows() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomFlatIndexOptions();\n \n-        var ex = expectThrows(IllegalArgumentException.class, () -> vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions));\n+        var ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> vectorsFormatProvider.getKnnVectorsFormat(\n+                settings,\n+                indexOptions,\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+            )\n+        );\n         assertThat(ex.getMessage(), startsWith(\"[index.vectors.indexing.use_gpu] doesn't support [index_options.type] of\"));\n     }\n \n@@ -181,7 +196,14 @@ public void testIndexSettingOnGPUNotSupportedThrows() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var ex = expectThrows(IllegalArgumentException.class, () -> vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions));\n+        var ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> vectorsFormatProvider.getKnnVectorsFormat(\n+                settings,\n+                indexOptions,\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+            )\n+        );\n         assertThat(\n             ex.getMessage(),\n             equalTo(\"[index.vectors.indexing.use_gpu] was set to [true], but GPU resources are not accessible on the node.\")\n@@ -200,7 +222,14 @@ public void testIndexSettingOnGPUSupportThrowsRethrows() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var ex = expectThrows(IllegalArgumentException.class, () -> vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions));\n+        var ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> vectorsFormatProvider.getKnnVectorsFormat(\n+                settings,\n+                indexOptions,\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+            )\n+        );\n         assertThat(\n             ex.getMessage(),\n             equalTo(\"[index.vectors.indexing.use_gpu] was set to [true], but GPU resources are not accessible on the node.\")\n@@ -218,7 +247,11 @@ public void testIndexSettingAutoIndexTypeSupportedGPUSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNotNull(format);\n     }\n \n@@ -233,7 +266,11 @@ public void testIndexSettingAutoGPUNotSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \n@@ -248,7 +285,11 @@ public void testIndexSettingAutoIndexTypeNotSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomFlatIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \n@@ -263,7 +304,11 @@ public void testIndexSettingOff() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n "
    },
    {
      "filename": "x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/GPUPlugin.java",
      "status": "modified",
      "additions": 18,
      "deletions": 4,
      "changes": 22,
      "patch": "@@ -60,7 +60,7 @@ public List<Setting<?>> getSettings() {\n \n     @Override\n     public VectorsFormatProvider getVectorsFormatProvider() {\n-        return (indexSettings, indexOptions) -> {\n+        return (indexSettings, indexOptions, similarity) -> {\n             if (GPU_FORMAT.isEnabled()) {\n                 GpuMode gpuMode = indexSettings.getValue(VECTORS_INDEXING_USE_GPU_SETTING);\n                 if (gpuMode == GpuMode.TRUE) {\n@@ -74,10 +74,10 @@ public VectorsFormatProvider getVectorsFormatProvider() {\n                             \"[index.vectors.indexing.use_gpu] was set to [true], but GPU resources are not accessible on the node.\"\n                         );\n                     }\n-                    return getVectorsFormat(indexOptions);\n+                    return getVectorsFormat(indexOptions, similarity);\n                 }\n                 if (gpuMode == GpuMode.AUTO && vectorIndexTypeSupported(indexOptions.getType()) && GPUSupport.isSupported(false)) {\n-                    return getVectorsFormat(indexOptions);\n+                    return getVectorsFormat(indexOptions, similarity);\n                 }\n             }\n             return null;\n@@ -88,7 +88,10 @@ private boolean vectorIndexTypeSupported(DenseVectorFieldMapper.VectorIndexType\n         return type == DenseVectorFieldMapper.VectorIndexType.HNSW || type == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW;\n     }\n \n-    private static KnnVectorsFormat getVectorsFormat(DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions) {\n+    private static KnnVectorsFormat getVectorsFormat(\n+        DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions,\n+        DenseVectorFieldMapper.VectorSimilarity similarity\n+    ) {\n         if (indexOptions.getType() == DenseVectorFieldMapper.VectorIndexType.HNSW) {\n             DenseVectorFieldMapper.HnswIndexOptions hnswIndexOptions = (DenseVectorFieldMapper.HnswIndexOptions) indexOptions;\n             int efConstruction = hnswIndexOptions.efConstruction();\n@@ -97,6 +100,17 @@ private static KnnVectorsFormat getVectorsFormat(DenseVectorFieldMapper.DenseVec\n             }\n             return new ES92GpuHnswVectorsFormat(hnswIndexOptions.m(), efConstruction);\n         } else if (indexOptions.getType() == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n+            if (similarity == DenseVectorFieldMapper.VectorSimilarity.MAX_INNER_PRODUCT) {\n+                throw new IllegalArgumentException(\n+                    \"GPU vector indexing does not support [\"\n+                        + similarity\n+                        + \"] similarity for [int8_hnsw] index type. \"\n+                        + \"Instead, consider using [\"\n+                        + DenseVectorFieldMapper.VectorSimilarity.COSINE\n+                        + \"] or \"\n+                        + \" [hnsw] index type.\"\n+                );\n+            }\n             DenseVectorFieldMapper.Int8HnswIndexOptions int8HnswIndexOptions = (DenseVectorFieldMapper.Int8HnswIndexOptions) indexOptions;\n             int efConstruction = int8HnswIndexOptions.efConstruction();\n             if (efConstruction == HnswGraphBuilder.DEFAULT_BEAM_WIDTH) {"
    },
    {
      "filename": "x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswVectorsWriter.java",
      "status": "modified",
      "additions": 11,
      "deletions": 2,
      "changes": 13,
      "patch": "@@ -313,9 +313,18 @@ private CagraIndex buildGPUIndex(\n         CuVSMatrix dataset\n     ) throws Throwable {\n         CagraIndexParams.CuvsDistanceType distanceType = switch (similarityFunction) {\n-            case EUCLIDEAN -> CagraIndexParams.CuvsDistanceType.L2Expanded;\n-            case DOT_PRODUCT, MAXIMUM_INNER_PRODUCT -> CagraIndexParams.CuvsDistanceType.InnerProduct;\n             case COSINE -> CagraIndexParams.CuvsDistanceType.CosineExpanded;\n+            case EUCLIDEAN -> CagraIndexParams.CuvsDistanceType.L2Expanded;\n+            case DOT_PRODUCT -> {\n+                if (dataType == CuVSMatrix.DataType.BYTE) {\n+                    yield CagraIndexParams.CuvsDistanceType.CosineExpanded;\n+                }\n+                yield CagraIndexParams.CuvsDistanceType.InnerProduct;\n+            }\n+            case MAXIMUM_INNER_PRODUCT -> {\n+                assert dataType != CuVSMatrix.DataType.BYTE;\n+                yield CagraIndexParams.CuvsDistanceType.InnerProduct;\n+            }\n         };\n \n         // TODO: expose cagra index params for algorithm, NNDescentNumIterations"
    },
    {
      "filename": "x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java",
      "status": "modified",
      "additions": 5,
      "deletions": 1,
      "changes": 6,
      "patch": "@@ -13,6 +13,9 @@\n import org.apache.lucene.tests.util.LuceneTestCase;\n import org.apache.lucene.tests.util.TestUtil;\n import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.index.IndexVersion;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldMapper;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldTypeTests;\n import org.elasticsearch.xpack.gpu.GPUSupport;\n import org.junit.BeforeClass;\n \n@@ -39,7 +42,8 @@ protected Codec getCodec() {\n \n     @Override\n     protected VectorSimilarityFunction randomSimilarity() {\n-        return VectorSimilarityFunction.values()[random().nextInt(VectorSimilarityFunction.values().length)];\n+        return DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(DenseVectorFieldMapper.VectorIndexType.INT8_HNSW)\n+            .vectorSimilarityFunction(IndexVersion.current(), DenseVectorFieldMapper.ElementType.FLOAT);\n     }\n \n     @Override"
    }
  ],
  "diff": "diff --git a/docs/changelog/136881.yaml b/docs/changelog/136881.yaml\nnew file mode 100644\nindex 0000000000000..6ec0c0f410a22\n--- /dev/null\n+++ b/docs/changelog/136881.yaml\n@@ -0,0 +1,5 @@\n+pr: 136881\n+summary: Disallow `max_inner_product`, swap `dot_product` for `cosine` for int8_hnsw GPU type\n+area: Search\n+type: bug\n+issues: []\ndiff --git a/server/src/main/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldMapper.java b/server/src/main/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldMapper.java\nindex 8f92f1d0628ba..756e129c449e3 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldMapper.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldMapper.java\n@@ -2267,6 +2267,10 @@ public DenseVectorFieldType(\n             this.isSyntheticSource = isSyntheticSource;\n         }\n \n+        public VectorSimilarity similarity() {\n+            return similarity;\n+        }\n+\n         @Override\n         public String typeName() {\n             return CONTENT_TYPE;\n@@ -2863,7 +2867,7 @@ public KnnVectorsFormat getKnnVectorsFormatForField(KnnVectorsFormat defaultForm\n             // if plugins provided alternative KnnVectorsFormat for this indexOptions, use it instead of standard\n             KnnVectorsFormat extraKnnFormat = null;\n             for (VectorsFormatProvider vectorsFormatProvider : extraVectorsFormatProviders) {\n-                extraKnnFormat = vectorsFormatProvider.getKnnVectorsFormat(indexSettings, indexOptions);\n+                extraKnnFormat = vectorsFormatProvider.getKnnVectorsFormat(indexSettings, indexOptions, fieldType().similarity());\n                 if (extraKnnFormat != null) {\n                     break;\n                 }\ndiff --git a/server/src/main/java/org/elasticsearch/index/mapper/vectors/VectorsFormatProvider.java b/server/src/main/java/org/elasticsearch/index/mapper/vectors/VectorsFormatProvider.java\nindex 4bc338e6680ec..7629b1032b98c 100644\n--- a/server/src/main/java/org/elasticsearch/index/mapper/vectors/VectorsFormatProvider.java\n+++ b/server/src/main/java/org/elasticsearch/index/mapper/vectors/VectorsFormatProvider.java\n@@ -24,7 +24,12 @@ public interface VectorsFormatProvider {\n      *\n      * @param indexSettings The index settings.\n      * @param indexOptions The dense vector index options.\n+     * @param similarity The vector similarity function.\n      * @return A KnnVectorsFormat instance.\n      */\n-    KnnVectorsFormat getKnnVectorsFormat(IndexSettings indexSettings, DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions);\n+    KnnVectorsFormat getKnnVectorsFormat(\n+        IndexSettings indexSettings,\n+        DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions,\n+        DenseVectorFieldMapper.VectorSimilarity similarity\n+    );\n }\ndiff --git a/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java b/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java\nindex 75d7e8609bf56..211fe73bc134b 100644\n--- a/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java\n+++ b/server/src/test/java/org/elasticsearch/index/mapper/vectors/DenseVectorFieldTypeTests.java\n@@ -96,6 +96,15 @@ public static DenseVectorFieldMapper.DenseVectorIndexOptions randomGpuSupportedI\n         );\n     }\n \n+    public static DenseVectorFieldMapper.VectorSimilarity randomGPUSupportedSimilarity(\n+        DenseVectorFieldMapper.VectorIndexType vectorIndexType\n+    ) {\n+        if (vectorIndexType == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n+            return randomFrom(VectorSimilarity.L2_NORM, VectorSimilarity.COSINE, VectorSimilarity.DOT_PRODUCT);\n+        }\n+        return randomFrom(VectorSimilarity.values());\n+    }\n+\n     public static DenseVectorFieldMapper.DenseVectorIndexOptions randomIndexOptionsAll() {\n         List<DenseVectorFieldMapper.DenseVectorIndexOptions> options = new ArrayList<>(\n             Arrays.asList(\ndiff --git a/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUIndexIT.java b/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUIndexIT.java\nindex b00d8d83143a9..92d91c7db22c5 100644\n--- a/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUIndexIT.java\n+++ b/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUIndexIT.java\n@@ -27,6 +27,7 @@\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoFailures;\n import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoFailuresAndResponse;\n+import static org.hamcrest.Matchers.containsString;\n \n @LuceneTestCase.SuppressCodecs(\"*\") // use our custom codec\n public class GPUIndexIT extends ESIntegTestCase {\n@@ -160,6 +161,44 @@ public void testSearchWithoutGPU() {\n         assertSearch(indexName, randomFloatVector(dims), numDocs);\n     }\n \n+    public void testInt8HnswMaxInnerProductProductFails() {\n+        String indexName = \"index_int8_max_inner_product_fails\";\n+        final int dims = randomIntBetween(4, 128);\n+\n+        Settings.Builder settingsBuilder = Settings.builder().put(indexSettings());\n+        settingsBuilder.put(\"index.number_of_shards\", 1);\n+        settingsBuilder.put(\"index.vectors.indexing.use_gpu\", true);\n+\n+        String mapping = String.format(Locale.ROOT, \"\"\"\n+            {\n+              \"properties\": {\n+                \"my_vector\": {\n+                  \"type\": \"dense_vector\",\n+                  \"dims\": %d,\n+                  \"similarity\": \"max_inner_product\",\n+                  \"index_options\": {\n+                    \"type\": \"int8_hnsw\"\n+                  }\n+                }\n+              }\n+            }\n+            \"\"\", dims);\n+\n+        // Index creation should succeed\n+        assertAcked(prepareCreate(indexName).setSettings(settingsBuilder.build()).setMapping(mapping));\n+        ensureGreen();\n+\n+        // Attempt to index a document and expect it to fail\n+        IllegalArgumentException ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> client().prepareIndex(indexName).setId(\"1\").setSource(\"my_vector\", randomFloatVector(dims)).get()\n+        );\n+        assertThat(\n+            ex.getMessage(),\n+            containsString(\"GPU vector indexing does not support [max_inner_product] similarity for [int8_hnsw] index type.\")\n+        );\n+    }\n+\n     private void createIndex(String indexName, int dims, boolean sorted) {\n         var settings = Settings.builder().put(indexSettings());\n         settings.put(\"index.number_of_shards\", 1);\ndiff --git a/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java b/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java\nindex 65d8daf14d31e..29645f566a8e6 100644\n--- a/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java\n+++ b/x-pack/plugin/gpu/src/internalClusterTest/java/org/elasticsearch/plugin/gpu/GPUPluginInitializationIT.java\n@@ -109,7 +109,7 @@ public void testFFOff() {\n         GPUPlugin gpuPlugin = internalCluster().getInstance(GPUPlugin.class);\n         VectorsFormatProvider vectorsFormatProvider = gpuPlugin.getVectorsFormatProvider();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(null, null);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(null, null, null);\n         assertNull(format);\n     }\n \n@@ -136,7 +136,11 @@ public void testFFOffGPUFormatNull() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \n@@ -151,7 +155,11 @@ public void testIndexSettingOnIndexTypeSupportedGPUSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNotNull(format);\n     }\n \n@@ -166,7 +174,14 @@ public void testIndexSettingOnIndexTypeNotSupportedThrows() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomFlatIndexOptions();\n \n-        var ex = expectThrows(IllegalArgumentException.class, () -> vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions));\n+        var ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> vectorsFormatProvider.getKnnVectorsFormat(\n+                settings,\n+                indexOptions,\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+            )\n+        );\n         assertThat(ex.getMessage(), startsWith(\"[index.vectors.indexing.use_gpu] doesn't support [index_options.type] of\"));\n     }\n \n@@ -181,7 +196,14 @@ public void testIndexSettingOnGPUNotSupportedThrows() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var ex = expectThrows(IllegalArgumentException.class, () -> vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions));\n+        var ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> vectorsFormatProvider.getKnnVectorsFormat(\n+                settings,\n+                indexOptions,\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+            )\n+        );\n         assertThat(\n             ex.getMessage(),\n             equalTo(\"[index.vectors.indexing.use_gpu] was set to [true], but GPU resources are not accessible on the node.\")\n@@ -200,7 +222,14 @@ public void testIndexSettingOnGPUSupportThrowsRethrows() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var ex = expectThrows(IllegalArgumentException.class, () -> vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions));\n+        var ex = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> vectorsFormatProvider.getKnnVectorsFormat(\n+                settings,\n+                indexOptions,\n+                DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+            )\n+        );\n         assertThat(\n             ex.getMessage(),\n             equalTo(\"[index.vectors.indexing.use_gpu] was set to [true], but GPU resources are not accessible on the node.\")\n@@ -218,7 +247,11 @@ public void testIndexSettingAutoIndexTypeSupportedGPUSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNotNull(format);\n     }\n \n@@ -233,7 +266,11 @@ public void testIndexSettingAutoGPUNotSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \n@@ -248,7 +285,11 @@ public void testIndexSettingAutoIndexTypeNotSupported() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomFlatIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \n@@ -263,7 +304,11 @@ public void testIndexSettingOff() {\n         IndexSettings settings = getIndexSettings();\n         final var indexOptions = DenseVectorFieldTypeTests.randomGpuSupportedIndexOptions();\n \n-        var format = vectorsFormatProvider.getKnnVectorsFormat(settings, indexOptions);\n+        var format = vectorsFormatProvider.getKnnVectorsFormat(\n+            settings,\n+            indexOptions,\n+            DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(indexOptions.getType())\n+        );\n         assertNull(format);\n     }\n \ndiff --git a/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/GPUPlugin.java b/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/GPUPlugin.java\nindex 62190bc0fb752..5fe7746755c9e 100644\n--- a/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/GPUPlugin.java\n+++ b/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/GPUPlugin.java\n@@ -60,7 +60,7 @@ public List<Setting<?>> getSettings() {\n \n     @Override\n     public VectorsFormatProvider getVectorsFormatProvider() {\n-        return (indexSettings, indexOptions) -> {\n+        return (indexSettings, indexOptions, similarity) -> {\n             if (GPU_FORMAT.isEnabled()) {\n                 GpuMode gpuMode = indexSettings.getValue(VECTORS_INDEXING_USE_GPU_SETTING);\n                 if (gpuMode == GpuMode.TRUE) {\n@@ -74,10 +74,10 @@ public VectorsFormatProvider getVectorsFormatProvider() {\n                             \"[index.vectors.indexing.use_gpu] was set to [true], but GPU resources are not accessible on the node.\"\n                         );\n                     }\n-                    return getVectorsFormat(indexOptions);\n+                    return getVectorsFormat(indexOptions, similarity);\n                 }\n                 if (gpuMode == GpuMode.AUTO && vectorIndexTypeSupported(indexOptions.getType()) && GPUSupport.isSupported(false)) {\n-                    return getVectorsFormat(indexOptions);\n+                    return getVectorsFormat(indexOptions, similarity);\n                 }\n             }\n             return null;\n@@ -88,7 +88,10 @@ private boolean vectorIndexTypeSupported(DenseVectorFieldMapper.VectorIndexType\n         return type == DenseVectorFieldMapper.VectorIndexType.HNSW || type == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW;\n     }\n \n-    private static KnnVectorsFormat getVectorsFormat(DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions) {\n+    private static KnnVectorsFormat getVectorsFormat(\n+        DenseVectorFieldMapper.DenseVectorIndexOptions indexOptions,\n+        DenseVectorFieldMapper.VectorSimilarity similarity\n+    ) {\n         if (indexOptions.getType() == DenseVectorFieldMapper.VectorIndexType.HNSW) {\n             DenseVectorFieldMapper.HnswIndexOptions hnswIndexOptions = (DenseVectorFieldMapper.HnswIndexOptions) indexOptions;\n             int efConstruction = hnswIndexOptions.efConstruction();\n@@ -97,6 +100,17 @@ private static KnnVectorsFormat getVectorsFormat(DenseVectorFieldMapper.DenseVec\n             }\n             return new ES92GpuHnswVectorsFormat(hnswIndexOptions.m(), efConstruction);\n         } else if (indexOptions.getType() == DenseVectorFieldMapper.VectorIndexType.INT8_HNSW) {\n+            if (similarity == DenseVectorFieldMapper.VectorSimilarity.MAX_INNER_PRODUCT) {\n+                throw new IllegalArgumentException(\n+                    \"GPU vector indexing does not support [\"\n+                        + similarity\n+                        + \"] similarity for [int8_hnsw] index type. \"\n+                        + \"Instead, consider using [\"\n+                        + DenseVectorFieldMapper.VectorSimilarity.COSINE\n+                        + \"] or \"\n+                        + \" [hnsw] index type.\"\n+                );\n+            }\n             DenseVectorFieldMapper.Int8HnswIndexOptions int8HnswIndexOptions = (DenseVectorFieldMapper.Int8HnswIndexOptions) indexOptions;\n             int efConstruction = int8HnswIndexOptions.efConstruction();\n             if (efConstruction == HnswGraphBuilder.DEFAULT_BEAM_WIDTH) {\ndiff --git a/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswVectorsWriter.java b/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswVectorsWriter.java\nindex 6702547314f2d..6cccda6333f2b 100644\n--- a/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswVectorsWriter.java\n+++ b/x-pack/plugin/gpu/src/main/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswVectorsWriter.java\n@@ -313,9 +313,18 @@ private CagraIndex buildGPUIndex(\n         CuVSMatrix dataset\n     ) throws Throwable {\n         CagraIndexParams.CuvsDistanceType distanceType = switch (similarityFunction) {\n-            case EUCLIDEAN -> CagraIndexParams.CuvsDistanceType.L2Expanded;\n-            case DOT_PRODUCT, MAXIMUM_INNER_PRODUCT -> CagraIndexParams.CuvsDistanceType.InnerProduct;\n             case COSINE -> CagraIndexParams.CuvsDistanceType.CosineExpanded;\n+            case EUCLIDEAN -> CagraIndexParams.CuvsDistanceType.L2Expanded;\n+            case DOT_PRODUCT -> {\n+                if (dataType == CuVSMatrix.DataType.BYTE) {\n+                    yield CagraIndexParams.CuvsDistanceType.CosineExpanded;\n+                }\n+                yield CagraIndexParams.CuvsDistanceType.InnerProduct;\n+            }\n+            case MAXIMUM_INNER_PRODUCT -> {\n+                assert dataType != CuVSMatrix.DataType.BYTE;\n+                yield CagraIndexParams.CuvsDistanceType.InnerProduct;\n+            }\n         };\n \n         // TODO: expose cagra index params for algorithm, NNDescentNumIterations\ndiff --git a/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java b/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java\nindex f1c13b15795c5..798cb726427ce 100644\n--- a/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java\n+++ b/x-pack/plugin/gpu/src/test/java/org/elasticsearch/xpack/gpu/codec/ES92GpuHnswSQVectorsFormatTests.java\n@@ -13,6 +13,9 @@\n import org.apache.lucene.tests.util.LuceneTestCase;\n import org.apache.lucene.tests.util.TestUtil;\n import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.index.IndexVersion;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldMapper;\n+import org.elasticsearch.index.mapper.vectors.DenseVectorFieldTypeTests;\n import org.elasticsearch.xpack.gpu.GPUSupport;\n import org.junit.BeforeClass;\n \n@@ -39,7 +42,8 @@ protected Codec getCodec() {\n \n     @Override\n     protected VectorSimilarityFunction randomSimilarity() {\n-        return VectorSimilarityFunction.values()[random().nextInt(VectorSimilarityFunction.values().length)];\n+        return DenseVectorFieldTypeTests.randomGPUSupportedSimilarity(DenseVectorFieldMapper.VectorIndexType.INT8_HNSW)\n+            .vectorSimilarityFunction(IndexVersion.current(), DenseVectorFieldMapper.ElementType.FLOAT);\n     }\n \n     @Override\n",
  "additions": 153,
  "deletions": 19,
  "changed_files": 9,
  "url": "https://github.com/elastic/elasticsearch/pull/137043",
  "mined_at": "2025-10-25T13:38:49.774216"
}