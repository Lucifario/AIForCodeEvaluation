{
  "id": 136712,
  "repository": "elastic/elasticsearch",
  "title": "New timeseries aggregations: Stddev and variance over time",
  "body": "ESQL already had support of stdev with a proper numerically-stable algorithm by @limotova. This PR makes the following changes:\r\n\r\n- Implement `stddev_over_time` based on `stddev`\r\n- Add a parameter to the internal std dev algorithm to return variance or stddev\r\n- Implement `variance` (alias: `stdvar`) function\r\n- Implement `stdvar_over_time` (alias `variance_over_time`) - name is to match prometheus function.",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T19:41:35+00:00",
  "created_at": "2025-10-16T18:29:19+00:00",
  "updated_at": "2025-10-24T21:51:32+00:00",
  "author": "pabloem",
  "reviewers": [
    "pabloem",
    "kkrik-es",
    "limotova",
    "dnhatn"
  ],
  "base_sha": "bd94fd85d23e36f0b8a4db031e303182a14bcf3a",
  "head_sha": "1c88ab11c8513793750baeef1ffd9a2607f46482",
  "review_comments": [
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-17T08:10:21+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-17T08:11:52+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-17T16:21:45+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-17T16:24:59+00:00"
    },
    {
      "user": "limotova",
      "state": "DISMISSED",
      "body": "Just a few things, thank you Pablo!\r\n\r\nBut also I don't think we should call this std_var, I think it should be variance (or var if we want something short), standard variance is a misnomer",
      "submitted_at": "2025-10-17T20:15:08+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-17T22:38:33+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-17T22:38:40+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-18T02:05:01+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-18T02:44:20+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-18T03:08:21+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-18T16:56:05+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T00:12:31+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T00:16:44+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T00:19:01+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T00:38:24+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T03:24:25+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T03:24:28+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T03:24:31+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T03:24:34+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T03:34:50+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T06:16:03+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T06:21:42+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-21T17:35:52+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T04:07:45+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T17:45:41+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T17:46:24+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T17:47:47+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T17:48:11+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T17:48:54+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T18:05:00+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T18:05:02+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T18:05:04+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T18:05:06+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T18:05:08+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T21:28:12+00:00"
    },
    {
      "user": "limotova",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-22T21:30:26+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T03:45:16+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T03:45:30+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T08:36:08+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T08:36:34+00:00"
    },
    {
      "user": "kkrik-es",
      "state": "COMMENTED",
      "body": "Documentation is almost there - just a couple of small fixes left.\r\n\r\nLooks good, will leave it to @dnhatn to approve.",
      "submitted_at": "2025-10-23T08:38:22+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T16:28:23+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T16:28:26+00:00"
    },
    {
      "user": "dnhatn",
      "state": "APPROVED",
      "body": "Looks great, thanks Pablo!",
      "submitted_at": "2025-10-23T16:57:20+00:00"
    },
    {
      "user": "pabloem",
      "state": "COMMENTED",
      "body": "",
      "submitted_at": "2025-10-23T17:42:20+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "github-actions[bot]",
      "body": "## üîç Preview links for changed docs\n- [docs/reference/query-languages/esql/kibana/docs/functions/stddev_over_time.md](https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/kibana/docs/functions/stddev_over_time)\n- [docs/reference/query-languages/esql/kibana/docs/functions/variance.md](https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/kibana/docs/functions/variance)\n- [docs/reference/query-languages/esql/kibana/docs/functions/variance_over_time.md](https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/kibana/docs/functions/variance_over_time)\n- [docs/reference/query-languages/esql/functions-operators/aggregation-functions.md](https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/aggregation-functions)\n- [docs/reference/query-languages/esql/functions-operators/time-series-aggregation-functions.md](https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/time-series-aggregation-functions)",
      "created_at": "2025-10-17T02:44:19+00:00"
    },
    {
      "user": "github-actions[bot]",
      "body": "## ‚ÑπÔ∏è Important: Docs version tagging\n\nüëã Thanks for updating the docs! Just a friendly reminder that our docs are now **cumulative**. This means all 9.x versions are documented on the same page and published off of the main branch, instead of creating separate pages for each minor version.\n\nWe use [applies_to tags](https://elastic.github.io/docs-builder/syntax/applies) to mark version-specific features and changes.\n\n<details>\n<summary>Expand for a quick overview</summary>\n\n### When to use applies_to tags:\n‚úÖ At the page level to indicate which products/deployments the content applies to (mandatory)\n‚úÖ When features change state (e.g. preview, ga) in a specific version\n‚úÖ When availability differs across deployments and environments\n\n### What NOT to do:\n‚ùå Don't remove or replace information that applies to an older version\n‚ùå Don't add new information that applies to a specific version without an applies_to tag\n‚ùå Don't forget that applies_to tags can be used at the page, section, and inline level\n</details>\n\n### ü§î Need help?\n- Check out the [cumulative docs guidelines](https://elastic.github.io/docs-builder/contribute/cumulative-docs/)\n- Reach out in the [#docs](https://elastic.slack.com/archives/C0JF80CJZ) Slack channel",
      "created_at": "2025-10-17T02:44:20+00:00"
    },
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-storage-engine (Team:StorageEngine)",
      "created_at": "2025-10-17T03:49:40+00:00"
    },
    {
      "user": "kkrik-es",
      "body": "Let's make sure that the description captures the interesting parts of a PR. Here, you're modifying the existing implementation of StdDev to cover StdVar too.",
      "created_at": "2025-10-17T07:11:22+00:00"
    },
    {
      "user": "kkrik-es",
      "body": "You also need to include these functions here:\r\n\r\nhttps://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/time-series-aggregation-functions\r\n",
      "created_at": "2025-10-17T08:17:47+00:00"
    },
    {
      "user": "kkrik-es",
      "body": "I still don't see these functions in the documentation:\r\nhttps://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/aggregation-functions\r\nhttps://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/time-series-aggregation-functions",
      "created_at": "2025-10-21T05:43:31+00:00"
    },
    {
      "user": "pabloem",
      "body": "> I still don't see these functions in the documentation: https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/aggregation-functions https://docs-v3-preview.elastic.dev/elastic/elasticsearch/pull/136712/reference/query-languages/esql/functions-operators/time-series-aggregation-functions\r\n\r\nlooking into this...",
      "created_at": "2025-10-21T17:36:13+00:00"
    },
    {
      "user": "pabloem",
      "body": "the only difference I see between `stddev_over_time` vs `absent_over_time` is the version `9.3.0 - preview` v.s. `9.2.0 - preview` - I tried making everything 9.2.0 as a test here https://github.com/elastic/elasticsearch/pull/136906 and it didn't work either.. ü§î ",
      "created_at": "2025-10-22T04:08:21+00:00"
    },
    {
      "user": "pabloem",
      "body": "examples and docs fixed @kkrik-es üëç ",
      "created_at": "2025-10-22T17:40:29+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/description/stddev_over_time.md",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "patch": "@@ -0,0 +1,6 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Description**\n+\n+Calculates the population standard deviation over time of a numeric field.\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/description/variance.md",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "patch": "@@ -0,0 +1,6 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Description**\n+\n+The population variance of a numeric field.\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/description/variance_over_time.md",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "patch": "@@ -0,0 +1,6 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Description**\n+\n+Calculates the population variance over time of a numeric field.\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/examples/stddev_over_time.md",
      "status": "added",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "patch": "@@ -0,0 +1,18 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Example**\n+\n+```esql\n+TS k8s\n+| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```\n+\n+| cluster:keyword | time_bucket:datetime | max_stddev_cost:double |\n+| --- | --- | --- |\n+| staging | 2024-05-10T00:03:00.000Z | 5.4375 |\n+| staging | 2024-05-10T00:09:00.000Z | 5.1875 |\n+| qa | 2024-05-10T00:18:00.000Z | 4.097764 |\n+| qa | 2024-05-10T00:21:00.000Z | 4.0 |\n+| staging | 2024-05-10T00:20:00.000Z | 3.9375 |\n+\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/examples/variance.md",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "patch": "@@ -0,0 +1,14 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Example**\n+\n+```esql\n+FROM employees\n+| STATS var_height = VARIANCE(height)\n+```\n+\n+| var_height:double |\n+| --- |\n+| 0.0425888 |\n+\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/examples/variance_over_time.md",
      "status": "added",
      "additions": 17,
      "deletions": 0,
      "changes": 17,
      "patch": "@@ -0,0 +1,17 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Example**\n+\n+```esql\n+TS k8s\n+| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```\n+\n+| cluster:keyword | time_bucket:datetime | avg_var_cost:double |\n+| --- | --- | --- |\n+| staging | 2024-05-10T00:03:00.000Z | 20.478516 |\n+| qa | 2024-05-10T00:21:00.000Z | 16.0 |\n+| qa | 2024-05-10T00:18:00.000Z | 11.192274 |\n+| staging | 2024-05-10T00:09:00.000Z | 10.446904 |\n+\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/layout/stddev_over_time.md",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "patch": "@@ -0,0 +1,27 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+## `STDDEV_OVER_TIME` [esql-stddev_over_time]\n+```{applies_to}\n+stack: preview 9.3.0\n+serverless: preview\n+```\n+\n+**Syntax**\n+\n+:::{image} ../../../images/functions/stddev_over_time.svg\n+:alt: Embedded\n+:class: text-center\n+:::\n+\n+\n+:::{include} ../parameters/stddev_over_time.md\n+:::\n+\n+:::{include} ../description/stddev_over_time.md\n+:::\n+\n+:::{include} ../types/stddev_over_time.md\n+:::\n+\n+:::{include} ../examples/stddev_over_time.md\n+:::"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/layout/variance.md",
      "status": "added",
      "additions": 23,
      "deletions": 0,
      "changes": 23,
      "patch": "@@ -0,0 +1,23 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+## `VARIANCE` [esql-variance]\n+\n+**Syntax**\n+\n+:::{image} ../../../images/functions/variance.svg\n+:alt: Embedded\n+:class: text-center\n+:::\n+\n+\n+:::{include} ../parameters/variance.md\n+:::\n+\n+:::{include} ../description/variance.md\n+:::\n+\n+:::{include} ../types/variance.md\n+:::\n+\n+:::{include} ../examples/variance.md\n+:::"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/layout/variance_over_time.md",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "patch": "@@ -0,0 +1,27 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+## `VARIANCE_OVER_TIME` [esql-variance_over_time]\n+```{applies_to}\n+stack: preview 9.3.0\n+serverless: preview\n+```\n+\n+**Syntax**\n+\n+:::{image} ../../../images/functions/variance_over_time.svg\n+:alt: Embedded\n+:class: text-center\n+:::\n+\n+\n+:::{include} ../parameters/variance_over_time.md\n+:::\n+\n+:::{include} ../description/variance_over_time.md\n+:::\n+\n+:::{include} ../types/variance_over_time.md\n+:::\n+\n+:::{include} ../examples/variance_over_time.md\n+:::"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/parameters/stddev_over_time.md",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "patch": "@@ -0,0 +1,7 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Parameters**\n+\n+`number`\n+:   Expression that outputs values to calculate the standard deviation of.\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/parameters/variance.md",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "patch": "@@ -0,0 +1,7 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Parameters**\n+\n+`number`\n+:   \n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/parameters/variance_over_time.md",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "patch": "@@ -0,0 +1,7 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Parameters**\n+\n+`number`\n+:   Expression for which to calculate the variance over time.\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/types/stddev_over_time.md",
      "status": "added",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "patch": "@@ -0,0 +1,10 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Supported types**\n+\n+| number | result |\n+| --- | --- |\n+| double | double |\n+| integer | double |\n+| long | double |\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/types/variance.md",
      "status": "added",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "patch": "@@ -0,0 +1,10 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Supported types**\n+\n+| number | result |\n+| --- | --- |\n+| double | double |\n+| integer | double |\n+| long | double |\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/functions/types/variance_over_time.md",
      "status": "added",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "patch": "@@ -0,0 +1,10 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Supported types**\n+\n+| number | result |\n+| --- | --- |\n+| double | double |\n+| integer | double |\n+| long | double |\n+"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/lists/aggregation-functions.md",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "patch": "@@ -17,4 +17,5 @@\n * [`SUM`](../../functions-operators/aggregation-functions.md#esql-sum)\n * [`TOP`](../../functions-operators/aggregation-functions.md#esql-top)\n * [`VALUES`](../../functions-operators/aggregation-functions.md#esql-values) {applies_to}`stack: preview` {applies_to}`serverless: preview`\n+* [`VARIANCE`](../../functions-operators/aggregation-functions.md#esql-variance)\n * [`WEIGHTED_AVG`](../../functions-operators/aggregation-functions.md#esql-weighted_avg)"
    },
    {
      "filename": "docs/reference/query-languages/esql/_snippets/lists/time-series-aggregation-functions.md",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "patch": "@@ -12,4 +12,6 @@\n * [`MIN_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-min_over_time) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\n * [`PRESENT_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-present_over_time) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\n * [`RATE`](../../functions-operators/time-series-aggregation-functions.md#esql-rate) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\n+* [`STDDEV_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-stddev_over_time) {applies_to}`stack: preview 9.3` {applies_to}`serverless: preview`\n+* [`VARIANCE_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-variance_over_time) {applies_to}`stack: preview 9.3` {applies_to}`serverless: preview`\n * [`SUM_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-sum_over_time) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`"
    },
    {
      "filename": "docs/reference/query-languages/esql/functions-operators/aggregation-functions.md",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "patch": "@@ -73,5 +73,8 @@ The [`STATS`](/reference/query-languages/esql/commands/stats-by.md) and [`INLINE\n :::{include} ../_snippets/functions/layout/values.md\n :::\n \n+:::{include} ../_snippets/functions/layout/variance.md\n+:::\n+\n :::{include} ../_snippets/functions/layout/weighted_avg.md\n :::"
    },
    {
      "filename": "docs/reference/query-languages/esql/functions-operators/time-series-aggregation-functions.md",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "patch": "@@ -55,5 +55,11 @@ supports the following time series aggregation functions:\n :::{include} ../_snippets/functions/layout/rate.md\n :::\n \n+:::{include} ../_snippets/functions/layout/stddev_over_time.md\n+:::\n+\n+:::{include} ../_snippets/functions/layout/variance_over_time.md\n+:::\n+\n :::{include} ../_snippets/functions/layout/sum_over_time.md\n :::"
    },
    {
      "filename": "docs/reference/query-languages/esql/images/functions/stddev_over_time.svg",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "patch": "@@ -0,0 +1 @@\n+<svg version=\"1.1\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"408\" height=\"46\" viewbox=\"0 0 408 46\"><defs><style type=\"text/css\">.c{fill:none;stroke:#222222;}.k{fill:#000000;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}.s{fill:#e4f4ff;stroke:#222222;}.syn{fill:#8D8D8D;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}</style></defs><path class=\"c\" d=\"M0 31h5m212 0h10m32 0h10m92 0h10m32 0h5\"/><rect class=\"s\" x=\"5\" y=\"5\" width=\"212\" height=\"36\"/><text class=\"k\" x=\"15\" y=\"31\">STDDEV_OVER_TIME</text><rect class=\"s\" x=\"227\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"237\" y=\"31\">(</text><rect class=\"s\" x=\"269\" y=\"5\" width=\"92\" height=\"36\" rx=\"7\"/><text class=\"k\" x=\"279\" y=\"31\">number</text><rect class=\"s\" x=\"371\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"381\" y=\"31\">)</text></svg>\n\\ No newline at end of file"
    },
    {
      "filename": "docs/reference/query-languages/esql/images/functions/variance.svg",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "patch": "@@ -0,0 +1 @@\n+<svg version=\"1.1\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"312\" height=\"46\" viewbox=\"0 0 312 46\"><defs><style type=\"text/css\">.c{fill:none;stroke:#222222;}.k{fill:#000000;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}.s{fill:#e4f4ff;stroke:#222222;}.syn{fill:#8D8D8D;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}</style></defs><path class=\"c\" d=\"M0 31h5m116 0h10m32 0h10m92 0h10m32 0h5\"/><rect class=\"s\" x=\"5\" y=\"5\" width=\"116\" height=\"36\"/><text class=\"k\" x=\"15\" y=\"31\">VARIANCE</text><rect class=\"s\" x=\"131\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"141\" y=\"31\">(</text><rect class=\"s\" x=\"173\" y=\"5\" width=\"92\" height=\"36\" rx=\"7\"/><text class=\"k\" x=\"183\" y=\"31\">number</text><rect class=\"s\" x=\"275\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"285\" y=\"31\">)</text></svg>\n\\ No newline at end of file"
    },
    {
      "filename": "docs/reference/query-languages/esql/images/functions/variance_over_time.svg",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "patch": "@@ -0,0 +1 @@\n+<svg version=\"1.1\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"432\" height=\"46\" viewbox=\"0 0 432 46\"><defs><style type=\"text/css\">.c{fill:none;stroke:#222222;}.k{fill:#000000;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}.s{fill:#e4f4ff;stroke:#222222;}.syn{fill:#8D8D8D;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}</style></defs><path class=\"c\" d=\"M0 31h5m236 0h10m32 0h10m92 0h10m32 0h5\"/><rect class=\"s\" x=\"5\" y=\"5\" width=\"236\" height=\"36\"/><text class=\"k\" x=\"15\" y=\"31\">VARIANCE_OVER_TIME</text><rect class=\"s\" x=\"251\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"261\" y=\"31\">(</text><rect class=\"s\" x=\"293\" y=\"5\" width=\"92\" height=\"36\" rx=\"7\"/><text class=\"k\" x=\"303\" y=\"31\">number</text><rect class=\"s\" x=\"395\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"405\" y=\"31\">)</text></svg>\n\\ No newline at end of file"
    },
    {
      "filename": "docs/reference/query-languages/esql/kibana/definition/functions/stddev_over_time.json",
      "status": "added",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "patch": "@@ -0,0 +1,49 @@\n+{\n+  \"comment\" : \"This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\",\n+  \"type\" : \"time_series_agg\",\n+  \"name\" : \"stddev_over_time\",\n+  \"description\" : \"Calculates the population standard deviation over time of a numeric field.\",\n+  \"signatures\" : [\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"double\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression that outputs values to calculate the standard deviation of.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"integer\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression that outputs values to calculate the standard deviation of.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"long\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression that outputs values to calculate the standard deviation of.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    }\n+  ],\n+  \"examples\" : [\n+    \"TS k8s\\n| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\"\n+  ],\n+  \"preview\" : true,\n+  \"snapshot_only\" : false\n+}"
    },
    {
      "filename": "docs/reference/query-languages/esql/kibana/definition/functions/variance.json",
      "status": "added",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "patch": "@@ -0,0 +1,49 @@\n+{\n+  \"comment\" : \"This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\",\n+  \"type\" : \"agg\",\n+  \"name\" : \"variance\",\n+  \"description\" : \"The population variance of a numeric field.\",\n+  \"signatures\" : [\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"double\",\n+          \"optional\" : false,\n+          \"description\" : \"\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"integer\",\n+          \"optional\" : false,\n+          \"description\" : \"\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"long\",\n+          \"optional\" : false,\n+          \"description\" : \"\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    }\n+  ],\n+  \"examples\" : [\n+    \"FROM employees\\n| STATS var_height = VARIANCE(height)\"\n+  ],\n+  \"preview\" : false,\n+  \"snapshot_only\" : false\n+}"
    },
    {
      "filename": "docs/reference/query-languages/esql/kibana/definition/functions/variance_over_time.json",
      "status": "added",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "patch": "@@ -0,0 +1,49 @@\n+{\n+  \"comment\" : \"This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\",\n+  \"type\" : \"time_series_agg\",\n+  \"name\" : \"variance_over_time\",\n+  \"description\" : \"Calculates the population variance over time of a numeric field.\",\n+  \"signatures\" : [\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"double\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression for which to calculate the variance over time.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"integer\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression for which to calculate the variance over time.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"long\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression for which to calculate the variance over time.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    }\n+  ],\n+  \"examples\" : [\n+    \"TS k8s\\n| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\"\n+  ],\n+  \"preview\" : true,\n+  \"snapshot_only\" : false\n+}"
    },
    {
      "filename": "docs/reference/query-languages/esql/kibana/docs/functions/stddev_over_time.md",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "patch": "@@ -0,0 +1,9 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+### STDDEV OVER TIME\n+Calculates the population standard deviation over time of a numeric field.\n+\n+```esql\n+TS k8s\n+| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```"
    },
    {
      "filename": "docs/reference/query-languages/esql/kibana/docs/functions/variance.md",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "patch": "@@ -0,0 +1,9 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+### VARIANCE\n+The population variance of a numeric field.\n+\n+```esql\n+FROM employees\n+| STATS var_height = VARIANCE(height)\n+```"
    },
    {
      "filename": "docs/reference/query-languages/esql/kibana/docs/functions/variance_over_time.md",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "patch": "@@ -0,0 +1,9 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+### VARIANCE OVER TIME\n+Calculates the population variance over time of a numeric field.\n+\n+```esql\n+TS k8s\n+| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevDoubleAggregator.java",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "patch": "@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevDoubleAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, double value) {\n+    public static void combine(VarianceStates.SingleState state, double value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, double value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, double value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevFloatAggregator.java",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "patch": "@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevFloatAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, float value) {\n+    public static void combine(VarianceStates.SingleState state, float value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, float value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, float value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevIntAggregator.java",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "patch": "@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevIntAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, int value) {\n+    public static void combine(VarianceStates.SingleState state, int value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, int value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, int value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevLongAggregator.java",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "patch": "@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevLongAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, long value) {\n+    public static void combine(VarianceStates.SingleState state, long value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, long value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, long value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -31,20 +31,23 @@ public final class StdDevDoubleAggregatorFunction implements AggregatorFunction\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevDoubleAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevDoubleAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevDoubleAggregatorFunction(driverContext, channels, StdDevDoubleAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevDoubleAggregatorFunction(driverContext, channels, StdDevDoubleAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunctionSupplier.java",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "patch": "@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevDoubleAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevDoubleAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevDoubleAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevDoubleAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevDoubleAggregatorFunction.create(driverContext, channels);\n+    return StdDevDoubleAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevDoubleGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevDoubleGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevDoubleGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleGroupingAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -31,22 +31,25 @@ public final class StdDevDoubleGroupingAggregatorFunction implements GroupingAgg\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevDoubleGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevDoubleGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevDoubleGroupingAggregatorFunction(channels, StdDevDoubleAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevDoubleGroupingAggregatorFunction(channels, StdDevDoubleAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -33,20 +33,23 @@ public final class StdDevFloatAggregatorFunction implements AggregatorFunction {\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevFloatAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevFloatAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevFloatAggregatorFunction(driverContext, channels, StdDevFloatAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevFloatAggregatorFunction(driverContext, channels, StdDevFloatAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunctionSupplier.java",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "patch": "@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevFloatAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevFloatAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevFloatAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevFloatAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevFloatAggregatorFunction.create(driverContext, channels);\n+    return StdDevFloatAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevFloatGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevFloatGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevFloatGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatGroupingAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -33,22 +33,25 @@ public final class StdDevFloatGroupingAggregatorFunction implements GroupingAggr\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevFloatGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevFloatGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevFloatGroupingAggregatorFunction(channels, StdDevFloatAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevFloatGroupingAggregatorFunction(channels, StdDevFloatAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -33,20 +33,23 @@ public final class StdDevIntAggregatorFunction implements AggregatorFunction {\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevIntAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevIntAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevIntAggregatorFunction(driverContext, channels, StdDevIntAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevIntAggregatorFunction(driverContext, channels, StdDevIntAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunctionSupplier.java",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "patch": "@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevIntAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevIntAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevIntAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevIntAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevIntAggregatorFunction.create(driverContext, channels);\n+    return StdDevIntAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevIntGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevIntGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevIntGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntGroupingAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -32,22 +32,25 @@ public final class StdDevIntGroupingAggregatorFunction implements GroupingAggreg\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevIntGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevIntGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevIntGroupingAggregatorFunction(channels, StdDevIntAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevIntGroupingAggregatorFunction(channels, StdDevIntAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -31,20 +31,23 @@ public final class StdDevLongAggregatorFunction implements AggregatorFunction {\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevLongAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevLongAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevLongAggregatorFunction(driverContext, channels, StdDevLongAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevLongAggregatorFunction(driverContext, channels, StdDevLongAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunctionSupplier.java",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "patch": "@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevLongAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevLongAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevLongAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevLongAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevLongAggregatorFunction.create(driverContext, channels);\n+    return StdDevLongAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevLongGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevLongGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevLongGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongGroupingAggregatorFunction.java",
      "status": "modified",
      "additions": 7,
      "deletions": 4,
      "changes": 11,
      "patch": "@@ -31,22 +31,25 @@ public final class StdDevLongGroupingAggregatorFunction implements GroupingAggre\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevLongGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevLongGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevLongGroupingAggregatorFunction(channels, StdDevLongAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevLongGroupingAggregatorFunction(channels, StdDevLongAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/VarianceStates.java",
      "status": "renamed",
      "additions": 12,
      "deletions": 8,
      "changes": 20,
      "patch": "@@ -16,20 +16,22 @@\n import org.elasticsearch.compute.operator.DriverContext;\n import org.elasticsearch.core.Releasables;\n \n-public final class StdDevStates {\n+public final class VarianceStates {\n \n-    private StdDevStates() {}\n+    private VarianceStates() {}\n \n     static final class SingleState implements AggregatorState {\n \n         private final WelfordAlgorithm welfordAlgorithm;\n+        private final boolean stdDev;\n \n-        SingleState() {\n-            this(0, 0, 0);\n+        SingleState(boolean stdDev) {\n+            this(0, 0, 0, stdDev);\n         }\n \n-        SingleState(double mean, double m2, long count) {\n+        SingleState(double mean, double m2, long count, boolean stdDev) {\n             this.welfordAlgorithm = new WelfordAlgorithm(mean, m2, count);\n+            this.stdDev = stdDev;\n         }\n \n         public void add(long value) {\n@@ -73,7 +75,7 @@ public long count() {\n         }\n \n         public double evaluateFinal() {\n-            return welfordAlgorithm.evaluate();\n+            return welfordAlgorithm.evaluate(stdDev);\n         }\n \n         public Block evaluateFinal(DriverContext driverContext) {\n@@ -90,10 +92,12 @@ static final class GroupingState implements GroupingAggregatorState {\n \n         private ObjectArray<WelfordAlgorithm> states;\n         private final BigArrays bigArrays;\n+        private final boolean stdDev;\n \n-        GroupingState(BigArrays bigArrays) {\n+        GroupingState(BigArrays bigArrays, boolean stdDev) {\n             this.states = bigArrays.newObjectArray(1);\n             this.bigArrays = bigArrays;\n+            this.stdDev = stdDev;\n         }\n \n         WelfordAlgorithm getOrNull(int position) {\n@@ -189,7 +193,7 @@ public Block evaluateFinal(IntVector selected, DriverContext driverContext) {\n                         if (count == 0 || Double.isFinite(m2) == false) {\n                             builder.appendNull();\n                         } else {\n-                            builder.appendDouble(st.evaluate());\n+                            builder.appendDouble(st.evaluate(stdDev));\n                         }\n                     } else {\n                         builder.appendNull();"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/WelfordAlgorithm.java",
      "status": "modified",
      "additions": 11,
      "deletions": 2,
      "changes": 13,
      "patch": "@@ -73,7 +73,16 @@ public void add(double meanValue, double m2Value, long countValue) {\n         count += countValue;\n     }\n \n-    public double evaluate() {\n-        return count < 2 ? 0 : Math.sqrt(m2 / count);\n+    /**\n+     * Evaluate the variance or standard deviation.\n+     * @param stdDev if true, compute standard deviation, otherwise variance\n+     * @return\n+     */\n+    public double evaluate(boolean stdDev) {\n+        if (stdDev == false) {\n+            return count < 2 ? 0 : m2 / count;\n+        } else {\n+            return count < 2 ? 0 : Math.sqrt(m2 / count);\n+        }\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/X-StdDevAggregator.java.st",
      "status": "modified",
      "additions": 10,
      "deletions": 10,
      "changes": 20,
      "patch": "@@ -28,35 +28,35 @@ import org.elasticsearch.compute.operator.DriverContext;\n @GroupingAggregator\n public class StdDev$Type$Aggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, $type$ value) {\n+    public static void combine(VarianceStates.SingleState state, $type$ value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, $type$ value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, $type$ value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }"
    },
    {
      "filename": "x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec",
      "status": "modified",
      "additions": 79,
      "deletions": 0,
      "changes": 79,
      "patch": "@@ -594,6 +594,84 @@ max_cost:integer | pod:keyword | time_bucket:datetime     | max_cluster_cost:int\n 973              | two         | 2024-05-10T00:00:00.000Z | 1209                     | staging\n ;\n \n+max_of_stddev_over_time\n+required_capability: ts_command_v0\n+required_capability: variance_stddev_over_time\n+// tag::stddev_over_time[]\n+TS k8s\n+| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+// end::stddev_over_time[]\n+| EVAL max_stddev_cost = ROUND(max_stddev_cost, 6)\n+| SORT max_stddev_cost DESC, time_bucket DESC, cluster | LIMIT 10;\n+\n+// tag::stddev_over_time-result[]\n+cluster:keyword | time_bucket:datetime     | max_stddev_cost:double\n+staging         | 2024-05-10T00:03:00.000Z | 5.4375\n+staging         | 2024-05-10T00:09:00.000Z | 5.1875\n+qa              | 2024-05-10T00:18:00.000Z | 4.097764\n+qa              | 2024-05-10T00:21:00.000Z | 4.0\n+staging         | 2024-05-10T00:20:00.000Z | 3.9375\n+// end::stddev_over_time-result[]\n+prod            | 2024-05-10T00:18:00.000Z | 3.93353\n+qa              | 2024-05-10T00:08:00.000Z | 3.89444\n+qa              | 2024-05-10T00:17:00.000Z | 3.882385\n+staging         | 2024-05-10T00:13:00.000Z | 3.835597\n+staging         | 2024-05-10T00:12:00.000Z | 3.8125\n+\n+;\n+\n+avg_variance_over_time\n+required_capability: ts_command_v0\n+required_capability: variance_stddev_over_time\n+// tag::variance_over_time[]\n+TS k8s\n+| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+// end::variance_over_time[]\n+| EVAL avg_var_cost = ROUND(avg_var_cost, 6)\n+| SORT avg_var_cost DESC, time_bucket DESC, cluster | LIMIT 10;\n+\n+// tag::variance_over_time-result[]\n+cluster:keyword | time_bucket:datetime     | avg_var_cost:double\n+staging         | 2024-05-10T00:03:00.000Z | 20.478516\n+qa              | 2024-05-10T00:21:00.000Z | 16.0\n+qa              | 2024-05-10T00:18:00.000Z | 11.192274\n+staging         | 2024-05-10T00:09:00.000Z | 10.446904\n+// end::variance_over_time-result[]\n+qa              | 2024-05-10T00:17:00.000Z | 10.398003\n+qa              | 2024-05-10T00:08:00.000Z | 10.114583\n+staging         | 2024-05-10T00:20:00.000Z | 7.910156\n+staging         | 2024-05-10T00:13:00.000Z | 7.355903\n+prod            | 2024-05-10T00:02:00.000Z | 6.570313\n+prod            | 2024-05-10T00:18:00.000Z | 5.157552\n+\n+;\n+\n+stddev_sq_and_var_over_time_are_consistent\n+required_capability: ts_command_v0\n+required_capability: variance_stddev_over_time\n+\n+TS k8s\n+| STATS sd=max(stddev_over_time(network.cost)), var=max(variance_over_time(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+| EVAL sd_squared = sd * sd\n+| EVAL sd_squared = ROUND(sd_squared, 6), var = ROUND(var, 6), sd = ROUND(sd, 6)\n+| KEEP sd, var, sd_squared, cluster, time_bucket\n+| SORT cluster, time_bucket\n+| LIMIT 10;\n+\n+sd:double | var:double | sd_squared:double | cluster:keyword | time_bucket:datetime\n+1.4375    | 2.066406   | 2.066406          | prod            | 2024-05-10T00:00:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:01:00.000Z\n+3.625     | 13.140625  | 13.140625         | prod            | 2024-05-10T00:02:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:03:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:04:00.000Z\n+2.75      | 7.5625     | 7.5625            | prod            | 2024-05-10T00:05:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:06:00.000Z\n+1.9375    | 3.753906   | 3.753906          | prod            | 2024-05-10T00:08:00.000Z\n+3.406999  | 11.607639  | 11.607639         | prod            | 2024-05-10T00:09:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:10:00.000Z\n+\n+;\n+\n Max of Rate with Bucket\n required_capability: ts_command_v0\n \n@@ -642,3 +720,4 @@ mx:integer | tbucket:datetime\n 1716       | 2024-05-10T00:00:00.000Z\n ;\n \n+"
    },
    {
      "filename": "x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec",
      "status": "modified",
      "additions": 56,
      "deletions": 2,
      "changes": 58,
      "patch": "@@ -2969,6 +2969,22 @@ std_dev_height:double\n // end::stdev-result[]\n ;\n \n+varianceSimple\n+required_capability: variance_stddev_over_time\n+\n+// tag::variance[]\n+FROM employees\n+| STATS var_height = VARIANCE(height)\n+// end::variance[]\n+| EVAL var_height = ROUND(var_height, 7)\n+;\n+\n+// tag::variance-result[]\n+var_height:double\n+0.0425888\n+// end::variance-result[]\n+;\n+\n stdDeviationNested\n required_capability: std_dev\n // tag::docsStatsStdDevNestedExpression[]\n@@ -2985,6 +3001,22 @@ stddev_salary_change:double\n ;\n \n \n+varianceNested\n+required_capability: variance_stddev_over_time\n+\n+# tag::variance[]\n+FROM employees\n+| STATS var_salary_change = VARIANCE(MV_MAX(salary_change))\n+# end::variance[]\n+| EVAL var_salary_change = ROUND(var_salary_change, 5)\n+;\n+\n+# tag::variance-result[]\n+var_salary_change:double\n+47.27703\n+# end::variance-result[]\n+;\n+\n stdDeviationWithLongs\n required_capability: std_dev\n FROM employees\n@@ -2996,6 +3028,17 @@ std_dev:double\n 5.7601043E7\n ;\n \n+varianceWithLongs\n+required_capability: variance_stddev_over_time\n+FROM employees\n+| STATS var = variance(avg_worked_seconds)\n+| EVAL var = ROUND(var, 7)\n+;\n+\n+var:double\n+3.317880108280233E15\n+;\n+\n stdDeviationWithInts\n required_capability: std_dev\n FROM employees\n@@ -3007,6 +3050,17 @@ std_dev:double\n 13765.1255\n ;\n \n+varianceWithInts\n+required_capability: variance_stddev_over_time\n+FROM employees\n+| STATS var = STD_VAR(salary)\n+| EVAL var = ROUND(var, 5)\n+;\n+\n+var:double\n+1.894786801075E8\n+;\n+\n stdDeviationConstantValue\n required_capability: std_dev\n FROM employees\n@@ -3059,10 +3113,10 @@ stdDeviationNoRows\n required_capability: std_dev\n FROM employees\n | WHERE languages IS null\n-| STATS STD_DEV(languages)\n+| STATS sd=STD_DEV(languages)\n ;\n \n-STD_DEV(languages):double\n+sd:double\n null\n ;\n "
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -1476,7 +1476,7 @@ public enum Cap {\n          * Percentile over time and other ts-aggregations\n          */\n         PERCENTILE_OVER_TIME,\n-\n+        VARIANCE_STDDEV_OVER_TIME,\n         /**\n          * INLINE STATS fix incorrect prunning of null filtering\n          * https://github.com/elastic/elasticsearch/pull/135011"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "patch": "@@ -49,10 +49,13 @@\n import org.elasticsearch.xpack.esql.expression.function.aggregate.SpatialCentroid;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.SpatialExtent;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.StdDev;\n+import org.elasticsearch.xpack.esql.expression.function.aggregate.StdDevOverTime;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.Sum;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.SumOverTime;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.Top;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.Values;\n+import org.elasticsearch.xpack.esql.expression.function.aggregate.Variance;\n+import org.elasticsearch.xpack.esql.expression.function.aggregate.VarianceOverTime;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.WeightedAvg;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Kql;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Match;\n@@ -357,6 +360,7 @@ private static FunctionDefinition[][] functions() {\n                 def(Percentile.class, bi(Percentile::new), \"percentile\"),\n                 def(Sample.class, bi(Sample::new), \"sample\"),\n                 def(StdDev.class, uni(StdDev::new), \"std_dev\"),\n+                def(Variance.class, uni(Variance::new), \"variance\", \"std_var\"),\n                 def(Sum.class, uni(Sum::new), \"sum\"),\n                 def(Top.class, tri(Top::new), \"top\"),\n                 def(Values.class, uni(Values::new), \"values\"),\n@@ -531,6 +535,8 @@ private static FunctionDefinition[][] functions() {\n                 def(MaxOverTime.class, uni(MaxOverTime::new), \"max_over_time\"),\n                 def(MinOverTime.class, uni(MinOverTime::new), \"min_over_time\"),\n                 def(SumOverTime.class, uni(SumOverTime::new), \"sum_over_time\"),\n+                def(StdDevOverTime.class, uni(StdDevOverTime::new), \"stddev_over_time\"),\n+                def(VarianceOverTime.class, uni(VarianceOverTime::new), \"variance_over_time\", \"stdvar_over_time\"),\n                 def(CountOverTime.class, uni(CountOverTime::new), \"count_over_time\"),\n                 def(CountDistinctOverTime.class, bi(CountDistinctOverTime::new), \"count_distinct_over_time\"),\n                 def(PresentOverTime.class, uni(PresentOverTime::new), \"present_over_time\"),"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/AggregateWritables.java",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "patch": "@@ -33,6 +33,7 @@ public static List<NamedWriteableRegistry.Entry> getNamedWriteables() {\n             SpatialCentroid.ENTRY,\n             SpatialExtent.ENTRY,\n             StdDev.ENTRY,\n+            Variance.ENTRY,\n             Sum.ENTRY,\n             Top.ENTRY,\n             Values.ENTRY,"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDev.java",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "patch": "@@ -100,13 +100,13 @@ public StdDev withFilter(Expression filter) {\n     public final AggregatorFunctionSupplier supplier() {\n         DataType type = field().dataType();\n         if (type == DataType.LONG) {\n-            return new StdDevLongAggregatorFunctionSupplier();\n+            return new StdDevLongAggregatorFunctionSupplier(true);\n         }\n         if (type == DataType.INTEGER) {\n-            return new StdDevIntAggregatorFunctionSupplier();\n+            return new StdDevIntAggregatorFunctionSupplier(true);\n         }\n         if (type == DataType.DOUBLE) {\n-            return new StdDevDoubleAggregatorFunctionSupplier();\n+            return new StdDevDoubleAggregatorFunctionSupplier(true);\n         }\n         throw EsqlIllegalArgumentException.illegalDataType(type);\n     }"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevOverTime.java",
      "status": "added",
      "additions": 87,
      "deletions": 0,
      "changes": 87,
      "patch": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.expression.Literal;\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.Example;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesTo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesToLifecycle;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionInfo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionType;\n+import org.elasticsearch.xpack.esql.expression.function.Param;\n+\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+\n+/**\n+ * Similar to {@link StdDev}, but it is used to calculate the standard deviation over a time series of values from the given field.\n+ */\n+public class StdDevOverTime extends TimeSeriesAggregateFunction {\n+    @FunctionInfo(\n+        returnType = \"double\",\n+        description = \"Calculates the population standard deviation over time of a numeric field.\",\n+        type = FunctionType.TIME_SERIES_AGGREGATE,\n+        appliesTo = { @FunctionAppliesTo(lifeCycle = FunctionAppliesToLifecycle.PREVIEW, version = \"9.3.0\") },\n+        preview = true,\n+        examples = { @Example(file = \"k8s-timeseries\", tag = \"stddev_over_time\") }\n+    )\n+    public StdDevOverTime(\n+        Source source,\n+        @Param(\n+            name = \"number\",\n+            type = { \"double\", \"integer\", \"long\" },\n+            description = \"Expression that outputs values to calculate the standard deviation of.\"\n+        ) Expression field\n+    ) {\n+        this(source, field, Literal.TRUE);\n+    }\n+\n+    public StdDevOverTime(Source source, Expression field, Expression filter) {\n+        super(source, field, filter, emptyList());\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        return perTimeSeriesAggregation().resolveType();\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        throw new UnsupportedOperationException(\"StdDevOverTime does not have a writeable name\");\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return perTimeSeriesAggregation().dataType();\n+    }\n+\n+    @Override\n+    protected NodeInfo<StdDevOverTime> info() {\n+        return NodeInfo.create(this, StdDevOverTime::new, field(), filter());\n+    }\n+\n+    @Override\n+    public StdDevOverTime replaceChildren(List<Expression> newChildren) {\n+        return new StdDevOverTime(source(), newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    @Override\n+    public StdDevOverTime withFilter(Expression filter) {\n+        return new StdDevOverTime(source(), field(), filter);\n+    }\n+\n+    @Override\n+    public AggregateFunction perTimeSeriesAggregation() {\n+        return new StdDev(source(), field(), filter());\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Variance.java",
      "status": "added",
      "additions": 105,
      "deletions": 0,
      "changes": 105,
      "patch": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.compute.aggregation.AggregatorFunctionSupplier;\n+import org.elasticsearch.compute.aggregation.StdDevDoubleAggregatorFunctionSupplier;\n+import org.elasticsearch.compute.aggregation.StdDevIntAggregatorFunctionSupplier;\n+import org.elasticsearch.compute.aggregation.StdDevLongAggregatorFunctionSupplier;\n+import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.expression.Literal;\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.Example;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionInfo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionType;\n+import org.elasticsearch.xpack.esql.expression.function.Param;\n+import org.elasticsearch.xpack.esql.planner.ToAggregator;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+import static org.elasticsearch.xpack.esql.core.expression.TypeResolutions.ParamOrdinal.DEFAULT;\n+import static org.elasticsearch.xpack.esql.core.expression.TypeResolutions.isType;\n+\n+public class Variance extends AggregateFunction implements ToAggregator {\n+    public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(Expression.class, \"Variance\", Variance::new);\n+\n+    @FunctionInfo(\n+        returnType = \"double\",\n+        description = \"The population variance of a numeric field.\",\n+        type = FunctionType.AGGREGATE,\n+        examples = { @Example(file = \"stats\", tag = \"variance\") }\n+    )\n+    public Variance(Source source, @Param(name = \"number\", type = { \"double\", \"integer\", \"long\" }) Expression field) {\n+        this(source, field, Literal.TRUE);\n+    }\n+\n+    public Variance(Source source, Expression field, Expression filter) {\n+        super(source, field, filter, emptyList());\n+    }\n+\n+    private Variance(StreamInput in) throws IOException {\n+        super(in);\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        return ENTRY.name;\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return DataType.DOUBLE;\n+    }\n+\n+    @Override\n+    protected Expression.TypeResolution resolveType() {\n+        return isType(\n+            field(),\n+            dt -> dt.isNumeric() && dt != DataType.UNSIGNED_LONG,\n+            sourceText(),\n+            DEFAULT,\n+            \"numeric except unsigned_long or counter types\"\n+        );\n+    }\n+\n+    @Override\n+    protected NodeInfo<Variance> info() {\n+        return NodeInfo.create(this, Variance::new, field(), filter());\n+    }\n+\n+    @Override\n+    public Variance replaceChildren(List<Expression> newChildren) {\n+        return new Variance(source(), newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    public Variance withFilter(Expression filter) {\n+        return new Variance(source(), field(), filter);\n+    }\n+\n+    @Override\n+    public final AggregatorFunctionSupplier supplier() {\n+        DataType type = field().dataType();\n+        if (type == DataType.LONG) {\n+            return new StdDevLongAggregatorFunctionSupplier(false);\n+        }\n+        if (type == DataType.INTEGER) {\n+            return new StdDevIntAggregatorFunctionSupplier(false);\n+        }\n+        if (type == DataType.DOUBLE) {\n+            return new StdDevDoubleAggregatorFunctionSupplier(false);\n+        }\n+        throw EsqlIllegalArgumentException.illegalDataType(type);\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTime.java",
      "status": "added",
      "additions": 87,
      "deletions": 0,
      "changes": 87,
      "patch": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.expression.Literal;\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.Example;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesTo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesToLifecycle;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionInfo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionType;\n+import org.elasticsearch.xpack.esql.expression.function.Param;\n+\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+\n+/**\n+ * Similar to {@link Variance}, but it is used to calculate the variance over a time series of values from the given field.\n+ */\n+public class VarianceOverTime extends TimeSeriesAggregateFunction {\n+    @FunctionInfo(\n+        returnType = \"double\",\n+        description = \"Calculates the population variance over time of a numeric field.\",\n+        type = FunctionType.TIME_SERIES_AGGREGATE,\n+        appliesTo = { @FunctionAppliesTo(lifeCycle = FunctionAppliesToLifecycle.PREVIEW, version = \"9.3.0\") },\n+        preview = true,\n+        examples = { @Example(file = \"k8s-timeseries\", tag = \"variance_over_time\") }\n+    )\n+    public VarianceOverTime(\n+        Source source,\n+        @Param(\n+            name = \"number\",\n+            type = { \"double\", \"integer\", \"long\" },\n+            description = \"Expression for which to calculate the variance over time.\"\n+        ) Expression field\n+    ) {\n+        this(source, field, Literal.TRUE);\n+    }\n+\n+    public VarianceOverTime(Source source, Expression field, Expression filter) {\n+        super(source, field, filter, emptyList());\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        return perTimeSeriesAggregation().resolveType();\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        throw new UnsupportedOperationException(\"VarianceOverTime does not have a writeable name\");\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return perTimeSeriesAggregation().dataType();\n+    }\n+\n+    @Override\n+    protected NodeInfo<VarianceOverTime> info() {\n+        return NodeInfo.create(this, VarianceOverTime::new, field(), filter());\n+    }\n+\n+    @Override\n+    public VarianceOverTime replaceChildren(List<Expression> newChildren) {\n+        return new VarianceOverTime(source(), newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    @Override\n+    public VarianceOverTime withFilter(Expression filter) {\n+        return new VarianceOverTime(source(), field(), filter);\n+    }\n+\n+    @Override\n+    public AggregateFunction perTimeSeriesAggregation() {\n+        return new Variance(source(), field(), filter());\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevTests.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -60,7 +60,7 @@ private static TestCaseSupplier makeSupplier(TestCaseSupplier.TypedDataSupplier\n                 var value = ((Number) fieldValue).doubleValue();\n                 welfordAlgorithm.add(value);\n             }\n-            var result = welfordAlgorithm.evaluate();\n+            var result = welfordAlgorithm.evaluate(true);\n             var expected = Double.isFinite(result) ? result : null;\n             return new TestCaseSupplier.TestCase(\n                 List.of(fieldTypedData),"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StddevOverTimeTests.java",
      "status": "added",
      "additions": 39,
      "deletions": 0,
      "changes": 39,
      "patch": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.expression.function.AbstractFunctionTestCase;\n+import org.elasticsearch.xpack.esql.expression.function.TestCaseSupplier;\n+\n+import java.util.List;\n+import java.util.function.Supplier;\n+\n+public class StddevOverTimeTests extends AbstractFunctionTestCase {\n+    public StddevOverTimeTests(Supplier<TestCaseSupplier.TestCase> testCaseSupplier) {\n+        testCase = testCaseSupplier.get();\n+    }\n+\n+    @Override\n+    protected boolean canSerialize() {\n+        return false;\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() {\n+        return StdDevTests.parameters();\n+    }\n+\n+    @Override\n+    protected Expression build(Source source, List<Expression> args) {\n+        return new StdDevOverTime(source, args.get(0));\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTimeTests.java",
      "status": "added",
      "additions": 39,
      "deletions": 0,
      "changes": 39,
      "patch": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.expression.function.AbstractFunctionTestCase;\n+import org.elasticsearch.xpack.esql.expression.function.TestCaseSupplier;\n+\n+import java.util.List;\n+import java.util.function.Supplier;\n+\n+public class VarianceOverTimeTests extends AbstractFunctionTestCase {\n+    public VarianceOverTimeTests(Supplier<TestCaseSupplier.TestCase> testCaseSupplier) {\n+        testCase = testCaseSupplier.get();\n+    }\n+\n+    @Override\n+    protected boolean canSerialize() {\n+        return false;\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() {\n+        return VarianceTests.parameters();\n+    }\n+\n+    @Override\n+    protected Expression build(Source source, List<Expression> args) {\n+        return new VarianceOverTime(source, args.get(0));\n+    }\n+}"
    },
    {
      "filename": "x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceTests.java",
      "status": "added",
      "additions": 74,
      "deletions": 0,
      "changes": 74,
      "patch": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import com.carrotsearch.randomizedtesting.annotations.Name;\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.compute.aggregation.WelfordAlgorithm;\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.AbstractAggregationTestCase;\n+import org.elasticsearch.xpack.esql.expression.function.MultiRowTestCaseSupplier;\n+import org.elasticsearch.xpack.esql.expression.function.TestCaseSupplier;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class VarianceTests extends AbstractAggregationTestCase {\n+    public VarianceTests(@Name(\"TestCase\") Supplier<TestCaseSupplier.TestCase> testCaseSupplier) {\n+        this.testCase = testCaseSupplier.get();\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() {\n+        var suppliers = new ArrayList<TestCaseSupplier>();\n+\n+        Stream.of(\n+            MultiRowTestCaseSupplier.intCases(1, 1000, Integer.MIN_VALUE, Integer.MAX_VALUE, true),\n+            MultiRowTestCaseSupplier.longCases(1, 1000, Long.MIN_VALUE, Long.MAX_VALUE, true),\n+            MultiRowTestCaseSupplier.doubleCases(1, 1000, -Double.MAX_VALUE, Double.MAX_VALUE, true)\n+        ).flatMap(List::stream).map(VarianceTests::makeSupplier).collect(Collectors.toCollection(() -> suppliers));\n+\n+        return parameterSuppliersFromTypedDataWithDefaultChecks(suppliers, true);\n+    }\n+\n+    @Override\n+    protected Expression build(Source source, List<Expression> args) {\n+        return new Variance(source, args.get(0));\n+    }\n+\n+    private static TestCaseSupplier makeSupplier(TestCaseSupplier.TypedDataSupplier fieldSupplier) {\n+        return new TestCaseSupplier(List.of(fieldSupplier.type()), () -> {\n+            var fieldTypedData = fieldSupplier.get();\n+            var fieldValues = fieldTypedData.multiRowData();\n+\n+            WelfordAlgorithm welfordAlgorithm = new WelfordAlgorithm();\n+\n+            for (var fieldValue : fieldValues) {\n+                var value = ((Number) fieldValue).doubleValue();\n+                welfordAlgorithm.add(value);\n+            }\n+            var result = welfordAlgorithm.evaluate(false);\n+            var expected = Double.isFinite(result) ? result : null;\n+            return new TestCaseSupplier.TestCase(\n+                List.of(fieldTypedData),\n+                // Note that this stddev because it's the operator that implements both of these\n+                standardAggregatorName(\"StdDev\", fieldSupplier.type()),\n+                DataType.DOUBLE,\n+                equalTo(expected)\n+            );\n+        });\n+    }\n+}"
    }
  ],
  "diff": "diff --git a/docs/reference/query-languages/esql/_snippets/functions/description/stddev_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/description/stddev_over_time.md\nnew file mode 100644\nindex 0000000000000..42db5b4412aa9\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/description/stddev_over_time.md\n@@ -0,0 +1,6 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Description**\n+\n+Calculates the population standard deviation over time of a numeric field.\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/description/variance.md b/docs/reference/query-languages/esql/_snippets/functions/description/variance.md\nnew file mode 100644\nindex 0000000000000..d9b489b9037bd\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/description/variance.md\n@@ -0,0 +1,6 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Description**\n+\n+The population variance of a numeric field.\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/description/variance_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/description/variance_over_time.md\nnew file mode 100644\nindex 0000000000000..16ec531dba29f\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/description/variance_over_time.md\n@@ -0,0 +1,6 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Description**\n+\n+Calculates the population variance over time of a numeric field.\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/examples/stddev_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/examples/stddev_over_time.md\nnew file mode 100644\nindex 0000000000000..022d6dfa95f42\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/examples/stddev_over_time.md\n@@ -0,0 +1,18 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Example**\n+\n+```esql\n+TS k8s\n+| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```\n+\n+| cluster:keyword | time_bucket:datetime | max_stddev_cost:double |\n+| --- | --- | --- |\n+| staging | 2024-05-10T00:03:00.000Z | 5.4375 |\n+| staging | 2024-05-10T00:09:00.000Z | 5.1875 |\n+| qa | 2024-05-10T00:18:00.000Z | 4.097764 |\n+| qa | 2024-05-10T00:21:00.000Z | 4.0 |\n+| staging | 2024-05-10T00:20:00.000Z | 3.9375 |\n+\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/examples/variance.md b/docs/reference/query-languages/esql/_snippets/functions/examples/variance.md\nnew file mode 100644\nindex 0000000000000..7033087c9e76c\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/examples/variance.md\n@@ -0,0 +1,14 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Example**\n+\n+```esql\n+FROM employees\n+| STATS var_height = VARIANCE(height)\n+```\n+\n+| var_height:double |\n+| --- |\n+| 0.0425888 |\n+\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/examples/variance_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/examples/variance_over_time.md\nnew file mode 100644\nindex 0000000000000..1aa98d1f64e28\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/examples/variance_over_time.md\n@@ -0,0 +1,17 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Example**\n+\n+```esql\n+TS k8s\n+| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```\n+\n+| cluster:keyword | time_bucket:datetime | avg_var_cost:double |\n+| --- | --- | --- |\n+| staging | 2024-05-10T00:03:00.000Z | 20.478516 |\n+| qa | 2024-05-10T00:21:00.000Z | 16.0 |\n+| qa | 2024-05-10T00:18:00.000Z | 11.192274 |\n+| staging | 2024-05-10T00:09:00.000Z | 10.446904 |\n+\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/layout/stddev_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/layout/stddev_over_time.md\nnew file mode 100644\nindex 0000000000000..e991631595071\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/layout/stddev_over_time.md\n@@ -0,0 +1,27 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+## `STDDEV_OVER_TIME` [esql-stddev_over_time]\n+```{applies_to}\n+stack: preview 9.3.0\n+serverless: preview\n+```\n+\n+**Syntax**\n+\n+:::{image} ../../../images/functions/stddev_over_time.svg\n+:alt: Embedded\n+:class: text-center\n+:::\n+\n+\n+:::{include} ../parameters/stddev_over_time.md\n+:::\n+\n+:::{include} ../description/stddev_over_time.md\n+:::\n+\n+:::{include} ../types/stddev_over_time.md\n+:::\n+\n+:::{include} ../examples/stddev_over_time.md\n+:::\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/layout/variance.md b/docs/reference/query-languages/esql/_snippets/functions/layout/variance.md\nnew file mode 100644\nindex 0000000000000..4db08b9e8caae\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/layout/variance.md\n@@ -0,0 +1,23 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+## `VARIANCE` [esql-variance]\n+\n+**Syntax**\n+\n+:::{image} ../../../images/functions/variance.svg\n+:alt: Embedded\n+:class: text-center\n+:::\n+\n+\n+:::{include} ../parameters/variance.md\n+:::\n+\n+:::{include} ../description/variance.md\n+:::\n+\n+:::{include} ../types/variance.md\n+:::\n+\n+:::{include} ../examples/variance.md\n+:::\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/layout/variance_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/layout/variance_over_time.md\nnew file mode 100644\nindex 0000000000000..208fd055ba76f\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/layout/variance_over_time.md\n@@ -0,0 +1,27 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+## `VARIANCE_OVER_TIME` [esql-variance_over_time]\n+```{applies_to}\n+stack: preview 9.3.0\n+serverless: preview\n+```\n+\n+**Syntax**\n+\n+:::{image} ../../../images/functions/variance_over_time.svg\n+:alt: Embedded\n+:class: text-center\n+:::\n+\n+\n+:::{include} ../parameters/variance_over_time.md\n+:::\n+\n+:::{include} ../description/variance_over_time.md\n+:::\n+\n+:::{include} ../types/variance_over_time.md\n+:::\n+\n+:::{include} ../examples/variance_over_time.md\n+:::\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/parameters/stddev_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/parameters/stddev_over_time.md\nnew file mode 100644\nindex 0000000000000..0ac6e4bf13042\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/parameters/stddev_over_time.md\n@@ -0,0 +1,7 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Parameters**\n+\n+`number`\n+:   Expression that outputs values to calculate the standard deviation of.\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/parameters/variance.md b/docs/reference/query-languages/esql/_snippets/functions/parameters/variance.md\nnew file mode 100644\nindex 0000000000000..e003b3562deeb\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/parameters/variance.md\n@@ -0,0 +1,7 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Parameters**\n+\n+`number`\n+:   \n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/parameters/variance_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/parameters/variance_over_time.md\nnew file mode 100644\nindex 0000000000000..209e56fbc04a9\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/parameters/variance_over_time.md\n@@ -0,0 +1,7 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Parameters**\n+\n+`number`\n+:   Expression for which to calculate the variance over time.\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/types/stddev_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/types/stddev_over_time.md\nnew file mode 100644\nindex 0000000000000..e204309f17bb1\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/types/stddev_over_time.md\n@@ -0,0 +1,10 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Supported types**\n+\n+| number | result |\n+| --- | --- |\n+| double | double |\n+| integer | double |\n+| long | double |\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/types/variance.md b/docs/reference/query-languages/esql/_snippets/functions/types/variance.md\nnew file mode 100644\nindex 0000000000000..e204309f17bb1\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/types/variance.md\n@@ -0,0 +1,10 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Supported types**\n+\n+| number | result |\n+| --- | --- |\n+| double | double |\n+| integer | double |\n+| long | double |\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/functions/types/variance_over_time.md b/docs/reference/query-languages/esql/_snippets/functions/types/variance_over_time.md\nnew file mode 100644\nindex 0000000000000..e204309f17bb1\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/_snippets/functions/types/variance_over_time.md\n@@ -0,0 +1,10 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+**Supported types**\n+\n+| number | result |\n+| --- | --- |\n+| double | double |\n+| integer | double |\n+| long | double |\n+\ndiff --git a/docs/reference/query-languages/esql/_snippets/lists/aggregation-functions.md b/docs/reference/query-languages/esql/_snippets/lists/aggregation-functions.md\nindex 7e4d241b959d6..11dfbcd102601 100644\n--- a/docs/reference/query-languages/esql/_snippets/lists/aggregation-functions.md\n+++ b/docs/reference/query-languages/esql/_snippets/lists/aggregation-functions.md\n@@ -17,4 +17,5 @@\n * [`SUM`](../../functions-operators/aggregation-functions.md#esql-sum)\n * [`TOP`](../../functions-operators/aggregation-functions.md#esql-top)\n * [`VALUES`](../../functions-operators/aggregation-functions.md#esql-values) {applies_to}`stack: preview` {applies_to}`serverless: preview`\n+* [`VARIANCE`](../../functions-operators/aggregation-functions.md#esql-variance)\n * [`WEIGHTED_AVG`](../../functions-operators/aggregation-functions.md#esql-weighted_avg)\ndiff --git a/docs/reference/query-languages/esql/_snippets/lists/time-series-aggregation-functions.md b/docs/reference/query-languages/esql/_snippets/lists/time-series-aggregation-functions.md\nindex 0a1e31ed3b4a5..67d40be53178c 100644\n--- a/docs/reference/query-languages/esql/_snippets/lists/time-series-aggregation-functions.md\n+++ b/docs/reference/query-languages/esql/_snippets/lists/time-series-aggregation-functions.md\n@@ -12,4 +12,6 @@\n * [`MIN_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-min_over_time) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\n * [`PRESENT_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-present_over_time) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\n * [`RATE`](../../functions-operators/time-series-aggregation-functions.md#esql-rate) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\n+* [`STDDEV_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-stddev_over_time) {applies_to}`stack: preview 9.3` {applies_to}`serverless: preview`\n+* [`VARIANCE_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-variance_over_time) {applies_to}`stack: preview 9.3` {applies_to}`serverless: preview`\n * [`SUM_OVER_TIME`](../../functions-operators/time-series-aggregation-functions.md#esql-sum_over_time) {applies_to}`stack: preview 9.2` {applies_to}`serverless: preview`\ndiff --git a/docs/reference/query-languages/esql/functions-operators/aggregation-functions.md b/docs/reference/query-languages/esql/functions-operators/aggregation-functions.md\nindex 981508765a17f..602a65cd5e282 100644\n--- a/docs/reference/query-languages/esql/functions-operators/aggregation-functions.md\n+++ b/docs/reference/query-languages/esql/functions-operators/aggregation-functions.md\n@@ -73,5 +73,8 @@ The [`STATS`](/reference/query-languages/esql/commands/stats-by.md) and [`INLINE\n :::{include} ../_snippets/functions/layout/values.md\n :::\n \n+:::{include} ../_snippets/functions/layout/variance.md\n+:::\n+\n :::{include} ../_snippets/functions/layout/weighted_avg.md\n :::\ndiff --git a/docs/reference/query-languages/esql/functions-operators/time-series-aggregation-functions.md b/docs/reference/query-languages/esql/functions-operators/time-series-aggregation-functions.md\nindex 25ad2a62f21a6..141ec5706de3f 100644\n--- a/docs/reference/query-languages/esql/functions-operators/time-series-aggregation-functions.md\n+++ b/docs/reference/query-languages/esql/functions-operators/time-series-aggregation-functions.md\n@@ -55,5 +55,11 @@ supports the following time series aggregation functions:\n :::{include} ../_snippets/functions/layout/rate.md\n :::\n \n+:::{include} ../_snippets/functions/layout/stddev_over_time.md\n+:::\n+\n+:::{include} ../_snippets/functions/layout/variance_over_time.md\n+:::\n+\n :::{include} ../_snippets/functions/layout/sum_over_time.md\n :::\ndiff --git a/docs/reference/query-languages/esql/images/functions/stddev_over_time.svg b/docs/reference/query-languages/esql/images/functions/stddev_over_time.svg\nnew file mode 100644\nindex 0000000000000..c314d6a193df8\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/images/functions/stddev_over_time.svg\n@@ -0,0 +1 @@\n+<svg version=\"1.1\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"408\" height=\"46\" viewbox=\"0 0 408 46\"><defs><style type=\"text/css\">.c{fill:none;stroke:#222222;}.k{fill:#000000;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}.s{fill:#e4f4ff;stroke:#222222;}.syn{fill:#8D8D8D;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}</style></defs><path class=\"c\" d=\"M0 31h5m212 0h10m32 0h10m92 0h10m32 0h5\"/><rect class=\"s\" x=\"5\" y=\"5\" width=\"212\" height=\"36\"/><text class=\"k\" x=\"15\" y=\"31\">STDDEV_OVER_TIME</text><rect class=\"s\" x=\"227\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"237\" y=\"31\">(</text><rect class=\"s\" x=\"269\" y=\"5\" width=\"92\" height=\"36\" rx=\"7\"/><text class=\"k\" x=\"279\" y=\"31\">number</text><rect class=\"s\" x=\"371\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"381\" y=\"31\">)</text></svg>\n\\ No newline at end of file\ndiff --git a/docs/reference/query-languages/esql/images/functions/variance.svg b/docs/reference/query-languages/esql/images/functions/variance.svg\nnew file mode 100644\nindex 0000000000000..08eb2333082fc\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/images/functions/variance.svg\n@@ -0,0 +1 @@\n+<svg version=\"1.1\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"312\" height=\"46\" viewbox=\"0 0 312 46\"><defs><style type=\"text/css\">.c{fill:none;stroke:#222222;}.k{fill:#000000;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}.s{fill:#e4f4ff;stroke:#222222;}.syn{fill:#8D8D8D;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}</style></defs><path class=\"c\" d=\"M0 31h5m116 0h10m32 0h10m92 0h10m32 0h5\"/><rect class=\"s\" x=\"5\" y=\"5\" width=\"116\" height=\"36\"/><text class=\"k\" x=\"15\" y=\"31\">VARIANCE</text><rect class=\"s\" x=\"131\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"141\" y=\"31\">(</text><rect class=\"s\" x=\"173\" y=\"5\" width=\"92\" height=\"36\" rx=\"7\"/><text class=\"k\" x=\"183\" y=\"31\">number</text><rect class=\"s\" x=\"275\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"285\" y=\"31\">)</text></svg>\n\\ No newline at end of file\ndiff --git a/docs/reference/query-languages/esql/images/functions/variance_over_time.svg b/docs/reference/query-languages/esql/images/functions/variance_over_time.svg\nnew file mode 100644\nindex 0000000000000..ebef8c3c83310\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/images/functions/variance_over_time.svg\n@@ -0,0 +1 @@\n+<svg version=\"1.1\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" width=\"432\" height=\"46\" viewbox=\"0 0 432 46\"><defs><style type=\"text/css\">.c{fill:none;stroke:#222222;}.k{fill:#000000;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}.s{fill:#e4f4ff;stroke:#222222;}.syn{fill:#8D8D8D;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;font-size:20px;}</style></defs><path class=\"c\" d=\"M0 31h5m236 0h10m32 0h10m92 0h10m32 0h5\"/><rect class=\"s\" x=\"5\" y=\"5\" width=\"236\" height=\"36\"/><text class=\"k\" x=\"15\" y=\"31\">VARIANCE_OVER_TIME</text><rect class=\"s\" x=\"251\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"261\" y=\"31\">(</text><rect class=\"s\" x=\"293\" y=\"5\" width=\"92\" height=\"36\" rx=\"7\"/><text class=\"k\" x=\"303\" y=\"31\">number</text><rect class=\"s\" x=\"395\" y=\"5\" width=\"32\" height=\"36\" rx=\"7\"/><text class=\"syn\" x=\"405\" y=\"31\">)</text></svg>\n\\ No newline at end of file\ndiff --git a/docs/reference/query-languages/esql/kibana/definition/functions/stddev_over_time.json b/docs/reference/query-languages/esql/kibana/definition/functions/stddev_over_time.json\nnew file mode 100644\nindex 0000000000000..2a83817caf616\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/kibana/definition/functions/stddev_over_time.json\n@@ -0,0 +1,49 @@\n+{\n+  \"comment\" : \"This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\",\n+  \"type\" : \"time_series_agg\",\n+  \"name\" : \"stddev_over_time\",\n+  \"description\" : \"Calculates the population standard deviation over time of a numeric field.\",\n+  \"signatures\" : [\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"double\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression that outputs values to calculate the standard deviation of.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"integer\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression that outputs values to calculate the standard deviation of.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"long\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression that outputs values to calculate the standard deviation of.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    }\n+  ],\n+  \"examples\" : [\n+    \"TS k8s\\n| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\"\n+  ],\n+  \"preview\" : true,\n+  \"snapshot_only\" : false\n+}\ndiff --git a/docs/reference/query-languages/esql/kibana/definition/functions/variance.json b/docs/reference/query-languages/esql/kibana/definition/functions/variance.json\nnew file mode 100644\nindex 0000000000000..22e258ecff2dd\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/kibana/definition/functions/variance.json\n@@ -0,0 +1,49 @@\n+{\n+  \"comment\" : \"This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\",\n+  \"type\" : \"agg\",\n+  \"name\" : \"variance\",\n+  \"description\" : \"The population variance of a numeric field.\",\n+  \"signatures\" : [\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"double\",\n+          \"optional\" : false,\n+          \"description\" : \"\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"integer\",\n+          \"optional\" : false,\n+          \"description\" : \"\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"long\",\n+          \"optional\" : false,\n+          \"description\" : \"\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    }\n+  ],\n+  \"examples\" : [\n+    \"FROM employees\\n| STATS var_height = VARIANCE(height)\"\n+  ],\n+  \"preview\" : false,\n+  \"snapshot_only\" : false\n+}\ndiff --git a/docs/reference/query-languages/esql/kibana/definition/functions/variance_over_time.json b/docs/reference/query-languages/esql/kibana/definition/functions/variance_over_time.json\nnew file mode 100644\nindex 0000000000000..588cb14d35334\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/kibana/definition/functions/variance_over_time.json\n@@ -0,0 +1,49 @@\n+{\n+  \"comment\" : \"This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\",\n+  \"type\" : \"time_series_agg\",\n+  \"name\" : \"variance_over_time\",\n+  \"description\" : \"Calculates the population variance over time of a numeric field.\",\n+  \"signatures\" : [\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"double\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression for which to calculate the variance over time.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"integer\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression for which to calculate the variance over time.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    },\n+    {\n+      \"params\" : [\n+        {\n+          \"name\" : \"number\",\n+          \"type\" : \"long\",\n+          \"optional\" : false,\n+          \"description\" : \"Expression for which to calculate the variance over time.\"\n+        }\n+      ],\n+      \"variadic\" : false,\n+      \"returnType\" : \"double\"\n+    }\n+  ],\n+  \"examples\" : [\n+    \"TS k8s\\n| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\"\n+  ],\n+  \"preview\" : true,\n+  \"snapshot_only\" : false\n+}\ndiff --git a/docs/reference/query-languages/esql/kibana/docs/functions/stddev_over_time.md b/docs/reference/query-languages/esql/kibana/docs/functions/stddev_over_time.md\nnew file mode 100644\nindex 0000000000000..decd95b2fefdc\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/kibana/docs/functions/stddev_over_time.md\n@@ -0,0 +1,9 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+### STDDEV OVER TIME\n+Calculates the population standard deviation over time of a numeric field.\n+\n+```esql\n+TS k8s\n+| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```\ndiff --git a/docs/reference/query-languages/esql/kibana/docs/functions/variance.md b/docs/reference/query-languages/esql/kibana/docs/functions/variance.md\nnew file mode 100644\nindex 0000000000000..07dd12c377aec\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/kibana/docs/functions/variance.md\n@@ -0,0 +1,9 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+### VARIANCE\n+The population variance of a numeric field.\n+\n+```esql\n+FROM employees\n+| STATS var_height = VARIANCE(height)\n+```\ndiff --git a/docs/reference/query-languages/esql/kibana/docs/functions/variance_over_time.md b/docs/reference/query-languages/esql/kibana/docs/functions/variance_over_time.md\nnew file mode 100644\nindex 0000000000000..bfe5b3ef6a42b\n--- /dev/null\n+++ b/docs/reference/query-languages/esql/kibana/docs/functions/variance_over_time.md\n@@ -0,0 +1,9 @@\n+% This is generated by ESQL's AbstractFunctionTestCase. Do not edit it. See ../README.md for how to regenerate it.\n+\n+### VARIANCE OVER TIME\n+Calculates the population variance over time of a numeric field.\n+\n+```esql\n+TS k8s\n+| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+```\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevDoubleAggregator.java b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevDoubleAggregator.java\nindex 8cf0809164aa1..cb2bc98c79e65 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevDoubleAggregator.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevDoubleAggregator.java\n@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevDoubleAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, double value) {\n+    public static void combine(VarianceStates.SingleState state, double value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, double value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, double value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevFloatAggregator.java b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevFloatAggregator.java\nindex 7fd851a16ab8f..2179e2053513e 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevFloatAggregator.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevFloatAggregator.java\n@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevFloatAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, float value) {\n+    public static void combine(VarianceStates.SingleState state, float value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, float value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, float value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevIntAggregator.java b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevIntAggregator.java\nindex 30adf0e28b1b4..851b611ed7f29 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevIntAggregator.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevIntAggregator.java\n@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevIntAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, int value) {\n+    public static void combine(VarianceStates.SingleState state, int value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, int value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, int value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevLongAggregator.java b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevLongAggregator.java\nindex 4f6b5008d79eb..1c1d90e187000 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevLongAggregator.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated-src/org/elasticsearch/compute/aggregation/StdDevLongAggregator.java\n@@ -28,35 +28,35 @@\n @GroupingAggregator\n public class StdDevLongAggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, long value) {\n+    public static void combine(VarianceStates.SingleState state, long value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, long value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, long value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunction.java\nindex 208a293f7aeb8..727b0a6226f31 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunction.java\n@@ -31,20 +31,23 @@ public final class StdDevDoubleAggregatorFunction implements AggregatorFunction\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevDoubleAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevDoubleAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevDoubleAggregatorFunction(driverContext, channels, StdDevDoubleAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevDoubleAggregatorFunction(driverContext, channels, StdDevDoubleAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunctionSupplier.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunctionSupplier.java\nindex 5310a11c1fddb..ada74a2a5fc1e 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunctionSupplier.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleAggregatorFunctionSupplier.java\n@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevDoubleAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevDoubleAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevDoubleAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevDoubleAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevDoubleAggregatorFunction.create(driverContext, channels);\n+    return StdDevDoubleAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevDoubleGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevDoubleGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevDoubleGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleGroupingAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleGroupingAggregatorFunction.java\nindex b4337f1030adb..1738282c7ee0b 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleGroupingAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevDoubleGroupingAggregatorFunction.java\n@@ -31,22 +31,25 @@ public final class StdDevDoubleGroupingAggregatorFunction implements GroupingAgg\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevDoubleGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevDoubleGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevDoubleGroupingAggregatorFunction(channels, StdDevDoubleAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevDoubleGroupingAggregatorFunction(channels, StdDevDoubleAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunction.java\nindex c82d0a3ab01d3..0dc56fc22040c 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunction.java\n@@ -33,20 +33,23 @@ public final class StdDevFloatAggregatorFunction implements AggregatorFunction {\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevFloatAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevFloatAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevFloatAggregatorFunction(driverContext, channels, StdDevFloatAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevFloatAggregatorFunction(driverContext, channels, StdDevFloatAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunctionSupplier.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunctionSupplier.java\nindex 52ffb0f5d580d..a233f89757350 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunctionSupplier.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatAggregatorFunctionSupplier.java\n@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevFloatAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevFloatAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevFloatAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevFloatAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevFloatAggregatorFunction.create(driverContext, channels);\n+    return StdDevFloatAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevFloatGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevFloatGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevFloatGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatGroupingAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatGroupingAggregatorFunction.java\nindex 7e513e1f9dc35..5ee9758c98d45 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatGroupingAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevFloatGroupingAggregatorFunction.java\n@@ -33,22 +33,25 @@ public final class StdDevFloatGroupingAggregatorFunction implements GroupingAggr\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevFloatGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevFloatGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevFloatGroupingAggregatorFunction(channels, StdDevFloatAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevFloatGroupingAggregatorFunction(channels, StdDevFloatAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunction.java\nindex 6b9f7f4e561ac..0a59974587b59 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunction.java\n@@ -33,20 +33,23 @@ public final class StdDevIntAggregatorFunction implements AggregatorFunction {\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevIntAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevIntAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevIntAggregatorFunction(driverContext, channels, StdDevIntAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevIntAggregatorFunction(driverContext, channels, StdDevIntAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunctionSupplier.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunctionSupplier.java\nindex 2f43a867bf83e..9475818c918d7 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunctionSupplier.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntAggregatorFunctionSupplier.java\n@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevIntAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevIntAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevIntAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevIntAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevIntAggregatorFunction.create(driverContext, channels);\n+    return StdDevIntAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevIntGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevIntGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevIntGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntGroupingAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntGroupingAggregatorFunction.java\nindex 1145ccfd4bce3..2c0c427b9266e 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntGroupingAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevIntGroupingAggregatorFunction.java\n@@ -32,22 +32,25 @@ public final class StdDevIntGroupingAggregatorFunction implements GroupingAggreg\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevIntGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevIntGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevIntGroupingAggregatorFunction(channels, StdDevIntAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevIntGroupingAggregatorFunction(channels, StdDevIntAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunction.java\nindex 0e53e5f2d461e..edf7b4fbecb44 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunction.java\n@@ -31,20 +31,23 @@ public final class StdDevLongAggregatorFunction implements AggregatorFunction {\n \n   private final DriverContext driverContext;\n \n-  private final StdDevStates.SingleState state;\n+  private final VarianceStates.SingleState state;\n \n   private final List<Integer> channels;\n \n+  private final boolean stdDev;\n+\n   public StdDevLongAggregatorFunction(DriverContext driverContext, List<Integer> channels,\n-      StdDevStates.SingleState state) {\n+      VarianceStates.SingleState state, boolean stdDev) {\n     this.driverContext = driverContext;\n     this.channels = channels;\n     this.state = state;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevLongAggregatorFunction create(DriverContext driverContext,\n-      List<Integer> channels) {\n-    return new StdDevLongAggregatorFunction(driverContext, channels, StdDevLongAggregator.initSingle());\n+      List<Integer> channels, boolean stdDev) {\n+    return new StdDevLongAggregatorFunction(driverContext, channels, StdDevLongAggregator.initSingle(stdDev), stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunctionSupplier.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunctionSupplier.java\nindex 364fc4820c283..bacba99142e41 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunctionSupplier.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongAggregatorFunctionSupplier.java\n@@ -15,7 +15,10 @@\n  * This class is generated. Edit {@code AggregatorFunctionSupplierImplementer} instead.\n  */\n public final class StdDevLongAggregatorFunctionSupplier implements AggregatorFunctionSupplier {\n-  public StdDevLongAggregatorFunctionSupplier() {\n+  private final boolean stdDev;\n+\n+  public StdDevLongAggregatorFunctionSupplier(boolean stdDev) {\n+    this.stdDev = stdDev;\n   }\n \n   @Override\n@@ -31,13 +34,13 @@ public List<IntermediateStateDesc> groupingIntermediateStateDesc() {\n   @Override\n   public StdDevLongAggregatorFunction aggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevLongAggregatorFunction.create(driverContext, channels);\n+    return StdDevLongAggregatorFunction.create(driverContext, channels, stdDev);\n   }\n \n   @Override\n   public StdDevLongGroupingAggregatorFunction groupingAggregator(DriverContext driverContext,\n       List<Integer> channels) {\n-    return StdDevLongGroupingAggregatorFunction.create(channels, driverContext);\n+    return StdDevLongGroupingAggregatorFunction.create(channels, driverContext, stdDev);\n   }\n \n   @Override\ndiff --git a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongGroupingAggregatorFunction.java b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongGroupingAggregatorFunction.java\nindex 5e2dde7ea1fde..60aea98c728bf 100644\n--- a/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongGroupingAggregatorFunction.java\n+++ b/x-pack/plugin/esql/compute/src/main/generated/org/elasticsearch/compute/aggregation/StdDevLongGroupingAggregatorFunction.java\n@@ -31,22 +31,25 @@ public final class StdDevLongGroupingAggregatorFunction implements GroupingAggre\n       new IntermediateStateDesc(\"m2\", ElementType.DOUBLE),\n       new IntermediateStateDesc(\"count\", ElementType.LONG)  );\n \n-  private final StdDevStates.GroupingState state;\n+  private final VarianceStates.GroupingState state;\n \n   private final List<Integer> channels;\n \n   private final DriverContext driverContext;\n \n+  private final boolean stdDev;\n+\n   public StdDevLongGroupingAggregatorFunction(List<Integer> channels,\n-      StdDevStates.GroupingState state, DriverContext driverContext) {\n+      VarianceStates.GroupingState state, DriverContext driverContext, boolean stdDev) {\n     this.channels = channels;\n     this.state = state;\n     this.driverContext = driverContext;\n+    this.stdDev = stdDev;\n   }\n \n   public static StdDevLongGroupingAggregatorFunction create(List<Integer> channels,\n-      DriverContext driverContext) {\n-    return new StdDevLongGroupingAggregatorFunction(channels, StdDevLongAggregator.initGrouping(driverContext.bigArrays()), driverContext);\n+      DriverContext driverContext, boolean stdDev) {\n+    return new StdDevLongGroupingAggregatorFunction(channels, StdDevLongAggregator.initGrouping(driverContext.bigArrays(), stdDev), driverContext, stdDev);\n   }\n \n   public static List<IntermediateStateDesc> intermediateStateDesc() {\ndiff --git a/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/StdDevStates.java b/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/VarianceStates.java\nsimilarity index 93%\nrename from x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/StdDevStates.java\nrename to x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/VarianceStates.java\nindex 5b48498d83294..a4b6b2a04d593 100644\n--- a/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/StdDevStates.java\n+++ b/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/VarianceStates.java\n@@ -16,20 +16,22 @@\n import org.elasticsearch.compute.operator.DriverContext;\n import org.elasticsearch.core.Releasables;\n \n-public final class StdDevStates {\n+public final class VarianceStates {\n \n-    private StdDevStates() {}\n+    private VarianceStates() {}\n \n     static final class SingleState implements AggregatorState {\n \n         private final WelfordAlgorithm welfordAlgorithm;\n+        private final boolean stdDev;\n \n-        SingleState() {\n-            this(0, 0, 0);\n+        SingleState(boolean stdDev) {\n+            this(0, 0, 0, stdDev);\n         }\n \n-        SingleState(double mean, double m2, long count) {\n+        SingleState(double mean, double m2, long count, boolean stdDev) {\n             this.welfordAlgorithm = new WelfordAlgorithm(mean, m2, count);\n+            this.stdDev = stdDev;\n         }\n \n         public void add(long value) {\n@@ -73,7 +75,7 @@ public long count() {\n         }\n \n         public double evaluateFinal() {\n-            return welfordAlgorithm.evaluate();\n+            return welfordAlgorithm.evaluate(stdDev);\n         }\n \n         public Block evaluateFinal(DriverContext driverContext) {\n@@ -90,10 +92,12 @@ static final class GroupingState implements GroupingAggregatorState {\n \n         private ObjectArray<WelfordAlgorithm> states;\n         private final BigArrays bigArrays;\n+        private final boolean stdDev;\n \n-        GroupingState(BigArrays bigArrays) {\n+        GroupingState(BigArrays bigArrays, boolean stdDev) {\n             this.states = bigArrays.newObjectArray(1);\n             this.bigArrays = bigArrays;\n+            this.stdDev = stdDev;\n         }\n \n         WelfordAlgorithm getOrNull(int position) {\n@@ -189,7 +193,7 @@ public Block evaluateFinal(IntVector selected, DriverContext driverContext) {\n                         if (count == 0 || Double.isFinite(m2) == false) {\n                             builder.appendNull();\n                         } else {\n-                            builder.appendDouble(st.evaluate());\n+                            builder.appendDouble(st.evaluate(stdDev));\n                         }\n                     } else {\n                         builder.appendNull();\ndiff --git a/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/WelfordAlgorithm.java b/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/WelfordAlgorithm.java\nindex 8ccb985507247..2ab4c75624cb2 100644\n--- a/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/WelfordAlgorithm.java\n+++ b/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/WelfordAlgorithm.java\n@@ -73,7 +73,16 @@ public void add(double meanValue, double m2Value, long countValue) {\n         count += countValue;\n     }\n \n-    public double evaluate() {\n-        return count < 2 ? 0 : Math.sqrt(m2 / count);\n+    /**\n+     * Evaluate the variance or standard deviation.\n+     * @param stdDev if true, compute standard deviation, otherwise variance\n+     * @return\n+     */\n+    public double evaluate(boolean stdDev) {\n+        if (stdDev == false) {\n+            return count < 2 ? 0 : m2 / count;\n+        } else {\n+            return count < 2 ? 0 : Math.sqrt(m2 / count);\n+        }\n     }\n }\ndiff --git a/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/X-StdDevAggregator.java.st b/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/X-StdDevAggregator.java.st\nindex 5cb3197ce0e3c..0705a24024875 100644\n--- a/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/X-StdDevAggregator.java.st\n+++ b/x-pack/plugin/esql/compute/src/main/java/org/elasticsearch/compute/aggregation/X-StdDevAggregator.java.st\n@@ -28,35 +28,35 @@ import org.elasticsearch.compute.operator.DriverContext;\n @GroupingAggregator\n public class StdDev$Type$Aggregator {\n \n-    public static StdDevStates.SingleState initSingle() {\n-        return new StdDevStates.SingleState();\n+    public static VarianceStates.SingleState initSingle(boolean stdDev) {\n+        return new VarianceStates.SingleState(stdDev);\n     }\n \n-    public static void combine(StdDevStates.SingleState state, $type$ value) {\n+    public static void combine(VarianceStates.SingleState state, $type$ value) {\n         state.add(value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.SingleState state, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.SingleState state, double mean, double m2, long count) {\n         state.combine(mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.SingleState state, DriverContext driverContext) {\n+    public static Block evaluateFinal(VarianceStates.SingleState state, DriverContext driverContext) {\n         return state.evaluateFinal(driverContext);\n     }\n \n-    public static StdDevStates.GroupingState initGrouping(BigArrays bigArrays) {\n-        return new StdDevStates.GroupingState(bigArrays);\n+    public static VarianceStates.GroupingState initGrouping(BigArrays bigArrays, boolean stdDev) {\n+        return new VarianceStates.GroupingState(bigArrays, stdDev);\n     }\n \n-    public static void combine(StdDevStates.GroupingState current, int groupId, $type$ value) {\n+    public static void combine(VarianceStates.GroupingState current, int groupId, $type$ value) {\n         current.add(groupId, value);\n     }\n \n-    public static void combineIntermediate(StdDevStates.GroupingState state, int groupId, double mean, double m2, long count) {\n+    public static void combineIntermediate(VarianceStates.GroupingState state, int groupId, double mean, double m2, long count) {\n         state.combine(groupId, mean, m2, count);\n     }\n \n-    public static Block evaluateFinal(StdDevStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n+    public static Block evaluateFinal(VarianceStates.GroupingState state, IntVector selected, GroupingAggregatorEvaluationContext ctx) {\n         return state.evaluateFinal(selected, ctx.driverContext());\n     }\n }\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec\nindex 033d89f0cb54d..64cdae20e5635 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/k8s-timeseries.csv-spec\n@@ -594,6 +594,84 @@ max_cost:integer | pod:keyword | time_bucket:datetime     | max_cluster_cost:int\n 973              | two         | 2024-05-10T00:00:00.000Z | 1209                     | staging\n ;\n \n+max_of_stddev_over_time\n+required_capability: ts_command_v0\n+required_capability: variance_stddev_over_time\n+// tag::stddev_over_time[]\n+TS k8s\n+| STATS max_stddev_cost=MAX(STDDEV_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+// end::stddev_over_time[]\n+| EVAL max_stddev_cost = ROUND(max_stddev_cost, 6)\n+| SORT max_stddev_cost DESC, time_bucket DESC, cluster | LIMIT 10;\n+\n+// tag::stddev_over_time-result[]\n+cluster:keyword | time_bucket:datetime     | max_stddev_cost:double\n+staging         | 2024-05-10T00:03:00.000Z | 5.4375\n+staging         | 2024-05-10T00:09:00.000Z | 5.1875\n+qa              | 2024-05-10T00:18:00.000Z | 4.097764\n+qa              | 2024-05-10T00:21:00.000Z | 4.0\n+staging         | 2024-05-10T00:20:00.000Z | 3.9375\n+// end::stddev_over_time-result[]\n+prod            | 2024-05-10T00:18:00.000Z | 3.93353\n+qa              | 2024-05-10T00:08:00.000Z | 3.89444\n+qa              | 2024-05-10T00:17:00.000Z | 3.882385\n+staging         | 2024-05-10T00:13:00.000Z | 3.835597\n+staging         | 2024-05-10T00:12:00.000Z | 3.8125\n+\n+;\n+\n+avg_variance_over_time\n+required_capability: ts_command_v0\n+required_capability: variance_stddev_over_time\n+// tag::variance_over_time[]\n+TS k8s\n+| STATS avg_var_cost=AVG(VARIANCE_OVER_TIME(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+// end::variance_over_time[]\n+| EVAL avg_var_cost = ROUND(avg_var_cost, 6)\n+| SORT avg_var_cost DESC, time_bucket DESC, cluster | LIMIT 10;\n+\n+// tag::variance_over_time-result[]\n+cluster:keyword | time_bucket:datetime     | avg_var_cost:double\n+staging         | 2024-05-10T00:03:00.000Z | 20.478516\n+qa              | 2024-05-10T00:21:00.000Z | 16.0\n+qa              | 2024-05-10T00:18:00.000Z | 11.192274\n+staging         | 2024-05-10T00:09:00.000Z | 10.446904\n+// end::variance_over_time-result[]\n+qa              | 2024-05-10T00:17:00.000Z | 10.398003\n+qa              | 2024-05-10T00:08:00.000Z | 10.114583\n+staging         | 2024-05-10T00:20:00.000Z | 7.910156\n+staging         | 2024-05-10T00:13:00.000Z | 7.355903\n+prod            | 2024-05-10T00:02:00.000Z | 6.570313\n+prod            | 2024-05-10T00:18:00.000Z | 5.157552\n+\n+;\n+\n+stddev_sq_and_var_over_time_are_consistent\n+required_capability: ts_command_v0\n+required_capability: variance_stddev_over_time\n+\n+TS k8s\n+| STATS sd=max(stddev_over_time(network.cost)), var=max(variance_over_time(network.cost)) BY cluster, time_bucket = TBUCKET(1minute)\n+| EVAL sd_squared = sd * sd\n+| EVAL sd_squared = ROUND(sd_squared, 6), var = ROUND(var, 6), sd = ROUND(sd, 6)\n+| KEEP sd, var, sd_squared, cluster, time_bucket\n+| SORT cluster, time_bucket\n+| LIMIT 10;\n+\n+sd:double | var:double | sd_squared:double | cluster:keyword | time_bucket:datetime\n+1.4375    | 2.066406   | 2.066406          | prod            | 2024-05-10T00:00:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:01:00.000Z\n+3.625     | 13.140625  | 13.140625         | prod            | 2024-05-10T00:02:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:03:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:04:00.000Z\n+2.75      | 7.5625     | 7.5625            | prod            | 2024-05-10T00:05:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:06:00.000Z\n+1.9375    | 3.753906   | 3.753906          | prod            | 2024-05-10T00:08:00.000Z\n+3.406999  | 11.607639  | 11.607639         | prod            | 2024-05-10T00:09:00.000Z\n+0.0       | 0.0        | 0.0               | prod            | 2024-05-10T00:10:00.000Z\n+\n+;\n+\n Max of Rate with Bucket\n required_capability: ts_command_v0\n \n@@ -642,3 +720,4 @@ mx:integer | tbucket:datetime\n 1716       | 2024-05-10T00:00:00.000Z\n ;\n \n+\ndiff --git a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\nindex 61ca316a39dbc..dc7607bda6934 100644\n--- a/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n+++ b/x-pack/plugin/esql/qa/testFixtures/src/main/resources/stats.csv-spec\n@@ -2969,6 +2969,22 @@ std_dev_height:double\n // end::stdev-result[]\n ;\n \n+varianceSimple\n+required_capability: variance_stddev_over_time\n+\n+// tag::variance[]\n+FROM employees\n+| STATS var_height = VARIANCE(height)\n+// end::variance[]\n+| EVAL var_height = ROUND(var_height, 7)\n+;\n+\n+// tag::variance-result[]\n+var_height:double\n+0.0425888\n+// end::variance-result[]\n+;\n+\n stdDeviationNested\n required_capability: std_dev\n // tag::docsStatsStdDevNestedExpression[]\n@@ -2985,6 +3001,22 @@ stddev_salary_change:double\n ;\n \n \n+varianceNested\n+required_capability: variance_stddev_over_time\n+\n+# tag::variance[]\n+FROM employees\n+| STATS var_salary_change = VARIANCE(MV_MAX(salary_change))\n+# end::variance[]\n+| EVAL var_salary_change = ROUND(var_salary_change, 5)\n+;\n+\n+# tag::variance-result[]\n+var_salary_change:double\n+47.27703\n+# end::variance-result[]\n+;\n+\n stdDeviationWithLongs\n required_capability: std_dev\n FROM employees\n@@ -2996,6 +3028,17 @@ std_dev:double\n 5.7601043E7\n ;\n \n+varianceWithLongs\n+required_capability: variance_stddev_over_time\n+FROM employees\n+| STATS var = variance(avg_worked_seconds)\n+| EVAL var = ROUND(var, 7)\n+;\n+\n+var:double\n+3.317880108280233E15\n+;\n+\n stdDeviationWithInts\n required_capability: std_dev\n FROM employees\n@@ -3007,6 +3050,17 @@ std_dev:double\n 13765.1255\n ;\n \n+varianceWithInts\n+required_capability: variance_stddev_over_time\n+FROM employees\n+| STATS var = STD_VAR(salary)\n+| EVAL var = ROUND(var, 5)\n+;\n+\n+var:double\n+1.894786801075E8\n+;\n+\n stdDeviationConstantValue\n required_capability: std_dev\n FROM employees\n@@ -3059,10 +3113,10 @@ stdDeviationNoRows\n required_capability: std_dev\n FROM employees\n | WHERE languages IS null\n-| STATS STD_DEV(languages)\n+| STATS sd=STD_DEV(languages)\n ;\n \n-STD_DEV(languages):double\n+sd:double\n null\n ;\n \ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\nindex 29a8101dd9324..057328903aac2 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/action/EsqlCapabilities.java\n@@ -1476,7 +1476,7 @@ public enum Cap {\n          * Percentile over time and other ts-aggregations\n          */\n         PERCENTILE_OVER_TIME,\n-\n+        VARIANCE_STDDEV_OVER_TIME,\n         /**\n          * INLINE STATS fix incorrect prunning of null filtering\n          * https://github.com/elastic/elasticsearch/pull/135011\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java\nindex 4214c3c49558d..62013b8602a03 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/EsqlFunctionRegistry.java\n@@ -49,10 +49,13 @@\n import org.elasticsearch.xpack.esql.expression.function.aggregate.SpatialCentroid;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.SpatialExtent;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.StdDev;\n+import org.elasticsearch.xpack.esql.expression.function.aggregate.StdDevOverTime;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.Sum;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.SumOverTime;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.Top;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.Values;\n+import org.elasticsearch.xpack.esql.expression.function.aggregate.Variance;\n+import org.elasticsearch.xpack.esql.expression.function.aggregate.VarianceOverTime;\n import org.elasticsearch.xpack.esql.expression.function.aggregate.WeightedAvg;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Kql;\n import org.elasticsearch.xpack.esql.expression.function.fulltext.Match;\n@@ -357,6 +360,7 @@ private static FunctionDefinition[][] functions() {\n                 def(Percentile.class, bi(Percentile::new), \"percentile\"),\n                 def(Sample.class, bi(Sample::new), \"sample\"),\n                 def(StdDev.class, uni(StdDev::new), \"std_dev\"),\n+                def(Variance.class, uni(Variance::new), \"variance\", \"std_var\"),\n                 def(Sum.class, uni(Sum::new), \"sum\"),\n                 def(Top.class, tri(Top::new), \"top\"),\n                 def(Values.class, uni(Values::new), \"values\"),\n@@ -531,6 +535,8 @@ private static FunctionDefinition[][] functions() {\n                 def(MaxOverTime.class, uni(MaxOverTime::new), \"max_over_time\"),\n                 def(MinOverTime.class, uni(MinOverTime::new), \"min_over_time\"),\n                 def(SumOverTime.class, uni(SumOverTime::new), \"sum_over_time\"),\n+                def(StdDevOverTime.class, uni(StdDevOverTime::new), \"stddev_over_time\"),\n+                def(VarianceOverTime.class, uni(VarianceOverTime::new), \"variance_over_time\", \"stdvar_over_time\"),\n                 def(CountOverTime.class, uni(CountOverTime::new), \"count_over_time\"),\n                 def(CountDistinctOverTime.class, bi(CountDistinctOverTime::new), \"count_distinct_over_time\"),\n                 def(PresentOverTime.class, uni(PresentOverTime::new), \"present_over_time\"),\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/AggregateWritables.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/AggregateWritables.java\nindex d604a72dce08c..5b3bddd89d093 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/AggregateWritables.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/AggregateWritables.java\n@@ -33,6 +33,7 @@ public static List<NamedWriteableRegistry.Entry> getNamedWriteables() {\n             SpatialCentroid.ENTRY,\n             SpatialExtent.ENTRY,\n             StdDev.ENTRY,\n+            Variance.ENTRY,\n             Sum.ENTRY,\n             Top.ENTRY,\n             Values.ENTRY,\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDev.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDev.java\nindex 22a97c2ccb5b3..af4428199e322 100644\n--- a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDev.java\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDev.java\n@@ -100,13 +100,13 @@ public StdDev withFilter(Expression filter) {\n     public final AggregatorFunctionSupplier supplier() {\n         DataType type = field().dataType();\n         if (type == DataType.LONG) {\n-            return new StdDevLongAggregatorFunctionSupplier();\n+            return new StdDevLongAggregatorFunctionSupplier(true);\n         }\n         if (type == DataType.INTEGER) {\n-            return new StdDevIntAggregatorFunctionSupplier();\n+            return new StdDevIntAggregatorFunctionSupplier(true);\n         }\n         if (type == DataType.DOUBLE) {\n-            return new StdDevDoubleAggregatorFunctionSupplier();\n+            return new StdDevDoubleAggregatorFunctionSupplier(true);\n         }\n         throw EsqlIllegalArgumentException.illegalDataType(type);\n     }\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevOverTime.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevOverTime.java\nnew file mode 100644\nindex 0000000000000..c6ee0f3df5ad3\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevOverTime.java\n@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.expression.Literal;\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.Example;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesTo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesToLifecycle;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionInfo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionType;\n+import org.elasticsearch.xpack.esql.expression.function.Param;\n+\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+\n+/**\n+ * Similar to {@link StdDev}, but it is used to calculate the standard deviation over a time series of values from the given field.\n+ */\n+public class StdDevOverTime extends TimeSeriesAggregateFunction {\n+    @FunctionInfo(\n+        returnType = \"double\",\n+        description = \"Calculates the population standard deviation over time of a numeric field.\",\n+        type = FunctionType.TIME_SERIES_AGGREGATE,\n+        appliesTo = { @FunctionAppliesTo(lifeCycle = FunctionAppliesToLifecycle.PREVIEW, version = \"9.3.0\") },\n+        preview = true,\n+        examples = { @Example(file = \"k8s-timeseries\", tag = \"stddev_over_time\") }\n+    )\n+    public StdDevOverTime(\n+        Source source,\n+        @Param(\n+            name = \"number\",\n+            type = { \"double\", \"integer\", \"long\" },\n+            description = \"Expression that outputs values to calculate the standard deviation of.\"\n+        ) Expression field\n+    ) {\n+        this(source, field, Literal.TRUE);\n+    }\n+\n+    public StdDevOverTime(Source source, Expression field, Expression filter) {\n+        super(source, field, filter, emptyList());\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        return perTimeSeriesAggregation().resolveType();\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        throw new UnsupportedOperationException(\"StdDevOverTime does not have a writeable name\");\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return perTimeSeriesAggregation().dataType();\n+    }\n+\n+    @Override\n+    protected NodeInfo<StdDevOverTime> info() {\n+        return NodeInfo.create(this, StdDevOverTime::new, field(), filter());\n+    }\n+\n+    @Override\n+    public StdDevOverTime replaceChildren(List<Expression> newChildren) {\n+        return new StdDevOverTime(source(), newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    @Override\n+    public StdDevOverTime withFilter(Expression filter) {\n+        return new StdDevOverTime(source(), field(), filter);\n+    }\n+\n+    @Override\n+    public AggregateFunction perTimeSeriesAggregation() {\n+        return new StdDev(source(), field(), filter());\n+    }\n+}\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Variance.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Variance.java\nnew file mode 100644\nindex 0000000000000..bcb4734875650\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/Variance.java\n@@ -0,0 +1,105 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.compute.aggregation.AggregatorFunctionSupplier;\n+import org.elasticsearch.compute.aggregation.StdDevDoubleAggregatorFunctionSupplier;\n+import org.elasticsearch.compute.aggregation.StdDevIntAggregatorFunctionSupplier;\n+import org.elasticsearch.compute.aggregation.StdDevLongAggregatorFunctionSupplier;\n+import org.elasticsearch.xpack.esql.EsqlIllegalArgumentException;\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.expression.Literal;\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.Example;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionInfo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionType;\n+import org.elasticsearch.xpack.esql.expression.function.Param;\n+import org.elasticsearch.xpack.esql.planner.ToAggregator;\n+\n+import java.io.IOException;\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+import static org.elasticsearch.xpack.esql.core.expression.TypeResolutions.ParamOrdinal.DEFAULT;\n+import static org.elasticsearch.xpack.esql.core.expression.TypeResolutions.isType;\n+\n+public class Variance extends AggregateFunction implements ToAggregator {\n+    public static final NamedWriteableRegistry.Entry ENTRY = new NamedWriteableRegistry.Entry(Expression.class, \"Variance\", Variance::new);\n+\n+    @FunctionInfo(\n+        returnType = \"double\",\n+        description = \"The population variance of a numeric field.\",\n+        type = FunctionType.AGGREGATE,\n+        examples = { @Example(file = \"stats\", tag = \"variance\") }\n+    )\n+    public Variance(Source source, @Param(name = \"number\", type = { \"double\", \"integer\", \"long\" }) Expression field) {\n+        this(source, field, Literal.TRUE);\n+    }\n+\n+    public Variance(Source source, Expression field, Expression filter) {\n+        super(source, field, filter, emptyList());\n+    }\n+\n+    private Variance(StreamInput in) throws IOException {\n+        super(in);\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        return ENTRY.name;\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return DataType.DOUBLE;\n+    }\n+\n+    @Override\n+    protected Expression.TypeResolution resolveType() {\n+        return isType(\n+            field(),\n+            dt -> dt.isNumeric() && dt != DataType.UNSIGNED_LONG,\n+            sourceText(),\n+            DEFAULT,\n+            \"numeric except unsigned_long or counter types\"\n+        );\n+    }\n+\n+    @Override\n+    protected NodeInfo<Variance> info() {\n+        return NodeInfo.create(this, Variance::new, field(), filter());\n+    }\n+\n+    @Override\n+    public Variance replaceChildren(List<Expression> newChildren) {\n+        return new Variance(source(), newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    public Variance withFilter(Expression filter) {\n+        return new Variance(source(), field(), filter);\n+    }\n+\n+    @Override\n+    public final AggregatorFunctionSupplier supplier() {\n+        DataType type = field().dataType();\n+        if (type == DataType.LONG) {\n+            return new StdDevLongAggregatorFunctionSupplier(false);\n+        }\n+        if (type == DataType.INTEGER) {\n+            return new StdDevIntAggregatorFunctionSupplier(false);\n+        }\n+        if (type == DataType.DOUBLE) {\n+            return new StdDevDoubleAggregatorFunctionSupplier(false);\n+        }\n+        throw EsqlIllegalArgumentException.illegalDataType(type);\n+    }\n+}\ndiff --git a/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTime.java b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTime.java\nnew file mode 100644\nindex 0000000000000..61745619f98d0\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/main/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTime.java\n@@ -0,0 +1,87 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.expression.Literal;\n+import org.elasticsearch.xpack.esql.core.tree.NodeInfo;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.Example;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesTo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionAppliesToLifecycle;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionInfo;\n+import org.elasticsearch.xpack.esql.expression.function.FunctionType;\n+import org.elasticsearch.xpack.esql.expression.function.Param;\n+\n+import java.util.List;\n+\n+import static java.util.Collections.emptyList;\n+\n+/**\n+ * Similar to {@link Variance}, but it is used to calculate the variance over a time series of values from the given field.\n+ */\n+public class VarianceOverTime extends TimeSeriesAggregateFunction {\n+    @FunctionInfo(\n+        returnType = \"double\",\n+        description = \"Calculates the population variance over time of a numeric field.\",\n+        type = FunctionType.TIME_SERIES_AGGREGATE,\n+        appliesTo = { @FunctionAppliesTo(lifeCycle = FunctionAppliesToLifecycle.PREVIEW, version = \"9.3.0\") },\n+        preview = true,\n+        examples = { @Example(file = \"k8s-timeseries\", tag = \"variance_over_time\") }\n+    )\n+    public VarianceOverTime(\n+        Source source,\n+        @Param(\n+            name = \"number\",\n+            type = { \"double\", \"integer\", \"long\" },\n+            description = \"Expression for which to calculate the variance over time.\"\n+        ) Expression field\n+    ) {\n+        this(source, field, Literal.TRUE);\n+    }\n+\n+    public VarianceOverTime(Source source, Expression field, Expression filter) {\n+        super(source, field, filter, emptyList());\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        return perTimeSeriesAggregation().resolveType();\n+    }\n+\n+    @Override\n+    public String getWriteableName() {\n+        throw new UnsupportedOperationException(\"VarianceOverTime does not have a writeable name\");\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return perTimeSeriesAggregation().dataType();\n+    }\n+\n+    @Override\n+    protected NodeInfo<VarianceOverTime> info() {\n+        return NodeInfo.create(this, VarianceOverTime::new, field(), filter());\n+    }\n+\n+    @Override\n+    public VarianceOverTime replaceChildren(List<Expression> newChildren) {\n+        return new VarianceOverTime(source(), newChildren.get(0), newChildren.get(1));\n+    }\n+\n+    @Override\n+    public VarianceOverTime withFilter(Expression filter) {\n+        return new VarianceOverTime(source(), field(), filter);\n+    }\n+\n+    @Override\n+    public AggregateFunction perTimeSeriesAggregation() {\n+        return new Variance(source(), field(), filter());\n+    }\n+}\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevTests.java\nindex f78e04ec94e82..f070852dafddb 100644\n--- a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevTests.java\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StdDevTests.java\n@@ -60,7 +60,7 @@ private static TestCaseSupplier makeSupplier(TestCaseSupplier.TypedDataSupplier\n                 var value = ((Number) fieldValue).doubleValue();\n                 welfordAlgorithm.add(value);\n             }\n-            var result = welfordAlgorithm.evaluate();\n+            var result = welfordAlgorithm.evaluate(true);\n             var expected = Double.isFinite(result) ? result : null;\n             return new TestCaseSupplier.TestCase(\n                 List.of(fieldTypedData),\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StddevOverTimeTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StddevOverTimeTests.java\nnew file mode 100644\nindex 0000000000000..4035be33f8a12\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/StddevOverTimeTests.java\n@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.expression.function.AbstractFunctionTestCase;\n+import org.elasticsearch.xpack.esql.expression.function.TestCaseSupplier;\n+\n+import java.util.List;\n+import java.util.function.Supplier;\n+\n+public class StddevOverTimeTests extends AbstractFunctionTestCase {\n+    public StddevOverTimeTests(Supplier<TestCaseSupplier.TestCase> testCaseSupplier) {\n+        testCase = testCaseSupplier.get();\n+    }\n+\n+    @Override\n+    protected boolean canSerialize() {\n+        return false;\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() {\n+        return StdDevTests.parameters();\n+    }\n+\n+    @Override\n+    protected Expression build(Source source, List<Expression> args) {\n+        return new StdDevOverTime(source, args.get(0));\n+    }\n+}\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTimeTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTimeTests.java\nnew file mode 100644\nindex 0000000000000..10eecd7d5b330\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceOverTimeTests.java\n@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.expression.function.AbstractFunctionTestCase;\n+import org.elasticsearch.xpack.esql.expression.function.TestCaseSupplier;\n+\n+import java.util.List;\n+import java.util.function.Supplier;\n+\n+public class VarianceOverTimeTests extends AbstractFunctionTestCase {\n+    public VarianceOverTimeTests(Supplier<TestCaseSupplier.TestCase> testCaseSupplier) {\n+        testCase = testCaseSupplier.get();\n+    }\n+\n+    @Override\n+    protected boolean canSerialize() {\n+        return false;\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() {\n+        return VarianceTests.parameters();\n+    }\n+\n+    @Override\n+    protected Expression build(Source source, List<Expression> args) {\n+        return new VarianceOverTime(source, args.get(0));\n+    }\n+}\ndiff --git a/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceTests.java b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceTests.java\nnew file mode 100644\nindex 0000000000000..99b853b24c3d2\n--- /dev/null\n+++ b/x-pack/plugin/esql/src/test/java/org/elasticsearch/xpack/esql/expression/function/aggregate/VarianceTests.java\n@@ -0,0 +1,74 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License\n+ * 2.0; you may not use this file except in compliance with the Elastic License\n+ * 2.0.\n+ */\n+\n+package org.elasticsearch.xpack.esql.expression.function.aggregate;\n+\n+import com.carrotsearch.randomizedtesting.annotations.Name;\n+import com.carrotsearch.randomizedtesting.annotations.ParametersFactory;\n+\n+import org.elasticsearch.compute.aggregation.WelfordAlgorithm;\n+import org.elasticsearch.xpack.esql.core.expression.Expression;\n+import org.elasticsearch.xpack.esql.core.tree.Source;\n+import org.elasticsearch.xpack.esql.core.type.DataType;\n+import org.elasticsearch.xpack.esql.expression.function.AbstractAggregationTestCase;\n+import org.elasticsearch.xpack.esql.expression.function.MultiRowTestCaseSupplier;\n+import org.elasticsearch.xpack.esql.expression.function.TestCaseSupplier;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class VarianceTests extends AbstractAggregationTestCase {\n+    public VarianceTests(@Name(\"TestCase\") Supplier<TestCaseSupplier.TestCase> testCaseSupplier) {\n+        this.testCase = testCaseSupplier.get();\n+    }\n+\n+    @ParametersFactory\n+    public static Iterable<Object[]> parameters() {\n+        var suppliers = new ArrayList<TestCaseSupplier>();\n+\n+        Stream.of(\n+            MultiRowTestCaseSupplier.intCases(1, 1000, Integer.MIN_VALUE, Integer.MAX_VALUE, true),\n+            MultiRowTestCaseSupplier.longCases(1, 1000, Long.MIN_VALUE, Long.MAX_VALUE, true),\n+            MultiRowTestCaseSupplier.doubleCases(1, 1000, -Double.MAX_VALUE, Double.MAX_VALUE, true)\n+        ).flatMap(List::stream).map(VarianceTests::makeSupplier).collect(Collectors.toCollection(() -> suppliers));\n+\n+        return parameterSuppliersFromTypedDataWithDefaultChecks(suppliers, true);\n+    }\n+\n+    @Override\n+    protected Expression build(Source source, List<Expression> args) {\n+        return new Variance(source, args.get(0));\n+    }\n+\n+    private static TestCaseSupplier makeSupplier(TestCaseSupplier.TypedDataSupplier fieldSupplier) {\n+        return new TestCaseSupplier(List.of(fieldSupplier.type()), () -> {\n+            var fieldTypedData = fieldSupplier.get();\n+            var fieldValues = fieldTypedData.multiRowData();\n+\n+            WelfordAlgorithm welfordAlgorithm = new WelfordAlgorithm();\n+\n+            for (var fieldValue : fieldValues) {\n+                var value = ((Number) fieldValue).doubleValue();\n+                welfordAlgorithm.add(value);\n+            }\n+            var result = welfordAlgorithm.evaluate(false);\n+            var expected = Double.isFinite(result) ? result : null;\n+            return new TestCaseSupplier.TestCase(\n+                List.of(fieldTypedData),\n+                // Note that this stddev because it's the operator that implements both of these\n+                standardAggregatorName(\"StdDev\", fieldSupplier.type()),\n+                DataType.DOUBLE,\n+                equalTo(expected)\n+            );\n+        });\n+    }\n+}\n",
  "additions": 1115,
  "deletions": 111,
  "changed_files": 60,
  "url": "https://github.com/elastic/elasticsearch/pull/136712",
  "mined_at": "2025-10-25T13:11:37.949682"
}