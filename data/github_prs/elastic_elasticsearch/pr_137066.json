{
  "id": 137066,
  "repository": "elastic/elasticsearch",
  "title": "[Sampling] Improving random sampling performance very slightly",
  "body": "In doing some profiling of random sampling, I realized that we are unnecessarily constructing a ProjectMetadata object inside of `SamplingService.atLeastOneSampleConfigured()`. That method is called frequently enough during heavng bulk loading that it registers in the profiler. There is no need for this, since all callers already have a ProjectMetadata.",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-10-24T12:41:55+00:00",
  "created_at": "2025-10-23T20:15:20+00:00",
  "updated_at": "2025-10-24T12:41:58+00:00",
  "author": "masseyke",
  "reviewers": [
    "seanzatzdev"
  ],
  "base_sha": "d213909657ee411a30cdcfc67a406b0d03deaaa8",
  "head_sha": "ccbf9f7e434a34d360e666210b92432f67c93e30",
  "review_comments": [
    {
      "user": "seanzatzdev",
      "state": "APPROVED",
      "body": "LGTM!",
      "submitted_at": "2025-10-23T20:28:30+00:00"
    }
  ],
  "pr_comments": [
    {
      "user": "elasticsearchmachine",
      "body": "Pinging @elastic/es-data-management (Team:Data Management)",
      "created_at": "2025-10-23T20:15:44+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "server/src/main/java/org/elasticsearch/action/bulk/TransportAbstractBulkAction.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -312,7 +312,7 @@ private boolean applyPipelines(\n                 }\n             });\n             return true;\n-        } else if (haveRunIngestService == false && samplingService != null && samplingService.atLeastOneSampleConfigured()) {\n+        } else if (haveRunIngestService == false && samplingService != null && samplingService.atLeastOneSampleConfigured(project)) {\n             /*\n              * Else ample only if this request has not passed through IngestService::executeBulkRequest. Otherwise, some request within the\n              * bulk had pipelines and we sampled in IngestService already."
    },
    {
      "filename": "server/src/main/java/org/elasticsearch/ingest/IngestService.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -1385,7 +1385,7 @@ private void attemptToSampleData(\n         IngestDocument ingestDocument,\n         Metadata originalDocumentMetadata\n     ) {\n-        if (samplingService != null && samplingService.atLeastOneSampleConfigured()) {\n+        if (samplingService != null && samplingService.atLeastOneSampleConfigured(projectMetadata)) {\n             /*\n              * We need both the original document and the fully updated document for sampling, so we make a copy of the original\n              * before overwriting it here. We can discard it after sampling."
    },
    {
      "filename": "server/src/main/java/org/elasticsearch/ingest/SamplingService.java",
      "status": "modified",
      "additions": 5,
      "deletions": 21,
      "changes": 26,
      "patch": "@@ -28,7 +28,6 @@\n import org.elasticsearch.cluster.metadata.Metadata;\n import org.elasticsearch.cluster.metadata.ProjectId;\n import org.elasticsearch.cluster.metadata.ProjectMetadata;\n-import org.elasticsearch.cluster.project.ProjectResolver;\n import org.elasticsearch.cluster.service.ClusterService;\n import org.elasticsearch.cluster.service.MasterServiceTaskQueue;\n import org.elasticsearch.common.Priority;\n@@ -95,7 +94,6 @@ public class SamplingService extends AbstractLifecycleComponent implements Clust\n     private static final String TTL_JOB_ID = \"sampling_ttl\";\n     private final ScriptService scriptService;\n     private final ClusterService clusterService;\n-    private final ProjectResolver projectResolver;\n     private final LongSupplier statsTimeSupplier = System::nanoTime;\n     private final MasterServiceTaskQueue<UpdateSamplingConfigurationTask> updateSamplingConfigurationTaskQueue;\n     private final MasterServiceTaskQueue<DeleteSampleConfigurationTask> deleteSamplingConfigurationTaskQueue;\n@@ -122,26 +120,15 @@ public class SamplingService extends AbstractLifecycleComponent implements Clust\n     /*\n      * This creates a new SamplingService, and configures various listeners on it.\n      */\n-    public static SamplingService create(\n-        ScriptService scriptService,\n-        ClusterService clusterService,\n-        ProjectResolver projectResolver,\n-        Settings settings\n-    ) {\n-        SamplingService samplingService = new SamplingService(scriptService, clusterService, projectResolver, settings);\n+    public static SamplingService create(ScriptService scriptService, ClusterService clusterService, Settings settings) {\n+        SamplingService samplingService = new SamplingService(scriptService, clusterService, settings);\n         samplingService.configureListeners();\n         return samplingService;\n     }\n \n-    private SamplingService(\n-        ScriptService scriptService,\n-        ClusterService clusterService,\n-        ProjectResolver projectResolver,\n-        Settings settings\n-    ) {\n+    private SamplingService(ScriptService scriptService, ClusterService clusterService, Settings settings) {\n         this.scriptService = scriptService;\n         this.clusterService = clusterService;\n-        this.projectResolver = projectResolver;\n         this.updateSamplingConfigurationTaskQueue = clusterService.createTaskQueue(\n             \"update-sampling-configuration\",\n             Priority.NORMAL,\n@@ -340,12 +327,9 @@ public SampleStats getLocalSampleStats(ProjectId projectId, String index) {\n         return sampleInfo == null ? new SampleStats() : sampleInfo.stats;\n     }\n \n-    public boolean atLeastOneSampleConfigured() {\n+    public boolean atLeastOneSampleConfigured(ProjectMetadata projectMetadata) {\n         if (RANDOM_SAMPLING_FEATURE_FLAG) {\n-            SamplingMetadata samplingMetadata = clusterService.state()\n-                .projectState(projectResolver.getProjectId())\n-                .metadata()\n-                .custom(SamplingMetadata.TYPE);\n+            SamplingMetadata samplingMetadata = projectMetadata.custom(SamplingMetadata.TYPE);\n             return samplingMetadata != null && samplingMetadata.getIndexToSamplingConfigMap().isEmpty() == false;\n         } else {\n             return false;"
    },
    {
      "filename": "server/src/main/java/org/elasticsearch/node/NodeConstruction.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -728,7 +728,7 @@ private void construct(\n \n         FeatureService featureService = new FeatureService(pluginsService.loadServiceProviders(FeatureSpecification.class));\n \n-        SamplingService samplingService = SamplingService.create(scriptService, clusterService, projectResolver, settings);\n+        SamplingService samplingService = SamplingService.create(scriptService, clusterService, settings);\n         modules.bindToInstance(SamplingService.class, samplingService);\n         clusterService.addListener(samplingService);\n "
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -180,7 +180,7 @@ public boolean clusterHasFeature(ClusterState state, NodeFeature feature) {\n \n         private static SamplingService initializeSamplingService() {\n             SamplingService samplingService = mock(SamplingService.class);\n-            when(samplingService.atLeastOneSampleConfigured()).thenReturn(true);\n+            when(samplingService.atLeastOneSampleConfigured(any())).thenReturn(true);\n             return samplingService;\n         }\n "
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -163,7 +163,7 @@ public boolean clusterHasFeature(ClusterState state, NodeFeature feature) {\n \n         private static SamplingService initializeSamplingService() {\n             SamplingService samplingService = mock(SamplingService.class);\n-            when(samplingService.atLeastOneSampleConfigured()).thenReturn(true);\n+            when(samplingService.atLeastOneSampleConfigured(any())).thenReturn(true);\n             return samplingService;\n         }\n "
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/ingest/IngestServiceTests.java",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "patch": "@@ -3357,7 +3357,7 @@ public void testSampling() {\n             Predicates.never(),\n             samplingService\n         );\n-        when(samplingService.atLeastOneSampleConfigured()).thenReturn(true);\n+        when(samplingService.atLeastOneSampleConfigured(any())).thenReturn(true);\n         PutPipelineRequest putRequest = putJsonPipelineRequest(\"_id\", \"{\\\"processors\\\": [{\\\"mock\\\" : {}}]}\");\n         var projectId = randomProjectIdOrDefault();\n         ClusterState clusterState = ClusterState.builder(ClusterName.DEFAULT)"
    },
    {
      "filename": "server/src/test/java/org/elasticsearch/ingest/SamplingServiceTests.java",
      "status": "modified",
      "additions": 1,
      "deletions": 4,
      "changes": 5,
      "patch": "@@ -16,7 +16,6 @@\n import org.elasticsearch.cluster.ClusterState;\n import org.elasticsearch.cluster.metadata.ProjectId;\n import org.elasticsearch.cluster.metadata.ProjectMetadata;\n-import org.elasticsearch.cluster.project.ProjectResolver;\n import org.elasticsearch.cluster.project.TestProjectResolvers;\n import org.elasticsearch.cluster.service.ClusterService;\n import org.elasticsearch.common.settings.Settings;\n@@ -352,8 +351,6 @@ private SamplingService getTestSamplingService() {\n             TestProjectResolvers.singleProject(randomProjectIdOrDefault())\n         );\n         ClusterService clusterService = ClusterServiceUtils.createClusterService(new DeterministicTaskQueue().getThreadPool());\n-        final ProjectId projectId = ProjectId.DEFAULT;\n-        final ProjectResolver projectResolver = TestProjectResolvers.singleProject(projectId);\n-        return SamplingService.create(scriptService, clusterService, projectResolver, Settings.EMPTY);\n+        return SamplingService.create(scriptService, clusterService, Settings.EMPTY);\n     }\n }"
    }
  ],
  "diff": "diff --git a/server/src/main/java/org/elasticsearch/action/bulk/TransportAbstractBulkAction.java b/server/src/main/java/org/elasticsearch/action/bulk/TransportAbstractBulkAction.java\nindex f7460dd3de47d..c1b1cbf01741a 100644\n--- a/server/src/main/java/org/elasticsearch/action/bulk/TransportAbstractBulkAction.java\n+++ b/server/src/main/java/org/elasticsearch/action/bulk/TransportAbstractBulkAction.java\n@@ -312,7 +312,7 @@ private boolean applyPipelines(\n                 }\n             });\n             return true;\n-        } else if (haveRunIngestService == false && samplingService != null && samplingService.atLeastOneSampleConfigured()) {\n+        } else if (haveRunIngestService == false && samplingService != null && samplingService.atLeastOneSampleConfigured(project)) {\n             /*\n              * Else ample only if this request has not passed through IngestService::executeBulkRequest. Otherwise, some request within the\n              * bulk had pipelines and we sampled in IngestService already.\ndiff --git a/server/src/main/java/org/elasticsearch/ingest/IngestService.java b/server/src/main/java/org/elasticsearch/ingest/IngestService.java\nindex 82be81eed7c2f..ddd60dc522b3f 100644\n--- a/server/src/main/java/org/elasticsearch/ingest/IngestService.java\n+++ b/server/src/main/java/org/elasticsearch/ingest/IngestService.java\n@@ -1385,7 +1385,7 @@ private void attemptToSampleData(\n         IngestDocument ingestDocument,\n         Metadata originalDocumentMetadata\n     ) {\n-        if (samplingService != null && samplingService.atLeastOneSampleConfigured()) {\n+        if (samplingService != null && samplingService.atLeastOneSampleConfigured(projectMetadata)) {\n             /*\n              * We need both the original document and the fully updated document for sampling, so we make a copy of the original\n              * before overwriting it here. We can discard it after sampling.\ndiff --git a/server/src/main/java/org/elasticsearch/ingest/SamplingService.java b/server/src/main/java/org/elasticsearch/ingest/SamplingService.java\nindex 4a6407585b4e5..c11c5bb1b30d0 100644\n--- a/server/src/main/java/org/elasticsearch/ingest/SamplingService.java\n+++ b/server/src/main/java/org/elasticsearch/ingest/SamplingService.java\n@@ -28,7 +28,6 @@\n import org.elasticsearch.cluster.metadata.Metadata;\n import org.elasticsearch.cluster.metadata.ProjectId;\n import org.elasticsearch.cluster.metadata.ProjectMetadata;\n-import org.elasticsearch.cluster.project.ProjectResolver;\n import org.elasticsearch.cluster.service.ClusterService;\n import org.elasticsearch.cluster.service.MasterServiceTaskQueue;\n import org.elasticsearch.common.Priority;\n@@ -95,7 +94,6 @@ public class SamplingService extends AbstractLifecycleComponent implements Clust\n     private static final String TTL_JOB_ID = \"sampling_ttl\";\n     private final ScriptService scriptService;\n     private final ClusterService clusterService;\n-    private final ProjectResolver projectResolver;\n     private final LongSupplier statsTimeSupplier = System::nanoTime;\n     private final MasterServiceTaskQueue<UpdateSamplingConfigurationTask> updateSamplingConfigurationTaskQueue;\n     private final MasterServiceTaskQueue<DeleteSampleConfigurationTask> deleteSamplingConfigurationTaskQueue;\n@@ -122,26 +120,15 @@ public class SamplingService extends AbstractLifecycleComponent implements Clust\n     /*\n      * This creates a new SamplingService, and configures various listeners on it.\n      */\n-    public static SamplingService create(\n-        ScriptService scriptService,\n-        ClusterService clusterService,\n-        ProjectResolver projectResolver,\n-        Settings settings\n-    ) {\n-        SamplingService samplingService = new SamplingService(scriptService, clusterService, projectResolver, settings);\n+    public static SamplingService create(ScriptService scriptService, ClusterService clusterService, Settings settings) {\n+        SamplingService samplingService = new SamplingService(scriptService, clusterService, settings);\n         samplingService.configureListeners();\n         return samplingService;\n     }\n \n-    private SamplingService(\n-        ScriptService scriptService,\n-        ClusterService clusterService,\n-        ProjectResolver projectResolver,\n-        Settings settings\n-    ) {\n+    private SamplingService(ScriptService scriptService, ClusterService clusterService, Settings settings) {\n         this.scriptService = scriptService;\n         this.clusterService = clusterService;\n-        this.projectResolver = projectResolver;\n         this.updateSamplingConfigurationTaskQueue = clusterService.createTaskQueue(\n             \"update-sampling-configuration\",\n             Priority.NORMAL,\n@@ -340,12 +327,9 @@ public SampleStats getLocalSampleStats(ProjectId projectId, String index) {\n         return sampleInfo == null ? new SampleStats() : sampleInfo.stats;\n     }\n \n-    public boolean atLeastOneSampleConfigured() {\n+    public boolean atLeastOneSampleConfigured(ProjectMetadata projectMetadata) {\n         if (RANDOM_SAMPLING_FEATURE_FLAG) {\n-            SamplingMetadata samplingMetadata = clusterService.state()\n-                .projectState(projectResolver.getProjectId())\n-                .metadata()\n-                .custom(SamplingMetadata.TYPE);\n+            SamplingMetadata samplingMetadata = projectMetadata.custom(SamplingMetadata.TYPE);\n             return samplingMetadata != null && samplingMetadata.getIndexToSamplingConfigMap().isEmpty() == false;\n         } else {\n             return false;\ndiff --git a/server/src/main/java/org/elasticsearch/node/NodeConstruction.java b/server/src/main/java/org/elasticsearch/node/NodeConstruction.java\nindex 6ae1ea9c9c6c8..4366789342c12 100644\n--- a/server/src/main/java/org/elasticsearch/node/NodeConstruction.java\n+++ b/server/src/main/java/org/elasticsearch/node/NodeConstruction.java\n@@ -728,7 +728,7 @@ private void construct(\n \n         FeatureService featureService = new FeatureService(pluginsService.loadServiceProviders(FeatureSpecification.class));\n \n-        SamplingService samplingService = SamplingService.create(scriptService, clusterService, projectResolver, settings);\n+        SamplingService samplingService = SamplingService.create(scriptService, clusterService, settings);\n         modules.bindToInstance(SamplingService.class, samplingService);\n         clusterService.addListener(samplingService);\n \ndiff --git a/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java b/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java\nindex 119385319e52f..9263d2e3d742a 100644\n--- a/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionIngestTests.java\n@@ -180,7 +180,7 @@ public boolean clusterHasFeature(ClusterState state, NodeFeature feature) {\n \n         private static SamplingService initializeSamplingService() {\n             SamplingService samplingService = mock(SamplingService.class);\n-            when(samplingService.atLeastOneSampleConfigured()).thenReturn(true);\n+            when(samplingService.atLeastOneSampleConfigured(any())).thenReturn(true);\n             return samplingService;\n         }\n \ndiff --git a/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java b/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java\nindex 4242c44e29808..fed735a7ecd0f 100644\n--- a/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java\n+++ b/server/src/test/java/org/elasticsearch/action/bulk/TransportBulkActionTests.java\n@@ -163,7 +163,7 @@ public boolean clusterHasFeature(ClusterState state, NodeFeature feature) {\n \n         private static SamplingService initializeSamplingService() {\n             SamplingService samplingService = mock(SamplingService.class);\n-            when(samplingService.atLeastOneSampleConfigured()).thenReturn(true);\n+            when(samplingService.atLeastOneSampleConfigured(any())).thenReturn(true);\n             return samplingService;\n         }\n \ndiff --git a/server/src/test/java/org/elasticsearch/ingest/IngestServiceTests.java b/server/src/test/java/org/elasticsearch/ingest/IngestServiceTests.java\nindex 395407c897a63..46a8baf541009 100644\n--- a/server/src/test/java/org/elasticsearch/ingest/IngestServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/ingest/IngestServiceTests.java\n@@ -3357,7 +3357,7 @@ public void testSampling() {\n             Predicates.never(),\n             samplingService\n         );\n-        when(samplingService.atLeastOneSampleConfigured()).thenReturn(true);\n+        when(samplingService.atLeastOneSampleConfigured(any())).thenReturn(true);\n         PutPipelineRequest putRequest = putJsonPipelineRequest(\"_id\", \"{\\\"processors\\\": [{\\\"mock\\\" : {}}]}\");\n         var projectId = randomProjectIdOrDefault();\n         ClusterState clusterState = ClusterState.builder(ClusterName.DEFAULT)\ndiff --git a/server/src/test/java/org/elasticsearch/ingest/SamplingServiceTests.java b/server/src/test/java/org/elasticsearch/ingest/SamplingServiceTests.java\nindex bd24090d24a52..f49316a41804e 100644\n--- a/server/src/test/java/org/elasticsearch/ingest/SamplingServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/ingest/SamplingServiceTests.java\n@@ -16,7 +16,6 @@\n import org.elasticsearch.cluster.ClusterState;\n import org.elasticsearch.cluster.metadata.ProjectId;\n import org.elasticsearch.cluster.metadata.ProjectMetadata;\n-import org.elasticsearch.cluster.project.ProjectResolver;\n import org.elasticsearch.cluster.project.TestProjectResolvers;\n import org.elasticsearch.cluster.service.ClusterService;\n import org.elasticsearch.common.settings.Settings;\n@@ -352,8 +351,6 @@ private SamplingService getTestSamplingService() {\n             TestProjectResolvers.singleProject(randomProjectIdOrDefault())\n         );\n         ClusterService clusterService = ClusterServiceUtils.createClusterService(new DeterministicTaskQueue().getThreadPool());\n-        final ProjectId projectId = ProjectId.DEFAULT;\n-        final ProjectResolver projectResolver = TestProjectResolvers.singleProject(projectId);\n-        return SamplingService.create(scriptService, clusterService, projectResolver, Settings.EMPTY);\n+        return SamplingService.create(scriptService, clusterService, Settings.EMPTY);\n     }\n }\n",
  "additions": 12,
  "deletions": 31,
  "changed_files": 8,
  "url": "https://github.com/elastic/elasticsearch/pull/137066",
  "mined_at": "2025-10-25T13:24:14.104033"
}