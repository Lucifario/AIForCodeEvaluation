{
  "id": 1437,
  "repository": "apache/commons-lang",
  "title": "[LANG-1774] Improve handling of ClassUtils.getShortCanonicalName for invalid input",
  "body": "This PR improves handling of invalid class name inputs to `ClassUtils.getShortCanonicalName(String name)`\r\n\r\n- Added checks for the invalid class names, and replaced `RuntimeException `with descriptive `IllegalArgumentException`.\r\n- Added tests for invalid input scenarios and confirmed all existing and new test cases pass with `mvn`.",
  "state": "closed",
  "merged": true,
  "merged_at": "2025-09-01T19:45:21+00:00",
  "created_at": "2025-08-27T19:22:50+00:00",
  "updated_at": "2025-09-02T02:48:46+00:00",
  "author": "madhurlathi",
  "reviewers": [],
  "base_sha": "0d0681c4b34fe54ace1d5f08c2ff2a1cfe4e2c8b",
  "head_sha": "76455375e103bb1d5d5e5cbe95d10b8448806fc3",
  "review_comments": [],
  "pr_comments": [
    {
      "user": "garydgregory",
      "body": "Tracking https://issues.apache.org/jira/browse/LANG-1774",
      "created_at": "2025-09-01T19:48:35+00:00"
    },
    {
      "user": "garydgregory",
      "body": "@madhurlathi \r\nMerged. TY!\r\n",
      "created_at": "2025-09-01T19:51:37+00:00"
    },
    {
      "user": "madhurlathi",
      "body": "Thank you for merging the changes.",
      "created_at": "2025-09-02T02:48:46+00:00"
    }
  ],
  "files_changed": [
    {
      "filename": "src/main/java/org/apache/commons/lang3/ClassUtils.java",
      "status": "modified",
      "additions": 18,
      "deletions": 4,
      "changes": 22,
      "patch": "@@ -476,27 +476,41 @@ public static String getCanonicalName(final Object object, final String valueIfN\n      *\n      * @param name the name of class.\n      * @return canonical form of class name.\n+     * @throws IllegalArgumentException if the class name is invalid\n      */\n     private static String getCanonicalName(final String name) {\n         String className = StringUtils.deleteWhitespace(name);\n         if (className == null) {\n             return null;\n         }\n         int dim = 0;\n-        while (className.charAt(dim) == '[') {\n+        final int len = className.length();\n+        while (dim < len && className.charAt(dim) == '[') {\n             dim++;\n             if (dim > MAX_DIMENSIONS) {\n                 throw new IllegalArgumentException(String.format(\"Maximum array dimension %d exceeded\", MAX_DIMENSIONS));\n             }\n         }\n+        if (dim >= len) {\n+            throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n+        }\n         if (dim < 1) {\n             return className;\n         }\n         className = className.substring(dim);\n         if (className.startsWith(\"L\")) {\n-            className = className.substring(1, className.endsWith(\";\") ? className.length() - 1 : className.length());\n-        } else if (!className.isEmpty()) {\n-            className = REVERSE_ABBREVIATION_MAP.get(className.substring(0, 1));\n+            if (!className.endsWith(\";\") || className.length() < 3) {\n+                throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n+            }\n+            className = className.substring(1, className.length() - 1);\n+        } else if (className.length() == 1) {\n+            final String primitive = REVERSE_ABBREVIATION_MAP.get(className.substring(0, 1));\n+            if (primitive == null) {\n+                throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n+            }\n+            className = primitive;\n+        } else {\n+            throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n         }\n         final StringBuilder canonicalClassNameBuffer = new StringBuilder(className.length() + dim * 2);\n         canonicalClassNameBuffer.append(className);"
    },
    {
      "filename": "src/test/java/org/apache/commons/lang3/ClassUtilsTest.java",
      "status": "modified",
      "additions": 13,
      "deletions": 9,
      "changes": 22,
      "patch": "@@ -585,15 +585,19 @@ void test_getShortCanonicalName_String() {\n         assertEquals(\"String[]\", ClassUtils.getShortCanonicalName(String[].class.getName()));\n         assertEquals(\"String[]\", ClassUtils.getShortCanonicalName(String[].class.getCanonicalName()));\n         assertEquals(\"String[]\", ClassUtils.getShortCanonicalName(\"String[]\"));\n-        // Note that we throw RuntimeException (but not which one) for the following bad inputs:\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[]\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[;\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[];\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\" \"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[$\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[$a\"));\n+        // Note that we throw IllegalArgumentException for the following bad inputs:\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[]\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[;\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[];\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\" \"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[$\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[$a\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[[\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[[L\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[org.apache.commons.lang3.ClassUtilsTest\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[Lorg.apache.commons.lang3.ClassUtilsTest\"));\n     }\n \n     @Test"
    }
  ],
  "diff": "diff --git a/src/main/java/org/apache/commons/lang3/ClassUtils.java b/src/main/java/org/apache/commons/lang3/ClassUtils.java\nindex 615838def14..12470d5e0c3 100644\n--- a/src/main/java/org/apache/commons/lang3/ClassUtils.java\n+++ b/src/main/java/org/apache/commons/lang3/ClassUtils.java\n@@ -476,6 +476,7 @@ public static String getCanonicalName(final Object object, final String valueIfN\n      *\n      * @param name the name of class.\n      * @return canonical form of class name.\n+     * @throws IllegalArgumentException if the class name is invalid\n      */\n     private static String getCanonicalName(final String name) {\n         String className = StringUtils.deleteWhitespace(name);\n@@ -483,20 +484,33 @@ private static String getCanonicalName(final String name) {\n             return null;\n         }\n         int dim = 0;\n-        while (className.charAt(dim) == '[') {\n+        final int len = className.length();\n+        while (dim < len && className.charAt(dim) == '[') {\n             dim++;\n             if (dim > MAX_DIMENSIONS) {\n                 throw new IllegalArgumentException(String.format(\"Maximum array dimension %d exceeded\", MAX_DIMENSIONS));\n             }\n         }\n+        if (dim >= len) {\n+            throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n+        }\n         if (dim < 1) {\n             return className;\n         }\n         className = className.substring(dim);\n         if (className.startsWith(\"L\")) {\n-            className = className.substring(1, className.endsWith(\";\") ? className.length() - 1 : className.length());\n-        } else if (!className.isEmpty()) {\n-            className = REVERSE_ABBREVIATION_MAP.get(className.substring(0, 1));\n+            if (!className.endsWith(\";\") || className.length() < 3) {\n+                throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n+            }\n+            className = className.substring(1, className.length() - 1);\n+        } else if (className.length() == 1) {\n+            final String primitive = REVERSE_ABBREVIATION_MAP.get(className.substring(0, 1));\n+            if (primitive == null) {\n+                throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n+            }\n+            className = primitive;\n+        } else {\n+            throw new IllegalArgumentException(String.format(\"Invalid class name %s\", name));\n         }\n         final StringBuilder canonicalClassNameBuffer = new StringBuilder(className.length() + dim * 2);\n         canonicalClassNameBuffer.append(className);\ndiff --git a/src/test/java/org/apache/commons/lang3/ClassUtilsTest.java b/src/test/java/org/apache/commons/lang3/ClassUtilsTest.java\nindex abe0d82f381..c1dd53ac82c 100644\n--- a/src/test/java/org/apache/commons/lang3/ClassUtilsTest.java\n+++ b/src/test/java/org/apache/commons/lang3/ClassUtilsTest.java\n@@ -585,15 +585,19 @@ void test_getShortCanonicalName_String() {\n         assertEquals(\"String[]\", ClassUtils.getShortCanonicalName(String[].class.getName()));\n         assertEquals(\"String[]\", ClassUtils.getShortCanonicalName(String[].class.getCanonicalName()));\n         assertEquals(\"String[]\", ClassUtils.getShortCanonicalName(\"String[]\"));\n-        // Note that we throw RuntimeException (but not which one) for the following bad inputs:\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[]\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[;\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[];\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\" \"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[$\"));\n-        assertThrows(RuntimeException.class, () -> ClassUtils.getShortCanonicalName(\"[$a\"));\n+        // Note that we throw IllegalArgumentException for the following bad inputs:\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[]\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[;\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[];\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\" \"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[$\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[$a\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[[\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[[L\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[org.apache.commons.lang3.ClassUtilsTest\"));\n+        assertThrows(IllegalArgumentException.class, () -> ClassUtils.getShortCanonicalName(\"[Lorg.apache.commons.lang3.ClassUtilsTest\"));\n     }\n \n     @Test\n",
  "additions": 31,
  "deletions": 13,
  "changed_files": 2,
  "url": "https://github.com/apache/commons-lang/pull/1437",
  "mined_at": "2025-10-25T12:46:35.062222"
}